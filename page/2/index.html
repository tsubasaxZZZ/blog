<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Japan Azure Identity Support Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta name="keywords" content="Azure,Azure AD,Identity,AD FS">
<meta property="og:type" content="website">
<meta property="og:title" content="Japan Azure Identity Support Blog">
<meta property="og:url" content="https://jpazureid.github.io/page/2/index.html">
<meta property="og:site_name" content="Japan Azure Identity Support Blog">
<meta property="og:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta property="og:locale" content="ja">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Japan Azure Identity Support Blog">
<meta name="twitter:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
  
    <link rel="alternate" href="/blog/atom.xml" title="Japan Azure Identity Support Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Japan Azure Identity Support Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://jpazureid.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-azure-active-directory/expressroute-support" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/07/19/azure-active-directory/expressroute-support/" class="article-date">
  <time datetime="2018-07-18T15:00:00.000Z" itemprop="datePublished">2018-07-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/07/19/azure-active-directory/expressroute-support/">Azure AD の ExpressRoute サポート</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、 Azure ID チームの三浦です。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new#may-2018" target="_blank" rel="noopener">2018 年 5 月の Azure AD に対する更新情報</a> に記載の  ExpressRoute 利用環境における Azure AD への認証トラフィックの変更について、その変更の内容、変更の影響を受ける場合の対応策についてご案内します。</p>
<h2 id="変更の内容"><a href="#変更の内容" class="headerlink" title="変更の内容"></a>変更の内容</h2><p>Azure AD の認証トラフィックを処理するエンドポイント (IP アドレス) について、これまで ExpressRoute で Public ピアリング、 Microsoft ピアリングのいずれにおいてもルート情報がアドバタイズされていました。<br>言い換えますと ExpressRoute で Public ピアリングや Microsoft ピアリングを有効にして利用している環境では、 Azure AD に対する認証トラフィックが ExpressRoute を経由していました。</p>
<p>これが 2018 年 8 月 1 日から次のように変更されます。</p>
<p><strong>Microsoft ピアリング、かつ ExpressRoute を利用するサービスとして “その他の Office 365 Online サービス (12076:5100)” の BGP コミュニティを利用するように構成されている場合のみ ExpressRoute を経由する</strong></p>
<p>結果として、上記のような構成以外では、 ExpressRoute を経由することなく、インターネットを利用して通信するようになります。<br>なお、 Azure AD にはリージョンが無いため、その認証トラフィックは必ずしも指定したリージョンに留まりません。そのため、これまでも ExpressRoute の構成として <a href="https://azure.microsoft.com/ja-jp/pricing/details/expressroute/" target="_blank" rel="noopener">ExpressRoute Premium アドオン</a> を利用していなかった場合には、 Azure AD への認証トラフィックは必ずしも ExpressRoute を経由しませんでした。つまり、現状でも ExpressRoute を利用している環境でも今回の変更とは関係なく、Azure AD への通信はインターネット経由となっている可能性があります。</p>
<h2 id="何をするべきか"><a href="#何をするべきか" class="headerlink" title="何をするべきか"></a>何をするべきか</h2><p>基本的にはそれほど注意することはありません。注意しなければいけないのは以下の条件を全て満たすケースです。</p>
<ul>
<li>ExpressRoute を利用している</li>
<li>ExpressRoute で Public ピアリングを利用している、または Microsoft ピアリングを利用しているが、 “その他の Office 365 Online サービス (12076:5100)” コミュニティを有効にしていない</li>
<li>インターネットへのアクセスを特定の URL のみを通すようにプロキシなどで URL フィルタを実施している</li>
</ul>
<p>これまでは、上記条件を全て満たしている場合でも  ExpressRoute を経由して Azure AD への認証通信がおこなわれていたため、インターネットへのアクセス フィルタなどで、 Azure AD 認証に利用される URL を許可していなくとも問題ありませんでした。</p>
<p>2018 年 8 月 1 日以降は、上記条件を満たしている場合、 Azure AD への認証が通らなくなる恐れがあり、その結果として Azure や Office 365 などの各種サービスが利用できなくなる可能性があります。<br>対応策としては、次の公開情報で記載されています URL のうち <strong>Office 365 ポータルと共有</strong> と <strong>Office 365 の認証と ID</strong> に含まれるものについて、利用しているネットワークからインターネットにアクセスができるように、利用しているプロキシなどの設定変更を実施します。</p>
<p>Office 365 URL および IP アドレス範囲<br><a href="https://support.office.com/ja-jp/article/Office-365-URL-%e3%81%8a%e3%82%88%e3%81%b3-IP-%e3%82%a2%e3%83%89%e3%83%ac%e3%82%b9%e7%af%84%e5%9b%b2-8548a211-3fe7-47cb-abb1-355ea5aa88a2" target="_blank" rel="noopener">https://support.office.com/ja-jp/article/Office-365-URL-%e3%81%8a%e3%82%88%e3%81%b3-IP-%e3%82%a2%e3%83%89%e3%83%ac%e3%82%b9%e7%af%84%e5%9b%b2-8548a211-3fe7-47cb-abb1-355ea5aa88a2</a></p>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>現状は Azure AD の認証トラフィックに関連した経路は次の種類の ExpressRoute にてアドバタイズされています。</p>
<ol>
<li>Public ピアリング</li>
<li>Microsoft ピアリングの Azure の全てのリージョン コミュニティ</li>
<li>Microsoft ピアリングでの “その他の Office 365 Online サービス (12076:5100)” コミュニティ</li>
</ol>
<p>2018 年 8 月 1 日以降は 3 のみが ExpressRoute でアドバタイズされることになります。<br>各ピアリングについても 2018 年 4 月 1 日以降に考え方が変わり、例えば Public ピアリングについての新規構成が停止されているなどありますので、こちらについての詳細は以下の記事を参照ください。</p>
<p>ExpressRoute の Public Peering と Microsoft Peering に関するアナウンス<br><a href="https://blogs.technet.microsoft.com/jpaztech/2018/03/02/expressroute-announcement-march-2018/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2018/03/02/expressroute-announcement-march-2018/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/07/19/azure-active-directory/expressroute-support/" data-id="cjth4sca2000hhgytwpg2yclf" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ExpressRoute/">ExpressRoute</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/zero-trust-network" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/06/29/azure-active-directory/zero-trust-network/" class="article-date">
  <time datetime="2018-06-28T15:00:00.000Z" itemprop="datePublished">2018-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/06/29/azure-active-directory/zero-trust-network/">Microsoft 365 を用いたゼロ トラスト ネットワークの実現</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本記事は、米国時間 2018年 6 月 14 日に公開された <a href="https://cloudblogs.microsoft.com/microsoftsecure/2018/06/14/building-zero-trust-networks-with-microsoft-365/" target="_blank" rel="noopener">Building Zero Trust networks with Microsoft 365</a> の抄訳です。</p>
<hr>
<p>従来の境界ベースのネットワーク制御は時代遅れとなりつつあります。 境界ベースのネットワークには、ネットワーク内のすべてのシステムが信頼できるという前提があります。 しかし、今日ますますモバイル ワーカーが増える中、パブリック クラウドサービスへの移行や BYOD (Bring Your Own Device) モデルの採用もあり、境界セキュリティの制御は意味をなさなくなってきています。従来有効とされていた制御方法を依然として使い続けているネットワークは、侵入に脆弱となります。信頼される境界として定義していた中に含まれるエンドポイントのたった一つからでも攻撃者の侵入を許すと、攻撃者はその後あっという間にネットワーク全体を支配下においていきます。</p>
<p>ゼロ トラスト ネットワークは、境界で囲まれたネットワークは信頼できるという考え方を用いません。 代わりに、ゼロ トラスト アーキテクチャは組織内のデータとリソースへのアクセスにデバイスおよびユーザーのクレーム情報を活用します。 一般的なゼロ トラスト ネットワークモデル (図 1) は通常、以下の要素で構成されます。</p>
<ul>
<li>ユーザーおよびユーザー関連の情報を保持する ID プロバイダ</li>
<li>対応するデバイス情報 (デバイスの種類、整合性など) に基づいて、会社のリソースにアクセスできるデバイスのリストを保持するデバイス ディレクトリ</li>
<li>ユーザーまたはデバイスがセキュリティ管理者によって設定されたポリシーに準拠しているかどうかを判断するポリシー評価サービス</li>
<li>組織リソースへのアクセスを許可または拒否する上記の方式を利用したプロキシ</li>
</ul>
<img src="/blog/2018/06/29/azure-active-directory/zero-trust-network/fig1-basic-components-of-general-zero-trust-network-model-2.png">
<p>図 1. 一般的なゼロトラスト ネットワークモデルの基本構成</p>
<p>動的に信頼性を評価してリソースへのアクセスを制御することで、デバイスから特定のリソースへのアクセスを可能にし、一方で管理された準拠済みデバイス上の価値あるデータへのアクセスを制限することができます。標的型およびデータ漏洩を目的とした攻撃では、攻撃者は組織内の 1 つのデバイスに侵入し、盗んだ資格情報を使用してネットワーク全体を次々と横断的に移動していきます。ユーザーとデバイスに適切なポリシーが構成されたゼロ トラスト ネットワークに基づくソリューションは、盗まれたネットワーク資格情報を利用してネットワークにアクセスされるのを防ぐことができます。</p>
<p>ゼロ トラストの考え方は、ネットワーク セキュリティの進化系です。 サイバー攻撃の現状を鑑みるに、組織は「侵入されることが前提」として考える必要があります。しかし侵入への対応だけではなく、ゼロトラスト ネットワークは企業のデータとリソースを保護しながら、従業員がいつでもどこでもどのような方法であっても生産的でいられるようモダンな職場環境を得られるようにします。</p>
<h2 id="Azure-AD-条件付きアクセスに基づくゼロ-トラスト-ネットワーキング"><a href="#Azure-AD-条件付きアクセスに基づくゼロ-トラスト-ネットワーキング" class="headerlink" title="Azure AD 条件付きアクセスに基づくゼロ トラスト ネットワーキング"></a>Azure AD 条件付きアクセスに基づくゼロ トラスト ネットワーキング</h2><p>今日、従業員はさまざまなデバイスやアプリを使用して、どこからでも組織のリソースにアクセスできます。リソースにアクセスできるユーザーのみに焦点を当てたアクセス制御ポリシーは十分ではありません。セキュリティと生産性を高いバランスで保つために、セキュリティ管理者は、リソースへのアクセス方法も考慮する必要があります。</p>
<p>マイクロソフトは、ゼロ トラスト ネットワーキングに関する実績と戦略を持っています。お客様がゼロ トラスト ネットワークを実現するにあたり、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-conditional-access-azure-portal" target="_blank" rel="noopener">Azure Active Directory の条件付きアクセス</a> が重要な構成要素となります。 条件付きアクセスと <a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-identityprotection" target="_blank" rel="noopener">Azure Active Directory Identity Protection</a> は、すべてのリソース要求に対して、ユーザー、デバイス、場所、およびセッションのリスクに基づき動的にアクセス制御を実施します。 これらにより、(1) Windows デバイスのセキュリティ状態に関する <a href="https://cloudblogs.microsoft.com/microsoftsecure/2018/04/19/introducing-windows-defender-system-guard-runtime-attestation/" target="_blank" rel="noopener">attested runtime signals</a> (正常性を示す実行時の情報) と (2) ユーザー セッションと ID の信頼度を組み合わせることで、可能な限り強力なセキュリティ状態が得られるようにします。</p>
<p>条件付きアクセスには、ユーザーが企業のリソースにアクセスできる条件を制御するための一連のポリシーが用意されています。 アクセスの際に利用できる条件としては、ユーザーの役割、グループ メンバーシップ、デバイスの健全性やコンプライアンス (準拠状態)、モバイル アプリケーション、場所、サインインのリスクが挙げられます。これらの条件が、(1) アクセスを許可するか、(2) アクセスを拒否するか、または (3) 追加認証 (例えば多要素認証) の要求や利用規約の提示などのアクセス制限を行うかを決定するために使用されます。 条件付きアクセスは、Azure Active Directory と連携して動作する全てのアプリケーションで動作します。</p>
<img src="/blog/2018/06/29/azure-active-directory/zero-trust-network/fig2-Microsoft-high-level-approach-to-Zero-Trust-networks-using-conditional-access.png">
<p>図 2. 条件付きアクセスを用いてゼロトラスト ネットワークを実現するためのマイクロソフトのアプローチ (概要)</p>
<p>ゼロ トラスト モデルを実現するため、マイクロソフトは Windows Defender Advanced Threat Protection、Azure Active Directory、Windows Defender System Guard、Microsoft Intune など、Microsoft 365 におけるいくつかのコンポーネントと機能を統合して利用しています。</p>
<h3 id="Windows-Defender-Advanced-Threat-Protection"><a href="#Windows-Defender-Advanced-Threat-Protection" class="headerlink" title="Windows Defender Advanced Threat Protection"></a>Windows Defender Advanced Threat Protection</h3><p><a href="https://www.microsoft.com/en-us/windowsforbusiness/windows-atp?ocid=cx-blog-mmpc" target="_blank" rel="noopener">Windows Defender Advanced Threat Protection</a> (ATP) は、インテリジェンス駆動型の保護機能を有し、侵入後の検出、調査、および自動修復機能を提供するエンドポイント保護プラットフォーム (EPP: endpoint protection platform) です。また、エンドポイントでの検出と対応のための (EDR: endpoint detection response) 機能を持ちます。不審な動作の検出機能、機械学習、およびセキュリティ解析を組み合わせて、デバイスの状態を継続的に監視し、必要に応じて対処を行います。 Windows Defender ATP が侵入時の影響を軽減する独自の方法の 1 つとしては、侵入されたマシンとユーザーがこれ以上の影響を与えないようクラウド リソースへから自動的に分離することが挙げられます。</p>
<p>例えば、攻撃者は <a href="https://en.wikipedia.org/wiki/Pass_the_hash" target="_blank" rel="noopener">Pass-the-Hash (PtH)</a> と “Pass the ticket for Kerberos” という手法を使用して、侵入されたデバイスからハッシュされたユーザー資格情報を直接抽出します。攻撃者はハッシュされた資格情報を次々と別のシステムを乗っ取るために利用し、ついには特権を得るに至ります。<a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard" target="_blank" rel="noopener">Windows Defender Credential Guard</a> は、NTLM ハッシュとドメインの資格情報を保護してこれらの攻撃を防ぎますが、セキュリティ管理者としては攻撃が防がれただけではなく、そのような攻撃が発生したこと自体も把握したいと考えるでしょう。<br>Windows Defender ATP は、上記のような攻撃を管理者に報告し、侵入されたデバイスがどの程度危険かというリスク レベルを生成します。条件付きアクセスでは、Windows Defender ATP がデバイスのリスク レベルを生成し、この情報をもとにして、クライアント デバイスが企業内のリソースにアクセスするためのトークンを発行するかどうかを判断します。 Windows Defender ATP は、次のような幅広いセキュリティ機能を使用します。</p>
<ul>
<li><a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/05/08/antivirus-evolved/" target="_blank" rel="noopener">豊富な機械学習と行動検出ライブラリ</a></li>
<li><a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/10/23/windows-defender-exploit-guard-reduce-the-attack-surface-against-next-generation-malware/" target="_blank" rel="noopener">脆弱性を利用した悪意ある行為からの保護</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard" target="_blank" rel="noopener">資格情報の保護</a></li>
<li><a href="https://blogs.windows.com/msedgedev/2016/09/27/application-guard-microsoft-edge/" target="_blank" rel="noopener">アプリケーションの分離</a></li>
<li><a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/05/08/antivirus-evolved/" target="_blank" rel="noopener">ウイルス対策</a></li>
<li><a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/10/23/windows-defender-exploit-guard-reduce-the-attack-surface-against-next-generation-malware/" target="_blank" rel="noopener">ネットワーク保護</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-smartscreen/windows-defender-smartscreen-set-individual-device" target="_blank" rel="noopener">ウェブ保護</a></li>
</ul>
<h3 id="Windows-Defender-System-Guard-の実行時検証機能-runtime-attestation"><a href="#Windows-Defender-System-Guard-の実行時検証機能-runtime-attestation" class="headerlink" title="Windows Defender System Guard の実行時検証機能 (runtime attestation)"></a>Windows Defender System Guard の実行時検証機能 (runtime attestation)</h3><p><a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/10/23/hardening-the-system-and-maintaining-integrity-with-windows-defender-system-guard/" target="_blank" rel="noopener">Windows Defender System Guard</a> は、起動時にシステムの整合性を保護し、その後も維持し続けます。「侵入されることが前提」という考え方では、セキュリティ管理者は、デバイスのセキュリティ状態をリモートから証明することが重要です。 2018 年 4 月 の Windows 10 のアップデートでは、<a href="https://cloudblogs.microsoft.com/microsoftsecure/2018/04/19/introducing-windows-defender-system-guard-runtime-attestation/" target="_blank" rel="noopener">Windows Defender System Guard の実行時検証機能 (runtime attestation)</a> もデバイスの整合性を確立するのに効果的です。本機能は、デバイスの起動時および実行時に、ハードウェアハードの検証処理を行います。 これらの結果は、Windows Defender ATP によって処理され、そのデバイスのリスク レベルがどの程度であるか判断するのに用いられます。</p>
<p>Windows Defender System Guard の最も重要な目標は、システムの整合性が侵害されていないか検証することです。 このハードウェアに基づいた信頼性の高いフレームワークにより、ユーザーはデバイスのセキュリティ状態が改竄されていないことを (一定の範囲内で) 証明する署名付きのレポート得ることができます。 Windows Defender ATP のユーザーは、Windows Defender ATP ポータルを使用して、すべてのデバイスのセキュリティ状態を確認し、セキュリティ違反を検出したり修復したりできます。</p>
<p>Windows Defender System Guard の実行時検証機能 (runtime attestation) は、攻撃を検出するにあたり、<a href="https://docs.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-vbs" target="_blank" rel="noopener">仮想化ベースのセキュリティ (VBS)</a> におけるハードウェアに基づくセキュリティ技術を活用しています。 バーチャル セキュア モード対応デバイスでは、Windows Defender System Guard の実行時検証機能 (runtime attestation) は分離された環境で実行されるため、カーネル レベルの攻撃にも耐性があります。</p>
<p>Windows Defender System Guard の実行時検証機能 (runtime attestation) は、実行時にシステム セキュリティの状態を継続的に監視します。 これら検証機能が生成する結果は、例えばプロセスの保護機能がデバイス上で無効化されるなど、Windows のセキュリティが意図しない状態となっていることを捉える目的で利用されます。</p>
<h3 id="Azure-Active-Directory"><a href="#Azure-Active-Directory" class="headerlink" title="Azure Active Directory"></a>Azure Active Directory</h3><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-whatis" target="_blank" rel="noopener">Azure Active Directory</a> は、企業がアプリケーションへのアクセスを管理し、クラウドとオンプレミスの両方でユーザー ID を保護するためのクラウド ID とアクセス管理ソリューションです。ディレクトリと ID 管理の機能に加えて、アクセス制御をつかさどる Azure AD は以下の機能を提供します。</p>
<ul>
<li>シングルサインオン: すべてのユーザーが単一の ID を持ち、企業をまたがるリソースにアクセスして高い生産性を確保します。 ユーザーは、クラウド サービスやオンプレミス Web アプリケーションにシングル サインオンするため、同じ職場または学校のアカウントを使用できます。多要素認証を利用すれば、より確実なユーザー検証が可能となります。</li>
<li>アプリケーション アクセスの自動プロビジョニング: ユーザーが所属するグループのメンバーシップや地理的位置、雇用状況に基づいて、ユーザーによるアプリケーションへのアクセスを自動的にプロビジョニングまたは解除することができます。</li>
</ul>
<p>Azure AD は、アクセス管理をつかさどるサービスとして、組織内のリソースへのアクセス許可を付与するかどうかの判断を以下の情報を用いて行います。</p>
<ul>
<li>グループとユーザーのアクセス許可</li>
<li>アクセスしようとしているアプリケーション</li>
<li>サインインに使用したデバイス (Intune のデバイス準拠情報など)</li>
<li>サインインに使用されているデバイスのオペレーティング システム</li>
<li>サインインの場所または IP 範囲</li>
<li>ログインに使用したクライアント アプリ</li>
<li>サインイン時間</li>
<li>サインイン リスク (そのサインインが正規のユーザーによるものでない可能性)<br>(Azure AD Identity Protection の機械学習およびヒューリスティック検出による算出)</li>
<li>ユーザー リスク (攻撃者が対象のユーザーに成りすましている可能性)<br>(連携している社外のセキュリティ パートナーから継続的に寄せられる情報を活用し、Azure AD Identity Protection の高度な機械学習により算出)</li>
<li>その他にも今後様々な判断要素が追加される予定です</li>
</ul>
<p>条件付きアクセス ポリシーは、ユーザーが Azure AD と連携したアプリケーション (例えば、SaaSアプリケーション、クラウドで実行されているカスタム アプリケーション、オンプレミス Web アプリケーションなど） にアクセスしようとすると、リアルタイムで評価および適用されます。 疑わしいアクティビティが検出された場合、Azure ADは、危険度の高いユーザーをブロックしたり、資格情報が侵害された場合にはユーザーのパスワードをリセットしたり、利用規約を強制したりするなど、復旧を支援します。</p>
<p>企業のアプリケーションへのアクセスが許可されると、クライアント デバイスにはアクセス トークンが与えられます。このトークンを発行するかどうかの判断を Azure AD 条件付きアクセス ポリシーが中心となって行います。要求が条件を満たしている場合は、トークンがクライアントに付与されます。ポリシーによっては、制限付きのアクセス (ダウンロードが許可されていないなど) を要求したり、Microsoft Cloud App Security でのセッション監視が行われたりする場合もあります。</p>
<h3 id="Microsoft-Intune"><a href="#Microsoft-Intune" class="headerlink" title="Microsoft Intune"></a>Microsoft Intune</h3><p>Microsoft Intune は、組織内のモバイル デバイス、PC およびアプリケーションを管理するために使用されます。 Microsoft Intune と Azure を用いることで、価値ある資産とデータを管理・可視化でき、さらには <a href="https://docs.microsoft.com/en-us/information-protection/understand-explore/what-is-information-protection" target="_blank" rel="noopener">Azure Information Protection</a> や Asset Tagging、<a href="https://www.microsoft.com/en-us/cloud-platform/cloud-app-security" target="_blank" rel="noopener">Microsoft Cloud App Security</a> などの構成要素に基づいて、自然にセキュリティ要件が底上げされるような性質も持ち合わせています。</p>
<p>Microsoft Intune は、クライアント デバイスの導入、登録、および管理を担当します。 モバイルデバイス (Android および iOS）、ラップトップ (Windows および macOS)、従業員の BYOD デバイスなど、幅広いデバイスをサポートしています。 Intune は、Windows Defender ATP によって提供されるコンピュータのリスクレベルを他のコンプライアンス情報と組み合わせて、デバイスが準拠状態にあるかどうか (“isCompliant”) を判断します。 Azure AD は、この準拠状態を利用することで、企業リソースへのアクセスをブロックするか許可するかを判断します。 条件付きアクセスポリシーは、以下のいずれかの方法で Intune から設定可能です。</p>
<ul>
<li>アプリケーション ベースの設定: 承認されたアプリケーションのみが企業リソースにアクセス可能</li>
<li>デバイス ベースの設定: 承認され準拠しているデバイスのみが企業リソースにアクセス可能</li>
</ul>
<p><a href="https://cloudblogs.microsoft.com/enterprisemobility/2018/04/18/enhancing-conditional-access-with-machine-risk-data-from-windows-defender-advanced-threat-protection/" target="_blank" rel="noopener">Intune におけるリスクベースの条件付きアクセスの準拠確認を構成する方法はこちら</a></p>
<h2 id="条件付きアクセスの実行例"><a href="#条件付きアクセスの実行例" class="headerlink" title="条件付きアクセスの実行例"></a>条件付きアクセスの実行例</h2><p>条件付きアクセスの価値を理解するには、実例を見るのが一番です。(注: このセクションで使用されている名前は架空のものですが、ここでは様々なシナリオにおいて如何にして条件付きアクセスが企業のデータとリソースを保護するかご覧いただけます)。</p>
<blockquote>
<p>“SurelyMoney” は世界で最も権威のある金融機関の一つであり、100 万人以上のユーザーに対して日々の取引がシームレスに行えるようサービスを提供しています。同社は Microsoft 365 E5 を使用しており、セキュリティ エンタープライズ管理者は条件付きアクセスを利用しています。</p>
<p>攻撃者は、企業の顧客情報と取引情報の詳細を盗もうとします。攻撃者はマルウェアの添付ファイルを含む一見すると無害な電子メールを従業員に送信します。ある従業員が企業のデバイス上でこの添付ファイルを無意識のうちに開くと、そのデバイスが侵害されます。この 1 人の従業員の操作によって、攻撃者はその従業員のユーザー資格情報を収集し、企業のアプリケーションにアクセスすることが可能となってしまいます。</p>
<p>Windows Defender ATP は、デバイスの状態を継続的に監視し、侵入を検出しすると、デバイスが侵害されたとフラグを立てます。 このデバイス情報は、Azure AD と Intune に中継され、そのデバイスからアプリケーションへのアクセスが拒否されます。 侵害されたデバイスとユーザーの資格情報を用いても、企業リソースへのアクセスができないようブロックされます。 デバイスが Windows Defender ATP によって自動修復されると、修復されたデバイス上のユーザーにアクセス権が再付与されます。</p>
</blockquote>
<p>上記のように、条件付きアクセスと Windows Defender ATP が連携することで、マルウェアの移動を防ぐとともに、攻撃の分離や企業リソースの確実な保護が行われます。</p>
<h3 id="Azure-ADアプリケーション-Office-365、Exchange-Online、SPO-など"><a href="#Azure-ADアプリケーション-Office-365、Exchange-Online、SPO-など" class="headerlink" title="Azure ADアプリケーション (Office 365、Exchange Online、SPO など)"></a>Azure ADアプリケーション (Office 365、Exchange Online、SPO など)</h3><blockquote>
<p>SurelyMoney の経営陣は、Office 365 アプリケーションである Microsoft SharePoint に企業秘密を含む文書を多数格納しています。攻撃者は侵入したデバイスを用いてこれらのドキュメントを盗もうとします。 ただし、O365 アプリケーションと条件付きアクセスは統合されているため、こういった事象は未然に防がれることになります。</p>
</blockquote>
<p>Microsoft Word、Microsoft PowerPoint、Microsoft Excel などの Office 365 アプリケーションを用いることで、組織の従業員は連携して日々の業務を完了することができます。ただし、業務の機密性や性質、所属するグループやその他の要因によって、ユーザーは一人ひとり異なる権限を持っています。アプリケーションと条件付きアクセスは統合されているため、このような様々なユーザー権限のある環境であっても条件付きアクセスを用いることでアクセス管理が容易となります。条件付きアクセスにより、セキュリティ管理者はカスタム ポリシーを実装することができ、アプリケーションは目的のリソースに対する部分的または完全なアクセスを得ることができます。</p>
<img src="/blog/2018/06/29/azure-active-directory/zero-trust-network/fig-3-zero-trust-network-model-for-azure-ad-applications.png">  
<p>図 3. Azure AD アプリケーションのゼロトラスト ネットワークモデル</p>
<h3 id="業務アプリケーション"><a href="#業務アプリケーション" class="headerlink" title="業務アプリケーション"></a>業務アプリケーション</h3><blockquote>
<p>SurelyMoney には、Azure AD と連携した、独自開発の取引追跡アプリケーションがあります。 このアプリケーションは、顧客が実行したすべての取引記録を保持しています。 攻撃者は、取得したユーザーの資格情報を使用してこのアプリケーションにアクセスしようとします。 しかし、条件付きアクセスがこの侵入を防ぎます。</p>
</blockquote>
<p>どのような組織にも、従業員の生産性や事業の成功に直接かかわるミッション クリティカルなビジネス アプリケーションがあります。これらのアプリケーションには、通常、電子商取引システム、顧客情報の管理システム、文書管理システムなどのカスタム　アプリケーションが含まれます。Azure AD は、必要なコンプライアンスおよびリスク ポリシーを満たしていない場合、これらのアプリケーションにアクセス トークンを付与しません。つまりリソースへのアクセスを許可または拒否するかどうか明確な判断を下すことができます。</p>
<img src="/blog/2018/06/29/azure-active-directory/zero-trust-network/fig4-zero-trust-network-model-expanded-for-line-of-business-apps.png">  
<p>図 4. ビジネス アプリケーション向けに拡張されたゼロトラスト ネットワークモデル</p>
<h3 id="オンプレミス-Web-アプリケーション"><a href="#オンプレミス-Web-アプリケーション" class="headerlink" title="オンプレミス Web アプリケーション"></a>オンプレミス Web アプリケーション</h3><p>今日、従業員はどこからでも、いつでも、どのデバイスからでも高い生産性を発揮することが求められています。また、タブレット、携帯電話、ノート PC に関わらず自分のデバイスを用いて仕事をしたいと考えているでしょう。 このとき社内のオンプレミス アプリケーションにアクセスできることも期待していると思われます。<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-application-proxy-enable" target="_blank" rel="noopener">Azure AD Application Proxy</a> は、外部公開したアプリケーションへのリモート アクセスを実現し、承認済みもしくは非承認済みのデバイスに対して条件に応じたアクセスを可能とします。</p>
<blockquote>
<p>SurelyMoney は、レガシーな独自のコード署名用のアプリケーションを保持しています。コード署名を行うチームメンバーのデバイスが攻撃者により侵入されたことがわかりました。オンプレミスのレガシー アプリケーションへの要求は、Azure AD Application Proxy 経由で行われます。 攻撃者は、侵害されたユーザーの資格情報を使用してこのアプリケーションにアクセスしようとしますが、条件付きアクセスによりアクセスは失敗します。</p>
<p>条件付きアクセスがなければ、攻撃者は悪意あるアプリケーションを作成およびコード署名し、さらには Intune 経由で展開することができます。 これら悪意あるアプリは、Intune に登録されているすべてのデバイスにプッシュされ、ハッカーはこれまでにない量の機密情報を取ることができます。 このような攻撃はこれまでにも確認されており、こういった攻撃の防御に企業は非常に強い関心を寄せています。</p>
</blockquote>
<img src="/blog/2018/06/29/azure-active-directory/zero-trust-network/fig5-zero-trust-network-model-for-on-premises-web-applications.png">  
<p>図 5. オンプレミス Web アプリケーションのゼロトラスト ネットワークモデル</p>
<h2 id="継続的なイノベーション"><a href="#継続的なイノベーション" class="headerlink" title="継続的なイノベーション"></a>継続的なイノベーション</h2><p>現在、条件付きアクセスは Web アプリケーションとシームレスに動作します。 ゼロ トラストでは、厳密な意味で、すべてのネットワーク要求がアクセス制御プロキシを通過し、デバイスとユーザーの信頼モデルに基づいてすべての評価が行われることが必要です。 これらのネットワーク要求には、従来のさまざまなレガシー通信プロトコルや、FTP、RDP、SMBなどのアクセス方式も含まれます。</p>
<p>条件付きアクセスは、デバイスとユーザーのクレーム情報を利用して組織リソースへのアクセスを制御することで、ユーザーの生産性を確保しながら企業データを保護するための包括的で柔軟なポリシーを提供します。マイクロソフトは、ユーザーが企業ネットワークの境界を越えて生産性を発揮できる最新の職場環境が脅威にさらされないよう、技術的な革新を続けていきます。</p>
<p><strong>Sumesh Kumar, Ashwin Baliga, Himanshu Soni, Jairo Cadena</strong><br>Enterprise &amp; Security</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/06/29/azure-active-directory/zero-trust-network/" data-id="cjth4sccj0032hgyt15nnfic7" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-Application-Proxy/">Azure AD Application Proxy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Intune/">Intune</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Windows-Defender-ATP/">Windows Defender ATP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/b2b-invitation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/05/23/azure-active-directory/b2b-invitation/" class="article-date">
  <time datetime="2018-05-22T15:00:00.000Z" itemprop="datePublished">2018-05-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/05/23/azure-active-directory/b2b-invitation/">Azure AD B2B におけるユーザーの新しい招待方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure ID チームの高田です。</p>
<p>今回は、新しくなった Azure AD B2B (ゲスト招待機能) についてお知らせします。</p>
<p>マイクロソフトでは、以下の資料のとおり、5 月 11 日から Azure AD B2B の新しい更新を展開しています。これにより、ゲストユーザーの招待においてこれまでと比べてユーザーから見た画面が変更されたり、管理者により行うべきことも変更されていたりします。本記事ではその概要についておまとめしました。</p>
<p>Exciting improvements to the B2B collaboration experience<br><a href="https://cloudblogs.microsoft.com/enterprisemobility/2018/05/14/exciting-improvements-to-the-b2b-collaboration-experience/" target="_blank" rel="noopener">https://cloudblogs.microsoft.com/enterprisemobility/2018/05/14/exciting-improvements-to-the-b2b-collaboration-experience/</a></p>
<p>Azure Active Directory B2B collaboration invitation redemption<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/b2b/redemption-experience" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/b2b/redemption-experience</a></p>
<h2 id="新しい-Azure-AD-B2B-の変更概要"><a href="#新しい-Azure-AD-B2B-の変更概要" class="headerlink" title="新しい Azure AD B2B の変更概要"></a>新しい Azure AD B2B の変更概要</h2><p>新しい Azure AD B2B では、多くのシナリオにおいてユーザー自身が招待メールをクリックしなくてもよいように改善されています。従来は管理者がユーザーを招待すると、招待されたユーザーにメールが届き、ユーザーはメール内にある「はじめに」のリンクをクリックして招待を完了するというのが一般的な招待の流れでした。</p>
<p>しかしながら、招待メールのクリック自体が煩雑であること、また環境によっては招待メールがセキュリティによりブロックされるなどし届かないことで、招待がスムーズに行われないという問題がありました。</p>
<p>新しい Azure AD B2B でもメールによる招待は可能ですが、招待されたユーザーはメールにある「はじめに」のクリックせずとも、招待されたテナント上のリソース (URL) に直接アクセスしサインインすれば、招待を完了することが可能となります。招待されたテナント上のリソース (URL) に実際にアクセスしサインインすると、ユーザーには以下の画面が表示されます。</p>
<img src="/blog/2018/05/23/azure-active-directory/b2b-invitation/b2b-consent.png">
<p>この画面は、ユーザーが招待されたテナントに対してそのユーザーのサインインおよびプロファイル情報の読み取りを許可して良いか確認するものです。GDPR への対応として、招待を完了するにはユーザーが必ずこの画面を確認のうえ承諾することが求められるようになりました。<br>これを踏まえ、ユーザーの招待の仕方には現在大まかに二つの方法があります。</p>
<h3 id="1-招待されたテナントのリソースの-URL-に直接アクセスし招待を完了する"><a href="#1-招待されたテナントのリソースの-URL-に直接アクセスし招待を完了する" class="headerlink" title="1. 招待されたテナントのリソースの URL に直接アクセスし招待を完了する"></a>1. 招待されたテナントのリソースの URL に直接アクセスし招待を完了する</h3><p>ゲストユーザーの追加は SharePoint などのアプリケーションからも行うことができますが、このシナリオの場合、ゲストとしてユーザーを登録したら、招待されたユーザーは直接リソース (この例の場合には SharePoint) の URL にアクセスすることで上述の画面が表示され招待を完了できます。</p>
<p>例えば、Tenant A 上に SharePoint サイト (例: <a href="https://tenanta.sharepoint.com/sites/testsite" target="_blank" rel="noopener">https://tenanta.sharepoint.com/sites/testsite</a>) があり、この SharePoint サイトに Tenant B のユーザーもアクセスさせたいとします。この場合は、Tenant A 上に SharePoint サイトにゲストとして Tenant B のユーザーを追加ください。そのうえで、ユーザーに対して、<a href="https://tenanta.sharepoint.com/sites/testsite" target="_blank" rel="noopener">https://tenanta.sharepoint.com/sites/testsite</a> という URL を配布します。URL を受け取った Tenant B のユーザーはこの URL に直接アクセスしサインインすることで、上記画面から招待の受け付けを完了し、サイトにアクセスできるようになります。</p>
<p>SharePoint のようにアプリケーションから招待した場合でなくとも、この方法を取ることができます。例として、 Azure ポータルでゲストの追加を行う場合を考えます。ポータルで招待が行われた後、招待されたユーザーは、Azure Portal (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) にアクセスしても URL にはテナントの名前が含まれないため、このままでは自テナントのポータルにサインインしてしまいます。結果として同意画面が表示されません (招待は完了しません)。</p>
<p>この場合は、<a href="https://portal.azure.com/tenanta.onmicrosoft.com" target="_blank" rel="noopener">https://portal.azure.com/tenanta.onmicrosoft.com</a> のように、招待されたテナント名を URL の末尾につけてアクセスします。このようにすると、Tenant A 上のリソースとしてアクセスを試みるため、招待された Tenant B のアカウントでサインインすれば上記の画面を表示させることができます。招待が完了した後は、Azure Portal 上でテナントを切り替えて各テナントのリソースを管理することができます。</p>
<h3 id="2-従来どおり招待メールからの招待を完了する"><a href="#2-従来どおり招待メールからの招待を完了する" class="headerlink" title="2. 従来どおり招待メールからの招待を完了する"></a>2. 従来どおり招待メールからの招待を完了する</h3><p>従来通りの方法も引き続きサポートされます。Azure Portal から [+ 新しいゲストユーザー] を選択するか New-AzureADMSInvitation コマンドレット (-SendInvitationMessage オプションは $true) を使用してユーザーを招待した場合には、招待メールが送信されます。また、これ以外にも、サブスクリプションやリソースに対して、[アクセス制御 (IAM)] から権限を付与する際に、外部のメールアドレスを指定すると招待メールが送信されます。以前と同様に、送信されたメールには招待を完了させるための「はじめに」のリンクがあるのでこれをクリックします。自身のアカウントでサインインすると上記画面が表示され、承諾することで招待を完了することが可能です。</p>
<p>また、 1 に記載しましたように招待メールが送信された場合でも、明示的に <a href="https://portal.azure.com/tenanta.onmicrosoft.com" target="_blank" rel="noopener">https://portal.azure.com/tenanta.onmicrosoft.com</a> のように招待されたテナントを指定してアクセスすることで、招待を完了させることもできます。</p>
<p>なお、以前は例えば Tenant A 上に Tenant B 上のユーザーを一名招待しておき、そのゲスト ユーザーにゲスト招待元のディレクトリロールを割り当てたうえで、当該ゲスト ユーザーから New-AzureADMSInvitation コマンドレット (-SendInvitationMessage オプションは $false) を実行することで、招待メールを送ることなく一括してユーザーの招待を完了することが可能でした。</p>
<p>しかしこの方法は今回の変更で利用できなくなっています。メールを送らない招待方法の場合、前述のとおりユーザーは招待されたテナント上のリソースにアクセスして、必ず同意画面で承諾ボタンを押下する必要があります。恐れ入りますが、招待メールを送信し各ユーザーで「はじめに」のリンクをクリックするか、各ユーザーに直接リソースにアクセスしてもらう (<a href="https://portal.azure.com/{tenant}.onmicrosoft.com" target="_blank" rel="noopener">https://portal.azure.com/{tenant}.onmicrosoft.com</a> にアクセスしてもらう方法でも可) ことで同意画面から招待を完了いただければと思います。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/05/23/azure-active-directory/b2b-invitation/" data-id="cjth4sc9y000ahgytnwp4wi9o" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory-connect/auto-upgrade-issue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/" class="article-date">
  <time datetime="2018-04-22T15:00:00.000Z" itemprop="datePublished">2018-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/">自動アップグレード機能の問題</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>皆さん、こんにちは。Azure AD Connect (AADC) のサポートを担当している福島です。</p>
<p>今回のブログは、AADC で発生する 「本来行われるべき AADC の自動アップグレードが実施されない問題」 に関する投稿です。<strong>“バージョン 1.1.524.0 以降 1.1.750.0 未満” の Azure AD Connect を利用している場合</strong>、気づかない間に本問題事象に該当している可能性がありますため一読ください。</p>
<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>バージョン 1.1.524.0 を一度でもインストールしたことがある環境では、本来行われるように設定している自動アップグレードが行われていない可能性があります。</p>
<p>既定で AADC は自動アップグレードが有効になっています。しかし、バージョン 1.1.524.0 を新規でインストールした、あるいはそれ以前のバージョンを利用しており自動アップグレードを利用して 1.1.524.0 がインストールされた環境では、その後自動アップグレード設定を有効にしていても 1.1.524.0 以降のバージョンにアップグレードが行われていない可能性があります。</p>
<p>問題となるシナリオを整理すると次の通りです。</p>
<ul>
<li><p>シナリオ 1. バージョン 1.1.524.0 よりも前の AADC をインストールし、自動アップグレードを有効な状態としていた</p>
<p>  このケースでは、1.1.524.0 までは自動アップグレードによる更新が行われていました。<br>しかし、 1.1.524.0 のアップグレード機能に問題が存在していたため、1.1.524.0 以降への自動アップグレードが行われない状態となります。</p>
</li>
<li><p>シナリオ 2. 新規でバージョン 1.1.524.0 をインストールした</p>
<p>  本バージョン自体に問題が存在しているため、自動アップグレードを有効にしていてもアップグレードが行われません。</p>
</li>
<li><p>シナリオ 3. 新規でバージョン1.1.524.0 をインストール後、手動で 1.1.750.0 未満にアップグレードした</p>
<p>  この状態でも、引き続き自動アップグレードは行われません。</p>
</li>
</ul>
<p>この問題は、バージョン 1.1.750.0 で解消しています。</p>
<p>そのため、反対に 1.1.524.0 -1.1.749.0 を利用している間自動アップグレードが (製品の期待される動作とは反対に) 動作していなかった状態のものが、 1.1.750.0 のインストールにより自動アップグレードが正しく機能するようになることにも注意ください。</p>
<h2 id="対象の確認方法"><a href="#対象の確認方法" class="headerlink" title="対象の確認方法"></a>対象の確認方法</h2><p>下記 2 つの条件を “両方” 満たしている AADC サーバーで、本事象は発生している可能性があります。</p>
<ul>
<li>条件 1. UpdateCheckEnabled レジストリに 0 が設定されている</li>
<li>条件 2. 自動アップグレード機能の実行状態が、Enabled または Suspended である</li>
</ul>
<p>条件 1. のレジストリ値の設定状態は下記コマンドで確認することが可能です。(管理者権限が必要)</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ADHealthAgent\Sync /v UpdateCheckEnabled</span><br></pre></td></tr></table></figure>
<p>出力結果例)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ADHealthAgent\Sync</span><br><span class="line">    UpdateCheckEnabled    REG_DWORD    0x0</span><br></pre></td></tr></table></figure>
<p>条件 2. の自動アップグレード機能の実行状態 (Enabled または Suspended であるか) は、Get-ADSyncAutoUpgrade コマンドで確認することが可能です。</p>
<p>コマンド実行例)</p>
<img src="/blog/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/1_command.png">
<p>なお、Suspended (保留) 状態にある場合も、自動アップグレード処理 (モジュールのダウンロードおよびインストール) は試行されます。<br>Suspended は [自動アップグレード機能は有効だが、システムにより一時的に保留された状態] を意味し、システムの判断により自動アップグレード処理が行われる可能性がある状態となります。</p>
<p>Azure AD Connect: 自動アップグレード<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/connect/active-directory-aadconnect-feature-automatic-upgrade" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/connect/active-directory-aadconnect-feature-automatic-upgrade</a></p>
<p>運用の要件として、AADC の自動アップグレードを無効化したい場合は、[Set-ADSyncAutoUpgrade -AutoUpgradeState Disabled] コマンドを AADC サーバー上で実行して、明示的に自動アップグレード機能を無効にする必要がありますのでご留意ください。<br>(もちろん弊社としては、様々な問題の修正や機能追加が行われているため、最新の AADC をご利用いただくことを推奨しております。)</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>バージョン 1.1.524.0 の AADC を一度でもインストールした場合、自動アップグレード機能に関連するレジストリ情報に誤った値が設定されてしまうためです。</p>
<p>キーパス : HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ADHealthAgent\Sync<br>名前 : UpdateCheckEnabled<br>値 : 0 (無効)  &lt;&lt;&lt;&lt;&lt;★ 無効 (0x0) が誤って設定されてしまいます。  </p>
<p>当該レジストリが設定されている状態では、自動アップグレード機能の実行状態に Enabled または Suspended が設定されていた場合でも、実際のアップグレード処理が行われなくなります。</p>
<h2 id="解決策"><a href="#解決策" class="headerlink" title="解決策"></a>解決策</h2><p>本問題の解決策は下記 2 つです。</p>
<h3 id="解決策-1-手動アップグレートを利用して-AADC-のバージョンを-1-1-750-0-以降にアップグレードする"><a href="#解決策-1-手動アップグレートを利用して-AADC-のバージョンを-1-1-750-0-以降にアップグレードする" class="headerlink" title="解決策 1. 手動アップグレートを利用して AADC のバージョンを 1.1.750.0 以降にアップグレードする"></a>解決策 1. 手動アップグレートを利用して AADC のバージョンを 1.1.750.0 以降にアップグレードする</h3><p>バージョン 1.1.750.0 以降の AADC では、本問題が修正されています。執筆時 (2018/4/23 時点) は、バージョン 1.1.750.0 以降の AADC がダウンロードページに掲載されていますので、こちらをダウンロードします。</p>
<p>Microsoft Azure Active Directory Connect<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=47594" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=47594</a></p>
<p>AADC サーバー上でダウンロードしたインストーラー (.msi) を起動し、手動でアップグレードを行います。</p>
<h3 id="解決策-2-Powershell-スクリプトを利用してレジストリの値を修正する"><a href="#解決策-2-Powershell-スクリプトを利用してレジストリの値を修正する" class="headerlink" title="解決策 2. Powershell スクリプトを利用してレジストリの値を修正する"></a>解決策 2. Powershell スクリプトを利用してレジストリの値を修正する</h3><p>弊社が提供している下記スクリプトを利用することで、該当のレジストリ値の修正を含めて一括して問題箇所を修正することが可能です。</p>
<p>AAD Connect - Repair AutoUpgrade Suspended state<br><a href="https://gallery.technet.microsoft.com/AAD-connect-Repair-f4a2094a" target="_blank" rel="noopener">https://gallery.technet.microsoft.com/AAD-connect-Repair-f4a2094a</a> </p>
<p>なお、このスクリプトの処理内容は対象レジストリ値と自動アップグレードの有効 (Enabled,Suspended) /無効 (Disabled) をチェックし、前述の2つの条件を満たす構成だった場合に、レジストリを修正して AADC の Health Sync Monitor サービスを再起動しています。<br>※ディレクトリ同期を行う本体サービスの再起動を行っているわけではないので、同期処理への影響はありません。</p>
<blockquote>
<p>(補足)<br>AADC のバージョン情報を纏める公開資料では、“Set-ADSyncAutoUpgrade -AutoupGradeState Enabled” コマンドを案内していますが、当該手順を実行後に AADC サーバーの Health Sync Monitor サービスを再起動する必要があります。<br>そのため、これらを一括して実行できる上述スクリプトを利用することを推奨しています。</p>
</blockquote>
<p>Azure AD Connect: バージョンのリリース履歴<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/connect/active-directory-aadconnect-version-history" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/connect/active-directory-aadconnect-version-history</a></p>
<img src="/blog/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/2_caution.png">
<h2 id="管理者への通知"><a href="#管理者への通知" class="headerlink" title="管理者への通知"></a>管理者への通知</h2><p>テナントの管理者に対しては、Azure AD Connect のアップグレード機能に問題があり、最新版へ手動アップグレードすることを促すメールが通知されます。<br>本メールを受け取った管理者は、本ブログに記載された [対象の確認方法] を参照し、現在の AADC 設定を確認いただきますようお願いいたします。</p>
<p>※送信元 : AAD Notification [<a href="mailto:aad-notification-noreply@azureemail.microsoft.com" target="_blank" rel="noopener">aad-notification-noreply@azureemail.microsoft.com</a>]</p>
 <img src="/blog/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/3_adminnotification1.png">
<p> <strong>2017/6/8 追記</strong></p>
<p> 「本件問題事象が解消していない可能性のあるテナント」 の管理者様には、下記内容で追加のメールが送付されております。</p>
<img src="/blog/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/4_adminnotification2.png">
<h2 id="関連情報"><a href="#関連情報" class="headerlink" title="関連情報"></a>関連情報</h2><p>自動アップグレードに関しては、当チームによる以下 Blog もぜひ併せてご参照ください。</p>
<p>Azure AD Connect ビルド 1.1.749.0 の注意点<br><a href="https://blogs.technet.microsoft.com/jpazureid/2018/02/26/azure-ad-connect-117490/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpazureid/2018/02/26/azure-ad-connect-117490/</a></p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>Q1. バージョン 1.1.524.0 以降 1.1.750.0 未満の AADC (1.1.749.0 など) を利用していますが、アップグレードが実施できているように見受けられます。対処が必要ですか？</p>
<p>A1. 冒頭の [対象の確認方法] に記載された条件に合致している、且つ自動アップグレードを実施したい場合には対処が必要です。<br>もし条件に合致している場合、ご利用中の AADC では 「自動アップグレード」 ではなく、「手動アップグレード (インプレースアップグレード)」 が行われていることが考えられます。<br>自動アップグレード機能を利用するためには本ブログに記載された解決策を実施してください。</p>
<p>Q2. バージョン 1.1.524.0 以降 1.1.750.0 未満の AADC (1.1.749.0 など) を利用していますが、問題の バージョン 1.1.524.0 を経由せずに本バージョン (1.1.749.0 など) を利用しています。対処が必要ですか？</p>
<p>A2. いいえ。バージョン 1.1.524.0 を一度でもインストールしていない環境 (1.1.524.0 からインプレイスアップグレードをしていない環境) では、本問題について考慮する必要はありません。</p>
<h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>その他、ご不明な点等がありましたら、ぜひ弊社サポート サービスをご利用ください。<br>※本情報の内容（リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/04/23/azure-active-directory-connect/auto-upgrade-issue/" data-id="cjth4scbg0028hgytkdgc4joe" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AAD-Connect/">AAD Connect</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-Sync/">AD Sync</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/password-sprey-attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/03/19/azure-active-directory/password-sprey-attack/" class="article-date">
  <time datetime="2018-03-18T15:00:00.000Z" itemprop="datePublished">2018-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/03/19/azure-active-directory/password-sprey-attack/">Azure AD と AD FS のベスト プラクティス - パスワード スプレー攻撃の防御</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure Identity サポートの宮林と高田です。</p>
<p>本記事は、米国時間 2018 年 3 月 5 日に公開された <a href="https://cloudblogs.microsoft.com/enterprisemobility/2018/03/05/azure-ad-and-adfs-best-practices-defending-against-password-spray-attacks/" target="_blank" rel="noopener">Azure AD and ADFS best practices: Defending against password spray attacks</a> の抄訳です。Azure AD と AD FS に関してパスワードスプレー攻撃を取り上げた情報がまとめられており、日本のサポート チームとして皆様にぜひ内容を共有したく日本語化しました。</p>
<hr>
<p>皆さんこんにちは。<br>パスワードを用いたログインを採用している限り、第三者がそれを推測しようとすることは避けられません。このブログでは、最近非常に頻繁に行われるようになった <strong>パスワード スプレー</strong> と呼ばれる攻撃手法と、それに対する防衛のためのベスト プラクティスについて説明します。</p>
<p>パスワード スプレー攻撃では、攻撃者が多くの人が設定するような一般的なパスワードで、複数の異なるアカウントに対してログインを試行することで、パスワードで保護されたリソースにアクセスを試みます。 通常、これらは 1 つの組織や 1 つの認証基盤に留まることなく行われます。例えば、攻撃者は <a href="https://www.blackhillsinfosec.com/introducing-mailsniper-a-tool-for-searching-every-users-email-for-sensitive-data/" target="_blank" rel="noopener">Mailsniper</a> などの一般にも入手可能なツールを用いて、複数の組織の全てのユーザーを列挙し、それらのアカウントすべてに対して “P@$$w0rd” や “Password1” などのパスワードを試します。</p>
<p>攻撃のイメージとしては、以下のようなものが挙げられます。</p>
<table>
<thead>
<tr>
<th>Target User</th>
<th>Target Password</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="mailto:User1@org1.com" target="_blank" rel="noopener">User1@org1.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td><a href="mailto:User2@org1.com" target="_blank" rel="noopener">User2@org1.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td><a href="mailto:User1@org2.com" target="_blank" rel="noopener">User1@org2.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td><a href="mailto:User2@org2.com" target="_blank" rel="noopener">User2@org2.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td><a href="mailto:User1@org1.com" target="_blank" rel="noopener">User1@org1.com</a></td>
<td>P@$$w0rd</td>
</tr>
<tr>
<td><a href="mailto:User2@org1.com" target="_blank" rel="noopener">User2@org1.com</a></td>
<td>P@$$w0rd</td>
</tr>
<tr>
<td><a href="mailto:User1@org2.com" target="_blank" rel="noopener">User1@org2.com</a></td>
<td>P@$$w0rd</td>
</tr>
<tr>
<td><a href="mailto:User2@org2.com" target="_blank" rel="noopener">User2@org2.com</a></td>
<td>P@$$w0rd</td>
</tr>
</tbody>
</table>
<p>この攻撃パターンは、個々のユーザーまたは企業から見ると、それぞれが別々のログイン失敗のように見えるため、ほとんどの検出手法 (例えばロックアウトなどの設定) をすり抜けてしまいます。</p>
<p>攻撃者にとっては数字を当てるナンバーズの宝くじのようなもので、攻撃者はよく当たりそうな最も一般的なパスワードをいくつも知っています。これらの最も一般的なパスワードを使用しているアカウントは全体の 0.5 〜 1.0％ 程度ですが、1000 個ほどアカウントがあれば、数個は攻撃が成功するため十分効果的です。</p>
<p>攻撃者は、ログインが成功したアカウントを使用して電子メールからデータを取得し、連絡先情報を収集したり、フィッシングのリンクを送信したり、さらにパスワード スプレーの標的を広げようとします。 攻撃者は、最初の標的が誰であるかについては気にせず、最初の成功をきっかけにその後どれだけ攻撃を広げられるか試していきます。</p>
<p>幸いなことに、マイクロソフトではこの攻撃に対するツールを実装および公開済みです。さらに、近いうちに多くのツールがリリースされる予定です。 パスワード スプレー攻撃への対策のために現在および今後数ヶ月の間に何ができるのかについて以下をご覧ください。</p>
<h2 id="パスワードスプレー攻撃を困難にする４つの簡単なステップ"><a href="#パスワードスプレー攻撃を困難にする４つの簡単なステップ" class="headerlink" title="パスワードスプレー攻撃を困難にする４つの簡単なステップ"></a>パスワードスプレー攻撃を困難にする４つの簡単なステップ</h2><h3 id="Step-1-クラウド認証の利用"><a href="#Step-1-クラウド認証の利用" class="headerlink" title="Step 1: クラウド認証の利用"></a>Step 1: クラウド認証の利用</h3><p>クラウド環境では、マイクロソフトが提供するシステムへのサインインが毎日何十億も行われています。 マイクロソフトのセキュリティ検出アルゴリズムにより、攻撃の検出とブロックを瞬時に行います。 これらはクラウドによるリアルタイム検出と保護システムによるもので、クラウド上で Azure AD 認証を行う場合（<a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication" target="_blank" rel="noopener">パススルー認証</a> を含む）にのみ使用できます。</p>
<h4 id="スマート-ロックアウト"><a href="#スマート-ロックアウト" class="headerlink" title="スマート ロックアウト"></a>スマート ロックアウト</h4><p>クラウドでは、スマート ロックアウトを使用して、正当と思われるユーザーからのサインイン試行と攻撃者と思われるユーザーからのサインイン試行を区別します。正当なユーザーがアカウントを使用できるようにしながら、攻撃者をロックアウトすることができます。これにより、ユーザーへのサービス拒否が防止され、繰り返しのパスワードスプレー攻撃が阻止されます。 これは、Azure AD に対してのすべてのサインイン、 Microsoft アカウントを利用したすべてのサインインについてライセンスのレベルによらず対象とします。</p>
<p>Active Directory Federation Services (AD FS) をご利用のテナントでは、2018 年 3 月に、Windows Server 2016 の AD FS でスマート ロックアウトを利用可能となります。Windows Update による提供をお待ちください。</p>
<h4 id="IP-ロックアウト"><a href="#IP-ロックアウト" class="headerlink" title="IP ロックアウト"></a>IP ロックアウト</h4><p>IP ロックアウトは、数十億のサインインを分析して、マイクロソフトのシステムにアクセスを試みる各 IP アドレスからのトラフィックの性質を評価する仕組みです。分析により、IP ロックアウトは悪意を持って動作する IP アドレスを見つけ、そのサインインをリアルタイムでブロックします。</p>
<h4 id="攻撃のシミュレーション"><a href="#攻撃のシミュレーション" class="headerlink" title="攻撃のシミュレーション"></a>攻撃のシミュレーション</h4><p><a href="https://techcommunity.microsoft.com/t5/Security-Privacy-and-Compliance/Announcing-the-Public-Preview-of-Attack-Simulator-for-Office-365/ba-p/162412" target="_blank" rel="noopener">現在公開中のプレビュー機能</a> ですが、Office 365 Threat Intelligence では攻撃シミュレーターの機能を利用いただけます。これにより、自らのシステムに対して攻撃のシミュ―レーションを行うことができます。その結果をもとにセキュリティ ポリシーを更新することや、パスワード スプレー攻撃のような脅威から組織を守るために適切なツールを社内に準備しておくこともできます。</p>
<img src="/blog/2018/03/19/azure-active-directory/password-sprey-attack/fig1-attack-simulator.jpg">
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>クラウド認証を使用する (すでに利用中の場合は問題ありません)</li>
<li>AD FS などのハイブリッド シナリオを使用している場合は、2018 年 3 月のスマート ロックアウトのための AD FS アップグレードを検討する</li>
<li><a href="https://techcommunity.microsoft.com/t5/Security-Privacy-and-Compliance/Announcing-the-Public-Preview-of-Attack-Simulator-for-Office-365/ba-p/162412" target="_blank" rel="noopener">攻撃のシミュレーター</a> を使用し、セキュリティの体制を評価し必要な対策を実施する</li>
</ol>
<h3 id="Step-2-多要素認証の使用"><a href="#Step-2-多要素認証の使用" class="headerlink" title="Step 2: 多要素認証の使用"></a>Step 2: 多要素認証の使用</h3><p>パスワードはアカウントにアクセスするための鍵となる情報であり攻撃者はパスワード スプレー攻撃を利用することで正しいパスワードを入手しようとします。これを止めるには、アカウント所有者と攻撃者を区別するためにパスワード以外のものを用意する必要があります。これを行う 3 つの方法は以下の通りです。</p>
<h4 id="リスク-ベースの多要素認証"><a href="#リスク-ベースの多要素認証" class="headerlink" title="リスク ベースの多要素認証"></a>リスク ベースの多要素認証</h4><p>Azure AD Identity Protection は、サインイン データを使用し、高度な機械学習と検出アルゴリズムを駆使して、システムに来るすべてのサインインのリスク スコアを算出します。 これにより、企業での Azure AD 利用者は Identity Protection にポリシーを作成して、ユーザーまたはセッションに対してリスクが検出された場合にのみ、ユーザーに追加での認証を促すことができます。これでユーザーの負担を軽減しつつも、攻撃者をブロックすることができます。<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-identityprotection" target="_blank" rel="noopener">Azure AD Identity Protection の詳細はこちら</a> をご覧ください。</p>
<img src="/blog/2018/03/19/azure-active-directory/password-sprey-attack/fig2-risk-based-mfa.jpg">
<h4 id="多要素認証の強制"><a href="#多要素認証の強制" class="headerlink" title="多要素認証の強制"></a>多要素認証の強制</h4><p>さらにセキュリティを強化するため、Azure MFA を使用して、クラウド認証と AD FS の両方で、常にユーザーに対して多要素認証を要求することができます。 これにより、エンドユーザーは常にデバイスを携行し、多要素認証を頻繁に実行する必要がありますが、エンタープライズ環境で最も高いセキュリティが得られます。組織内のすべての管理者で MFA を有効にすることを推奨します。詳細については、<a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication" target="_blank" rel="noopener">Azure 多要素認証の詳細</a>、および <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa" target="_blank" rel="noopener">AD FS 用の Azure MFA の設定方法</a> をご覧ください。</p>
<h4 id="Azure-MFA-をプライマリな認証方法とする"><a href="#Azure-MFA-をプライマリな認証方法とする" class="headerlink" title="Azure MFA をプライマリな認証方法とする"></a>Azure MFA をプライマリな認証方法とする</h4><p>AD FS 2016 では、<a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa" target="_blank" rel="noopener">パスワードなしの認証として Azure MFA をプライマリ認証で使用</a> できます。パスワードを使用しなければ、攻撃者は推測できなくなりますので、パスワード スプレーおよびパスワードの窃取攻撃を防ぐ優れた方法になります。また、様々なタイプのデバイスにも最適です。さらに、Azure MFA で OTP (One Time Password) を検証した後にのみ、パスワードを 2 番目の要素として使用できるようになりました。詳細は <a href="https://github.com/Microsoft/adfsAuthAdapters" target="_blank" rel="noopener">第 2 の要素としてパスワードを使用する方法</a> をご覧ください。</p>
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>組織内のすべての管理者、特にサブスクリプション所有者とテナント管理者に対して、常に多要素認証を有効にすることを強くお勧めします。まだの場合は今すぐに設定ください。</li>
<li>一般のユーザーにとって最高のエクスペリエンスを得るため、Azure AD Premium P2ライセンスで利用可能なリスクベースの多要素認証を検討する。</li>
<li>それ以外の場合は、クラウド認証と AD FS に Azure MFA を使用する。</li>
<li>AD FS では、Windows Server 2016 の AD FS にアップグレードし、特にすべてのエクストラネットアクセスに対して Azure MFA をプライマリ認証として使用する。</li>
</ol>
<h3 id="Step-3-より安全なパスワードの使用"><a href="#Step-3-より安全なパスワードの使用" class="headerlink" title="Step 3: より安全なパスワードの使用"></a>Step 3: より安全なパスワードの使用</h3><p>上記のすべての対策を行った場合でも、パスワード スプレー対策で重要なのは、すべてのユーザーが推測の難しいパスワードを使用することです。 ユーザーが作成したパスワードが推測困難かどうか、自分で判断することは容易ではありません。マイクロソフトでは、安全性の高いパスワードを作るため以下のようなツールを提供しています。</p>
<h4 id="禁止パスワード"><a href="#禁止パスワード" class="headerlink" title="禁止パスワード"></a>禁止パスワード</h4><p>Azure AD では、すべてのパスワードの変更とリセット時に禁止パスワードのチェックが行われます。 新しいパスワードが送信されると、パスワードに含めるべきではない単語のリストと曖昧さを考慮してマッチングされます (また、綴りを記号で置き換える leetspeak -&gt; l33t-sp3@k のようなものもチェックされます)。マッチングされると拒否され、ユーザーは推測することが難しいパスワードにするよう求められます。 マイクロソフトでは最もよく攻撃されるパスワードのリストを作成し、頻繁に更新しています。</p>
<img src="/blog/2018/03/19/azure-active-directory/password-sprey-attack/fig3-banned-password.jpg">
<h4 id="禁止パスワードのカスタマイズ"><a href="#禁止パスワードのカスタマイズ" class="headerlink" title="禁止パスワードのカスタマイズ"></a>禁止パスワードのカスタマイズ</h4><p>禁止パスワードをより効果のあるものにするため、テナントで <strong>禁止パスワードのリストをカスタマイズ</strong> できるようにする予定です。管理者は、有名な社員や創業者、製品、場所、地域の名物など、組織で共有される言葉を選択し、ユーザーのパスワードへの使用を制限することができます。 このリストはマイクロソフトが用意している一覧に加えて強制されるので、どちらかを選択する必要はありません。 現在は限定プレビュー版ですが、今年中に公開予定です。</p>
<h4 id="オンプレミス環境における禁止パスワード"><a href="#オンプレミス環境における禁止パスワード" class="headerlink" title="オンプレミス環境における禁止パスワード"></a>オンプレミス環境における禁止パスワード</h4><p>今春、マイクロソフトはハイブリッドな <strong>Azure AD - Active Directory 環境でエンタープライズ管理者が禁止パスワードの設定を行う</strong> ためのツールをリリースします。 禁止されたパスワード リストは、クラウドからオンプレミス環境に同期され、エージェントがインストールされたすべてのドメイン コントローラーに適用されます。これにより、管理者は、ユーザーがクラウドもしくはオンプレミスのどちらでも自分のパスワードを変更する場所に関係なく、ユーザーのパスワードを推測困難にすることができます。 2018 年 2 月に限定プレビューが開始され、今年中に公開予定です。</p>
<h4 id="パスワードに関するとらえ方を変える"><a href="#パスワードに関するとらえ方を変える" class="headerlink" title="パスワードに関するとらえ方を変える"></a>パスワードに関するとらえ方を変える</h4><p>良いパスワードとはどういうものかというこれまでの一般的な考え方の多くが実は間違っています。数学的に正しいことでも、実は予測しやすいユーザー行動を招くことがわかっています。例えば、ある文字種別をパスワードに要求したり、定期的なパスワードの変更を要求したりすると、特定のパスワード パターンが発生することがわかっています。詳細については、<a href="https://aka.ms/passwordguidance" target="_blank" rel="noopener">パスワード ガイダンス ホワイト ペーパー</a> をお読みください。PTA (Pass-Through Authentication) または AD FS で Active Directory を使用している場合は、<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc770842(v=ws.10" target="_blank" rel="noopener">パスワード ポリシー</a>) を更新ください。クラウドのマネージド アカウントを使用している場合は、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-passwords-policy" target="_blank" rel="noopener">パスワードを無期限に設定する</a> ことを検討ください。</p>
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>禁止パスワードツールがリリースされたら、ユーザーがより良いパスワードを作成できるように、オンプレミスの環境にインストールする。</li>
<li>パスワード ポリシーを確認し、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-passwords-policy" target="_blank" rel="noopener">パスワードを無期限に設定</a> して、ユーザーが周期的なパターンを使用してパスワードを作成しないようにします。</li>
</ol>
<h3 id="Step-4-AD-FS-と-Active-Directory-についてのさらなる新機能"><a href="#Step-4-AD-FS-と-Active-Directory-についてのさらなる新機能" class="headerlink" title="Step 4: AD FS と Active Directory についてのさらなる新機能"></a>Step 4: AD FS と Active Directory についてのさらなる新機能</h3><p>AD FS と Active Directory とのハイブリッド認証を使用している場合は、パスワード スプレー攻撃からご利用の環境を保護するためにとれる対策がさらにあります。</p>
<p>まず、AD FS 2.0 または Windows Server 2012 をご利用の組織では、できるだけ早く Windows Server 2016 の AD FS への移行を検討ください。最新バージョンは、外部ネットワークのロックアウト (Extranet lockout) など、より豊富な機能があり、より頻繁にアップデートが提供されます。なお、Windows Server 2012 R2 からであれば 2016 へのアップグレードは非常に簡単です。</p>
<h4 id="外部ネットワークからのレガシー認証のブロック"><a href="#外部ネットワークからのレガシー認証のブロック" class="headerlink" title="外部ネットワークからのレガシー認証のブロック"></a>外部ネットワークからのレガシー認証のブロック</h4><p>レガシー認証のプロトコルには多要素認証を強制する機能がないため、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-conditional-access-no-modern-authentication" target="_blank" rel="noopener">外部ネットワークからレガシー認証でのアクセスをブロックする</a> のが最善の方法です。これにより、MFA を利用できないプロトコル上の穴をついてパスワード スプレー攻撃を仕掛けてくることを防ぐことができます。</p>
<h4 id="AD-FS-Web-アプリケーション-プロキシでの-Extranet-Lockout-機能の有効化"><a href="#AD-FS-Web-アプリケーション-プロキシでの-Extranet-Lockout-機能の有効化" class="headerlink" title="AD FS Web アプリケーション プロキシでの Extranet Lockout 機能の有効化"></a>AD FS Web アプリケーション プロキシでの Extranet Lockout 機能の有効化</h4><p>AD FS Web アプリケーションプロキシで Extranet Lockout 機能を実行していない場合は、<a href="https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-extranet-lockout" target="_blank" rel="noopener">可能な限り早く有効</a> にして、今後発生する可能性のあるブルートフォース攻撃からユーザーを保護ください。</p>
<h4 id="Azure-AD-Connect-Health-の展開"><a href="#Azure-AD-Connect-Health-の展開" class="headerlink" title="Azure AD Connect Health の展開"></a>Azure AD Connect Health の展開</h4><p>Azure AD Connect Health は、AD FS ログに記録された不正なユーザー名/パスワードによるログイン試行の IP アドレスを記録します。これにより様々なシナリオに関する追加情報を提供するとともに、サポートのお問い合わせを発行いただいた際にはサポート エンジニアに対して追加の知見を提供します。</p>
<p>展開するには、すべての AD FS サーバーに最新バージョンの <a href="https://go.microsoft.com/fwlink/?linkid=518973" target="_blank" rel="noopener">AD FS 用 Azure AD Connect Health Agent</a> をダウンロードします。AD FS サーバーは、<a href="https://support.microsoft.com/en-us/help/3134787/ad-fs-logs-don-t-contain-client-ip-address-for-account-lockout-scenarios-in-windows-server-2012-r2" target="_blank" rel="noopener">KB3134222</a> がインストールされた Windows Server 2012 R2 または Windows Server 2016 上で実行されている必要があります。</p>
<h4 id="非パスワード-ベースの認証方法の採用"><a href="#非パスワード-ベースの認証方法の採用" class="headerlink" title="非パスワード ベースの認証方法の採用"></a>非パスワード ベースの認証方法の採用</h4><p>パスワードがなければ、パスワードは推測されません。次のような非パスワード ベースの認証方法が、AD FS および Web アプリケーション プロキシで使用できます。</p>
<ol>
<li>証明書ベースの認証により、ユーザー名/パスワードの認証で利用するエンドポイントをファイアウォールで完全にブロックすることができます。証明書ベースの認証についての詳細は、<a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-user-certificate-authentication" target="_blank" rel="noopener">AD FS での証明書ベース認証</a> で確認ください。</li>
<li>Azure の多要素認証は、上述のとおり、クラウド認証と AD FS 2012 R2 および 2016 の第二要素として使用できますが、パスワード スプレーの可能性を完全に排除するために AD FS 2016 の第一要素としても使用できます。 <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa" target="_blank" rel="noopener">AD FS を使用して Azure MFA を設定する方法についてはこちら</a> をご覧ください。</li>
<li>Windows 10 のクライアント、Windows Server 2016 の AD FS で利用できる Windows Hello for Business は、ユーザーとデバイスの両方に紐付けられた強力な暗号化キーに基づいて、外部ネットワークも含めた完全な非パスワードベースの認証を可能にします。これは、Azure AD 参加および Hybrid Azure AD 参加している組織で管理されるデバイスに加え、設定アプリから「職場や学校のアカウントを追加」を介して登録したパーソナル デバイスでも利用できます。<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-azureadjoin-passport" target="_blank" rel="noopener">Windows Hello for Business の詳細についてはこちら</a> をご覧ください。</li>
</ol>
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>より迅速に製品の更新を得るため AD FS 2016 にアップグレードする。</li>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-conditional-access-no-modern-authentication" target="_blank" rel="noopener">外部ネットワーク</a> からレガシー認証をブロックする。</li>
<li>すべての AD FS サーバーに Azure AD Connect Health をインストールする。</li>
<li>Azure MFA、証明書ベースの認証、Windows Hello for Business などパスワードを使用しないプライマリの認証方式の利用をする。</li>
</ol>
<h2 id="おまけ-Microsoft-アカウントの保護について"><a href="#おまけ-Microsoft-アカウントの保護について" class="headerlink" title="おまけ: Microsoft アカウントの保護について"></a>おまけ: Microsoft アカウントの保護について</h2><p>Microsoft アカウントをご利用の場合:</p>
<ul>
<li>あなたはすでに保護されています！ Microsoft アカウントでは、Smart Lockout、IP ロックアウト、リスクベースの 2 ステップ認証、禁止パスワードなどが有効です。</li>
<li>ただし、2 分ほどお時間をとっていただき、Microsoft アカウントの<a href="https://account.microsoft.com/security" target="_blank" rel="noopener">セキュリティ ページ</a> に移動して、「セキュリティ情報を更新する」を選択し、リスクベースの 2 段階認証に使用するセキュリティ情報を確認ください。</li>
<li>アカウントのセキュリティを最大限に高めるため、<a href="https://account.live.com/proofs/Manage/additional" target="_blank" rel="noopener">こちら</a> から常に 2 段階認証をオンにすることを検討ください。</li>
</ul>
<h2 id="最良の防衛策は…-このブログの推奨事項に従うこと"><a href="#最良の防衛策は…-このブログの推奨事項に従うこと" class="headerlink" title="最良の防衛策は… このブログの推奨事項に従うこと"></a>最良の防衛策は… このブログの推奨事項に従うこと</h2><p>パスワード スプレーは、インターネット上でパスワードを使用するすべてのサービスにとって深刻な脅威です。しかし、今回のブログの手順を実行することで、パスワードスプレーに対する最大限の対策を行えます。そして、多くの種類の攻撃が共通の特性を有しているため、今回説明した手法は他の脅威に対しても効果的です。お客様のセキュリティは常にマイクロソフトの最優先事項であり、パスワードスプレーなどあらゆるタイプの攻撃に対して、より新しく高度な防御策を開発するために絶えず尽力しています。 今回紹介した対策方法を利用し、インターネット上の攻撃者からサービスやシステムを守るため、新しい対処策を頻繁にチェックいただければと思います。</p>
<p>この情報がお役に立てば幸いです。いつものように、私たちは皆さんのご意見やご提案をお待ちしています。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/03/19/azure-active-directory/password-sprey-attack/" data-id="cjth4scbx002shgyt29vw12zg" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/MFA/">MFA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Smart-lockout/">Smart lockout</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/azure-ad-purchase" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/02/28/azure-active-directory/azure-ad-purchase/" class="article-date">
  <time datetime="2018-02-27T15:00:00.000Z" itemprop="datePublished">2018-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/02/28/azure-active-directory/azure-ad-purchase/">Azure AD 有償ライセンスの購入方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Azure-AD-有償ライセンスの購入方法"><a href="#Azure-AD-有償ライセンスの購入方法" class="headerlink" title="Azure AD 有償ライセンスの購入方法"></a>Azure AD 有償ライセンスの購入方法</h3><p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は、Azure AD 有償ライセンスの購入方法についてご案内します。</p>
<p>Azure AD は、Azure サブスクリプションや Office 365 をご利用いただく際の認証基盤として、無償で提供されます。</p>
<p>一方で Azure AD の有償ライセンスも用意されており、こちらを購入することで、様々な追加機能をご利用いただけます。</p>
<p>各ライセンスの機能差異についての詳細は、リンクをご参照ください。</p>
<p>基本的にはライセンスはその機能を利用するユーザーに割り当てる必要があるのですが、各機能における必要なライセンス数などは別途それぞれの機能の公開情報などをご確認ください。</p>
<h2 id="有償ライセンスの購入方法について"><a href="#有償ライセンスの購入方法について" class="headerlink" title="有償ライセンスの購入方法について"></a>有償ライセンスの購入方法について</h2><p>オンラインから購入する場合は、Office 365 ポータルより購入の手続きを実施します。</p>
<p>※もし、販売元のパートナー様を介する場合などオンライン以外から購入予定の場合は、その販売元や場合によっては弊社営業などにご確認ください。</p>
<p>「Office 365 は利用していない」というお客様もいらっしゃるかと思いますが、Azure のサブスクリプションを契約している、そうすると必ず Azure AD を利用していることになるのですが、この場合管理者のアカウントで Office 365 ポータルにログインすることができます。</p>
<p>こちらは、Office 365 の認証基盤も Azure と同じく Azure AD を利用しているためであり、Azure AD のライセンスの体系が Office 365 のライセンスと同様に Azure のサブスクリプションとは異なり、 Azure AD テナントに割り当たる体系になるためこのような実装になっています。</p>
<p>もちろんOffice 365 ポータルにログインできるからといって Office 365 のライセンスをお持ちでない場合は Office 365 の各種サービスは利用できません。また、勝手に Office 365 の契約がされてしまうこともありません。</p>
<p>Office 365 や Azure サブスクリプション、Azure AD についての説明は、別途リンクの内容もご参照ください。</p>
<p>それでは、購入方法についてご紹介します。</p>
<p>&lt;手順&gt;</p>
<p>Office 365 ポータルに、Azure AD の全体管理者ユーザーでサインインします。<br>管理センターの画面で、左側のメニューから[課金情報] - [サービスを購入する]を選択します。<br>サービスを購入する の画面が表示されたところで、該当のライセンスを探します。<br>[今すぐ購入します]を選択します<br>必要なユーザー数を選択いただき、[今すぐ支払う]を選択し、購入を進めます。(クレジット カードの情報などを入力します)</p>
<p>手順については以上となります。</p>
<h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p>Q. 費用は Azure のサブスクリプションの費用に加算されますか？</p>
<p>A. いいえ、Azure AD のライセンスと Azure サブスクリプションは別の契約形態になります。</p>
<p>そのため、Azure サブスクリプションで利用している残高で、Azure AD のライセンス料金を支払うことはできません。</p>
<p>Q. Office 365 ポータルにログインして、ライセンスが購入可能なユーザーの詳細を教えてください。</p>
<p>A. 職場または学校アカウント (組織アカウント) であり、Azure AD の全体管理者もしくは課金管理者である必要があります。</p>
<p>Microsoft アカウント (個人アカウント) では、Office 365 ポータルにログインすることはできません。</p>
<p>また、招待された組織ユーザーでも Office 365 ポータルには、招待元のアカウントとしてサインインするため、ここでライセンスの購入を実施すると、意図せずに招待元に紐づくため、 Office 365 ポータルに入った後に意図している Azure AD に接続しているか、ユーザー一覧などを確認の上、作業を実施することをお勧めいたします。</p>
<p>Q. ライセンスの割り当ては、Office 365 ポータルと Azure ポータルのどちらで可能か。</p>
<p>A. 購入したライセンスは、どちらのポータルでも参照でき、割り当てもどちらからも実施可能です。</p>
<p>▼ Azure ポータルより</p>
<p>Azure ポータル にアクセスします。<br>[Azure Active Directory] にアクセスします。<br>[ライセンス] を選択します。<br>[すべての製品] を選択します。<br>購入した ライセンスを選択します。<br>[ライセンスされているユーザー] に [割り当て] を選択して割り当てます。<br>※事前にユーザー プロファイルより、「利用場所」を設定する必要があります。設定していない場合はライセンスの割り当てに失敗します。</p>
<p>▼ Office 365 ポータルより</p>
<p>Office 365 ポータルに、管理者ユーザーでサインインします。<br>管理センターの画面で、「ユーザー」を選択します。<br>ライセンスを付与したいユーザーを選択します。<br>「製品ライセンス」の部分の編集を選択し、購入したライセンスを割り当てます。</p>
<p>Q. ライセンスの利用場所とはなんですか？</p>
<p>A. そのユーザーがライセンスを使用する地域を設定します。</p>
<p>Office 365 のサービスと機能を使用できるかどうかは、国または地域によって異なるため利用場所の選択が必要です。</p>
<p>Q. ライセンスは1 個単位で月ベースで購入可能か。</p>
<p>A. オンラインからの購入であれば、1個単位で購入が可能です。</p>
<p>期間は年間契約 (年支払い or 月々の支払) になりますので、月単位での購入はできません。</p>
<p>試用版も用意していますので、短期間の場合は、まず試用版をお試しください。</p>
<p>試用版ライセンスのご案内<br>&lt;手順&gt;</p>
<p>Azure ポータルにアクセスします。<br>[Azure Active Directory] にアクセスします。<br>[ライセンス] を選択します。<br>[すべての製品] を選択します。<br>[試用/購入] を選択します。<br>AZURE AD PREMIUM P2 の選択肢が表示されますので [無料試用版] を選択します。<br>30 日間利用いただけますので、[アクティブ化] を選択します。</p>
<p>こちらで、30 日間無料で、Azure AD Premium P2 ライセンスの機能を試すことができます。</p>
<p>なお、30 日間経過後に自動で有償ライセンスに移行するといった動作はありませんのでその点ご安心ください。</p>
<p>一度試用版の有効期限が経過すると、再度試用を有効にすることはできません。</p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/02/28/azure-active-directory/azure-ad-purchase/" data-id="cjth4sc9w0008hgythvpxm5du" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-License/">Azure AD License</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-active-directory-federation-service/claim-rule-conditional-access" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/01/30/active-directory-federation-service/claim-rule-conditional-access/" class="article-date">
  <time datetime="2018-01-29T15:00:00.000Z" itemprop="datePublished">2018-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/01/30/active-directory-federation-service/claim-rule-conditional-access/">クレーム ルールと条件付きアクセスの比較</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>クレーム ルールと条件付きアクセスは、両者ともに指定した条件に応じて認証アクセスの制御を行うことができます。例えば、多要素認証を発生させるための条件設定は、クレーム ルールでも条件付きアクセスでも可能です。</p>
<p>それぞれを利用する際に必要な前提条件は次のとおりです。</p>
<ul>
<li><p>クレーム ルール</p>
<p>  AD FS 環境が必須です。AD FS を利用した認証フローとなるため、認証についてはオンプレミス側で行います。</p>
</li>
<li><p>条件付きアクセス</p>
<p>  Azure AD 環境が必須です。また、条件付きアクセスの利用には、利用するユーザー分 Azure AD Premium のライセンスが必要です。AD FS が導入されている環境においても、条件付きアクセスを利用することが可能です。</p>
</li>
</ul>
<h2 id="コスト比較"><a href="#コスト比較" class="headerlink" title="コスト比較"></a>コスト比較</h2><p>まずは、重要となるコスト面について比較してみましょう。</p>
<ul>
<li><p>クレーム ルール</p>
<p>  AD FS 環境が必須となりますが、すでに AD FS を導入済みの環境の場合は、クレーム ルール設定のための追加コストは不要です。ただ、クレーム ルール自体は少し書き方が特殊なのとメンテナンスが必要で、メンテナンスに要する人的なコストは考慮する必要があります。サポートでクレーム ルールをいただいてみたら、連携先が新しい認証方式に対応していてクレーム ルールが使われていなかったというケースもあります。</p>
</li>
<li><p>条件付きアクセス</p>
<p>  条件付きアクセスを利用するユーザー分の Azure AD Premium (P1 または P2) のライセンスが必要となります。例えば、Azure AD 内に 1000 人のユーザーを登録している環境で特定の 300 人に対して条件付きアクセスの制御を行いたい場合は、300 ライセンス必要となります。詳細な価格情報については、下記の情報を参照ください。</p>
<p>  Azure Active Directory の価格<br>  <a href="https://azure.microsoft.com/ja-jp/pricing/details/active-directory/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/pricing/details/active-directory/</a></p>
</li>
</ul>
<h2 id="機能比較"><a href="#機能比較" class="headerlink" title="機能比較"></a>機能比較</h2><p>続いて、検討材料のメインとなるであろう機能について比較してみましょう。</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">クレーム ルール</th>
<th style="text-align:center">条件付きアクセス</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADAL への対応</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>非　ADAL への対応</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td>アプリケーション毎の制御</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○ ※2</td>
</tr>
<tr>
<td>ユーザーやグループによる制御</td>
<td style="text-align:center">○</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>IP アドレス ベースでの制御</td>
<td style="text-align:center">○</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>OS の種類による制御</td>
<td style="text-align:center">△ ※3</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>多要素認証</td>
<td style="text-align:center">○ ※4</td>
<td style="text-align:center">○ ※5</td>
</tr>
<tr>
<td>Intune との連携</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>デバイス ベースの制御</td>
<td style="text-align:center">△ ※6</td>
<td style="text-align:center">○ ※7</td>
</tr>
<tr>
<td>GUI での設定</td>
<td style="text-align:center">○</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>コマンドラインでの設定</td>
<td style="text-align:center">○</td>
<td style="text-align:center">×</td>
</tr>
</tbody>
</table>
<p>※ 1: user-agent などによりアプリケーションの特定が可能なものもありますが、OS  やアプリケーションのバージョンによって変更される可能性があり、厳密な判別には十分な検証が必要です。また、ADAL を利用するアプリケーションは、 user-agent はブラウザと区別が付かず、アプリケーション固有のクレームでの判別が困難です。</p>
<p>※ 2: 利用可能なアプリケーションについては下記の情報を参照ください。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-conditional-access-technical-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-conditional-access-technical-reference</a></p>
<p>※ 3: 既定では、OS の情報は取得できないため、別途デバイス認証を追加設定する必要があります。</p>
<p>※ 4 ※ 5: AD FS の多要素認証としては、証明書認証を使用するのが一般的です。一方で、条件付きアクセス (Azure MFA) では、電話、テキストコード、モバイルアプリ (Authenticator) が使用可能です (証明書認証は不可)。それぞれ利用できる多要素認証の種類が異なるため、重要な検討材料になります。</p>
<p>※ 6 ※ 7: AD FS においては、証明書認証とデバイス認証の方法がありますが、証明書認証はモバイル端末への証明書の配布方法、デバイス認証は各種デバイスの対応状況に課題があります (例えば、Windows 10 は AD FS 3.0 のデバイス認証に対応していません)。</p>
<p>一方で、条件付きアクセスでは Windows 端末がドメイン参加していることを条件に制御することができます。また、Intune に登録済みのデバイスを準拠済みデバイスとして制御可能です。詳細については、<a href="https://blogs.technet.microsoft.com/jpazureid/2018/01/25/device_access/" target="_blank" rel="noopener">リンク</a> の記事もご参照ください。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>現時点においても、条件付きアクセスは細かな制御に対応してきており、かつ今後の機能拡張も期待できます。なお、条件付きアクセスに関するよくあるお問い合わせについてもご紹介しておりますので、参考になれば幸いです。</p>
<p>今回、機能についてはお問い合わせの多いものを抜粋してご紹介させていただきました。より、詳細な内容の確認やお客様のご要望に沿った制御方法についてのご質問については、ぜひ弊社サポートサービスをご利用ください。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/01/30/active-directory-federation-service/claim-rule-conditional-access/" data-id="cjth4sc9g0000hgyt6atpu5a4" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/device-based-access-control" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/01/25/azure-active-directory/device-based-access-control/" class="article-date">
  <time datetime="2018-01-24T15:00:00.000Z" itemprop="datePublished">2018-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/01/25/azure-active-directory/device-based-access-control/">デバイス ベースのアクセス制御</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの下野です。</p>
<p>今回は下記の 3 つについてご紹介します。</p>
<ol>
<li>AD FS による証明書認証</li>
<li>AD FS によるデバイス認証</li>
<li>Azure AD によるデバイスベースの条件付きアクセス</li>
</ol>
<p>昨今話題の働き方改革を実現する手段の一つとして、テレワークができる環境を整える - オフィス内で利用する端末だけでなく、会社支給の端末、モバイルデバイスなど多種多様なデバイスから企業のリソースにアクセスできるようにする - ということも有効だと思います。</p>
<img src="/blog/2018/01/25/azure-active-directory/device-based-access-control/access-o365-from-everywhere.png">
<p>それを検討する際に、管理者側で会社のリソースにアクセスできるデバイスを限定したいとのご要望をいただくことが多くあります。<br>そのような要望の実現を検討する際に、今回ご紹介させていただく内容が少しでもお役に立ちましたら幸いです。</p>
<p>ではまずは、それぞれの制御方法を説明します。</p>
<h2 id="1-AD-FS-による証明書認証"><a href="#1-AD-FS-による証明書認証" class="headerlink" title="1. AD FS による証明書認証"></a>1. AD FS による証明書認証</h2><p>Windows Server 2012 R2 (AD FS 3.0) 以降で利用可能となった、証明書を使用した認証方式です。ユーザー証明書を各デバイスに配布して、モダン認証 (ADAL)に対応している多くのアプリケーションで利用します。</p>
<p>証明書認証を構成した際に正常に動作しないというケースでは、主に下記のようなポイントをチェックします。</p>
<ul>
<li>証明書のサブジェクト代替名にユーザーの UPN が正しくセットされているか</li>
<li>AD FS (または WAP) が信頼している証明機関から発行された証明書かどうか</li>
<li>証明書の有効期限が切れていないかどうか</li>
<li>証明書が、失効されていないかどうか</li>
</ul>
<p>証明書認証を利用できるクライアント端末は次のとおりです。</p>
<p><strong>対象 OS</strong>: Windows 7, Windows 8.1, Windows 10 ,MAC OS ,iOS ,Android</p>
<p>※ ブラウザではない Office クライアントなどを利用する場合、<a href="https://support.office.com/ja-jp/article/office-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%A7-office-365-%E5%85%88%E9%80%B2%E8%AA%8D%E8%A8%BC%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B-776c0036-66fd-41cb-8928-5495c0f9168a" target="_blank" rel="noopener">モダン認証 (ADAL)</a> が有効である必要があります。</p>
<p>※ iOS で証明書認証を利用する場合、Microsoft Authenticator をインストールする必要があります。</p>
<h2 id="2-AD-FS-によるデバイス認証"><a href="#2-AD-FS-によるデバイス認証" class="headerlink" title="2. AD FS によるデバイス認証"></a>2. AD FS によるデバイス認証</h2><p>AD FS でデバイス認証をおこなうことが可能ですが、これは実際のところ AD FS のクレーム ルールを利用して制御しています。デバイス認証を AD FS で有効にすると、クライアント端末固有の情報をクレームに含めるようになります。それを用いてトークンの発行を許可・拒否するルールを作成し、アクセスの制御を行います。</p>
<p>なお、デバイス認証もモダン認証 (ADAL) に対応している必要がありますが、モバイルのアプリケーションについては、デバイス認証に対応しておりません。</p>
<p>また、後述しますが、AD FS のデバイス認証を利用するためには、デバイスがオンプレミス AD に登録されている必要がございます。デバイス認証を構成し、それが正しく動作していないように見える場合には下記のようなポイントをチェックします。</p>
<ul>
<li>Workplace Join を行った際にサインインしていたユーザーで、そのクライアント端末にサインインしているか</li>
<li>そのユーザーの個人ストアにデバイス認証用の証明書が存在しているか</li>
<li>オンプレミス AD に対応するデバイス オブジェクトが存在しているか</li>
</ul>
<p>デバイス認証を利用できるクライアント端末は次の通りですが、AD FS のバージョンによって対象が異なるので注意が必要です。</p>
<p>&lt;<strong>Windows Server 2016 (AD FS 2016)</strong>&gt;<br>対象 OS: Windows 7, Windows 8.1, Windows 10 ,iOS ,Android</p>
<p>&lt;<strong>Windows Server 2012 R2 (AD FS 3.0)</strong>&gt;<br>対象 OS: Windows 7, Windows 8.1, iOS ,Android</p>
<h3 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h3><p>デバイス認証を行うためには前提条件として、オンプレミス AD へのデバイス オブジェクトの登録が必須となります。登録方法は大きく 2 つあり、その 2 つの方法によって対象 OS が異なります。</p>
<ul>
<li><p>方法 1: Azure AD に登録されたデバイスを書き戻す方法</p>
<p>  |方法|Azure AD に登録されたデバイス情報を Azure AD Connect を用いてオンプレミス AD に書き戻す|<br>  |—|—|<br>  |対象 OS|Windows 7, Windows 8.1, Windows10, iOS, Android|</p>
</li>
<li><p>方法 2: AD FS のDevice Registration Service (DRS) を利用する方法</p>
<p>  ※ 前提として Windows Server 2012 R2 を AD FS サーバーとして利用している (Windows Server 2016 は非対応)</p>
<p>  |方法|オンプレミス AD に AD FS の DRS を利用してデバイス情報を直接登録する|<br>  |—|—|<br>  |対象 OS|Windows 7, Windows 8.1, iOS|</p>
</li>
</ul>
<p>ここで、少し用語について整理します。</p>
<p>AD FS 2012 R2 は、Device Registration Service (DRS) の機能を有します。クライアントからのデバイス登録リクエスト（後述いたします、Workplace Join）を受け、そのクライアント端末に対応するデバイス オブジェクトをオンプレミス AD 内に登録する機能です。また、そのデバイス オブジェクトに紐づいた証明書をクライアントに配布致します。</p>
<p>Workplace Join とは、クライアントの機能/動作です。クライアントが DRS に対してデバイス オブジェクトの登録をリクエストする機能、またはその動作のことです。また、Workplace Join は、デバイス オブジェクトの登録に成功した際、DRS から配布された証明書を該当端末にインストールします。</p>
<p>AD FS 2012 R2 の DRS は、Windows 7、Windows 8.1、iOS 6 以降、Android 4.0 以降 の Workplace Join に対応しています。AD FS 2016 では、DRS の実装自体はありますが、サポートしていません。AD FS 2016 環境や、クライアントが Windows 10 の場合には、方法 1 の (Azure AD にデバイスを登録し、Azure AD Connect でオンプレミス AD に書き戻す) 必要がございます。</p>
<p>また、基本的にブラウザ アクセスに関しては問題ございませんが、Office クライアントなどのアプリケーションはデバイス認証に対応していません。ブラウザ以外のアプリケーションを利用する場合には、証明書認証や条件付きアクセスのご利用をご検討ください。</p>
<h2 id="3-Azure-AD-によるデバイスベースの条件付きアクセス"><a href="#3-Azure-AD-によるデバイスベースの条件付きアクセス" class="headerlink" title="3. Azure AD によるデバイスベースの条件付きアクセス"></a>3. Azure AD によるデバイスベースの条件付きアクセス</h2><p>Azure AD の「条件付きアクセス」を用いてデバイス ベースのアクセス制御を実装します。条件付きアクセスは、制御対象のアプリケーションがモダン認証 (ADAL) に対応している必要がありますが、簡単にご利用いただけます (ただし、Azure AD Premium のライセンスが必要な点についてはご注意ください)。</p>
<p>デバイスベースの条件付きアクセスを利用する前提条件として、制御対象のデバイスを以下いずれかのステータスで、Azure AD 上に登録する必要があります。これによりオンプレミスのドメインに参加している端末や Intune で管理されている端末を条件にアクセス制御が可能です。</p>
<table>
<thead>
<tr>
<th>デバイス登録時のステータス</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ドメイン参加済みデバイス</td>
<td>オンプレミスドメインに参加している端末である</td>
</tr>
<tr>
<td>準拠済みデバイス</td>
<td>Intune ポリシーにより準拠済みと判定された端末である</td>
</tr>
</tbody>
</table>
<p>ここで、少し用語について整理します。</p>
<p><strong>ドメイン参加済みデバイス</strong> とは、オンプレミス AD にドメイン参加しており、AD FS と Azure AD Connect を用いて Azure AD 上にデバイス登録した端末が該当します。実際の構成方法については、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup" target="_blank" rel="noopener">リンク</a> をご参照ください。</p>
<p><strong>準拠済みデバイス</strong> とは、Azure AD 上にデバイス登録した上で Intuneの MDM 管理を用いて Intune のコンプライアンス ポリシーの準拠した端末が該当します。</p>
<p>各種条件を考慮した、それぞれの制御対象 OS は下記になります。</p>
<table>
<thead>
<tr>
<th>OS の種類</th>
<th style="text-align:center">証明書認証</th>
<th style="text-align:center">AD FS デバイス認証</th>
<th style="text-align:center">条件付きアクセス</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows 7</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows 8.1</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows 10</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Mac OS</td>
<td style="text-align:center">○</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Android</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>iOS</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows Phone</td>
<td style="text-align:center">△ ※2</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
</tbody>
</table>
<p>※ 1: Windows 10 は 前述の通り AD FS 2016 が必要です。また、デバイスの登録方法は、 Azure AD に登録し、書き戻す必要があります。</p>
<p>※ 2: Windows Phone については iOS や Android では利用できる Skype for Business が先進認証に非対応などの制限があります。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>元々、証明書やデバイスによるアクセス制御は、AD FS を中心に行う必要がありました。<br>現在も証明書による認証をさせたい場合には AD FS が必要ですが、条件付きアクセスは日々機能が拡張されており、新しい機能も次々に追加されています。AD FS の構築、運用の費用と Azure AD Premium のライセンスの兼ね合いもありますが、今後の事も含め、条件付きアクセスを使用したデバイス制御も是非ご検討ください。</p>
<p>製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポートサービスをご利用ください。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/01/25/azure-active-directory/device-based-access-control/" data-id="cjth4scaw0020hgytzx2gw34c" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Intune/">Intune</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Workplace-Join/">Workplace Join</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/add-modify-delete-directory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/" class="article-date">
  <time datetime="2018-01-15T15:00:00.000Z" itemprop="datePublished">2018-01-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/">Azure AD の追加・変更・削除</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は下記の 3 つについて紹介します。</p>
<ul>
<li>Azure AD の追加手順</li>
<li>Azure AD の変更手順</li>
<li>Azure AD の削除手順</li>
</ul>
<p>まずは、簡単に Azure AD について説明します。</p>
<p>Azure AD とは、Azure や Office 365 などの Microsoft クラウド サービスに組織がサインアップしたときに作成されます (もう少し平易な言い方をすると、 Office 365 など Azure AD が必須のサービスの新規利用を開始した時点で自動的に作成されます)。Azure AD に所属しているユーザーは、その Azure AD に紐づいているクラウドサービスを利用することが可能です。</p>
<img src="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/user-access-o365-subscription.png">
<h2 id="Azure-AD-の追加手順"><a href="#Azure-AD-の追加手順" class="headerlink" title="Azure AD の追加手順"></a>Azure AD の追加手順</h2><p>冒頭で、クラウドサービスにサインアップした際に作成されると書きましたが、Azure AD を個別に追加することも可能です。下記の手順で、Azure AD Free (無料) を作成できます</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>表示された画面の右下より  [ディレクトリの作成] をクリックします</li>
<li><p>[ディレクトリの作成] 画面の下記の項目に入力します</p>
<ul>
<li>組織名：任意の組織名を入力</li>
<li>初期ドメイン名：&lt;組織&gt;のドメイン名を入力</li>
<li>“国/リージョン” を選択</li>
</ul>
</li>
<li><p>[作成] をクリックします</p>
</li>
<li>作成が完了すると、”新しいディレクトリを管理するにはここをクリックします” が表示するので、クリックします</li>
<li>新しく作成したディレクトリの画面に切り替わります</li>
</ol>
<p>作成操作を行ったユーザーが新しく作成した Azure AD ディレクトリ (テナント) の管理者となります。</p>
<h2 id="Azure-AD-の変更手順"><a href="#Azure-AD-の変更手順" class="headerlink" title="Azure AD の変更手順"></a>Azure AD の変更手順</h2><p>Azure AD ディレクトリは必ず xxxxx.onmicrosoft.com という名前を持ちますが、このドメイン名を後から変更することはできません。そのため、 Azure AD のディレクトリのドメイン名を例えば contoso.onmicrosoft.com にしたい場合は、上記の「Azure AD の追加手順」の手順に従い、Azure AD を新規に作成する必要があります。</p>
<p>なお、Azure AD の組織名 (よく ”既定のディレクトリ” と表示されている名称) については下記の手順で変更可能です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[プロパティ] をクリックします</li>
<li><p>[名前] の項目に新しい組織名を入力します。</p>
<p> 例：既定のディレクトリ –&gt; コントソ株式会社</p>
</li>
<li><p>[保存] を押します。</p>
</li>
<li>少し時間を空けて再度サインインすると、名前が変更されます。</li>
</ol>
<p>また、ご利用の Azure サブスクリプションを新規で作成した Azure AD に紐づけたいというような要件がある場合には、サブスクリプションの譲渡とディレクトリの変更の 2 つの方法があります。 </p>
<h2 id="Azure-AD-の削除手順"><a href="#Azure-AD-の削除手順" class="headerlink" title="Azure AD の削除手順"></a>Azure AD の削除手順</h2><p>手動で作成した Azure AD については削除が可能です。ディレクトリを削除するためには、いくつか前提条件があります。</p>
<p>&lt;ディレクトリ削除の前提条件&gt;</p>
<ul>
<li>Azure のご契約時に自動的に作成されたディレクトリ (既定のディレクトリ) ではない</li>
<li>ディレクトリにユーザーが存在しない</li>
<li>連携するアプリケーションが存在しない</li>
<li>サブスクリプションが紐づいていない</li>
<li>など</li>
</ul>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[ディレクトリの削除] をクリックします</li>
<li>前提条件のチェック完了後に [削除] をクリックします</li>
</ol>
<p>削除時に前提条件のチェックが走るため、すべての条件をクリアすることで削除が可能となります。前提条件に抵触している場合は、下記のように ! の警告が表示され削除が完了しません。</p>
<img src="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/confirm-delete-directory.png">
<p>なお、Azure のサインアップ時に自動作成された Azure AD  (既定のディレクトリ) やセルフサインアップテナント については削除が想定されていません。そのディレクトリはもう利用することはないが、ユーザーが Azure ポータルにサインインしたときにディレクトリが表示されるので煩わしいという場合には、そのディレクトリからユーザーを削除する方法で対応が可能です。</p>
<p>これにより該当のアカウントでサインインしてもディレクトリは見えなくなりますので、ディレクトリを削除した場合と同等の効果が得られます。</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[ユーザーとグループ] – [すべてのユーザー] をクリックします</li>
<li>[＋新しいユーザー] をクリックします</li>
<li><p>ユーザー名を入力し、ロールでは「全体管理者」を選択します</p>
<p> 例) 削除対象のディレクトリ名が contoso.onmicrosoft.com の場合: <a href="mailto:temp@conotoso.onmicrosoft.com" target="_blank" rel="noopener">temp@conotoso.onmicrosoft.com</a></p>
</li>
<li><p>手順 5. で作成した全体管理者のアカウントで <a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> にサインインします</p>
</li>
<li>[すべてのユーザー] まで移動して、本アカウント以外をこのディレクトリから削除します</li>
</ol>
<p>削除されたユーザーで、ディレクトリが見えない状態になっているかどうかを確認します。</p>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>複数の Azure AD は完全に独立したリソースとして管理されます。そのため、Azure AD 間の連携が必要なシナリオの場合は、Azure AD B2B の利用をします。B2B については下記の記事を合わせてご参照ください。</p>
<p>Azure AD B2B とは<br><a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/</a></p>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/01/16/azure-active-directory/add-modify-delete-directory/" data-id="cjth4sc9r0005hgyt5q1hwutg" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/access-restriction-azure-portal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/" class="article-date">
  <time datetime="2017-12-28T15:00:00.000Z" itemprop="datePublished">2017-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/">Azure ポータルへのアクセス制限</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は、一般ユーザーに対して Azure ポータルへのアクセスを制限する方法について紹介します。</p>
<p>クラシック ポータル (旧ポータル) ではログインする際に Azure のサブスクリプションを保持していることが前提となっていました。一方 Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) には、サブスクリプションの有無によらず、ログインすることが可能です。この動作変更により、より多くのユーザーが簡単に Azure に対してアクセスできるようになっています。</p>
<p>Azure ポータルからは、そのログインしたユーザーが所属する Azure AD ディレクトリにアクセスすることができ、このとき Azure AD に対しての管理者権限を持たない一般ユーザーであっても、既定では Azure AD に登録されているユーザー一覧を参照できるようになっています。ご利用状況によっては、このことがセキュリティ上好ましくない場合もあると思います。</p>
<h2 id="Azure-ポータルへのアクセスを制限する方法"><a href="#Azure-ポータルへのアクセスを制限する方法" class="headerlink" title="Azure ポータルへのアクセスを制限する方法"></a>Azure ポータルへのアクセスを制限する方法</h2><p>Azure ポータル自体へのアクセスを限られたユーザーのみに制限する方法については、条件付きアクセスの機能を利用する必要があります。条件付きアクセスの機能を利用するためには Azure AD Premium (P1 or P2) のライセンスが制御対象のユーザー分必要となります。</p>
<p>なお、 後述します Azure AD へのアクセスを制限する方法 (ユーザーの一覧を見えなくする) であれば、ライセンスは不要です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li>Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) に管理者のアカウントでアクセスします。</li>
<li>セキュリティの [条件付きアクセス] – [ポリシー] の順にクリックします。</li>
<li>上部 [＋新しいポリシー] をクリックします。</li>
<li>[名前] にポリシーの名前を入力します。</li>
<li><p>ポリシーを割り当てるユーザーまたはグループを選択します。</p>
<p> この時、全ての管理者に割り当てないようにしてください。全ての管理者がポリシーの制限を受け、Azure にアクセスすることができなくなり、設定解除もできなくなるというお問い合わせを過去に複数いただいております。</p>
</li>
<li><p>[クラウド アプリ] では 「アプリを選択」 にチェックを入れます。</p>
</li>
<li>[選択] をクリックし、[Microsoft Azure Management] アプリケーションを検索し、選択します。</li>
<li>[クラウド アプリ] のブレードに戻るので、[完了] をクリックします。</li>
<li>[条件] – [場所] をクリックし、構成で [はい] を選択します。</li>
<li>対象 で「すべての場所」を選択します。</li>
<li>Azure ポータルに戻って、[完了] を 2 回 クリックします。</li>
<li>アクセス制御 の [許可] で「アクセスのブロック」を選択して、[選択] をクリックします。</li>
<li>即時ポリシーを有効化する場合には、ポリシーの有効化で [オン] を選択し、[作成] をクリックします。</li>
</ol>
<p>該当ユーザーで Azure ポータルへアクセスすると下記の画面が表示され、アクセスがブロックされます。</p>
<img src="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/access-restricted.png">
<h2 id="Azure-AD-へのアクセスを制限する方法"><a href="#Azure-AD-へのアクセスを制限する方法" class="headerlink" title="Azure AD へのアクセスを制限する方法"></a>Azure AD へのアクセスを制限する方法</h2><p>Azure AD の管理者権限（全体管理者または制限付き管理者）を与えられていないユーザーによる ポータル内 [Azure Active Directory] へのアクセスを制限する方法です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li>全体管理者として Azure ポータル（<a href="http://portal.azure.com）にサインインします。" target="_blank" rel="noopener">http://portal.azure.com）にサインインします。</a></li>
<li>左側のメニューから [Azure Active Directory] をクリックします。</li>
<li>表示されたメニューから [ユーザーとグループ] をクリックします。</li>
<li>表示されたメニューから [ユーザー設定] をクリックします。</li>
<li>右側の下記の項目がございますので、[はい] を選択します。</li>
<li>[管理ポータル] - [Azure AD 管理ポータルへのアクセスを制限する]<br>上にある [保存] をクリックします。</li>
</ol>
<p>※ 上記 5. で [はい] を選択することで管理者以外の一般ユーザーは、Azure ポータル内での [Azure Active Directory] にアクセスしようとすると、下記の画面が表示されアクセス権がなくなります。</p>
<img src="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/no-access.png">
<p>上記設定は、Azure ポータル上のアクセス制限になるため、設定完了後も PowerShell を使用すれば、ユーザーの一覧は参照できます。その対処策となる設定についても下記にご案内させていただきます。</p>
<p>&lt;手順&gt;</p>
<p>この作業を実施するためには、Azure AD 用の PowerShell (Azure AD v1 の PowerShell) を利用する必要がありますが、 PowerShell を利用する際には Microsoft アカウントではなく、組織アカウントでの全体管理者が必要です (Azure AD の PowerShell についてはリンクも参照ください)。</p>
<ol>
<li><p>PowerShell を開き、下記のコマンドで全体管理者で Azure AD に接続します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connect-MsolService</span><br></pre></td></tr></table></figure>
</li>
<li><p>下記コマンドで他のユーザー及びグループの情報を取得させないように設定します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolCompanySettings -UsersPermissionToReadOtherUsersEnabled <span class="literal">$false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下記コマンドで他のユーザー及びグループの情報を取得させないように設定されたか確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolCompanyInformation | fl UsersPermissionToReadOtherUsersEnabled</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>外部から追加した Guest ユーザーについては既定で Azure AD へのアクセスが制限されています<br>(Guest と Member の違いについては、こちらのリンクを参照ください)。</p>
<p>Azure ポータルへのログインを条件付きアクセスを利用して制限していない場合でも、 Azure AD 以外の項目、例えば仮想マシンなどのリソースに対しては、サブスクリプションの権限を明示的に付与しない限りは、各ユーザーは参照することもできませんのでご安心ください。</p>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<p>※ 本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/29/azure-active-directory/access-restriction-azure-portal/" data-id="cjth4sc9p0004hgyteaic8qeq" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/">&laquo; 戻る</a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><a class="extend next" rel="next" href="/blog/page/3/">次へ &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグ</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AAD-Connect/">AAD Connect</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AD-Sync/">AD Sync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-Application-Proxy/">Azure AD Application Proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-Directory-Rolls/">Azure AD Directory Rolls</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-License/">Azure AD License</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ExpressRoute/">ExpressRoute</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hard-match/">Hard match</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Intune/">Intune</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MFA/">MFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/PowerShell/">PowerShell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/RBAC/">RBAC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Sgin-in-log/">Sgin-in log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Smart-lockout/">Smart lockout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Subscription/">Subscription</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Tenant-Restrictions/">Tenant Restrictions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/UPN/">UPN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Windows-Defender-ATP/">Windows Defender ATP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Workplace-Join/">Workplace Join</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグクラウド</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/AAD-Connect/" style="font-size: 14px;">AAD Connect</a> <a href="/blog/tags/AD-FS/" style="font-size: 18px;">AD FS</a> <a href="/blog/tags/AD-Sync/" style="font-size: 10px;">AD Sync</a> <a href="/blog/tags/Azure-AD/" style="font-size: 20px;">Azure AD</a> <a href="/blog/tags/Azure-AD-Application-Proxy/" style="font-size: 10px;">Azure AD Application Proxy</a> <a href="/blog/tags/Azure-AD-B2B/" style="font-size: 14px;">Azure AD B2B</a> <a href="/blog/tags/Azure-AD-Directory-Rolls/" style="font-size: 10px;">Azure AD Directory Rolls</a> <a href="/blog/tags/Azure-AD-License/" style="font-size: 10px;">Azure AD License</a> <a href="/blog/tags/Conditional-Access/" style="font-size: 16px;">Conditional Access</a> <a href="/blog/tags/ExpressRoute/" style="font-size: 10px;">ExpressRoute</a> <a href="/blog/tags/Hard-match/" style="font-size: 10px;">Hard match</a> <a href="/blog/tags/Hybrid-Azure-AD-Join/" style="font-size: 10px;">Hybrid Azure AD Join</a> <a href="/blog/tags/Intune/" style="font-size: 12px;">Intune</a> <a href="/blog/tags/MFA/" style="font-size: 10px;">MFA</a> <a href="/blog/tags/PowerShell/" style="font-size: 10px;">PowerShell</a> <a href="/blog/tags/RBAC/" style="font-size: 12px;">RBAC</a> <a href="/blog/tags/Security/" style="font-size: 12px;">Security</a> <a href="/blog/tags/Sgin-in-log/" style="font-size: 10px;">Sgin-in log</a> <a href="/blog/tags/Smart-lockout/" style="font-size: 10px;">Smart lockout</a> <a href="/blog/tags/Subscription/" style="font-size: 10px;">Subscription</a> <a href="/blog/tags/Tenant-Restrictions/" style="font-size: 10px;">Tenant Restrictions</a> <a href="/blog/tags/UPN/" style="font-size: 10px;">UPN</a> <a href="/blog/tags/Windows-Defender-ATP/" style="font-size: 10px;">Windows Defender ATP</a> <a href="/blog/tags/Workplace-Join/" style="font-size: 10px;">Workplace Join</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/10/">十月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2019/02/04/azure-active-directory/how-to-get-sign-in-logs/">Azure AD サインイン ログ取得方法まとめ</a>
          </li>
        
          <li>
            <a href="/blog/2018/12/12/azure-active-directory/last-signin-reports/">PowerShell にて全ユーザーの最終サインイン日時を一括で取得する方法</a>
          </li>
        
          <li>
            <a href="/blog/2018/11/01/azure-active-directory/create-subscription-error/">サブスクリプション作成時のエラー「アカウントが Azure サブスクリプションに関連付けられないディレクトリに属しています。別のアカウントでサインインしてください」</a>
          </li>
        
          <li>
            <a href="/blog/2018/10/15/azure-active-directory/mfa-reset/">多要素認証 (MFA) のリセット手順</a>
          </li>
        
          <li>
            <a href="/blog/2018/09/27/azure-active-directory/conditional-access-basuc/">条件付きアクセスの基本的な考え方</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Azure Identity Support Japan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>