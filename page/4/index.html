<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <!-- this tag should remove when publish production  -->
  <meta name="”robots”" content="”noindex”">
  

  
  <title>Japan Azure Identity Support Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta name="keywords" content="Azure,Azure AD,Identity,AD FS">
<meta property="og:type" content="website">
<meta property="og:title" content="Japan Azure Identity Support Blog">
<meta property="og:url" content="https://jpazureid.github.io/page/4/index.html">
<meta property="og:site_name" content="Japan Azure Identity Support Blog">
<meta property="og:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta property="og:locale" content="ja">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Japan Azure Identity Support Blog">
<meta name="twitter:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
  
    <link rel="alternate" href="../../atom.xml" title="Japan Azure Identity Support Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="../../css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="../../index.html" id="logo">Japan Azure Identity Support Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="../../index.html">Home</a>
        
          <a class="main-nav-link" href="../../archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="../../atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://jpazureid.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-azure-active-directory/hybrid-azuread-joined-devices-setup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/hybrid-azuread-joined-devices-setup/" class="article-date">
  <time datetime="2018-04-02T15:00:00.000Z" itemprop="datePublished">2018-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/hybrid-azuread-joined-devices-setup/">ハイブリッド Azure Active Directory 参加済みデバイスの構成について</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>いつもお世話になります。Azure &amp; Identity サポート チームの加藤です。</p>
<p>本記事では「ハイブリッド Azure Active Directory 参加済みデバイスの構成」についてご案内します。</p>
<p>本記事がみなさまの一助になれば幸いです。</p>
<ol>
<li>本記事の目的</li>
<li>ハイブリッド Azure Active Directory 参加済みデバイスの構成とは </li>
<li>手順 1 : サービス接続ポイントの構成」についての補足  </li>
<li>手順 2 : 要求の発行のセットアップ」についての補足  </li>
<li>Windows 10 のデバイス登録の流れについて  </li>
<li>Windows 10 のデバイス登録について注意事項  </li>
<li>ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録の流れ  </li>
<li>ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録について注意事項  </li>
</ol>
<h3 id="1-本記事の目的"><a href="#1-本記事の目的" class="headerlink" title="1. 本記事の目的"></a><strong>1. 本記事の目的</strong></h3><hr>
<p>本記事の目的は、以下の弊社公開情報を補足することです。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup" target="_blank" rel="noopener">ハイブリッド Azure Active Directory 参加済みデバイスの構成方法</a></p>
<p>補足のポイントは私たちサポート サービスに最もお問い合わせの多いシナリオである「”AD FS がある場合の” ハイブリッド Azure Active Directory 参加済みデバイスの構成方法」です。</p>
<p>!!!! 注意 !!!!<br>本記事は要所についての補足となります。<br><strong>全ての手順の確認は必ず上記ページをご確認ください。</strong></p>
<h3 id="2-ハイブリッド-Azure-Active-Directory-参加済みデバイスの構成とは"><a href="#2-ハイブリッド-Azure-Active-Directory-参加済みデバイスの構成とは" class="headerlink" title="2. ハイブリッド Azure Active Directory 参加済みデバイスの構成とは"></a><strong>2. ハイブリッド Azure Active Directory 参加済みデバイスの構成とは</strong></h3><hr>
<p>ハイブリッド Azure Active Directory 参加済みデバイスの構成とは、以下を実現するための構成です。</p>
<ul>
<li>オンプレミス AD にデバイスが参加している</li>
<li>同時に Azure AD にも同デバイスを登録する</li>
</ul>
<p>この構成を実現することで、該当のデバイスに対して、条件付きアクセスで「ドメイン参加済みであることが必要」によるアクセスの制御が行えるようになります。</p>
<img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/0011.png">
<p>条件付きアクセスで「ドメイン参加済みであることが必要」を使用することで、以下のアクセス制御を行えます。</p>
<ul>
<li>オンプレミス AD に参加しているデバイスであれば、アクセスを許可する</li>
</ul>
<p>つまり、「社給デバイスのみアクセスを許可したい」などの要件に対応することができます。</p>
<p>そのための前提となる構成がハイブリッド Azure Active Directory 参加済みデバイスの構成です。</p>
<h3 id="3-「手順-1-サービス接続ポイントの構成」についての補足"><a href="#3-「手順-1-サービス接続ポイントの構成」についての補足" class="headerlink" title="3. 「手順 1 : サービス接続ポイントの構成」についての補足"></a><strong>3. 「手順 1 : サービス接続ポイントの構成」についての補足</strong></h3><hr>
<p>以下ページの「手順 1: サービス接続ポイントの構成」について、AD FS が存在している環境を前提に補足します。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup" target="_blank" rel="noopener">ハイブリッド Azure Active Directory 参加済みデバイスの構成方法</a></p>
<h4 id="サービス接続ポイント-SCP-は何に使用されるか"><a href="#サービス接続ポイント-SCP-は何に使用されるか" class="headerlink" title="サービス接続ポイント (SCP) は何に使用されるか"></a>サービス接続ポイント (SCP) は何に使用されるか</h4><p>ハイブリッド Azure AD 参加では、オンプレミスのドメインに参加しているデバイスは Azure AD に対して自身を登録する必要があります。</p>
<p>この登録処理において各デバイスが参照する先がサービス接続ポイント (SCP) です。</p>
<p>サービス接続ポイント (SCP) が登録されていない場合、デバイス登録時に適切に AD FS への認証が行われません。</p>
<p>結果、デバイス登録に失敗します。<br>サービス接続ポイント (SCP) の実体は以下に登録されます。</p>
<ul>
<li>CN=62a0ff2e-97b9-4513-943f-0d221bd30080,CN=Device Registration Configuration,CN=Services,CN=Configuration,DC=contoso,DC=local (「DC=contoso,DC=local」部分は環境に合わせて読み替えてください) の keywords 属性の値</li>
</ul>
<p>この keywords 属性の値として登録される以下 2 つがサービス接続ポイント (SCP) の実体です。</p>
<ul>
<li>azureADId:&lt;該当 Azure AD のテナント ID&gt;</li>
<li>azureADName:&lt;該当 Azure AD のいずれかの Federated ドメイン&gt;</li>
</ul>
<p>azureADName に設定される Federated ドメインは、登録先の Azure AD に関連付けられた Federated ドメインが設定されます。</p>
<p>複数の Federated ドメインがある場合にも、サービス接続ポイント (SCP) を複数作ったり、すべての Federated ドメインを追加する必要はありません。</p>
<p>いずれかの 1 つの Federated ドメインがサービス接続ポイント (SCP) に設定されていれば問題ありません。</p>
<p>各デバイスは、 SCP に登録されている情報を元に Azure AD から AD FS の情報を参照し、 AD FS への認証が行われます。</p>
<p>このサービス接続ポイント (SCP) を構成するコマンドが以下になります。</p>
<ul>
<li>Initialize-ADSyncDomainJoinedComputerSync</li>
</ul>
<h4 id="Initialize-ADSyncDomainJoinedComputerSync-を使用してサービス接続ポイント-SCP-を構成する"><a href="#Initialize-ADSyncDomainJoinedComputerSync-を使用してサービス接続ポイント-SCP-を構成する" class="headerlink" title="Initialize-ADSyncDomainJoinedComputerSync を使用してサービス接続ポイント (SCP) を構成する"></a>Initialize-ADSyncDomainJoinedComputerSync を使用してサービス接続ポイント (SCP) を構成する</h4><p>上記の通り、Initialize-ADSyncDomainJoinedComputerSync コマンドはサービス接続ポイント (SCP) を構成します。</p>
<p>該当環境のドメイン コントローラーの OS が Windows 2008 より新しいバージョンの場合に使用できるコマンドです。</p>
<p>このコマンドの使用方法は以下になります。</p>
<ol>
<li>エンタープライズ管理者で Azure AD Connect サーバーにサインインする</li>
<li>PowerShell を管理者として起動する</li>
<li><p>以下のコマンドを実行して Active Directory PowerShell モジュールと AD DS ツールをインストールする</p>
<p>Add-WindowsFeature RSAT-AD-PowerShell,RSAT-AD-AdminCenter</p>
</li>
<li><p>以下の弊社公開情報に沿って MSOnline (Azure AD v1) をインストールする</p>
<p><a href="file:///C:/2017/12/04/aad-powershell/index.html" target="_blank" rel="noopener">Azure Active Directory の PowerShell モジュール</a></p>
</li>
<li><p>PowerShell を閉じる</p>
</li>
<li>再度、PowerShell を管理者として起動する</li>
<li><p>以下のコマンドを実行してサービス接続ポイント (SCP) オブジェクトを構成する</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">Import-Module</span> -Name <span class="string">"C:\Program Files\Microsoft Azure Active Directory Connect\AdPrep\AdSyncPrep.psm1"</span>;</span><br><span class="line"><span class="variable">$aadAdminCred</span> = <span class="built_in">Get-Credential</span>;</span><br></pre></td></tr></table></figure>
<p>※ 認証画面が表示されるので対象の Azure AD の管理者の資格情報を入力します</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Initialize-ADSyncDomainJoinedComputerSync -AdConnectorAccount <span class="string">"xxxx"</span> -AzureADCredentials <span class="variable">$aadAdminCred</span>;</span><br></pre></td></tr></table></figure>
<p>※ xxxx 部分はオンプレミス AD の管理者のユーザー名を domain\user の形式で入力します</p>
</li>
</ol>
<p>この手順が正常に行えない場合、または該当環境のドメイン コントローラーの OS が Windows 2008 以前のバージョンの場合は、手動でサービス接続ポイント (SCP) を構成します。</p>
<h4 id="手動でサービス接続ポイント-SCP-を構成する"><a href="#手動でサービス接続ポイント-SCP-を構成する" class="headerlink" title="手動でサービス接続ポイント (SCP) を構成する"></a>手動でサービス接続ポイント (SCP) を構成する</h4><p>Initialize-ADSyncDomainJoinedComputerSync を使用した登録ができない場合 (ドメイン コントローラーの OS が Windows 2008 以前のバージョンの場合を含む)、手動でサービス接続ポイント (SCP) を構成します。</p>
<p>その方法は以下になります。</p>
<ol>
<li><p>以下の公開情報に沿ってテナント ID を確認する</p>
<p><a href="https://support.office.com/ja-jp/article/6891b561-a52d-4ade-9f39-b492285e2c9b" target="_blank" rel="noopener">Office 365 テナント ID を検索する</a></p>
</li>
<li><p>エンタープライズ管理者でドメイン コントローラーにサインインする</p>
</li>
<li>PowerShell を管理者として起動する</li>
<li><p>以下のコマンドを実行してサービス接続ポイント (SCP) オブジェクトを構成する</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$verifiedDomain</span> = <span class="string">"contoso.com"</span></span><br></pre></td></tr></table></figure>
<p> ※ 該当 Azure AD に登録されているいずれかの Federated ドメインを指定します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tenantID</span> = <span class="string">"xxxxxx"</span></span><br></pre></td></tr></table></figure>
<p> ※ 「xxxxxx」部分に上記で確認したテナント ID を指定します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$configNC</span> = <span class="string">"CN=Configuration,DC=corp,DC=contoso,DC=com"</span></span><br><span class="line"><span class="variable">$de</span> = <span class="built_in">New-Object</span> System.DirectoryServices.DirectoryEntry</span><br><span class="line"><span class="variable">$de</span>.Path = <span class="string">"LDAP://CN=Services,"</span> + <span class="variable">$configNC</span></span><br><span class="line"><span class="variable">$deDRC</span> = <span class="variable">$de</span>.Children.Add(<span class="string">"CN=Device Registration Configuration"</span>, <span class="string">"container"</span>)</span><br><span class="line"><span class="variable">$deDRC</span>.CommitChanges()</span><br><span class="line"><span class="variable">$deSCP</span> = <span class="variable">$deDRC</span>.Children.Add(<span class="string">"CN=62a0ff2e-97b9-4513-943f-0d221bd30080"</span>, <span class="string">"serviceConnectionPoint"</span>)</span><br><span class="line"><span class="variable">$deSCP</span>.Properties[<span class="string">"keywords"</span>].Add(<span class="string">"azureADName:"</span> + <span class="variable">$verifiedDomain</span>)</span><br><span class="line"><span class="variable">$deSCP</span>.Properties[<span class="string">"keywords"</span>].Add(<span class="string">"azureADId:"</span> + <span class="variable">$tenantID</span>)</span><br><span class="line"><span class="variable">$deSCP</span>.CommitChanges()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4-「手順-2-要求の発行のセットアップ」についての補足"><a href="#4-「手順-2-要求の発行のセットアップ」についての補足" class="headerlink" title="4. 「手順 2 : 要求の発行のセットアップ」についての補足"></a><strong>4. 「手順 2 : 要求の発行のセットアップ」についての補足</strong></h3><hr>
<p>以下ページの「手順 2: 要求の発行のセットアップ」について、AD FS が存在している環境を前提に補足します。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup" target="_blank" rel="noopener">ハイブリッド Azure Active Directory 参加済みデバイスの構成方法</a></p>
<p>なお、AD FS でフェデレーションを行っていない環境では、この「手順 2: 要求の発行のセットアップ」の作業は不要です。</p>
<p><strong>クレーム ルールは何に使用されるか</strong></p>
<p>この手順ではクレーム ルールを設定します。</p>
<p>AD FS でデバイスの認証が行われると AD FS よりトークンが発行されます。</p>
<p>それをデバイスが Azure AD のデバイス登録を管理しているサービス (Azure AD DRS) に提示することでハイブリッド Azure AD 参加のデバイス登録が行われます。</p>
<p>ここで設定するクレーム ルールは、その AD FS から発行されるトークンにデバイス登録に必要なクレームを含めるためのものです。</p>
<p>これらのクレーム ルールが適切に設定されていない場合、 AD FS から発行されるトークン内に Azure AD DRS が求めるクレームが含まれない状態となるため、デバイス登録に失敗します。</p>
<p><strong>ヘルパースクリプトの使い方</strong></p>
<p>これらのクレーム ルールの登録方法として「手順 2: 要求の発行のセットアップ」内で記載されているヘルパースクリプトがあります。</p>
<p>このヘルパースクリプトの使い方について補足します。</p>
<p>ヘルパースクリプトのはじめの 3 行は、環境に合わせて設定をします。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$multipleVerifiedDomainNames</span> = <span class="literal">$false</span></span><br><span class="line"><span class="variable">$immutableIDAlreadyIssuedforUsers</span> = <span class="literal">$false</span></span><br><span class="line"><span class="variable">$oneOfVerifiedDomainNames</span> = <span class="string">'example.com'</span></span><br></pre></td></tr></table></figure>
<p>それぞれの行について説明します。</p>
<h4 id="multipleVerifiedDomainNames-false"><a href="#multipleVerifiedDomainNames-false" class="headerlink" title="$multipleVerifiedDomainNames = $false"></a>$multipleVerifiedDomainNames = $false</h4><p>ここで指定をする値は以下のいずれかです。</p>
<ul>
<li>$false</li>
<li>$true</li>
</ul>
<p>1 つの Federated ドメインのみの場合は $false を指定します。</p>
<p>複数の Federated ドメインがある場合は $true を指定します。</p>
<p>1 つか複数かというのは、より正確にいうと以下になります。</p>
<p>AD FS を構成する際に Federated ドメインの設定をする際に以下のコマンドを実行している場合は $false を指定します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Convert-MsolDomainToFederated -DomainName xxx</span><br></pre></td></tr></table></figure>
<p>Federated ドメインの設定をする際に以下のコマンドを実行している場合は $true を指定します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Convert-MsolDomainToFederated -DomainName xxx -SupportMultipleDomain</span><br></pre></td></tr></table></figure>
<p>厳密に $false と $true のどちらを指定するかの確認方法を以下に記載します。<br>(Federated ドメインが 1 つの場合も、-SupportMultipleDomain を指定して作成されている場合があるためです)</p>
<ol>
<li><p>以下の弊社公開情報に沿って MSOnline (Azure AD v1) をインストールする</p>
<p><a href="file:///C:/2017/12/04/aad-powershell/index.html" target="_blank" rel="noopener">Azure Active Directory の PowerShell モジュール</a></p>
</li>
<li><p>以下のコマンドを実行して対象の Azure AD に接続する</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connect-MsolService</span><br></pre></td></tr></table></figure>
<p>※ 認証が発生するので対象の Azure AD の全体管理者の資格情報を入力します。</p>
</li>
<li><p>以下のコマンドを実行してドメイン情報を取得する</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolDomain</span><br></pre></td></tr></table></figure>
</li>
<li><p>以下のコマンドを実行して IssuerUri を取得する</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolDomainFederationSettings -DomainName xxxx | select IssuerUri</span><br></pre></td></tr></table></figure>
<p>※「xxxx」部分は、上記 3. で取得したドメイン情報の中から Federated ドメインを 1 つ選んで指定してください。</p>
<p>Federated ドメインが 1 つのみの場合は、それを指定してください。</p>
<p>Federated ドメインが複数ある場合は、どれでも結構です。</p>
</li>
<li><p>取得した以下の IssuerUri の値から $false と $true のどちらを指定するかを判断する</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IssuerUri</span><br><span class="line">---------</span><br><span class="line">http://xxxx/adfs/services/trust/</span><br></pre></td></tr></table></figure>
<p>※「xxxx」部分が AD FS のフェデレーション サービス名と一致する場合は、$false を指定します。</p>
<p>「xxxx」部分が AD FS のフェデレーション サービス名と一致しない場合は、$true を指定します。</p>
</li>
</ol>
<h4 id="immutableIDAlreadyIssuedforUsers-false"><a href="#immutableIDAlreadyIssuedforUsers-false" class="headerlink" title="$immutableIDAlreadyIssuedforUsers = $false"></a>$immutableIDAlreadyIssuedforUsers = $false</h4><p>ここで指定をする値は以下のいずれかです。</p>
<ul>
<li>$false</li>
<li>$true</li>
</ul>
<p>Windows 10 のデバイス登録時、そのコンピューターオブジェクトによる AD FS での認証が発生します。</p>
<p>この際に、ImmutableID がトークン内に含まれる場合は $false を指定します。</p>
<p>この際に、ImmutableID がトークン内に含まれない場合は $true を指定します。</p>
<p>厳密に $false と $true のどちらを指定するかの確認方法を以下に記載します。</p>
<ol>
<li>プライマリ AD FS サーバーに管理者でサインインする</li>
<li>AD FS の管理コンソールを起動する</li>
<li><p>画面左のツリーから以下をクリックする</p>
<p>Windows Server 2012 R2 の AD FS の場合 : [AD FS] - [信頼関係] - [証明書利用者信頼]</p>
<p>Windows Server 2016 の AD FS の場合 : [AD FS] - [証明書利用者信頼]</p>
</li>
<li><p>画面中央から [Microsoft Office 365 Identity Platform] を右クリックして以下をクリックする</p>
<p> Windows Server 2012 R2 の AD FS の場合 : [要求規則の編集]</p>
<p> Windows Server 2016 の AD FS の場合 : [要求発行ポリシーの編集]</p>
</li>
<li>[発行変換規則] タブをクリックする</li>
<li>1 つ目の規則をダブルクリックする</li>
<li><p>以下の赤字部分の属性名を確認する (既定では objectGUID になっています。)</p>
<p> c:[Type == “<a href="http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;]" target="_blank" rel="noopener">http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;]</a><br>=&gt; issue(store = “Active Directory”, types = (“<a href="http://schemas.xmlsoap.org/claims/UPN&quot;" target="_blank" rel="noopener">http://schemas.xmlsoap.org/claims/UPN&quot;</a>, “<a href="http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID&quot;)" target="_blank" rel="noopener">http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID&quot;)</a>, query = “samAccountName={0};userPrincipalName,xxxxxxxxx;{1}”, param = regexreplace(c.Value, “(?[^\]+)\(?.+)”, “${user}”), param = c.Value);</p>
</li>
<li><p>確認した属性名から $false と $true のどちらを指定するかを判断する</p>
<p> 属性名がコンピューターオブジェクトにも存在していて、かつ、既定で値が設定される属性の場合は、$false を指定します。</p>
<p> 属性名がコンピューターオブジェクトに存在しない、または、存在するけど既定で値が設定されない属性の場合は、$true を指定します。</p>
</li>
</ol>
<h4 id="oneOfVerifiedDomainNames-‘example-com’"><a href="#oneOfVerifiedDomainNames-‘example-com’" class="headerlink" title="$oneOfVerifiedDomainNames = ‘example.com’"></a>$oneOfVerifiedDomainNames = ‘example.com’</h4><p>ここで指定をする値は対象の Azure AD に登録されている Federated ドメインのいずれかです。</p>
<p>Federated ドメインが 1 つのみの場合は、それを指定してください。</p>
<p>Federated ドメインが複数ある場合は、どれでも結構です。</p>
<p>以上を設定した上で、ヘルパースクリプトをご利用ください。</p>
<h3 id="5-Windows-10-のデバイス登録の流れについて"><a href="#5-Windows-10-のデバイス登録の流れについて" class="headerlink" title="5. Windows 10 のデバイス登録の流れについて"></a><strong>5. Windows 10 のデバイス登録の流れについて</strong></h3><hr>
<p>Windows 10 のデバイス登録の流れについて説明します。</p>
<p>”AD FS がある場合の” ハイブリッド Azure Active Directory 参加済みデバイスの構成が正しく構築できている場合、Windows 10 を新規にオンプレミスのドメインに参加させると、以下の流れで Azure AD へのデバイス登録がされます。</p>
<p>(実際には様々な処理が並列して行われているはずですので、前後する部分もあります)</p>
<ol>
<li>Workgroup の Windows 10 にローカルユーザーでサインインする</li>
<li><p>Windows 10 をドメインに参加させる</p>
 <img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/002.png">
</li>
<li><p>オンプレミス AD に Windows 10 のコンピューター オブジェクトが作成される</p>
</li>
<li>Windows 10 からサービス接続ポイント (SCP) を参照する</li>
<li>Windows 10 のコンピューター オブジェクトで AD FS の認証をする</li>
<li>AD FS から Windows 10 にトークンが発行される</li>
<li>Windows 10 から Azure AD にデバイス登録をする</li>
<li><p>Windows 10 に「xxxx ドメインへようこそ。」のメッセージボックスが表示される</p>
 <img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/003.png">
</li>
<li><p>このメッセージボックスが表示されている時点で Azure AD 側にもデバイスが登録されている</p>
 <img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/004-1024x298.png">
<p> ※ この時点では、[所有者] が [該当なし] になります。</p>
</li>
<li><p>以降、Azure AD Connect で同期が実行されると、オンプレミス AD 上のコンピューターオブジェクトの情報が、Azure AD 上のデバイスに上書きされる</p>
<img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/005-1024x297.png">
<p>※ この時点で [所有者] が登録されます。</p>
</li>
</ol>
<h3 id="6-Windows-10-のデバイス登録について注意事項"><a href="#6-Windows-10-のデバイス登録について注意事項" class="headerlink" title="6. Windows 10 のデバイス登録について注意事項"></a><strong>6. Windows 10 のデバイス登録について注意事項</strong></h3><hr>
<p>Workgroup の Windows 10 をオンプレミス AD のドメインに参加させる際に以下のダイアログが表示され、ここでオンプレミス AD のユーザー資格情報を入力します。</p>
<img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/006.png">
<p>ここに入力をしたユーザー Azure AD 上に登録されるデバイスの所有者になります。</p>
<p>仮にここで入力をするユーザーが Azure AD には同期されておらず、オンプレミス AD 上だけに存在するユーザーであった場合、以降ずっと Azure AD 上でそのデバイスの所有者は [該当なし] のままになります。</p>
<p>このデバイスの所有者情報については、 他ユーザーでこの Windows 10 にサインインしても変わらず、これを変更するためには、一旦 Workgroup に戻して再度オンプレミス AD へ、所有者にしたいユーザーの資格情報を利用しての参加が必要になります (もちろん所有者にしたいユーザーは Azure AD に同期済み / 同期予定のユーザーである必要があります)。</p>
<h3 id="7-ダウンレベルの-Windows-Windows-7、Windows-8-1-のデバイス登録の流れ"><a href="#7-ダウンレベルの-Windows-Windows-7、Windows-8-1-のデバイス登録の流れ" class="headerlink" title="7. ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録の流れ"></a><strong>7. ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録の流れ</strong></h3><hr>
<p>ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録の流れについて説明します。</p>
<p>”AD FS がある場合の” ハイブリッド Azure Active Directory 参加済みデバイスの構成が正しく構築できている場合、ダウンレベルの Windows は以下の流れでデバイス登録されます。</p>
<p>Windows 7 で説明をしますが、Windows 8.1 でも同様です。<br>(実際には様々な処理が並列して行われているはずですので、前後する部分もあります)</p>
<ol>
<li>Workgroup の Windows 7 にローカルユーザーでサインインする</li>
<li>Windows 7 をドメインに参加させる</li>
<li>オンプレミス AD に Windows 7 のコンピューター オブジェクトが作成される</li>
<li>Windows 7 の再起動を求められるので再起動する</li>
<li>Windows 7 にドメインユーザーでサインインする</li>
<li>Windows 7 からサービス接続ポイント (SCP) を参照する</li>
<li>Windows 7 にサインインしたドメインユーザーで AD FS の認証をする</li>
<li>AD FS から Windows 7 にトークンが発行される</li>
<li>Windows 7 から Azure AD にデバイス登録をする</li>
<li><p>この時点ではじめて Azure AD 側にデバイスが登録される</p>
<img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/007-1024x320.png">
<p>※ この時点で [所有者] も登録されています。</p>
</li>
</ol>
<h3 id="8-ダウンレベルの-Windows-Windows-7、Windows-8-1-のデバイス登録について注意事項"><a href="#8-ダウンレベルの-Windows-Windows-7、Windows-8-1-のデバイス登録について注意事項" class="headerlink" title="8. ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録について注意事項"></a><strong>8. ダウンレベルの Windows (Windows 7、Windows 8.1) のデバイス登録について注意事項</strong></h3><hr>
<p>ダウンレベルの Windows をオンプレミス AD のドメインに参加させる際に表示される以下のダイアログに入力した資格情報は Windows 10 の場合とは異なり所有者になりません。</p>
<img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/008.png">
<p>ダウンレベルの Windows はドメイン参加後にサインインを行ったドメインユーザーで Azure AD へのデバイス登録が行われます。</p>
<p>ダウンレベルの Windows に別のドメインユーザーでサインインを行うと、同様にその別ユーザーにてデバイス登録が行われ、Azure AD 上に複数のデバイスが登録されることになります。</p>
<img src="/blog/azure-active-directory/hybrid-azuread-joined-devices-setup/009-1024x351.png">
<p>本記事がみなさまの一助になれば幸いです。</p>
<p>引き続きよろしくお願いします。</p>
<p>更新履歴</p>
<p>2018/04/03:<br>新規作成<br>$immutableIDAlreadyIssuedforUsers の記載を修正</p>
<p>2018/04/04:<br>注意事項を追記</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/hybrid-azuread-joined-devices-setup/" data-id="cjtz46pp8004mzcyttoliunvp" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/password-sprey-attack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/password-sprey-attack/" class="article-date">
  <time datetime="2018-03-18T15:00:00.000Z" itemprop="datePublished">2018-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/password-sprey-attack/">Azure AD と AD FS のベスト プラクティス - パスワード スプレー攻撃の防御</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure Identity サポートの宮林と高田です。</p>
<p>本記事は、米国時間 2018 年 3 月 5 日に公開された <a href="https://cloudblogs.microsoft.com/enterprisemobility/2018/03/05/azure-ad-and-adfs-best-practices-defending-against-password-spray-attacks/" target="_blank" rel="noopener">Azure AD and ADFS best practices: Defending against password spray attacks</a> の抄訳です。Azure AD と AD FS に関してパスワードスプレー攻撃を取り上げた情報がまとめられており、日本のサポート チームとして皆様にぜひ内容を共有したく日本語化しました。</p>
<hr>
<p>皆さんこんにちは。<br>パスワードを用いたログインを採用している限り、第三者がそれを推測しようとすることは避けられません。このブログでは、最近非常に頻繁に行われるようになった <strong>パスワード スプレー</strong> と呼ばれる攻撃手法と、それに対する防衛のためのベスト プラクティスについて説明します。</p>
<p>パスワード スプレー攻撃では、攻撃者が多くの人が設定するような一般的なパスワードで、複数の異なるアカウントに対してログインを試行することで、パスワードで保護されたリソースにアクセスを試みます。 通常、これらは 1 つの組織や 1 つの認証基盤に留まることなく行われます。例えば、攻撃者は <a href="https://www.blackhillsinfosec.com/introducing-mailsniper-a-tool-for-searching-every-users-email-for-sensitive-data/" target="_blank" rel="noopener">Mailsniper</a> などの一般にも入手可能なツールを用いて、複数の組織の全てのユーザーを列挙し、それらのアカウントすべてに対して “P@$$w0rd” や “Password1” などのパスワードを試します。</p>
<p>攻撃のイメージとしては、以下のようなものが挙げられます。</p>
<table>
<thead>
<tr>
<th>Target User</th>
<th>Target Password</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="mailto:User1@org1.com" target="_blank" rel="noopener">User1@org1.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td><a href="mailto:User2@org1.com" target="_blank" rel="noopener">User2@org1.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td><a href="mailto:User1@org2.com" target="_blank" rel="noopener">User1@org2.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td><a href="mailto:User2@org2.com" target="_blank" rel="noopener">User2@org2.com</a></td>
<td>Password1</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td><a href="mailto:User1@org1.com" target="_blank" rel="noopener">User1@org1.com</a></td>
<td>P@$$w0rd</td>
</tr>
<tr>
<td><a href="mailto:User2@org1.com" target="_blank" rel="noopener">User2@org1.com</a></td>
<td>P@$$w0rd</td>
</tr>
<tr>
<td><a href="mailto:User1@org2.com" target="_blank" rel="noopener">User1@org2.com</a></td>
<td>P@$$w0rd</td>
</tr>
<tr>
<td><a href="mailto:User2@org2.com" target="_blank" rel="noopener">User2@org2.com</a></td>
<td>P@$$w0rd</td>
</tr>
</tbody>
</table>
<p>この攻撃パターンは、個々のユーザーまたは企業から見ると、それぞれが別々のログイン失敗のように見えるため、ほとんどの検出手法 (例えばロックアウトなどの設定) をすり抜けてしまいます。</p>
<p>攻撃者にとっては数字を当てるナンバーズの宝くじのようなもので、攻撃者はよく当たりそうな最も一般的なパスワードをいくつも知っています。これらの最も一般的なパスワードを使用しているアカウントは全体の 0.5 〜 1.0％ 程度ですが、1000 個ほどアカウントがあれば、数個は攻撃が成功するため十分効果的です。</p>
<p>攻撃者は、ログインが成功したアカウントを使用して電子メールからデータを取得し、連絡先情報を収集したり、フィッシングのリンクを送信したり、さらにパスワード スプレーの標的を広げようとします。 攻撃者は、最初の標的が誰であるかについては気にせず、最初の成功をきっかけにその後どれだけ攻撃を広げられるか試していきます。</p>
<p>幸いなことに、マイクロソフトではこの攻撃に対するツールを実装および公開済みです。さらに、近いうちに多くのツールがリリースされる予定です。 パスワード スプレー攻撃への対策のために現在および今後数ヶ月の間に何ができるのかについて以下をご覧ください。</p>
<h2 id="パスワードスプレー攻撃を困難にする４つの簡単なステップ"><a href="#パスワードスプレー攻撃を困難にする４つの簡単なステップ" class="headerlink" title="パスワードスプレー攻撃を困難にする４つの簡単なステップ"></a>パスワードスプレー攻撃を困難にする４つの簡単なステップ</h2><h3 id="Step-1-クラウド認証の利用"><a href="#Step-1-クラウド認証の利用" class="headerlink" title="Step 1: クラウド認証の利用"></a>Step 1: クラウド認証の利用</h3><p>クラウド環境では、マイクロソフトが提供するシステムへのサインインが毎日何十億も行われています。 マイクロソフトのセキュリティ検出アルゴリズムにより、攻撃の検出とブロックを瞬時に行います。 これらはクラウドによるリアルタイム検出と保護システムによるもので、クラウド上で Azure AD 認証を行う場合（<a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication" target="_blank" rel="noopener">パススルー認証</a> を含む）にのみ使用できます。</p>
<h4 id="スマート-ロックアウト"><a href="#スマート-ロックアウト" class="headerlink" title="スマート ロックアウト"></a>スマート ロックアウト</h4><p>クラウドでは、スマート ロックアウトを使用して、正当と思われるユーザーからのサインイン試行と攻撃者と思われるユーザーからのサインイン試行を区別します。正当なユーザーがアカウントを使用できるようにしながら、攻撃者をロックアウトすることができます。これにより、ユーザーへのサービス拒否が防止され、繰り返しのパスワードスプレー攻撃が阻止されます。 これは、Azure AD に対してのすべてのサインイン、 Microsoft アカウントを利用したすべてのサインインについてライセンスのレベルによらず対象とします。</p>
<p>Active Directory Federation Services (AD FS) をご利用のテナントでは、2018 年 3 月に、Windows Server 2016 の AD FS でスマート ロックアウトを利用可能となります。Windows Update による提供をお待ちください。</p>
<h4 id="IP-ロックアウト"><a href="#IP-ロックアウト" class="headerlink" title="IP ロックアウト"></a>IP ロックアウト</h4><p>IP ロックアウトは、数十億のサインインを分析して、マイクロソフトのシステムにアクセスを試みる各 IP アドレスからのトラフィックの性質を評価する仕組みです。分析により、IP ロックアウトは悪意を持って動作する IP アドレスを見つけ、そのサインインをリアルタイムでブロックします。</p>
<h4 id="攻撃のシミュレーション"><a href="#攻撃のシミュレーション" class="headerlink" title="攻撃のシミュレーション"></a>攻撃のシミュレーション</h4><p><a href="https://techcommunity.microsoft.com/t5/Security-Privacy-and-Compliance/Announcing-the-Public-Preview-of-Attack-Simulator-for-Office-365/ba-p/162412" target="_blank" rel="noopener">現在公開中のプレビュー機能</a> ですが、Office 365 Threat Intelligence では攻撃シミュレーターの機能を利用いただけます。これにより、自らのシステムに対して攻撃のシミュ―レーションを行うことができます。その結果をもとにセキュリティ ポリシーを更新することや、パスワード スプレー攻撃のような脅威から組織を守るために適切なツールを社内に準備しておくこともできます。</p>
<img src="/blog/azure-active-directory/password-sprey-attack/fig1-attack-simulator.jpg">
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>クラウド認証を使用する (すでに利用中の場合は問題ありません)</li>
<li>AD FS などのハイブリッド シナリオを使用している場合は、2018 年 3 月のスマート ロックアウトのための AD FS アップグレードを検討する</li>
<li><a href="https://techcommunity.microsoft.com/t5/Security-Privacy-and-Compliance/Announcing-the-Public-Preview-of-Attack-Simulator-for-Office-365/ba-p/162412" target="_blank" rel="noopener">攻撃のシミュレーター</a> を使用し、セキュリティの体制を評価し必要な対策を実施する</li>
</ol>
<h3 id="Step-2-多要素認証の使用"><a href="#Step-2-多要素認証の使用" class="headerlink" title="Step 2: 多要素認証の使用"></a>Step 2: 多要素認証の使用</h3><p>パスワードはアカウントにアクセスするための鍵となる情報であり攻撃者はパスワード スプレー攻撃を利用することで正しいパスワードを入手しようとします。これを止めるには、アカウント所有者と攻撃者を区別するためにパスワード以外のものを用意する必要があります。これを行う 3 つの方法は以下の通りです。</p>
<h4 id="リスク-ベースの多要素認証"><a href="#リスク-ベースの多要素認証" class="headerlink" title="リスク ベースの多要素認証"></a>リスク ベースの多要素認証</h4><p>Azure AD Identity Protection は、サインイン データを使用し、高度な機械学習と検出アルゴリズムを駆使して、システムに来るすべてのサインインのリスク スコアを算出します。 これにより、企業での Azure AD 利用者は Identity Protection にポリシーを作成して、ユーザーまたはセッションに対してリスクが検出された場合にのみ、ユーザーに追加での認証を促すことができます。これでユーザーの負担を軽減しつつも、攻撃者をブロックすることができます。<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-identityprotection" target="_blank" rel="noopener">Azure AD Identity Protection の詳細はこちら</a> をご覧ください。</p>
<img src="/blog/azure-active-directory/password-sprey-attack/fig2-risk-based-mfa.jpg">
<h4 id="多要素認証の強制"><a href="#多要素認証の強制" class="headerlink" title="多要素認証の強制"></a>多要素認証の強制</h4><p>さらにセキュリティを強化するため、Azure MFA を使用して、クラウド認証と AD FS の両方で、常にユーザーに対して多要素認証を要求することができます。 これにより、エンドユーザーは常にデバイスを携行し、多要素認証を頻繁に実行する必要がありますが、エンタープライズ環境で最も高いセキュリティが得られます。組織内のすべての管理者で MFA を有効にすることを推奨します。詳細については、<a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication" target="_blank" rel="noopener">Azure 多要素認証の詳細</a>、および <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa" target="_blank" rel="noopener">AD FS 用の Azure MFA の設定方法</a> をご覧ください。</p>
<h4 id="Azure-MFA-をプライマリな認証方法とする"><a href="#Azure-MFA-をプライマリな認証方法とする" class="headerlink" title="Azure MFA をプライマリな認証方法とする"></a>Azure MFA をプライマリな認証方法とする</h4><p>AD FS 2016 では、<a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa" target="_blank" rel="noopener">パスワードなしの認証として Azure MFA をプライマリ認証で使用</a> できます。パスワードを使用しなければ、攻撃者は推測できなくなりますので、パスワード スプレーおよびパスワードの窃取攻撃を防ぐ優れた方法になります。また、様々なタイプのデバイスにも最適です。さらに、Azure MFA で OTP (One Time Password) を検証した後にのみ、パスワードを 2 番目の要素として使用できるようになりました。詳細は <a href="https://github.com/Microsoft/adfsAuthAdapters" target="_blank" rel="noopener">第 2 の要素としてパスワードを使用する方法</a> をご覧ください。</p>
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>組織内のすべての管理者、特にサブスクリプション所有者とテナント管理者に対して、常に多要素認証を有効にすることを強くお勧めします。まだの場合は今すぐに設定ください。</li>
<li>一般のユーザーにとって最高のエクスペリエンスを得るため、Azure AD Premium P2ライセンスで利用可能なリスクベースの多要素認証を検討する。</li>
<li>それ以外の場合は、クラウド認証と AD FS に Azure MFA を使用する。</li>
<li>AD FS では、Windows Server 2016 の AD FS にアップグレードし、特にすべてのエクストラネットアクセスに対して Azure MFA をプライマリ認証として使用する。</li>
</ol>
<h3 id="Step-3-より安全なパスワードの使用"><a href="#Step-3-より安全なパスワードの使用" class="headerlink" title="Step 3: より安全なパスワードの使用"></a>Step 3: より安全なパスワードの使用</h3><p>上記のすべての対策を行った場合でも、パスワード スプレー対策で重要なのは、すべてのユーザーが推測の難しいパスワードを使用することです。 ユーザーが作成したパスワードが推測困難かどうか、自分で判断することは容易ではありません。マイクロソフトでは、安全性の高いパスワードを作るため以下のようなツールを提供しています。</p>
<h4 id="禁止パスワード"><a href="#禁止パスワード" class="headerlink" title="禁止パスワード"></a>禁止パスワード</h4><p>Azure AD では、すべてのパスワードの変更とリセット時に禁止パスワードのチェックが行われます。 新しいパスワードが送信されると、パスワードに含めるべきではない単語のリストと曖昧さを考慮してマッチングされます (また、綴りを記号で置き換える leetspeak -&gt; l33t-sp3@k のようなものもチェックされます)。マッチングされると拒否され、ユーザーは推測することが難しいパスワードにするよう求められます。 マイクロソフトでは最もよく攻撃されるパスワードのリストを作成し、頻繁に更新しています。</p>
<img src="/blog/azure-active-directory/password-sprey-attack/fig3-banned-password.jpg">
<h4 id="禁止パスワードのカスタマイズ"><a href="#禁止パスワードのカスタマイズ" class="headerlink" title="禁止パスワードのカスタマイズ"></a>禁止パスワードのカスタマイズ</h4><p>禁止パスワードをより効果のあるものにするため、テナントで <strong>禁止パスワードのリストをカスタマイズ</strong> できるようにする予定です。管理者は、有名な社員や創業者、製品、場所、地域の名物など、組織で共有される言葉を選択し、ユーザーのパスワードへの使用を制限することができます。 このリストはマイクロソフトが用意している一覧に加えて強制されるので、どちらかを選択する必要はありません。 現在は限定プレビュー版ですが、今年中に公開予定です。</p>
<h4 id="オンプレミス環境における禁止パスワード"><a href="#オンプレミス環境における禁止パスワード" class="headerlink" title="オンプレミス環境における禁止パスワード"></a>オンプレミス環境における禁止パスワード</h4><p>今春、マイクロソフトはハイブリッドな <strong>Azure AD - Active Directory 環境でエンタープライズ管理者が禁止パスワードの設定を行う</strong> ためのツールをリリースします。 禁止されたパスワード リストは、クラウドからオンプレミス環境に同期され、エージェントがインストールされたすべてのドメイン コントローラーに適用されます。これにより、管理者は、ユーザーがクラウドもしくはオンプレミスのどちらでも自分のパスワードを変更する場所に関係なく、ユーザーのパスワードを推測困難にすることができます。 2018 年 2 月に限定プレビューが開始され、今年中に公開予定です。</p>
<h4 id="パスワードに関するとらえ方を変える"><a href="#パスワードに関するとらえ方を変える" class="headerlink" title="パスワードに関するとらえ方を変える"></a>パスワードに関するとらえ方を変える</h4><p>良いパスワードとはどういうものかというこれまでの一般的な考え方の多くが実は間違っています。数学的に正しいことでも、実は予測しやすいユーザー行動を招くことがわかっています。例えば、ある文字種別をパスワードに要求したり、定期的なパスワードの変更を要求したりすると、特定のパスワード パターンが発生することがわかっています。詳細については、<a href="https://aka.ms/passwordguidance" target="_blank" rel="noopener">パスワード ガイダンス ホワイト ペーパー</a> をお読みください。PTA (Pass-Through Authentication) または AD FS で Active Directory を使用している場合は、<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc770842(v=ws.10" target="_blank" rel="noopener">パスワード ポリシー</a>) を更新ください。クラウドのマネージド アカウントを使用している場合は、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-passwords-policy" target="_blank" rel="noopener">パスワードを無期限に設定する</a> ことを検討ください。</p>
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>禁止パスワードツールがリリースされたら、ユーザーがより良いパスワードを作成できるように、オンプレミスの環境にインストールする。</li>
<li>パスワード ポリシーを確認し、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-passwords-policy" target="_blank" rel="noopener">パスワードを無期限に設定</a> して、ユーザーが周期的なパターンを使用してパスワードを作成しないようにします。</li>
</ol>
<h3 id="Step-4-AD-FS-と-Active-Directory-についてのさらなる新機能"><a href="#Step-4-AD-FS-と-Active-Directory-についてのさらなる新機能" class="headerlink" title="Step 4: AD FS と Active Directory についてのさらなる新機能"></a>Step 4: AD FS と Active Directory についてのさらなる新機能</h3><p>AD FS と Active Directory とのハイブリッド認証を使用している場合は、パスワード スプレー攻撃からご利用の環境を保護するためにとれる対策がさらにあります。</p>
<p>まず、AD FS 2.0 または Windows Server 2012 をご利用の組織では、できるだけ早く Windows Server 2016 の AD FS への移行を検討ください。最新バージョンは、外部ネットワークのロックアウト (Extranet lockout) など、より豊富な機能があり、より頻繁にアップデートが提供されます。なお、Windows Server 2012 R2 からであれば 2016 へのアップグレードは非常に簡単です。</p>
<h4 id="外部ネットワークからのレガシー認証のブロック"><a href="#外部ネットワークからのレガシー認証のブロック" class="headerlink" title="外部ネットワークからのレガシー認証のブロック"></a>外部ネットワークからのレガシー認証のブロック</h4><p>レガシー認証のプロトコルには多要素認証を強制する機能がないため、<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-conditional-access-no-modern-authentication" target="_blank" rel="noopener">外部ネットワークからレガシー認証でのアクセスをブロックする</a> のが最善の方法です。これにより、MFA を利用できないプロトコル上の穴をついてパスワード スプレー攻撃を仕掛けてくることを防ぐことができます。</p>
<h4 id="AD-FS-Web-アプリケーション-プロキシでの-Extranet-Lockout-機能の有効化"><a href="#AD-FS-Web-アプリケーション-プロキシでの-Extranet-Lockout-機能の有効化" class="headerlink" title="AD FS Web アプリケーション プロキシでの Extranet Lockout 機能の有効化"></a>AD FS Web アプリケーション プロキシでの Extranet Lockout 機能の有効化</h4><p>AD FS Web アプリケーションプロキシで Extranet Lockout 機能を実行していない場合は、<a href="https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-extranet-lockout" target="_blank" rel="noopener">可能な限り早く有効</a> にして、今後発生する可能性のあるブルートフォース攻撃からユーザーを保護ください。</p>
<h4 id="Azure-AD-Connect-Health-の展開"><a href="#Azure-AD-Connect-Health-の展開" class="headerlink" title="Azure AD Connect Health の展開"></a>Azure AD Connect Health の展開</h4><p>Azure AD Connect Health は、AD FS ログに記録された不正なユーザー名/パスワードによるログイン試行の IP アドレスを記録します。これにより様々なシナリオに関する追加情報を提供するとともに、サポートのお問い合わせを発行いただいた際にはサポート エンジニアに対して追加の知見を提供します。</p>
<p>展開するには、すべての AD FS サーバーに最新バージョンの <a href="https://go.microsoft.com/fwlink/?linkid=518973" target="_blank" rel="noopener">AD FS 用 Azure AD Connect Health Agent</a> をダウンロードします。AD FS サーバーは、<a href="https://support.microsoft.com/en-us/help/3134787/ad-fs-logs-don-t-contain-client-ip-address-for-account-lockout-scenarios-in-windows-server-2012-r2" target="_blank" rel="noopener">KB3134222</a> がインストールされた Windows Server 2012 R2 または Windows Server 2016 上で実行されている必要があります。</p>
<h4 id="非パスワード-ベースの認証方法の採用"><a href="#非パスワード-ベースの認証方法の採用" class="headerlink" title="非パスワード ベースの認証方法の採用"></a>非パスワード ベースの認証方法の採用</h4><p>パスワードがなければ、パスワードは推測されません。次のような非パスワード ベースの認証方法が、AD FS および Web アプリケーション プロキシで使用できます。</p>
<ol>
<li>証明書ベースの認証により、ユーザー名/パスワードの認証で利用するエンドポイントをファイアウォールで完全にブロックすることができます。証明書ベースの認証についての詳細は、<a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-user-certificate-authentication" target="_blank" rel="noopener">AD FS での証明書ベース認証</a> で確認ください。</li>
<li>Azure の多要素認証は、上述のとおり、クラウド認証と AD FS 2012 R2 および 2016 の第二要素として使用できますが、パスワード スプレーの可能性を完全に排除するために AD FS 2016 の第一要素としても使用できます。 <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-and-azure-mfa" target="_blank" rel="noopener">AD FS を使用して Azure MFA を設定する方法についてはこちら</a> をご覧ください。</li>
<li>Windows 10 のクライアント、Windows Server 2016 の AD FS で利用できる Windows Hello for Business は、ユーザーとデバイスの両方に紐付けられた強力な暗号化キーに基づいて、外部ネットワークも含めた完全な非パスワードベースの認証を可能にします。これは、Azure AD 参加および Hybrid Azure AD 参加している組織で管理されるデバイスに加え、設定アプリから「職場や学校のアカウントを追加」を介して登録したパーソナル デバイスでも利用できます。<a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-azureadjoin-passport" target="_blank" rel="noopener">Windows Hello for Business の詳細についてはこちら</a> をご覧ください。</li>
</ol>
<p>今すぐに以下の点を検討ください。</p>
<ol>
<li>より迅速に製品の更新を得るため AD FS 2016 にアップグレードする。</li>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-conditional-access-no-modern-authentication" target="_blank" rel="noopener">外部ネットワーク</a> からレガシー認証をブロックする。</li>
<li>すべての AD FS サーバーに Azure AD Connect Health をインストールする。</li>
<li>Azure MFA、証明書ベースの認証、Windows Hello for Business などパスワードを使用しないプライマリの認証方式の利用をする。</li>
</ol>
<h2 id="おまけ-Microsoft-アカウントの保護について"><a href="#おまけ-Microsoft-アカウントの保護について" class="headerlink" title="おまけ: Microsoft アカウントの保護について"></a>おまけ: Microsoft アカウントの保護について</h2><p>Microsoft アカウントをご利用の場合:</p>
<ul>
<li>あなたはすでに保護されています！ Microsoft アカウントでは、Smart Lockout、IP ロックアウト、リスクベースの 2 ステップ認証、禁止パスワードなどが有効です。</li>
<li>ただし、2 分ほどお時間をとっていただき、Microsoft アカウントの<a href="https://account.microsoft.com/security" target="_blank" rel="noopener">セキュリティ ページ</a> に移動して、「セキュリティ情報を更新する」を選択し、リスクベースの 2 段階認証に使用するセキュリティ情報を確認ください。</li>
<li>アカウントのセキュリティを最大限に高めるため、<a href="https://account.live.com/proofs/Manage/additional" target="_blank" rel="noopener">こちら</a> から常に 2 段階認証をオンにすることを検討ください。</li>
</ul>
<h2 id="最良の防衛策は…-このブログの推奨事項に従うこと"><a href="#最良の防衛策は…-このブログの推奨事項に従うこと" class="headerlink" title="最良の防衛策は… このブログの推奨事項に従うこと"></a>最良の防衛策は… このブログの推奨事項に従うこと</h2><p>パスワード スプレーは、インターネット上でパスワードを使用するすべてのサービスにとって深刻な脅威です。しかし、今回のブログの手順を実行することで、パスワードスプレーに対する最大限の対策を行えます。そして、多くの種類の攻撃が共通の特性を有しているため、今回説明した手法は他の脅威に対しても効果的です。お客様のセキュリティは常にマイクロソフトの最優先事項であり、パスワードスプレーなどあらゆるタイプの攻撃に対して、より新しく高度な防御策を開発するために絶えず尽力しています。 今回紹介した対策方法を利用し、インターネット上の攻撃者からサービスやシステムを守るため、新しい対処策を頻繁にチェックいただければと思います。</p>
<p>この情報がお役に立てば幸いです。いつものように、私たちは皆さんのご意見やご提案をお待ちしています。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/password-sprey-attack/" data-id="cjtz46pp9004ozcytbl4ll0gt" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/MFA/">MFA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Smart-lockout/">Smart lockout</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/azure-ad-purchase" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/azure-ad-purchase/" class="article-date">
  <time datetime="2018-02-27T15:00:00.000Z" itemprop="datePublished">2018-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/azure-ad-purchase/">Azure AD 有償ライセンスの購入方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は、Azure AD 有償ライセンスの購入方法についてご案内します。Azure AD は、Azure サブスクリプションや Office 365 をご利用いただく際の認証基盤として、無償で提供されます。一方で Azure AD の有償ライセンスも用意されており、こちらを購入することで、様々な追加機能をご利用いただけます。</p>
<p>各ライセンスの機能差異についての詳細は、リンクをご参照ください。基本的にはライセンスはその機能を利用するユーザーに割り当てる必要があるのですが、各機能における必要なライセンス数などは別途それぞれの機能の公開情報などをご確認ください。</p>
<h2 id="有償ライセンスの購入方法"><a href="#有償ライセンスの購入方法" class="headerlink" title="有償ライセンスの購入方法"></a>有償ライセンスの購入方法</h2><p>オンラインから購入する場合は、Office 365 ポータルより購入の手続きを実施します。</p>
<p>※もし、販売元のパートナー様を介する場合などオンライン以外から購入予定の場合は、その販売元や場合によっては弊社営業などにご確認ください。</p>
<p>「Office 365 は利用していない」というお客様もいらっしゃるかと思いますが、Azure のサブスクリプションを契約している、そうすると必ず Azure AD を利用していることになるのですが、この場合管理者のアカウントで Office 365 ポータルにログインすることができます。こちらは、Office 365 の認証基盤も Azure と同じく Azure AD を利用しているためであり、Azure AD のライセンスの体系が Office 365 のライセンスと同様に Azure のサブスクリプションとは異なり、 Azure AD テナントに割り当たる体系になるためこのような実装になっています。</p>
<p>もちろんOffice 365 ポータルにログインできるからといって Office 365 のライセンスをお持ちでない場合は Office 365 の各種サービスは利用できません。また、勝手に Office 365 の契約がされてしまうこともありません。Office 365 や Azure サブスクリプション、Azure AD についての説明は、別途リンクの内容もご参照ください。</p>
<p>それでは、購入方法についてご紹介します。</p>
<ol>
<li>Office 365 ポータルに、Azure AD の全体管理者ユーザーでサインインします。</li>
<li>管理センターの画面で、左側のメニューから[課金情報] - [サービスを購入する]を選択します。</li>
<li>サービスを購入する の画面が表示されたところで、該当のライセンスを探します。[今すぐ購入します]を選択します</li>
<li>必要なユーザー数を選択いただき、[今すぐ支払う]を選択し、購入を進めます。(クレジット カードの情報などを入力します)</li>
</ol>
<p>手順については以上となります。</p>
<h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p>Q. 費用は Azure のサブスクリプションの費用に加算されますか？</p>
<p>A. いいえ、Azure AD のライセンスと Azure サブスクリプションは別の契約形態になります。そのため、Azure サブスクリプションで利用している残高で、Azure AD のライセンス料金を支払うことはできません。</p>
<p>Q. Office 365 ポータルにログインして、ライセンスが購入可能なユーザーの詳細を教えてください。</p>
<p>A. 職場または学校アカウント (組織アカウント) であり、Azure AD の全体管理者もしくは課金管理者である必要があります。Microsoft アカウント (個人アカウント) では、Office 365 ポータルにログインすることはできません。また、招待された組織ユーザーでも Office 365 ポータルには、招待元のアカウントとしてサインインするため、ここでライセンスの購入を実施すると、意図せずに招待元に紐づくため、 Office 365 ポータルに入った後に意図している Azure AD に接続しているか、ユーザー一覧などを確認の上、作業を実施することをお勧めいたします。</p>
<p>Q. ライセンスの割り当ては、Office 365 ポータルと Azure ポータルのどちらで可能か。</p>
<p>A. 購入したライセンスは、どちらのポータルでも参照でき、割り当てもどちらからも実施可能です。Azure ポータルより操作する場合は以下のようにします。</p>
<ol>
<li>Azure ポータル にアクセスします。</li>
<li>[Azure Active Directory] にアクセスします。</li>
<li>[ライセンス] を選択します。</li>
<li>[すべての製品] を選択します。</li>
<li>購入した ライセンスを選択します。</li>
<li>[ライセンスされているユーザー] に [割り当て] を選択して割り当てます (※ 事前にユーザー プロファイルより、「利用場所」を設定する必要があります。設定していない場合はライセンスの割り当てに失敗します。)</li>
</ol>
<p>Office 365 ポータルより操作する場合は以下のとおりです。</p>
<ol>
<li>Office 365 ポータルに、管理者ユーザーでサインインします。</li>
<li>管理センターの画面で、「ユーザー」を選択します。</li>
<li>ライセンスを付与したいユーザーを選択します。</li>
<li>「製品ライセンス」の部分の編集を選択し、購入したライセンスを割り当てます。</li>
</ol>
<p>Q. ライセンスの利用場所とはなんですか？</p>
<p>A. そのユーザーがライセンスを使用する地域を設定します。Office 365 のサービスと機能を使用できるかどうかは、国または地域によって異なるため利用場所の選択が必要です。</p>
<p>Q. ライセンスは1 個単位で月ベースで購入可能か。</p>
<p>A. オンラインからの購入であれば、1個単位で購入が可能です。期間は年間契約 (年支払い or 月々の支払) になりますので、月単位での購入はできません。試用版も用意していますので、短期間の場合は、まず試用版をお試しください。試用版ライセンスの手順は以下のとおりです。</p>
<ol>
<li>Azure ポータルにアクセスします。</li>
<li>[Azure Active Directory] にアクセスします。</li>
<li>[ライセンス] を選択します。</li>
<li>[すべての製品] を選択します。</li>
<li>[試用/購入] を選択します。</li>
<li>AZURE AD PREMIUM P2 の選択肢が表示されますので [無料試用版] を選択します。</li>
<li>30 日間利用いただけますので、[アクティブ化] を選択します。</li>
</ol>
<p>こちらで、30 日間無料で、Azure AD Premium P2 ライセンスの機能を試すことができます。なお、30 日間経過後に自動で有償ライセンスに移行するといった動作はありませんのでその点ご安心ください。一度試用版の有効期限が経過すると、再度試用を有効にすることはできません。 </p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/azure-ad-purchase/" data-id="cjtz46plj000azcytahwmr0tw" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD-License/">Azure AD License</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/aad-token-lifetime" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/aad-token-lifetime/" class="article-date">
  <time datetime="2018-02-27T15:00:00.000Z" itemprop="datePublished">2018-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/aad-token-lifetime/">Azure AD が発行するトークンの有効期間について</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの金森です。</p>
<p>Azure AD (AAD) は Office 365 をはじめ様々なクラウド サービスの認証基盤として利用されますが、その重要な機能として認証が完了したアカウントに対してトークンを発行するということがあります。<br>ここでのトークンとは Kerberos 認証におけるチケットに近いものです。AAD が発行するトークンの種類や有効期間の制御方法は以下の docs 技術情報として公開しています。</p>
<ul>
<li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-configurable-token-lifetimes" target="_blank" rel="noopener">Azure Active Directory における構成可能なトークンの有効期間 (パブリック プレビュー)</a></li>
</ul>
<p>今回の情報の中で、 AAD が発行するトークンにどのような種類があり、既定の状態ではトークンの有効期間はどうなっているのか、AAD ポリシーでどのような制御ができるのか、もう少しかみ砕いてご紹介いたします。<br>以下は説明における略語の一覧です。</p>
<table>
<thead>
<tr>
<th>略称</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr>
<td>AAD</td>
<td>Azure Active Directory の略です。</td>
</tr>
<tr>
<td>SSO</td>
<td>Single Sign On の略です。</td>
</tr>
<tr>
<td>IdP</td>
<td>Identity Provider の略です。以下の説明では AAD を指します。</td>
</tr>
<tr>
<td>SP</td>
<td>Service Provider の略です。以下の説明ではアクセス先のアプリケーションを指します。</td>
</tr>
<tr>
<td>ADAL</td>
<td>先進認証ライブラリの略です。OAuth 2.0 や OpenIDConnect のような昨今の業界標準プロトコルを用いた認証方式を利用できるライブラリを指します。</td>
</tr>
<tr>
<td>Confidential クライアント</td>
<td>サーバー上で動く Web アプリなどのように、シークレットを秘密にできるクライアントを指します。</td>
</tr>
<tr>
<td>Public クライアント</td>
<td>JS アプリやスマホ上のネイティブ アプリなどのように、シークレットを安全に格納できないクライアントを指します。</td>
</tr>
</tbody>
</table>
<h2 id="トークン種別-プロトコル、目的別"><a href="#トークン種別-プロトコル、目的別" class="headerlink" title="トークン種別 (プロトコル、目的別)"></a>トークン種別 (プロトコル、目的別)</h2><img src="/blog/azure-active-directory/aad-token-lifetime/token-type.jpg">
<h2 id="トークン有効期間-AAD-ポリシーの制御パラメーター別"><a href="#トークン有効期間-AAD-ポリシーの制御パラメーター別" class="headerlink" title="トークン有効期間 (AAD ポリシーの制御パラメーター別)"></a>トークン有効期間 (AAD ポリシーの制御パラメーター別)</h2><img src="/blog/azure-active-directory/aad-token-lifetime/token-lifetime.jpg">
<p>(*) に関して<br>以前の公開技術情報には <code>14 日</code> と記載されており、これは Public クライアントに対する以前の既定値でした。<br>現在の実装は Public クライアントも Confidential クライアントと同じ <code>90 日</code> に変更されています。</p>
<h2 id="既定値における有効期間の考え方"><a href="#既定値における有効期間の考え方" class="headerlink" title="既定値における有効期間の考え方"></a>既定値における有効期間の考え方</h2><p>トークンの更新タイミングと有効期間の考え方を説明します (既定値を例にしています)。</p>
<h3 id="ADAL-クライアントによる認証フローと有効期限の考え方"><a href="#ADAL-クライアントによる認証フローと有効期限の考え方" class="headerlink" title="ADAL クライアントによる認証フローと有効期限の考え方"></a>ADAL クライアントによる認証フローと有効期限の考え方</h3><img src="/blog/azure-active-directory/aad-token-lifetime/adalclientflow.jpg">
<p>ID トークンは OpenID Connect での認証時に ID の属性情報を提示するためのトークンであり、初回の SP へのアクセス時に提示された後は再利用されることが無いのが一般的です。<br>そのため、上記の図では初回の SP へのアクセスに伴う認証時のみ取得している表現となっています。<br>明示的な再認証が必要となるケースは以下の通りです。</p>
<ul>
<li>(既定では) 90 日間以上、ADAL クライアント アプリを停止した状態を維持する</li>
<li>認証した AAD ユーザーのパスワードを変更する</li>
<li>AAD 側で対象ユーザーに発行済みの更新トークンを操作により失効する</li>
</ul>
<h3 id="ブラウザ-クライアントによる-AAD-との-SSO-セッション-フローと有効期限の考え方"><a href="#ブラウザ-クライアントによる-AAD-との-SSO-セッション-フローと有効期限の考え方" class="headerlink" title="ブラウザ クライアントによる AAD との SSO セッション フローと有効期限の考え方"></a>ブラウザ クライアントによる AAD との SSO セッション フローと有効期限の考え方</h3><h4 id="非永続セッション-Cookie-の場合"><a href="#非永続セッション-Cookie-の場合" class="headerlink" title="非永続セッション (Cookie) の場合"></a>非永続セッション (Cookie) の場合</h4><img src="/blog/azure-active-directory/aad-token-lifetime/nokmsicookie.jpg">
<p>明示的な再認証が必要となるケースは以下の通りです。</p>
<ul>
<li>(既定では) 24 時間以上、Azure AD へのアクセスを行わない</li>
<li>認証した AAD ユーザーのパスワードを変更する</li>
<li>ブラウザを閉じる</li>
</ul>
<h4 id="永続セッション-Cookie-の場合"><a href="#永続セッション-Cookie-の場合" class="headerlink" title="永続セッション (Cookie) の場合"></a>永続セッション (Cookie) の場合</h4><img src="/blog/azure-active-directory/aad-token-lifetime/kmsicookie.jpg">
<p>明示的な再認証が必要となるケースは以下の通りです。</p>
<ul>
<li>(既定では) 180 日以上、Azure AD へのアクセスを行わない</li>
<li>認証した AAD ユーザーのパスワードを変更する</li>
<li>クライアント ローカルに保存された Cookie のキャッシュをクリアする</li>
</ul>
<h4 id="参考-SAML-トークンを使用した認証フローと有効期間の考え方"><a href="#参考-SAML-トークンを使用した認証フローと有効期間の考え方" class="headerlink" title="参考: SAML トークンを使用した認証フローと有効期間の考え方"></a>参考: SAML トークンを使用した認証フローと有効期間の考え方</h4><p>SAML トークンは SAML プロトコルに準じた用途として <code>SAML 認証に対応した SP へ提示しユーザー認証を行う</code> ためのものです。SP へのアクセス時に提示した後は通常利用されることはありません。<br>AAD 制御ポリシーの <code>AccessTokenLifetime</code> パラメーターを変更すると、SAML トークン内の Conditions 要素にある NotOnOrAfter 属性が併せて変更されます。これにより、SAML トークンの有効期限を制御できます。SP は提示された SAML トークンの有効期限を見て、タイムアウトを確認することができます。<br>一般的にはクライアントが SAML トークンを取得してから即座に SP へ取得したトークンを提示することから、 SAML トークンの有効期限が切れることは通常ございません。</p>
<img src="/blog/azure-active-directory/aad-token-lifetime/samlflow.jpg">
<p>明示的な再認証が必要となるケース</p>
<ul>
<li>(既定では) 24 時間以上、既存のセッション Cookie の再利用が必要な SP へのアクセスを行わない (結果、24 時間以上、AAD へのアクセスを行わない)</li>
</ul>
<h3 id="MaxAge-～-名のポリシーの考え方"><a href="#MaxAge-～-名のポリシーの考え方" class="headerlink" title="MaxAge ～ 名のポリシーの考え方"></a>MaxAge ～ 名のポリシーの考え方</h3><p>MaxAge ～ 名のポリシーは <code>最終的にいつまで同じトークンを利用し続けられるか</code> を定義するパラメーターです。<br>既定では <code>失効するまで = 無期限</code> となり、上述の考え方が合致します。<br>以下に、MaxAge ポリシーを用いた場合の有効期間の考え方をご紹介します。</p>
<h4 id="ADAL-クライアント-MaxAgeSingle-MultiFactor-を-100-日にした場合"><a href="#ADAL-クライアント-MaxAgeSingle-MultiFactor-を-100-日にした場合" class="headerlink" title="ADAL クライアント : MaxAgeSingle/MultiFactor を 100 日にした場合"></a>ADAL クライアント : MaxAgeSingle/MultiFactor を 100 日にした場合</h4><img src="/blog/azure-active-directory/aad-token-lifetime/adalclient100d.jpg">
<h4 id="非永続ブラウザ-クライアント-MaxAgeSessionSingle-MultiFactor-を-30-時間にした場合"><a href="#非永続ブラウザ-クライアント-MaxAgeSessionSingle-MultiFactor-を-30-時間にした場合" class="headerlink" title="非永続ブラウザ クライアント : MaxAgeSessionSingle/MultiFactor を 30 時間にした場合"></a>非永続ブラウザ クライアント : MaxAgeSessionSingle/MultiFactor を 30 時間にした場合</h4><img src="/blog/azure-active-directory/aad-token-lifetime/nokmsiclient30h.jpg">
<h4 id="永続ブラウザ-クライアント-MaxAgeSessionSingle-MultiFactor-を-200-日にした場合"><a href="#永続ブラウザ-クライアント-MaxAgeSessionSingle-MultiFactor-を-200-日にした場合" class="headerlink" title="永続ブラウザ クライアント : MaxAgeSessionSingle/MultiFactor を 200 日にした場合"></a>永続ブラウザ クライアント : MaxAgeSessionSingle/MultiFactor を 200 日にした場合</h4><img src="/blog/azure-active-directory/aad-token-lifetime/kmsiclient200d.jpg">
<h4 id="MaxAgeSessionSingleFactor-を-1-時間にした場合"><a href="#MaxAgeSessionSingleFactor-を-1-時間にした場合" class="headerlink" title="MaxAgeSessionSingleFactor を 1 時間にした場合"></a>MaxAgeSessionSingleFactor を 1 時間にした場合</h4><img src="/blog/azure-active-directory/aad-token-lifetime/browserclient1h.jpg">
<p>AAD トークンの有効期間ポリシーを作成する手順は、docs 技術情報の <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-configurable-token-lifetimes#example-token-lifetime-policies" target="_blank" rel="noopener">トークンの有効期間ポリシーの例</a> のコーナーをぜひご参照ください。<br>(本コーナーにて使用している Azure AD PowerShell の利用準備については<a href="/blog/./powershell-module/">リンク</a>もご参照ください)</p>
<p>上記内容が皆様の参考となりますと幸いです。どちら様も素敵な AAD ライフをお過ごしください。</p>
<p>ご不明な点等がありましたら、ぜひ弊社サポート サービスをご利用ください。<br>※本情報の内容（リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/aad-token-lifetime/" data-id="cjtz46pnq0037zcytcl8yy0js" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/OAuth/">OAuth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Token/">Token</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-active-directory-federation-service/claim-rule-conditional-access" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../active-directory-federation-service/claim-rule-conditional-access/" class="article-date">
  <time datetime="2018-01-29T15:00:00.000Z" itemprop="datePublished">2018-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../active-directory-federation-service/claim-rule-conditional-access/">クレーム ルールと条件付きアクセスの比較</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は AD FS を利用したクレーム ルールとAzure AD を利用した条件付きアクセスについて比較します。これまで AD FS のクレーム ルールでアクセス制御を実施しているが、条件付きアクセスの機能にも興味をお持ちの方も多いかと思います。今後の運用においてクレーム ルールと条件付きアクセスのどちらで運用を行うか検討するにあたり少しでも本記事がお役に立ちましたら幸いです。</p>
<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>クレーム ルールと条件付きアクセスは、両者ともに指定した条件に応じて認証アクセスの制御を行うことができます。例えば、多要素認証を発生させるための条件設定は、クレーム ルールでも条件付きアクセスでも可能です。</p>
<p>それぞれを利用する際に必要な前提条件は次のとおりです。</p>
<ul>
<li><p>クレーム ルール</p>
<p>  AD FS 環境が必須です。AD FS を利用した認証フローとなるため、認証についてはオンプレミス側で行います。</p>
</li>
<li><p>条件付きアクセス</p>
<p>  Azure AD 環境が必須です。また、条件付きアクセスの利用には、利用するユーザー分 Azure AD Premium のライセンスが必要です。AD FS が導入されている環境においても、条件付きアクセスを利用することが可能です。</p>
</li>
</ul>
<h2 id="コスト比較"><a href="#コスト比較" class="headerlink" title="コスト比較"></a>コスト比較</h2><p>まずは、重要となるコスト面について比較してみましょう。</p>
<ul>
<li><p>クレーム ルール</p>
<p>  AD FS 環境が必須となりますが、すでに AD FS を導入済みの環境の場合は、クレーム ルール設定のための追加コストは不要です。ただ、クレーム ルール自体は少し書き方が特殊なのとメンテナンスが必要で、メンテナンスに要する人的なコストは考慮する必要があります。サポートでクレーム ルールをいただいてみたら、連携先が新しい認証方式に対応していてクレーム ルールが使われていなかったというケースもあります。</p>
</li>
<li><p>条件付きアクセス</p>
<p>  条件付きアクセスを利用するユーザー分の Azure AD Premium (P1 または P2) のライセンスが必要となります。例えば、Azure AD 内に 1000 人のユーザーを登録している環境で特定の 300 人に対して条件付きアクセスの制御を行いたい場合は、300 ライセンス必要となります。詳細な価格情報については、下記の情報を参照ください。</p>
<p>  Azure Active Directory の価格<br>  <a href="https://azure.microsoft.com/ja-jp/pricing/details/active-directory/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/pricing/details/active-directory/</a></p>
</li>
</ul>
<h2 id="機能比較"><a href="#機能比較" class="headerlink" title="機能比較"></a>機能比較</h2><p>続いて、検討材料のメインとなるであろう機能について比較してみましょう。</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">クレーム ルール</th>
<th style="text-align:center">条件付きアクセス</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADAL への対応</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>非　ADAL への対応</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td>アプリケーション毎の制御</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○ ※2</td>
</tr>
<tr>
<td>ユーザーやグループによる制御</td>
<td style="text-align:center">○</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>IP アドレス ベースでの制御</td>
<td style="text-align:center">○</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>OS の種類による制御</td>
<td style="text-align:center">△ ※3</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>多要素認証</td>
<td style="text-align:center">○ ※4</td>
<td style="text-align:center">○ ※5</td>
</tr>
<tr>
<td>Intune との連携</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>デバイス ベースの制御</td>
<td style="text-align:center">△ ※6</td>
<td style="text-align:center">○ ※7</td>
</tr>
<tr>
<td>GUI での設定</td>
<td style="text-align:center">○</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>コマンドラインでの設定</td>
<td style="text-align:center">○</td>
<td style="text-align:center">×</td>
</tr>
</tbody>
</table>
<p>※ 1: user-agent などによりアプリケーションの特定が可能なものもありますが、OS  やアプリケーションのバージョンによって変更される可能性があり、厳密な判別には十分な検証が必要です。また、ADAL を利用するアプリケーションは、 user-agent はブラウザと区別が付かず、アプリケーション固有のクレームでの判別が困難です。</p>
<p>※ 2: 利用可能なアプリケーションについては下記の情報を参照ください。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-conditional-access-technical-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-conditional-access-technical-reference</a></p>
<p>※ 3: 既定では、OS の情報は取得できないため、別途デバイス認証を追加設定する必要があります。</p>
<p>※ 4 ※ 5: AD FS の多要素認証としては、証明書認証を使用するのが一般的です。一方で、条件付きアクセス (Azure MFA) では、電話、テキストコード、モバイルアプリ (Authenticator) が使用可能です (証明書認証は不可)。それぞれ利用できる多要素認証の種類が異なるため、重要な検討材料になります。</p>
<p>※ 6 ※ 7: AD FS においては、証明書認証とデバイス認証の方法がありますが、証明書認証はモバイル端末への証明書の配布方法、デバイス認証は各種デバイスの対応状況に課題があります (例えば、Windows 10 は AD FS 3.0 のデバイス認証に対応していません)。</p>
<p>一方で、条件付きアクセスでは Windows 端末がドメイン参加していることを条件に制御することができます。また、Intune に登録済みのデバイスを準拠済みデバイスとして制御可能です。詳細については、<a href="https://blogs.technet.microsoft.com/jpazureid/2018/01/25/device_access/" target="_blank" rel="noopener">リンク</a> の記事もご参照ください。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>現時点においても、条件付きアクセスは細かな制御に対応してきており、かつ今後の機能拡張も期待できます。なお、条件付きアクセスに関するよくあるお問い合わせについてもご紹介しておりますので、参考になれば幸いです。</p>
<p>今回、機能についてはお問い合わせの多いものを抜粋してご紹介させていただきました。より、詳細な内容の確認やお客様のご要望に沿った制御方法についてのご質問については、ぜひ弊社サポートサービスをご利用ください。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/active-directory-federation-service/claim-rule-conditional-access/" data-id="cjtz46pko0000zcytvzipjufu" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Conditional-Access/">Conditional Access</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/azure-ad-reporting-api" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/azure-ad-reporting-api/" class="article-date">
  <time datetime="2018-01-27T15:00:00.000Z" itemprop="datePublished">2018-01-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/azure-ad-reporting-api/">Azure AD Reporting API を利用して PowerShell より Azure AD のサインイン アクティビティ レポートと監査アクティビティ レポートを CSV ファイルで取得する方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの 姚 (ヨウ)です。</p>
<p>Azure AD のサインイン アクティビティ レポートと監査アクティビティ レポートの保持期間は決まっており、例えばサインイン アクティビティであれば Azure AD Premium のライセンスがテナントに割り当てられていても 30 日です。</p>
<p>そのため、それ以前のデータを確認したい場合には、予めログをエクスポートしてバックアップしておく必要があります。</p>
<p>バックアップは、 Azure ポータルで行うことはできるのですが、手動で定期的にバックアップをすることは手間ですが、そのような場合には Azure Active Directory Reporting API を利用して PowerShell よりおこなうこともできます。</p>
<p>以下の公開情報では、それぞれのレポートを PowerShell スクリプトを用いて取得する方法を紹介しています。</p>
<ul>
<li><p>Azure Active Directory サインイン アクティビティ レポート API のサンプル</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-sign-in-activity-samples" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-sign-in-activity-samples</a></p>
</li>
</ul>
<ul>
<li><p>Azure Active Directory レポートの監査 API の例</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-audit-samples" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-audit-samples</a></p>
</li>
</ul>
<p>しかし、上記の方法は、レポートを .json ファイル形式で保持し、取得する方法です。</p>
<p>json ファイル形式は以下のようになり、このままは利用しづらいフォーマットです。</p>
<img src="/blog/azure-active-directory/azure-ad-reporting-api/jasonfiles1-1024x290.png">
<p>ポータルからは以下のような .csv ファイル形式でダウンロードできますので、この形式で入手したいという要望をお持ちの方も多いと思います。</p>
<img src="/blog/azure-active-directory/azure-ad-reporting-api/csv2.png">
<p>今回は PowerShell スクリプトで .csv ファイル形式で取得する方法を紹介します。</p>
<ol>
<li><p>以下の URL にアクセスし、 右上にある “Raw” を右クリックし、”対象をファイルの保存” をクリックし、azureadutils.psm1 をダウンロードします。</p>
<p><a href="https://github.com/AzureAD/azure-activedirectory-powershell/blob/gh-pages/Modules/AzureADUtils/AzureADUtils.psm1" target="_blank" rel="noopener">https://github.com/AzureAD/azure-activedirectory-powershell/blob/gh-pages/Modules/AzureADUtils/AzureADUtils.psm1</a></p>
</li>
<li><p>任意の一時フォルダを作成し、AzureADUtils.psm1 をコピーします。</p>
</li>
<li><p>管理者権限で PowerShell を起動し、AzureADUtils.psm1 をコピーした一時フォルダに移動します。</p>
</li>
<li><p>次のコマンドを実行し、 Execution Policy Change の画面が表示されましたら “Y” を入力します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Unrestricted</span><br></pre></td></tr></table></figure>
</li>
<li><p>次のコマンドを実行し、モジュールをインポートします。このとき Security warning が表示された場合には “R” を入力します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\AzureADUtils.psm1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="6">
<li>次のコマンドを実行し、モジュールをインストールします。ここでも Security warning が表示された場合には “R” を入力します。<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-AzureADUtilsModule</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="7">
<li><p>これまでの PowerShell コンソールを終了し、新しい PowerShell を開始します。</p>
</li>
<li><p>次のコマンドを実行し、再度モジュールをインポートします。ここでも Security warning が表示された場合には “R” を入力します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> AzureADUtils</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="9">
<li><p>以下のドキュメントに記載された手順に従って、アプリケーションを登録し、”構成設定を収集する” に従って必要な情報を取得します。</p>
<p>Azure AD Reporting API にアクセスするための前提条件</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-prerequisites-azure-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-prerequisites-azure-portal</a></p>
</li>
<li><p>テキスト エディタを開き、次の中身をコピーしたうえで、環境に合わせて赤字部分の内容を設定した上で、実行します。<br>これによりサインイン アクティビティ レポートと監査アクティビティ レポートを csv ファイルに取得できます。</p>
</li>
</ol>
<h3 id="サインイン-レポートの場合"><a href="#サインイン-レポートの場合" class="headerlink" title="サインイン レポートの場合"></a>サインイン レポートの場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import AzureADUtils Module</span></span><br><span class="line"><span class="built_in">Import-Module</span> AzureADUtils</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Set parameters for the command</span></span><br><span class="line"><span class="variable">$ClientID</span>     = <span class="string">"&lt;アプリケーションのクライアント ID&gt;"</span> <span class="comment"># 手順の 9 で作成したアプリケーションのクライアント ID です。</span></span><br><span class="line"><span class="variable">$ClientSecret</span> = <span class="built_in">ConvertTo-SecureString</span> -String <span class="string">"&lt;アプリケーションのクライアント シークレット&gt;"</span> -AsPlainText -Force  <span class="comment"># 手順の 9 で作成したアプリケーションのクライアント シークレットです。</span></span><br><span class="line"><span class="variable">$tenantdomain</span>   = <span class="string">"&lt;対象のテナント ドメイン名&gt;"</span> <span class="comment"># 利用されている Azure AD のテナント名です。例えば contoso.onmicrosoft.com です。</span></span><br><span class="line"><span class="variable">$Credential</span> = <span class="built_in">New-Object</span> -TypeName <span class="string">"System.Management.Automation.PSCredential"</span> -ArgumentList <span class="variable">$ClientID</span>, <span class="variable">$ClientSecret</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Get Access Token</span></span><br><span class="line"><span class="variable">$AccessToken</span> = Get-AzureADGraphAPIAccessTokenFromAppKey -TenantDomain <span class="variable">$tenantdomain</span> -ClientCredential <span class="variable">$Credential</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Set date range</span></span><br><span class="line"><span class="variable">$daysago</span> = <span class="string">"&#123;0:s&#125;"</span> -f (<span class="built_in">get-date</span>).AddDays(-&lt;採取したいログの過去の日数&gt;) + <span class="string">"Z"</span>  <span class="comment"># 例えば過去 30 日のデータを取得したい場合には $daysago = "&#123;0:s&#125;" -f (get-date).AddDays(-30) + "Z" とします。</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#Getting logs</span></span><br><span class="line">Invoke-AzureADGraphAPIQuery -TenantDomain <span class="variable">$tenantdomain</span> -AccessToken <span class="variable">$AccessToken</span> -GraphQuery <span class="string">"/activities/signinEvents?api-version=beta&amp;`$filter=signinDateTime gt <span class="variable">$daysago</span>"</span> | <span class="built_in">Export-Csv</span> -Path <span class="string">"&lt;出力ファイルのファイル名&gt;.csv"</span></span><br></pre></td></tr></table></figure>
<h3 id="監査レポートの場合"><a href="#監査レポートの場合" class="headerlink" title="監査レポートの場合"></a>監査レポートの場合</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import AzureADUtils Module</span></span><br><span class="line"><span class="built_in">Import-Module</span> AzureADUtils</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Set parameters for the command</span></span><br><span class="line"><span class="variable">$ClientID</span>     = <span class="string">"&lt;アプリケーションのクライアント ID&gt;"</span></span><br><span class="line"><span class="variable">$ClientSecret</span> = <span class="built_in">ConvertTo-SecureString</span> -String <span class="string">"&lt;アプリケーションのクライアント シークレット&gt;"</span> -AsPlainText -Force</span><br><span class="line"><span class="variable">$tenantdomain</span>   = <span class="string">"&lt;対象のテナント ドメイン名&gt;"</span></span><br><span class="line"><span class="variable">$Credential</span> = <span class="built_in">New-Object</span> -TypeName <span class="string">"System.Management.Automation.PSCredential"</span> -ArgumentList <span class="variable">$ClientID</span>, <span class="variable">$ClientSecret</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Get Access Token</span></span><br><span class="line"><span class="variable">$AccessToken</span> = Get-AzureADGraphAPIAccessTokenFromAppKey -TenantDomain <span class="variable">$tenantdomain</span> -ClientCredential <span class="variable">$Credential</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Set date range</span></span><br><span class="line"><span class="variable">$daysago</span> = <span class="string">"&#123;0:s&#125;"</span> -f (<span class="built_in">get-date</span>).AddDays(-&lt;採取したいログの過去の日数&gt;) + <span class="string">"Z"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#Getting logs</span></span><br><span class="line">Invoke-AzureADGraphAPIQuery -TenantDomain <span class="variable">$tenantdomain</span> -AccessToken <span class="variable">$AccessToken</span> -GraphQuery <span class="string">"/activities/audit?api-version=beta&amp;`$filter=activityDate gt <span class="variable">$daysago</span>"</span> | <span class="built_in">Export-Csv</span> -Path <span class="string">"&lt;出力ファイルのファイル名&gt;.csv"</span></span><br></pre></td></tr></table></figure>
<h4 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h4><p>Azure AD のサインイン アクティビティ レポートと監査アクティビティ レポートについては、以下の公開情報も参考いただければと思います。</p>
<ul>
<li><p>Azure Active Directory レポートの保持ポリシー</p>
<p>  <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-retention" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-retention</a></p>
</li>
<li><p>Azure Active Directory 監査 API リファレンス</p>
<p>  <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-audit-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-audit-reference</a></p>
</li>
<li><p>Azure Active Directory サインイン アクティビティ レポート API リファレンス</p>
<p>  <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-sign-in-activity-reference" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-api-sign-in-activity-reference</a></p>
</li>
</ul>
<p>本ブログの情報がお客様の検証や運用のお役に少しでもお役に立てば幸いです。</p>
<p>製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/azure-ad-reporting-api/" data-id="cjtz46po3003czcytcvrflify" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/graph-api/">graph api</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/signin-log/">signin log</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/device-based-access-control" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/device-based-access-control/" class="article-date">
  <time datetime="2018-01-24T15:00:00.000Z" itemprop="datePublished">2018-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/device-based-access-control/">デバイス ベースのアクセス制御</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの下野です。</p>
<p>今回は下記の 3 つについてご紹介します。</p>
<ol>
<li>AD FS による証明書認証</li>
<li>AD FS によるデバイス認証</li>
<li>Azure AD によるデバイスベースの条件付きアクセス</li>
</ol>
<p>昨今話題の働き方改革を実現する手段の一つとして、テレワークができる環境を整える - オフィス内で利用する端末だけでなく、会社支給の端末、モバイルデバイスなど多種多様なデバイスから企業のリソースにアクセスできるようにする - ということも有効だと思います。</p>
<img src="/blog/azure-active-directory/device-based-access-control/access-o365-from-everywhere.png">
<p>それを検討する際に、管理者側で会社のリソースにアクセスできるデバイスを限定したいとのご要望をいただくことが多くあります。<br>そのような要望の実現を検討する際に、今回ご紹介させていただく内容が少しでもお役に立ちましたら幸いです。</p>
<p>ではまずは、それぞれの制御方法を説明します。</p>
<h2 id="1-AD-FS-による証明書認証"><a href="#1-AD-FS-による証明書認証" class="headerlink" title="1. AD FS による証明書認証"></a>1. AD FS による証明書認証</h2><p>Windows Server 2012 R2 (AD FS 3.0) 以降で利用可能となった、証明書を使用した認証方式です。ユーザー証明書を各デバイスに配布して、モダン認証 (ADAL)に対応している多くのアプリケーションで利用します。</p>
<p>証明書認証を構成した際に正常に動作しないというケースでは、主に下記のようなポイントをチェックします。</p>
<ul>
<li>証明書のサブジェクト代替名にユーザーの UPN が正しくセットされているか</li>
<li>AD FS (または WAP) が信頼している証明機関から発行された証明書かどうか</li>
<li>証明書の有効期限が切れていないかどうか</li>
<li>証明書が、失効されていないかどうか</li>
</ul>
<p>証明書認証を利用できるクライアント端末は次のとおりです。</p>
<p><strong>対象 OS</strong>: Windows 7, Windows 8.1, Windows 10 ,MAC OS ,iOS ,Android</p>
<p>※ ブラウザではない Office クライアントなどを利用する場合、<a href="https://support.office.com/ja-jp/article/office-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%A7-office-365-%E5%85%88%E9%80%B2%E8%AA%8D%E8%A8%BC%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B-776c0036-66fd-41cb-8928-5495c0f9168a" target="_blank" rel="noopener">モダン認証 (ADAL)</a> が有効である必要があります。</p>
<p>※ iOS で証明書認証を利用する場合、Microsoft Authenticator をインストールする必要があります。</p>
<h2 id="2-AD-FS-によるデバイス認証"><a href="#2-AD-FS-によるデバイス認証" class="headerlink" title="2. AD FS によるデバイス認証"></a>2. AD FS によるデバイス認証</h2><p>AD FS でデバイス認証をおこなうことが可能ですが、これは実際のところ AD FS のクレーム ルールを利用して制御しています。デバイス認証を AD FS で有効にすると、クライアント端末固有の情報をクレームに含めるようになります。それを用いてトークンの発行を許可・拒否するルールを作成し、アクセスの制御を行います。</p>
<p>なお、デバイス認証もモダン認証 (ADAL) に対応している必要がありますが、モバイルのアプリケーションについては、デバイス認証に対応しておりません。</p>
<p>また、後述しますが、AD FS のデバイス認証を利用するためには、デバイスがオンプレミス AD に登録されている必要がございます。デバイス認証を構成し、それが正しく動作していないように見える場合には下記のようなポイントをチェックします。</p>
<ul>
<li>Workplace Join を行った際にサインインしていたユーザーで、そのクライアント端末にサインインしているか</li>
<li>そのユーザーの個人ストアにデバイス認証用の証明書が存在しているか</li>
<li>オンプレミス AD に対応するデバイス オブジェクトが存在しているか</li>
</ul>
<p>デバイス認証を利用できるクライアント端末は次の通りですが、AD FS のバージョンによって対象が異なるので注意が必要です。</p>
<p>&lt;<strong>Windows Server 2016 (AD FS 2016)</strong>&gt;<br>対象 OS: Windows 7, Windows 8.1, Windows 10 ,iOS ,Android</p>
<p>&lt;<strong>Windows Server 2012 R2 (AD FS 3.0)</strong>&gt;<br>対象 OS: Windows 7, Windows 8.1, iOS ,Android</p>
<h3 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h3><p>デバイス認証を行うためには前提条件として、オンプレミス AD へのデバイス オブジェクトの登録が必須となります。登録方法は大きく 2 つあり、その 2 つの方法によって対象 OS が異なります。</p>
<ul>
<li><p>方法 1: Azure AD に登録されたデバイスを書き戻す方法</p>
<p>  |方法|Azure AD に登録されたデバイス情報を Azure AD Connect を用いてオンプレミス AD に書き戻す|<br>  |—|—|<br>  |対象 OS|Windows 7, Windows 8.1, Windows10, iOS, Android|</p>
</li>
<li><p>方法 2: AD FS のDevice Registration Service (DRS) を利用する方法</p>
<p>  ※ 前提として Windows Server 2012 R2 を AD FS サーバーとして利用している (Windows Server 2016 は非対応)</p>
<p>  |方法|オンプレミス AD に AD FS の DRS を利用してデバイス情報を直接登録する|<br>  |—|—|<br>  |対象 OS|Windows 7, Windows 8.1, iOS|</p>
</li>
</ul>
<p>ここで、少し用語について整理します。</p>
<p>AD FS 2012 R2 は、Device Registration Service (DRS) の機能を有します。クライアントからのデバイス登録リクエスト（後述いたします、Workplace Join）を受け、そのクライアント端末に対応するデバイス オブジェクトをオンプレミス AD 内に登録する機能です。また、そのデバイス オブジェクトに紐づいた証明書をクライアントに配布致します。</p>
<p>Workplace Join とは、クライアントの機能/動作です。クライアントが DRS に対してデバイス オブジェクトの登録をリクエストする機能、またはその動作のことです。また、Workplace Join は、デバイス オブジェクトの登録に成功した際、DRS から配布された証明書を該当端末にインストールします。</p>
<p>AD FS 2012 R2 の DRS は、Windows 7、Windows 8.1、iOS 6 以降、Android 4.0 以降 の Workplace Join に対応しています。AD FS 2016 では、DRS の実装自体はありますが、サポートしていません。AD FS 2016 環境や、クライアントが Windows 10 の場合には、方法 1 の (Azure AD にデバイスを登録し、Azure AD Connect でオンプレミス AD に書き戻す) 必要がございます。</p>
<p>また、基本的にブラウザ アクセスに関しては問題ございませんが、Office クライアントなどのアプリケーションはデバイス認証に対応していません。ブラウザ以外のアプリケーションを利用する場合には、証明書認証や条件付きアクセスのご利用をご検討ください。</p>
<h2 id="3-Azure-AD-によるデバイスベースの条件付きアクセス"><a href="#3-Azure-AD-によるデバイスベースの条件付きアクセス" class="headerlink" title="3. Azure AD によるデバイスベースの条件付きアクセス"></a>3. Azure AD によるデバイスベースの条件付きアクセス</h2><p>Azure AD の「条件付きアクセス」を用いてデバイス ベースのアクセス制御を実装します。条件付きアクセスは、制御対象のアプリケーションがモダン認証 (ADAL) に対応している必要がありますが、簡単にご利用いただけます (ただし、Azure AD Premium のライセンスが必要な点についてはご注意ください)。</p>
<p>デバイスベースの条件付きアクセスを利用する前提条件として、制御対象のデバイスを以下いずれかのステータスで、Azure AD 上に登録する必要があります。これによりオンプレミスのドメインに参加している端末や Intune で管理されている端末を条件にアクセス制御が可能です。</p>
<table>
<thead>
<tr>
<th>デバイス登録時のステータス</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ドメイン参加済みデバイス</td>
<td>オンプレミスドメインに参加している端末である</td>
</tr>
<tr>
<td>準拠済みデバイス</td>
<td>Intune ポリシーにより準拠済みと判定された端末である</td>
</tr>
</tbody>
</table>
<p>ここで、少し用語について整理します。</p>
<p><strong>ドメイン参加済みデバイス</strong> とは、オンプレミス AD にドメイン参加しており、AD FS と Azure AD Connect を用いて Azure AD 上にデバイス登録した端末が該当します。実際の構成方法については、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup" target="_blank" rel="noopener">リンク</a> をご参照ください。</p>
<p><strong>準拠済みデバイス</strong> とは、Azure AD 上にデバイス登録した上で Intuneの MDM 管理を用いて Intune のコンプライアンス ポリシーの準拠した端末が該当します。</p>
<p>各種条件を考慮した、それぞれの制御対象 OS は下記になります。</p>
<table>
<thead>
<tr>
<th>OS の種類</th>
<th style="text-align:center">証明書認証</th>
<th style="text-align:center">AD FS デバイス認証</th>
<th style="text-align:center">条件付きアクセス</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows 7</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows 8.1</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows 10</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Mac OS</td>
<td style="text-align:center">○</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Android</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>iOS</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows Phone</td>
<td style="text-align:center">△ ※2</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
</tbody>
</table>
<p>※ 1: Windows 10 は 前述の通り AD FS 2016 が必要です。また、デバイスの登録方法は、 Azure AD に登録し、書き戻す必要があります。</p>
<p>※ 2: Windows Phone については iOS や Android では利用できる Skype for Business が先進認証に非対応などの制限があります。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>元々、証明書やデバイスによるアクセス制御は、AD FS を中心に行う必要がありました。<br>現在も証明書による認証をさせたい場合には AD FS が必要ですが、条件付きアクセスは日々機能が拡張されており、新しい機能も次々に追加されています。AD FS の構築、運用の費用と Azure AD Premium のライセンスの兼ね合いもありますが、今後の事も含め、条件付きアクセスを使用したデバイス制御も是非ご検討ください。</p>
<p>製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポートサービスをご利用ください。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/device-based-access-control/" data-id="cjtz46po8003ezcytj7wsflyg" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Conditional-Access/">Conditional Access</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Intune/">Intune</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Workplace-Join/">Workplace Join</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/add-modify-delete-directory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/add-modify-delete-directory/" class="article-date">
  <time datetime="2018-01-15T15:00:00.000Z" itemprop="datePublished">2018-01-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/add-modify-delete-directory/">Azure AD の追加・変更・削除</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は下記の 3 つについて紹介します。</p>
<ul>
<li>Azure AD の追加手順</li>
<li>Azure AD の変更手順</li>
<li>Azure AD の削除手順</li>
</ul>
<p>まずは、簡単に Azure AD について説明します。</p>
<p>Azure AD とは、Azure や Office 365 などの Microsoft クラウド サービスに組織がサインアップしたときに作成されます (もう少し平易な言い方をすると、 Office 365 など Azure AD が必須のサービスの新規利用を開始した時点で自動的に作成されます)。Azure AD に所属しているユーザーは、その Azure AD に紐づいているクラウドサービスを利用することが可能です。</p>
<img src="/blog/azure-active-directory/add-modify-delete-directory/user-access-o365-subscription.png">
<h2 id="Azure-AD-の追加手順"><a href="#Azure-AD-の追加手順" class="headerlink" title="Azure AD の追加手順"></a>Azure AD の追加手順</h2><p>冒頭で、クラウドサービスにサインアップした際に作成されると書きましたが、Azure AD を個別に追加することも可能です。下記の手順で、Azure AD Free (無料) を作成できます</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>表示された画面の右下より  [ディレクトリの作成] をクリックします</li>
<li><p>[ディレクトリの作成] 画面の下記の項目に入力します</p>
<ul>
<li>組織名：任意の組織名を入力</li>
<li>初期ドメイン名：&lt;組織&gt;のドメイン名を入力</li>
<li>“国/リージョン” を選択</li>
</ul>
</li>
<li><p>[作成] をクリックします</p>
</li>
<li>作成が完了すると、”新しいディレクトリを管理するにはここをクリックします” が表示するので、クリックします</li>
<li>新しく作成したディレクトリの画面に切り替わります</li>
</ol>
<p>作成操作を行ったユーザーが新しく作成した Azure AD ディレクトリ (テナント) の管理者となります。</p>
<h2 id="Azure-AD-の変更手順"><a href="#Azure-AD-の変更手順" class="headerlink" title="Azure AD の変更手順"></a>Azure AD の変更手順</h2><p>Azure AD ディレクトリは必ず xxxxx.onmicrosoft.com という名前を持ちますが、このドメイン名を後から変更することはできません。そのため、 Azure AD のディレクトリのドメイン名を例えば contoso.onmicrosoft.com にしたい場合は、上記の「Azure AD の追加手順」の手順に従い、Azure AD を新規に作成する必要があります。</p>
<p>なお、Azure AD の組織名 (よく ”既定のディレクトリ” と表示されている名称) については下記の手順で変更可能です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[プロパティ] をクリックします</li>
<li><p>[名前] の項目に新しい組織名を入力します。</p>
<p> 例：既定のディレクトリ –&gt; コントソ株式会社</p>
</li>
<li><p>[保存] を押します。</p>
</li>
<li>少し時間を空けて再度サインインすると、名前が変更されます。</li>
</ol>
<p>また、ご利用の Azure サブスクリプションを新規で作成した Azure AD に紐づけたいというような要件がある場合には、サブスクリプションの譲渡とディレクトリの変更の 2 つの方法があります。 </p>
<h2 id="Azure-AD-の削除手順"><a href="#Azure-AD-の削除手順" class="headerlink" title="Azure AD の削除手順"></a>Azure AD の削除手順</h2><p>手動で作成した Azure AD については削除が可能です。ディレクトリを削除するためには、いくつか前提条件があります。</p>
<p>&lt;ディレクトリ削除の前提条件&gt;</p>
<ul>
<li>Azure のご契約時に自動的に作成されたディレクトリ (既定のディレクトリ) ではない</li>
<li>ディレクトリにユーザーが存在しない</li>
<li>連携するアプリケーションが存在しない</li>
<li>サブスクリプションが紐づいていない</li>
<li>など</li>
</ul>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[ディレクトリの削除] をクリックします</li>
<li>前提条件のチェック完了後に [削除] をクリックします</li>
</ol>
<p>削除時に前提条件のチェックが走るため、すべての条件をクリアすることで削除が可能となります。前提条件に抵触している場合は、下記のように ! の警告が表示され削除が完了しません。</p>
<img src="/blog/azure-active-directory/add-modify-delete-directory/confirm-delete-directory.png">
<p>なお、Azure のサインアップ時に自動作成された Azure AD  (既定のディレクトリ) やセルフサインアップテナント については削除が想定されていません。そのディレクトリはもう利用することはないが、ユーザーが Azure ポータルにサインインしたときにディレクトリが表示されるので煩わしいという場合には、そのディレクトリからユーザーを削除する方法で対応が可能です。</p>
<p>これにより該当のアカウントでサインインしてもディレクトリは見えなくなりますので、ディレクトリを削除した場合と同等の効果が得られます。</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[ユーザーとグループ] – [すべてのユーザー] をクリックします</li>
<li>[＋新しいユーザー] をクリックします</li>
<li><p>ユーザー名を入力し、ロールでは「全体管理者」を選択します</p>
<p> 例) 削除対象のディレクトリ名が contoso.onmicrosoft.com の場合: <a href="mailto:temp@conotoso.onmicrosoft.com" target="_blank" rel="noopener">temp@conotoso.onmicrosoft.com</a></p>
</li>
<li><p>手順 5. で作成した全体管理者のアカウントで <a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> にサインインします</p>
</li>
<li>[すべてのユーザー] まで移動して、本アカウント以外をこのディレクトリから削除します</li>
</ol>
<p>削除されたユーザーで、ディレクトリが見えない状態になっているかどうかを確認します。</p>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>複数の Azure AD は完全に独立したリソースとして管理されます。そのため、Azure AD 間の連携が必要なシナリオの場合は、Azure AD B2B の利用をします。B2B については下記の記事を合わせてご参照ください。</p>
<p>Azure AD B2B とは<br><a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/</a></p>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/add-modify-delete-directory/" data-id="cjtz46plc0008zcytbp5vf0kr" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/access-restriction-azure-portal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../azure-active-directory/access-restriction-azure-portal/" class="article-date">
  <time datetime="2017-12-28T15:00:00.000Z" itemprop="datePublished">2017-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../azure-active-directory/access-restriction-azure-portal/">Azure ポータルへのアクセス制限</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は、一般ユーザーに対して Azure ポータルへのアクセスを制限する方法について紹介します。</p>
<p>クラシック ポータル (旧ポータル) ではログインする際に Azure のサブスクリプションを保持していることが前提となっていました。一方 Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) には、サブスクリプションの有無によらず、ログインすることが可能です。この動作変更により、より多くのユーザーが簡単に Azure に対してアクセスできるようになっています。</p>
<p>Azure ポータルからは、そのログインしたユーザーが所属する Azure AD ディレクトリにアクセスすることができ、このとき Azure AD に対しての管理者権限を持たない一般ユーザーであっても、既定では Azure AD に登録されているユーザー一覧を参照できるようになっています。ご利用状況によっては、このことがセキュリティ上好ましくない場合もあると思います。</p>
<h2 id="Azure-ポータルへのアクセスを制限する方法"><a href="#Azure-ポータルへのアクセスを制限する方法" class="headerlink" title="Azure ポータルへのアクセスを制限する方法"></a>Azure ポータルへのアクセスを制限する方法</h2><p>Azure ポータル自体へのアクセスを限られたユーザーのみに制限する方法については、条件付きアクセスの機能を利用する必要があります。条件付きアクセスの機能を利用するためには Azure AD Premium (P1 or P2) のライセンスが制御対象のユーザー分必要となります。</p>
<p>なお、 後述します Azure AD へのアクセスを制限する方法 (ユーザーの一覧を見えなくする) であれば、ライセンスは不要です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li>Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) に管理者のアカウントでアクセスします。</li>
<li>セキュリティの [条件付きアクセス] – [ポリシー] の順にクリックします。</li>
<li>上部 [＋新しいポリシー] をクリックします。</li>
<li>[名前] にポリシーの名前を入力します。</li>
<li><p>ポリシーを割り当てるユーザーまたはグループを選択します。</p>
<p> この時、全ての管理者に割り当てないようにしてください。全ての管理者がポリシーの制限を受け、Azure にアクセスすることができなくなり、設定解除もできなくなるというお問い合わせを過去に複数いただいております。</p>
</li>
<li><p>[クラウド アプリ] では 「アプリを選択」 にチェックを入れます。</p>
</li>
<li>[選択] をクリックし、[Microsoft Azure Management] アプリケーションを検索し、選択します。</li>
<li>[クラウド アプリ] のブレードに戻るので、[完了] をクリックします。</li>
<li>[条件] – [場所] をクリックし、構成で [はい] を選択します。</li>
<li>対象 で「すべての場所」を選択します。</li>
<li>Azure ポータルに戻って、[完了] を 2 回 クリックします。</li>
<li>アクセス制御 の [許可] で「アクセスのブロック」を選択して、[選択] をクリックします。</li>
<li>即時ポリシーを有効化する場合には、ポリシーの有効化で [オン] を選択し、[作成] をクリックします。</li>
</ol>
<p>該当ユーザーで Azure ポータルへアクセスすると下記の画面が表示され、アクセスがブロックされます。</p>
<img src="/blog/azure-active-directory/access-restriction-azure-portal/access-restricted.png">
<h2 id="Azure-AD-へのアクセスを制限する方法"><a href="#Azure-AD-へのアクセスを制限する方法" class="headerlink" title="Azure AD へのアクセスを制限する方法"></a>Azure AD へのアクセスを制限する方法</h2><p>Azure AD の管理者権限（全体管理者または制限付き管理者）を与えられていないユーザーによる ポータル内 [Azure Active Directory] へのアクセスを制限する方法です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li>全体管理者として Azure ポータル（<a href="http://portal.azure.com）にサインインします。" target="_blank" rel="noopener">http://portal.azure.com）にサインインします。</a></li>
<li>左側のメニューから [Azure Active Directory] をクリックします。</li>
<li>表示されたメニューから [ユーザーとグループ] をクリックします。</li>
<li>表示されたメニューから [ユーザー設定] をクリックします。</li>
<li>右側の下記の項目がございますので、[はい] を選択します。</li>
<li>[管理ポータル] - [Azure AD 管理ポータルへのアクセスを制限する]<br>上にある [保存] をクリックします。</li>
</ol>
<p>※ 上記 5. で [はい] を選択することで管理者以外の一般ユーザーは、Azure ポータル内での [Azure Active Directory] にアクセスしようとすると、下記の画面が表示されアクセス権がなくなります。</p>
<img src="/blog/azure-active-directory/access-restriction-azure-portal/no-access.png">
<p>上記設定は、Azure ポータル上のアクセス制限になるため、設定完了後も PowerShell を使用すれば、ユーザーの一覧は参照できます。その対処策となる設定についても下記にご案内させていただきます。</p>
<p>&lt;手順&gt;</p>
<p>この作業を実施するためには、Azure AD 用の PowerShell (Azure AD v1 の PowerShell) を利用する必要がありますが、 PowerShell を利用する際には Microsoft アカウントではなく、組織アカウントでの全体管理者が必要です (Azure AD の PowerShell についてはリンクも参照ください)。</p>
<ol>
<li><p>PowerShell を開き、下記のコマンドで全体管理者で Azure AD に接続します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connect-MsolService</span><br></pre></td></tr></table></figure>
</li>
<li><p>下記コマンドで他のユーザー及びグループの情報を取得させないように設定します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolCompanySettings -UsersPermissionToReadOtherUsersEnabled <span class="literal">$false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下記コマンドで他のユーザー及びグループの情報を取得させないように設定されたか確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolCompanyInformation | fl UsersPermissionToReadOtherUsersEnabled</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>外部から追加した Guest ユーザーについては既定で Azure AD へのアクセスが制限されています<br>(Guest と Member の違いについては、こちらのリンクを参照ください)。</p>
<p>Azure ポータルへのログインを条件付きアクセスを利用して制限していない場合でも、 Azure AD 以外の項目、例えば仮想マシンなどのリソースに対しては、サブスクリプションの権限を明示的に付与しない限りは、各ユーザーは参照することもできませんのでご安心ください。</p>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<p>※ 本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/azure-active-directory/access-restriction-azure-portal/" data-id="cjtz46pl50007zcytg97ut67d" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-active-directory-federation-service/kmsi-not-shown-wia" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="../../active-directory-federation-service/kmsi-not-shown-wia/" class="article-date">
  <time datetime="2017-12-13T15:00:00.000Z" itemprop="datePublished">2017-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="../../active-directory-federation-service/kmsi-not-shown-wia/">フェデレーション環境 (Windows 統合認証) で [サインインの状態を維持しますか？] の画面が表示されない</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure ID サポートチームの高田です。<br>本日は、Azure AD のサインイン画面の変更とそれに伴うフェデレーション環境への影響についておまとめしました。</p>
<h2 id="現在と以前のサインイン-エクスペリエンス"><a href="#現在と以前のサインイン-エクスペリエンス" class="headerlink" title="現在と以前のサインイン エクスペリエンス"></a>現在と以前のサインイン エクスペリエンス</h2><p>まず、Microsoft では、11 月より Azure AD のサインイン画面にいくつか変更を加えております。具体的には、新しいサインイン エクスペリエンスが導入されており、Azure AD へのサインイン時に以下のような画面が表示されることにお気づきの方もいらっしゃると思います。</p>
<p>▼古いサインイン エクスペリエンス</p>
<img src="/blog/active-directory-federation-service/kmsi-not-shown-wia/old-signin-page.png">
<p>▼新しいサインイン エクスペリエンス</p>
<img src="/blog/active-directory-federation-service/kmsi-not-shown-wia/new-signin-page.png">
<img src="/blog/active-directory-federation-service/kmsi-not-shown-wia/new-signin-page-kmsi.png">
<p>※画面遷移の説明は、下記ブログを参照ください。</p>
<p>Fewer login prompts: The new “Keep me signed in” experience for Azure AD is in preview<br><a href="https://cloudblogs.microsoft.com/enterprisemobility/2017/09/19/fewer-login-prompts-the-new-keep-me-signed-in-experience-for-azure-ad-is-in-preview/" target="_blank" rel="noopener">https://cloudblogs.microsoft.com/enterprisemobility/2017/09/19/fewer-login-prompts-the-new-keep-me-signed-in-experience-for-azure-ad-is-in-preview/</a></p>
<p>この [サインインの状態を維持しますか？] の画面は、古いサインイン画面の [サインインしたままにする] チェックボックスと同じ設定を表しています。Azure AD の [会社のブランド] から構成できる [サインインしたままにするオプションを表示する] の設定が [はい] の場合に表示されます。</p>
<p>既定ではこのオプションは [はい] の状態で、明示的に [いいえ] にしていない限り、基本的に上記の [サインインの状態を維持しますか？] の画面が表示されることとなります (オプションを [いいえ] にした場合、[サインインの状態を維持しますか？] の画面は表示されず、サインイン状態は維持されない動作です)。</p>
<p>※ [会社のブランド] を構成する手順につきましては、下記の公開情報を参照ください。</p>
<p>クイック スタート: Azure AD のサインイン ページに会社のブランドを追加する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/customize-branding" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/customize-branding</a></p>
<p>※ 以下は、上記設定画面における既知の問題と対処方法を案内している公開情報です。</p>
<p>「サインインしたままにするオプションを表示する」 の設定が保存できない<br><a href="https://answers.microsoft.com/thread/e8a32fbe-8d80-43f3-b99c-af585b4c57b" target="_blank" rel="noopener">https://answers.microsoft.com/thread/e8a32fbe-8d80-43f3-b99c-af585b4c57b</a></p>
<p>この [サインインの状態を維持しますか？] の画面は、 [サインインしたままにするオプションを表示する] オプションを [はい] にしていても、以下の場合に表示されません。</p>
<ol>
<li>Azure AD がユーザーのサインインをリスクある状態と判断した場合</li>
<li>フェデレーション ユーザーにてサインインを試行し、AD FS にて Windows 統合認証が用いられた場合</li>
</ol>
<p>上記 1 については、同一のマシンを複数人で共有していたり、短時間に長距離を移動したユーザーが該当します。<br>リスクの高いサインインについては以下の資料も参考にしていただければと思います。</p>
<p>Azure Active Directory ポータルのリスクの高いサインイン レポート<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-security-risky-sign-ins" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-security-risky-sign-ins</a></p>
<p>上記 2 は、社内にいるユーザーが AD FS を利用してサインインする場合を示しています。<br>Windows 統合認証を用いてサインインする場合、ユーザーから見るとアプリケーションへのアクセスから Azure AD へのリダイレクト、さらに AD FS へのリダイレクト後の Windows 統合認証がすべて自動的に完了する流れとなります。[サインインの状態を維持しますか？] の画面は、一連の処理の流れを止めることとなるため、Windows 統合認証の場合に表示されないよう実装されました。AD FS にて Windows 統合認証が用いられたとき、[サインインの状態を維持しますか？] の選択は表示されませんが、選択としては [いいえ] の状態で認証が完了しています。このため、サインインの状態は維持されません (Azure AD から永続的なクッキーは発行されません)。</p>
<p>AD FS を利用する場合でも、社内からではなく外部から WAP (Web Application Proxy) を介してアクセスするような場合や、社内からのアクセスであっても、Firefox 等、AD FS の標準設定では Windows 統合認証が使用できないブラウザをお使いの場合は、フォーム認証が用いられます。このときは、1 に合致していない状況であれば [サインインの状態を維持しますか？] の画面が表示されます。</p>
<h2 id="Windows-統合認証が行われた場合もサインインの状態を維持させる方法"><a href="#Windows-統合認証が行われた場合もサインインの状態を維持させる方法" class="headerlink" title="Windows 統合認証が行われた場合もサインインの状態を維持させる方法"></a>Windows 統合認証が行われた場合もサインインの状態を維持させる方法</h2><p>フェデレーション環境をお持ちのお客様において、AD FS で Windows 統合認証が行われた場合もサインインの状態を維持したい (Azure AD から永続的なクッキーを発行したい) とお考えのお客様においては、後述の対応を実施いただければと思います。</p>
<p>以下では AD FS 側でクレーム ルールを変更し、組織内からの認証の場合は、psso (Persistent SSO) と呼ばれるクレームをトークンに含めるように構成します。これを受け取った Azure AD は、サインイン状態を維持させるよう永続的なクッキーをクライアントに発行します。この際、「サインイン状態を維持しますか？」画面は表示されませんが、サインイン状態を維持するクッキーが発行されます ([サインインの状態を維持しますか？] 画面で手動にて [はい] を押下したのと同じ状態となります)。</p>
<p>AD FS サーバー上の手順を以下におまとめいたしましたので、ご確認いただけますと幸いです。</p>
<ol>
<li>AD FS サーバーに管理者でログオンします。</li>
<li>AD FS の管理コンソールを開きます。</li>
<li>画面左側のツリーから [証明書利用者信頼] を選択します。</li>
<li>[Microsoft Office 365 Identity Platform] を右クリックし、[要求規則の編集] を選択します。</li>
<li>[発行変換規則] で [規則の追加] をクリックします。</li>
<li>変換要求規則の追加ウィザードでドロップダウンから [カスタム規則を使用して要求を送信] を選択し、[次へ] をクリックします。</li>
<li>[要求規則名] の下のボックスに Keep Users Signed In と入力し、次に進みます。</li>
<li><p>[カスタム規則:] ボックスに次のように入力します。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c:[Type == &quot;http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork&quot;, Value == &quot;true&quot;]</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>[完了]をクリックし、ウィザードを終了します。</p>
</li>
</ol>
<p>上記クレーム ルールを追加しますと、社内からの (WAP を経由しない) アクセスの場合は、<a href="http://schemas.microsoft.com/2014/03/psso" target="_blank" rel="noopener">http://schemas.microsoft.com/2014/03/psso</a> のクレームがトークンに追加されます。Azure AD はこのクレームを確認し、永続的なクッキーをクライアントに発行します。AD FS ファーム全体 (全ユーザー) が対象となるルールですが、新しく psso のクレームを追加するだけですので、既存のクレーム ルールに影響を及ぼすことはありません。また、上記ウィザードの完了後すぐに効果が及びます。</p>
<p>なお、クレームルールの追加により予期しない動作が生じた場合は、追加したルールを削除すれば元に戻すことが可能ですので、その際は、追加したルールを削除することで対応ください。</p>
<h3 id="2018-02-21-追記"><a href="#2018-02-21-追記" class="headerlink" title="2018/02/21 追記:"></a>2018/02/21 追記:</h3><p>上記設定は、発行変換規則に対するものです。アクセス制御に影響する発行承認規則には変更を加えません。このため、上記設定を行っても既存のクレーム ルールでのアクセス制御に影響を及ぼすことはありません。上記設定を実施後に、これまで動作していたアクセスがブロックされるなどの影響が起きることはないとお考えください。影響が及ぶのは Azure AD が永続的なクッキーをクライアントに発行し、サインイン状態が維持されるという点のみです。</p>
<h3 id="2018-02-26-追記"><a href="#2018-02-26-追記" class="headerlink" title="2018/02/26 追記:"></a>2018/02/26 追記:</h3><p>クレーム ルールを制御することで、<a href="http://schemas.microsoft.com/2014/03/psso" target="_blank" rel="noopener">http://schemas.microsoft.com/2014/03/psso</a> のクレームを有効にする対象ユーザーを制御することが可能です。例えば以下のようにしてクレーム ルールを指定すれば、社内からのアクセスで、さらに指定したグループにユーザーが含まれている場合のみ psso を有効にできます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c1:[Type == &quot;http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork&quot;, Value == &quot;true&quot;]</span><br><span class="line">&amp;&amp; c2:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid&quot;, Value == &quot;S-1-5-21-4118385845-2129555445-158388420-1121&quot;]</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
<p>上記のうち、S-1-5-21-4118385845-2129555445-158388420-1121 の箇所にご要望のグループの SID を指定ください。グループの SID は、[Active Directory ユーザーとコンピューター] や PowerShell の Get-ADGroup コマンドレットからご確認いただけます。</p>
<h3 id="2018-03-06-追記"><a href="#2018-03-06-追記" class="headerlink" title="2018/03/06 追記:"></a>2018/03/06 追記:</h3><p><strong>以上の内容は、Windows Server 2012 R2 以降の AD FS を対象とした手順です。</strong></p>
<p>Windows Server 2008 R2 および 2012 の AD FS をご利用の場合は以下のようにします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOT exists([Type == &quot;http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy&quot;])</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
<p>なお、Windows Server 2008 R2 で x-ms-proxy クレームを利用するには AD FS 2.0 ロールアップ 3 の適用が必要です (要 OS 再起動)。</p>
<p>Description of Update Rollup 3 for Active Directory Federation Services (AD FS) 2.0<br><a href="https://support.microsoft.com/ja-jp/help/2790338/description-of-update-rollup-3-for-active-directory-federation-service" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/2790338/description-of-update-rollup-3-for-active-directory-federation-service</a></p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/active-directory-federation-service/kmsi-not-shown-wia/" data-id="cjtz46pnn0036zcytq2t06jat" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="../3/">&laquo; 戻る</a><a class="page-number" href="../../">1</a><a class="page-number" href="../2/">2</a><a class="page-number" href="../3/">3</a><span class="page-number current">4</span><a class="page-number" href="../5/">5</a><a class="page-number" href="../6/">6</a><a class="extend next" rel="next" href="../5/">次へ &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグ</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../tags/AAD-Connect/">AAD Connect</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/AD-FS/">AD FS</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/AD-Sync/">AD Sync</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Azure-AD/">Azure AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Azure-AD-Application-Proxy/">Azure AD Application Proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Azure-AD-B2B/">Azure AD B2B</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Azure-AD-Directory-Rolls/">Azure AD Directory Rolls</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Azure-AD-License/">Azure AD License</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/CBA/">CBA</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Conditional-Access/">Conditional Access</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/ExpressRoute/">ExpressRoute</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Hard-match/">Hard match</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Intune/">Intune</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/MFA/">MFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/OAuth/">OAuth</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/PowerShell/">PowerShell</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/RBAC/">RBAC</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Sgin-in-log/">Sgin-in log</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Smart-lockout/">Smart lockout</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Subscription/">Subscription</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Tenant-Restrictions/">Tenant Restrictions</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Token/">Token</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/UPN/">UPN</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Windows-Defender-ATP/">Windows Defender ATP</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Workplace-Join/">Workplace Join</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/graph-api/">graph api</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/signin-log/">signin log</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/サポート/">サポート</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/トラブルシューティング/">トラブルシューティング</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/情報採取/">情報採取</a></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/証明書認証/">証明書認証</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグクラウド</h3>
    <div class="widget tagcloud">
      <a href="../../tags/AAD-Connect/" style="font-size: 18.33px;">AAD Connect</a> <a href="../../tags/AD-FS/" style="font-size: 16.67px;">AD FS</a> <a href="../../tags/AD-Sync/" style="font-size: 10px;">AD Sync</a> <a href="../../tags/Azure-AD/" style="font-size: 20px;">Azure AD</a> <a href="../../tags/Azure-AD-Application-Proxy/" style="font-size: 10px;">Azure AD Application Proxy</a> <a href="../../tags/Azure-AD-B2B/" style="font-size: 13.33px;">Azure AD B2B</a> <a href="../../tags/Azure-AD-Directory-Rolls/" style="font-size: 10px;">Azure AD Directory Rolls</a> <a href="../../tags/Azure-AD-License/" style="font-size: 10px;">Azure AD License</a> <a href="../../tags/CBA/" style="font-size: 10px;">CBA</a> <a href="../../tags/Conditional-Access/" style="font-size: 15px;">Conditional Access</a> <a href="../../tags/ExpressRoute/" style="font-size: 10px;">ExpressRoute</a> <a href="../../tags/Hard-match/" style="font-size: 10px;">Hard match</a> <a href="../../tags/Hybrid-Azure-AD-Join/" style="font-size: 10px;">Hybrid Azure AD Join</a> <a href="../../tags/Intune/" style="font-size: 11.67px;">Intune</a> <a href="../../tags/MFA/" style="font-size: 10px;">MFA</a> <a href="../../tags/OAuth/" style="font-size: 10px;">OAuth</a> <a href="../../tags/PowerShell/" style="font-size: 10px;">PowerShell</a> <a href="../../tags/RBAC/" style="font-size: 11.67px;">RBAC</a> <a href="../../tags/Security/" style="font-size: 11.67px;">Security</a> <a href="../../tags/Sgin-in-log/" style="font-size: 10px;">Sgin-in log</a> <a href="../../tags/Smart-lockout/" style="font-size: 10px;">Smart lockout</a> <a href="../../tags/Subscription/" style="font-size: 10px;">Subscription</a> <a href="../../tags/Tenant-Restrictions/" style="font-size: 10px;">Tenant Restrictions</a> <a href="../../tags/Token/" style="font-size: 10px;">Token</a> <a href="../../tags/UPN/" style="font-size: 10px;">UPN</a> <a href="../../tags/Windows-Defender-ATP/" style="font-size: 10px;">Windows Defender ATP</a> <a href="../../tags/Workplace-Join/" style="font-size: 10px;">Workplace Join</a> <a href="../../tags/graph-api/" style="font-size: 11.67px;">graph api</a> <a href="../../tags/signin-log/" style="font-size: 11.67px;">signin log</a> <a href="../../tags/サポート/" style="font-size: 11.67px;">サポート</a> <a href="../../tags/トラブルシューティング/" style="font-size: 11.67px;">トラブルシューティング</a> <a href="../../tags/情報採取/" style="font-size: 11.67px;">情報採取</a> <a href="../../tags/証明書認証/" style="font-size: 10px;">証明書認証</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/10/">十月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="../../azure-active-directory/how-to-get-sign-in-logs/">Azure AD サインイン ログ取得方法まとめ</a>
          </li>
        
          <li>
            <a href="../../azure-active-directory/last-signin-reports/">PowerShell にて全ユーザーの最終サインイン日時を一括で取得する方法</a>
          </li>
        
          <li>
            <a href="../../azure-active-directory-connect/introduction-staging-server/">ステージング サーバーのすゝめ</a>
          </li>
        
          <li>
            <a href="../../azure-active-directory/create-subscription-error/">サブスクリプション作成時のエラー「アカウントが Azure サブスクリプションに関連付けられないディレクトリに属しています。別のアカウントでサインインしてください」</a>
          </li>
        
          <li>
            <a href="../../active-directory-federation-service/adfs-cba-ts/">証明書認証のトラブルシューティング</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Azure Identity Support Japan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="../../fancybox/jquery.fancybox.css">
  <script src="../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../js/script.js"></script>



  </div>
</body>
</html>