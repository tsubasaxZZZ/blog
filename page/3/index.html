<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <!-- this tag should remove when publish production  -->
  <meta name="”robots”" content="”noindex”">
  

  
  <title>Japan Azure Identity Support Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta name="keywords" content="Azure,Azure AD,Identity,AD FS">
<meta property="og:type" content="website">
<meta property="og:title" content="Japan Azure Identity Support Blog">
<meta property="og:url" content="https://jpazureid.github.io/page/3/index.html">
<meta property="og:site_name" content="Japan Azure Identity Support Blog">
<meta property="og:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta property="og:locale" content="ja">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Japan Azure Identity Support Blog">
<meta name="twitter:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
  
    <link rel="alternate" href="/blog/atom.xml" title="Japan Azure Identity Support Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Japan Azure Identity Support Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://jpazureid.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-azure-active-directory/device-based-access-control" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/01/25/azure-active-directory/device-based-access-control/" class="article-date">
  <time datetime="2018-01-24T15:00:00.000Z" itemprop="datePublished">2018-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/01/25/azure-active-directory/device-based-access-control/">デバイス ベースのアクセス制御</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの下野です。</p>
<p>今回は下記の 3 つについてご紹介します。</p>
<ol>
<li>AD FS による証明書認証</li>
<li>AD FS によるデバイス認証</li>
<li>Azure AD によるデバイスベースの条件付きアクセス</li>
</ol>
<p>昨今話題の働き方改革を実現する手段の一つとして、テレワークができる環境を整える - オフィス内で利用する端末だけでなく、会社支給の端末、モバイルデバイスなど多種多様なデバイスから企業のリソースにアクセスできるようにする - ということも有効だと思います。</p>
<img src="/blog/2018/01/25/azure-active-directory/device-based-access-control/access-o365-from-everywhere.png">
<p>それを検討する際に、管理者側で会社のリソースにアクセスできるデバイスを限定したいとのご要望をいただくことが多くあります。<br>そのような要望の実現を検討する際に、今回ご紹介させていただく内容が少しでもお役に立ちましたら幸いです。</p>
<p>ではまずは、それぞれの制御方法を説明します。</p>
<h2 id="1-AD-FS-による証明書認証"><a href="#1-AD-FS-による証明書認証" class="headerlink" title="1. AD FS による証明書認証"></a>1. AD FS による証明書認証</h2><p>Windows Server 2012 R2 (AD FS 3.0) 以降で利用可能となった、証明書を使用した認証方式です。ユーザー証明書を各デバイスに配布して、モダン認証 (ADAL)に対応している多くのアプリケーションで利用します。</p>
<p>証明書認証を構成した際に正常に動作しないというケースでは、主に下記のようなポイントをチェックします。</p>
<ul>
<li>証明書のサブジェクト代替名にユーザーの UPN が正しくセットされているか</li>
<li>AD FS (または WAP) が信頼している証明機関から発行された証明書かどうか</li>
<li>証明書の有効期限が切れていないかどうか</li>
<li>証明書が、失効されていないかどうか</li>
</ul>
<p>証明書認証を利用できるクライアント端末は次のとおりです。</p>
<p><strong>対象 OS</strong>: Windows 7, Windows 8.1, Windows 10 ,MAC OS ,iOS ,Android</p>
<p>※ ブラウザではない Office クライアントなどを利用する場合、<a href="https://support.office.com/ja-jp/article/office-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%A7-office-365-%E5%85%88%E9%80%B2%E8%AA%8D%E8%A8%BC%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B-776c0036-66fd-41cb-8928-5495c0f9168a" target="_blank" rel="noopener">モダン認証 (ADAL)</a> が有効である必要があります。</p>
<p>※ iOS で証明書認証を利用する場合、Microsoft Authenticator をインストールする必要があります。</p>
<h2 id="2-AD-FS-によるデバイス認証"><a href="#2-AD-FS-によるデバイス認証" class="headerlink" title="2. AD FS によるデバイス認証"></a>2. AD FS によるデバイス認証</h2><p>AD FS でデバイス認証をおこなうことが可能ですが、これは実際のところ AD FS のクレーム ルールを利用して制御しています。デバイス認証を AD FS で有効にすると、クライアント端末固有の情報をクレームに含めるようになります。それを用いてトークンの発行を許可・拒否するルールを作成し、アクセスの制御を行います。</p>
<p>なお、デバイス認証もモダン認証 (ADAL) に対応している必要がありますが、モバイルのアプリケーションについては、デバイス認証に対応しておりません。</p>
<p>また、後述しますが、AD FS のデバイス認証を利用するためには、デバイスがオンプレミス AD に登録されている必要がございます。デバイス認証を構成し、それが正しく動作していないように見える場合には下記のようなポイントをチェックします。</p>
<ul>
<li>Workplace Join を行った際にサインインしていたユーザーで、そのクライアント端末にサインインしているか</li>
<li>そのユーザーの個人ストアにデバイス認証用の証明書が存在しているか</li>
<li>オンプレミス AD に対応するデバイス オブジェクトが存在しているか</li>
</ul>
<p>デバイス認証を利用できるクライアント端末は次の通りですが、AD FS のバージョンによって対象が異なるので注意が必要です。</p>
<p>&lt;<strong>Windows Server 2016 (AD FS 2016)</strong>&gt;<br>対象 OS: Windows 7, Windows 8.1, Windows 10 ,iOS ,Android</p>
<p>&lt;<strong>Windows Server 2012 R2 (AD FS 3.0)</strong>&gt;<br>対象 OS: Windows 7, Windows 8.1, iOS ,Android</p>
<h3 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h3><p>デバイス認証を行うためには前提条件として、オンプレミス AD へのデバイス オブジェクトの登録が必須となります。登録方法は大きく 2 つあり、その 2 つの方法によって対象 OS が異なります。</p>
<ul>
<li><p>方法 1: Azure AD に登録されたデバイスを書き戻す方法</p>
<p>  |方法|Azure AD に登録されたデバイス情報を Azure AD Connect を用いてオンプレミス AD に書き戻す|<br>  |—|—|<br>  |対象 OS|Windows 7, Windows 8.1, Windows10, iOS, Android|</p>
</li>
<li><p>方法 2: AD FS のDevice Registration Service (DRS) を利用する方法</p>
<p>  ※ 前提として Windows Server 2012 R2 を AD FS サーバーとして利用している (Windows Server 2016 は非対応)</p>
<p>  |方法|オンプレミス AD に AD FS の DRS を利用してデバイス情報を直接登録する|<br>  |—|—|<br>  |対象 OS|Windows 7, Windows 8.1, iOS|</p>
</li>
</ul>
<p>ここで、少し用語について整理します。</p>
<p>AD FS 2012 R2 は、Device Registration Service (DRS) の機能を有します。クライアントからのデバイス登録リクエスト（後述いたします、Workplace Join）を受け、そのクライアント端末に対応するデバイス オブジェクトをオンプレミス AD 内に登録する機能です。また、そのデバイス オブジェクトに紐づいた証明書をクライアントに配布致します。</p>
<p>Workplace Join とは、クライアントの機能/動作です。クライアントが DRS に対してデバイス オブジェクトの登録をリクエストする機能、またはその動作のことです。また、Workplace Join は、デバイス オブジェクトの登録に成功した際、DRS から配布された証明書を該当端末にインストールします。</p>
<p>AD FS 2012 R2 の DRS は、Windows 7、Windows 8.1、iOS 6 以降、Android 4.0 以降 の Workplace Join に対応しています。AD FS 2016 では、DRS の実装自体はありますが、サポートしていません。AD FS 2016 環境や、クライアントが Windows 10 の場合には、方法 1 の (Azure AD にデバイスを登録し、Azure AD Connect でオンプレミス AD に書き戻す) 必要がございます。</p>
<p>また、基本的にブラウザ アクセスに関しては問題ございませんが、Office クライアントなどのアプリケーションはデバイス認証に対応していません。ブラウザ以外のアプリケーションを利用する場合には、証明書認証や条件付きアクセスのご利用をご検討ください。</p>
<h2 id="3-Azure-AD-によるデバイスベースの条件付きアクセス"><a href="#3-Azure-AD-によるデバイスベースの条件付きアクセス" class="headerlink" title="3. Azure AD によるデバイスベースの条件付きアクセス"></a>3. Azure AD によるデバイスベースの条件付きアクセス</h2><p>Azure AD の「条件付きアクセス」を用いてデバイス ベースのアクセス制御を実装します。条件付きアクセスは、制御対象のアプリケーションがモダン認証 (ADAL) に対応している必要がありますが、簡単にご利用いただけます (ただし、Azure AD Premium のライセンスが必要な点についてはご注意ください)。</p>
<p>デバイスベースの条件付きアクセスを利用する前提条件として、制御対象のデバイスを以下いずれかのステータスで、Azure AD 上に登録する必要があります。これによりオンプレミスのドメインに参加している端末や Intune で管理されている端末を条件にアクセス制御が可能です。</p>
<table>
<thead>
<tr>
<th>デバイス登録時のステータス</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ドメイン参加済みデバイス</td>
<td>オンプレミスドメインに参加している端末である</td>
</tr>
<tr>
<td>準拠済みデバイス</td>
<td>Intune ポリシーにより準拠済みと判定された端末である</td>
</tr>
</tbody>
</table>
<p>ここで、少し用語について整理します。</p>
<p><strong>ドメイン参加済みデバイス</strong> とは、オンプレミス AD にドメイン参加しており、AD FS と Azure AD Connect を用いて Azure AD 上にデバイス登録した端末が該当します。実際の構成方法については、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup" target="_blank" rel="noopener">リンク</a> をご参照ください。</p>
<p><strong>準拠済みデバイス</strong> とは、Azure AD 上にデバイス登録した上で Intuneの MDM 管理を用いて Intune のコンプライアンス ポリシーの準拠した端末が該当します。</p>
<p>各種条件を考慮した、それぞれの制御対象 OS は下記になります。</p>
<table>
<thead>
<tr>
<th>OS の種類</th>
<th style="text-align:center">証明書認証</th>
<th style="text-align:center">AD FS デバイス認証</th>
<th style="text-align:center">条件付きアクセス</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows 7</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows 8.1</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows 10</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△ ※1</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Mac OS</td>
<td style="text-align:center">○</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Android</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>iOS</td>
<td style="text-align:center">○</td>
<td style="text-align:center">△</td>
<td style="text-align:center">○</td>
</tr>
<tr>
<td>Windows Phone</td>
<td style="text-align:center">△ ※2</td>
<td style="text-align:center">×</td>
<td style="text-align:center">○</td>
</tr>
</tbody>
</table>
<p>※ 1: Windows 10 は 前述の通り AD FS 2016 が必要です。また、デバイスの登録方法は、 Azure AD に登録し、書き戻す必要があります。</p>
<p>※ 2: Windows Phone については iOS や Android では利用できる Skype for Business が先進認証に非対応などの制限があります。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>元々、証明書やデバイスによるアクセス制御は、AD FS を中心に行う必要がありました。<br>現在も証明書による認証をさせたい場合には AD FS が必要ですが、条件付きアクセスは日々機能が拡張されており、新しい機能も次々に追加されています。AD FS の構築、運用の費用と Azure AD Premium のライセンスの兼ね合いもありますが、今後の事も含め、条件付きアクセスを使用したデバイス制御も是非ご検討ください。</p>
<p>製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポートサービスをご利用ください。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/01/25/azure-active-directory/device-based-access-control/" data-id="cjtjvyw9j002ndgytv69k6lgh" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Intune/">Intune</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Workplace-Join/">Workplace Join</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/add-modify-delete-directory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/" class="article-date">
  <time datetime="2018-01-15T15:00:00.000Z" itemprop="datePublished">2018-01-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/">Azure AD の追加・変更・削除</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は下記の 3 つについて紹介します。</p>
<ul>
<li>Azure AD の追加手順</li>
<li>Azure AD の変更手順</li>
<li>Azure AD の削除手順</li>
</ul>
<p>まずは、簡単に Azure AD について説明します。</p>
<p>Azure AD とは、Azure や Office 365 などの Microsoft クラウド サービスに組織がサインアップしたときに作成されます (もう少し平易な言い方をすると、 Office 365 など Azure AD が必須のサービスの新規利用を開始した時点で自動的に作成されます)。Azure AD に所属しているユーザーは、その Azure AD に紐づいているクラウドサービスを利用することが可能です。</p>
<img src="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/user-access-o365-subscription.png">
<h2 id="Azure-AD-の追加手順"><a href="#Azure-AD-の追加手順" class="headerlink" title="Azure AD の追加手順"></a>Azure AD の追加手順</h2><p>冒頭で、クラウドサービスにサインアップした際に作成されると書きましたが、Azure AD を個別に追加することも可能です。下記の手順で、Azure AD Free (無料) を作成できます</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>表示された画面の右下より  [ディレクトリの作成] をクリックします</li>
<li><p>[ディレクトリの作成] 画面の下記の項目に入力します</p>
<ul>
<li>組織名：任意の組織名を入力</li>
<li>初期ドメイン名：&lt;組織&gt;のドメイン名を入力</li>
<li>“国/リージョン” を選択</li>
</ul>
</li>
<li><p>[作成] をクリックします</p>
</li>
<li>作成が完了すると、”新しいディレクトリを管理するにはここをクリックします” が表示するので、クリックします</li>
<li>新しく作成したディレクトリの画面に切り替わります</li>
</ol>
<p>作成操作を行ったユーザーが新しく作成した Azure AD ディレクトリ (テナント) の管理者となります。</p>
<h2 id="Azure-AD-の変更手順"><a href="#Azure-AD-の変更手順" class="headerlink" title="Azure AD の変更手順"></a>Azure AD の変更手順</h2><p>Azure AD ディレクトリは必ず xxxxx.onmicrosoft.com という名前を持ちますが、このドメイン名を後から変更することはできません。そのため、 Azure AD のディレクトリのドメイン名を例えば contoso.onmicrosoft.com にしたい場合は、上記の「Azure AD の追加手順」の手順に従い、Azure AD を新規に作成する必要があります。</p>
<p>なお、Azure AD の組織名 (よく ”既定のディレクトリ” と表示されている名称) については下記の手順で変更可能です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[プロパティ] をクリックします</li>
<li><p>[名前] の項目に新しい組織名を入力します。</p>
<p> 例：既定のディレクトリ –&gt; コントソ株式会社</p>
</li>
<li><p>[保存] を押します。</p>
</li>
<li>少し時間を空けて再度サインインすると、名前が変更されます。</li>
</ol>
<p>また、ご利用の Azure サブスクリプションを新規で作成した Azure AD に紐づけたいというような要件がある場合には、サブスクリプションの譲渡とディレクトリの変更の 2 つの方法があります。 </p>
<h2 id="Azure-AD-の削除手順"><a href="#Azure-AD-の削除手順" class="headerlink" title="Azure AD の削除手順"></a>Azure AD の削除手順</h2><p>手動で作成した Azure AD については削除が可能です。ディレクトリを削除するためには、いくつか前提条件があります。</p>
<p>&lt;ディレクトリ削除の前提条件&gt;</p>
<ul>
<li>Azure のご契約時に自動的に作成されたディレクトリ (既定のディレクトリ) ではない</li>
<li>ディレクトリにユーザーが存在しない</li>
<li>連携するアプリケーションが存在しない</li>
<li>サブスクリプションが紐づいていない</li>
<li>など</li>
</ul>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[ディレクトリの削除] をクリックします</li>
<li>前提条件のチェック完了後に [削除] をクリックします</li>
</ol>
<p>削除時に前提条件のチェックが走るため、すべての条件をクリアすることで削除が可能となります。前提条件に抵触している場合は、下記のように ! の警告が表示され削除が完了しません。</p>
<img src="/blog/2018/01/16/azure-active-directory/add-modify-delete-directory/confirm-delete-directory.png">
<p>なお、Azure のサインアップ時に自動作成された Azure AD  (既定のディレクトリ) やセルフサインアップテナント については削除が想定されていません。そのディレクトリはもう利用することはないが、ユーザーが Azure ポータルにサインインしたときにディレクトリが表示されるので煩わしいという場合には、そのディレクトリからユーザーを削除する方法で対応が可能です。</p>
<p>これにより該当のアカウントでサインインしてもディレクトリは見えなくなりますので、ディレクトリを削除した場合と同等の効果が得られます。</p>
<p>&lt;手順&gt;</p>
<ol>
<li><a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> より、管理者アカウントでサインインします</li>
<li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします</li>
<li>[ユーザーとグループ] – [すべてのユーザー] をクリックします</li>
<li>[＋新しいユーザー] をクリックします</li>
<li><p>ユーザー名を入力し、ロールでは「全体管理者」を選択します</p>
<p> 例) 削除対象のディレクトリ名が contoso.onmicrosoft.com の場合: <a href="mailto:temp@conotoso.onmicrosoft.com" target="_blank" rel="noopener">temp@conotoso.onmicrosoft.com</a></p>
</li>
<li><p>手順 5. で作成した全体管理者のアカウントで <a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a> にサインインします</p>
</li>
<li>[すべてのユーザー] まで移動して、本アカウント以外をこのディレクトリから削除します</li>
</ol>
<p>削除されたユーザーで、ディレクトリが見えない状態になっているかどうかを確認します。</p>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>複数の Azure AD は完全に独立したリソースとして管理されます。そのため、Azure AD 間の連携が必要なシナリオの場合は、Azure AD B2B の利用をします。B2B については下記の記事を合わせてご参照ください。</p>
<p>Azure AD B2B とは<br><a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/</a></p>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2018/01/16/azure-active-directory/add-modify-delete-directory/" data-id="cjtjvyw7c0007dgytwflrce6m" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/access-restriction-azure-portal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/" class="article-date">
  <time datetime="2017-12-28T15:00:00.000Z" itemprop="datePublished">2017-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/">Azure ポータルへのアクセス制限</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は、一般ユーザーに対して Azure ポータルへのアクセスを制限する方法について紹介します。</p>
<p>クラシック ポータル (旧ポータル) ではログインする際に Azure のサブスクリプションを保持していることが前提となっていました。一方 Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) には、サブスクリプションの有無によらず、ログインすることが可能です。この動作変更により、より多くのユーザーが簡単に Azure に対してアクセスできるようになっています。</p>
<p>Azure ポータルからは、そのログインしたユーザーが所属する Azure AD ディレクトリにアクセスすることができ、このとき Azure AD に対しての管理者権限を持たない一般ユーザーであっても、既定では Azure AD に登録されているユーザー一覧を参照できるようになっています。ご利用状況によっては、このことがセキュリティ上好ましくない場合もあると思います。</p>
<h2 id="Azure-ポータルへのアクセスを制限する方法"><a href="#Azure-ポータルへのアクセスを制限する方法" class="headerlink" title="Azure ポータルへのアクセスを制限する方法"></a>Azure ポータルへのアクセスを制限する方法</h2><p>Azure ポータル自体へのアクセスを限られたユーザーのみに制限する方法については、条件付きアクセスの機能を利用する必要があります。条件付きアクセスの機能を利用するためには Azure AD Premium (P1 or P2) のライセンスが制御対象のユーザー分必要となります。</p>
<p>なお、 後述します Azure AD へのアクセスを制限する方法 (ユーザーの一覧を見えなくする) であれば、ライセンスは不要です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li>Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) に管理者のアカウントでアクセスします。</li>
<li>セキュリティの [条件付きアクセス] – [ポリシー] の順にクリックします。</li>
<li>上部 [＋新しいポリシー] をクリックします。</li>
<li>[名前] にポリシーの名前を入力します。</li>
<li><p>ポリシーを割り当てるユーザーまたはグループを選択します。</p>
<p> この時、全ての管理者に割り当てないようにしてください。全ての管理者がポリシーの制限を受け、Azure にアクセスすることができなくなり、設定解除もできなくなるというお問い合わせを過去に複数いただいております。</p>
</li>
<li><p>[クラウド アプリ] では 「アプリを選択」 にチェックを入れます。</p>
</li>
<li>[選択] をクリックし、[Microsoft Azure Management] アプリケーションを検索し、選択します。</li>
<li>[クラウド アプリ] のブレードに戻るので、[完了] をクリックします。</li>
<li>[条件] – [場所] をクリックし、構成で [はい] を選択します。</li>
<li>対象 で「すべての場所」を選択します。</li>
<li>Azure ポータルに戻って、[完了] を 2 回 クリックします。</li>
<li>アクセス制御 の [許可] で「アクセスのブロック」を選択して、[選択] をクリックします。</li>
<li>即時ポリシーを有効化する場合には、ポリシーの有効化で [オン] を選択し、[作成] をクリックします。</li>
</ol>
<p>該当ユーザーで Azure ポータルへアクセスすると下記の画面が表示され、アクセスがブロックされます。</p>
<img src="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/access-restricted.png">
<h2 id="Azure-AD-へのアクセスを制限する方法"><a href="#Azure-AD-へのアクセスを制限する方法" class="headerlink" title="Azure AD へのアクセスを制限する方法"></a>Azure AD へのアクセスを制限する方法</h2><p>Azure AD の管理者権限（全体管理者または制限付き管理者）を与えられていないユーザーによる ポータル内 [Azure Active Directory] へのアクセスを制限する方法です。</p>
<p>&lt;手順&gt;</p>
<ol>
<li>全体管理者として Azure ポータル（<a href="http://portal.azure.com）にサインインします。" target="_blank" rel="noopener">http://portal.azure.com）にサインインします。</a></li>
<li>左側のメニューから [Azure Active Directory] をクリックします。</li>
<li>表示されたメニューから [ユーザーとグループ] をクリックします。</li>
<li>表示されたメニューから [ユーザー設定] をクリックします。</li>
<li>右側の下記の項目がございますので、[はい] を選択します。</li>
<li>[管理ポータル] - [Azure AD 管理ポータルへのアクセスを制限する]<br>上にある [保存] をクリックします。</li>
</ol>
<p>※ 上記 5. で [はい] を選択することで管理者以外の一般ユーザーは、Azure ポータル内での [Azure Active Directory] にアクセスしようとすると、下記の画面が表示されアクセス権がなくなります。</p>
<img src="/blog/2017/12/29/azure-active-directory/access-restriction-azure-portal/no-access.png">
<p>上記設定は、Azure ポータル上のアクセス制限になるため、設定完了後も PowerShell を使用すれば、ユーザーの一覧は参照できます。その対処策となる設定についても下記にご案内させていただきます。</p>
<p>&lt;手順&gt;</p>
<p>この作業を実施するためには、Azure AD 用の PowerShell (Azure AD v1 の PowerShell) を利用する必要がありますが、 PowerShell を利用する際には Microsoft アカウントではなく、組織アカウントでの全体管理者が必要です (Azure AD の PowerShell についてはリンクも参照ください)。</p>
<ol>
<li><p>PowerShell を開き、下記のコマンドで全体管理者で Azure AD に接続します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connect-MsolService</span><br></pre></td></tr></table></figure>
</li>
<li><p>下記コマンドで他のユーザー及びグループの情報を取得させないように設定します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolCompanySettings -UsersPermissionToReadOtherUsersEnabled <span class="literal">$false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下記コマンドで他のユーザー及びグループの情報を取得させないように設定されたか確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolCompanyInformation | fl UsersPermissionToReadOtherUsersEnabled</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>外部から追加した Guest ユーザーについては既定で Azure AD へのアクセスが制限されています<br>(Guest と Member の違いについては、こちらのリンクを参照ください)。</p>
<p>Azure ポータルへのログインを条件付きアクセスを利用して制限していない場合でも、 Azure AD 以外の項目、例えば仮想マシンなどのリソースに対しては、サブスクリプションの権限を明示的に付与しない限りは、各ユーザーは参照することもできませんのでご安心ください。</p>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<p>※ 本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/29/azure-active-directory/access-restriction-azure-portal/" data-id="cjtjvyw730004dgyt71bq58sa" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-active-directory-federation-service/kmsi-not-shown-wia" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/" class="article-date">
  <time datetime="2017-12-13T15:00:00.000Z" itemprop="datePublished">2017-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/">フェデレーション環境 (Windows 統合認証) で [サインインの状態を維持しますか？] の画面が表示されない</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure ID サポートチームの高田です。<br>本日は、Azure AD のサインイン画面の変更とそれに伴うフェデレーション環境への影響についておまとめしました。</p>
<h2 id="現在と以前のサインイン-エクスペリエンス"><a href="#現在と以前のサインイン-エクスペリエンス" class="headerlink" title="現在と以前のサインイン エクスペリエンス"></a>現在と以前のサインイン エクスペリエンス</h2><p>まず、Microsoft では、11 月より Azure AD のサインイン画面にいくつか変更を加えております。具体的には、新しいサインイン エクスペリエンスが導入されており、Azure AD へのサインイン時に以下のような画面が表示されることにお気づきの方もいらっしゃると思います。</p>
<p>▼古いサインイン エクスペリエンス</p>
<img src="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/old-signin-page.png">
<p>▼新しいサインイン エクスペリエンス</p>
<img src="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/new-signin-page.png">
<img src="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/new-signin-page-kmsi.png">
<p>※画面遷移の説明は、下記ブログを参照ください。</p>
<p>Fewer login prompts: The new “Keep me signed in” experience for Azure AD is in preview<br><a href="https://cloudblogs.microsoft.com/enterprisemobility/2017/09/19/fewer-login-prompts-the-new-keep-me-signed-in-experience-for-azure-ad-is-in-preview/" target="_blank" rel="noopener">https://cloudblogs.microsoft.com/enterprisemobility/2017/09/19/fewer-login-prompts-the-new-keep-me-signed-in-experience-for-azure-ad-is-in-preview/</a></p>
<p>この [サインインの状態を維持しますか？] の画面は、古いサインイン画面の [サインインしたままにする] チェックボックスと同じ設定を表しています。Azure AD の [会社のブランド] から構成できる [サインインしたままにするオプションを表示する] の設定が [はい] の場合に表示されます。</p>
<p>既定ではこのオプションは [はい] の状態で、明示的に [いいえ] にしていない限り、基本的に上記の [サインインの状態を維持しますか？] の画面が表示されることとなります (オプションを [いいえ] にした場合、[サインインの状態を維持しますか？] の画面は表示されず、サインイン状態は維持されない動作です)。</p>
<p>※ [会社のブランド] を構成する手順につきましては、下記の公開情報を参照ください。</p>
<p>クイック スタート: Azure AD のサインイン ページに会社のブランドを追加する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/customize-branding" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/customize-branding</a></p>
<p>※ 以下は、上記設定画面における既知の問題と対処方法を案内している公開情報です。</p>
<p>「サインインしたままにするオプションを表示する」 の設定が保存できない<br><a href="https://answers.microsoft.com/thread/e8a32fbe-8d80-43f3-b99c-af585b4c57b" target="_blank" rel="noopener">https://answers.microsoft.com/thread/e8a32fbe-8d80-43f3-b99c-af585b4c57b</a></p>
<p>この [サインインの状態を維持しますか？] の画面は、 [サインインしたままにするオプションを表示する] オプションを [はい] にしていても、以下の場合に表示されません。</p>
<ol>
<li>Azure AD がユーザーのサインインをリスクある状態と判断した場合</li>
<li>フェデレーション ユーザーにてサインインを試行し、AD FS にて Windows 統合認証が用いられた場合</li>
</ol>
<p>上記 1 については、同一のマシンを複数人で共有していたり、短時間に長距離を移動したユーザーが該当します。<br>リスクの高いサインインについては以下の資料も参考にしていただければと思います。</p>
<p>Azure Active Directory ポータルのリスクの高いサインイン レポート<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-security-risky-sign-ins" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-security-risky-sign-ins</a></p>
<p>上記 2 は、社内にいるユーザーが AD FS を利用してサインインする場合を示しています。<br>Windows 統合認証を用いてサインインする場合、ユーザーから見るとアプリケーションへのアクセスから Azure AD へのリダイレクト、さらに AD FS へのリダイレクト後の Windows 統合認証がすべて自動的に完了する流れとなります。[サインインの状態を維持しますか？] の画面は、一連の処理の流れを止めることとなるため、Windows 統合認証の場合に表示されないよう実装されました。AD FS にて Windows 統合認証が用いられたとき、[サインインの状態を維持しますか？] の選択は表示されませんが、選択としては [いいえ] の状態で認証が完了しています。このため、サインインの状態は維持されません (Azure AD から永続的なクッキーは発行されません)。</p>
<p>AD FS を利用する場合でも、社内からではなく外部から WAP (Web Application Proxy) を介してアクセスするような場合や、社内からのアクセスであっても、Firefox 等、AD FS の標準設定では Windows 統合認証が使用できないブラウザをお使いの場合は、フォーム認証が用いられます。このときは、1 に合致していない状況であれば [サインインの状態を維持しますか？] の画面が表示されます。</p>
<h2 id="Windows-統合認証が行われた場合もサインインの状態を維持させる方法"><a href="#Windows-統合認証が行われた場合もサインインの状態を維持させる方法" class="headerlink" title="Windows 統合認証が行われた場合もサインインの状態を維持させる方法"></a>Windows 統合認証が行われた場合もサインインの状態を維持させる方法</h2><p>フェデレーション環境をお持ちのお客様において、AD FS で Windows 統合認証が行われた場合もサインインの状態を維持したい (Azure AD から永続的なクッキーを発行したい) とお考えのお客様においては、後述の対応を実施いただければと思います。</p>
<p>以下では AD FS 側でクレーム ルールを変更し、組織内からの認証の場合は、psso (Persistent SSO) と呼ばれるクレームをトークンに含めるように構成します。これを受け取った Azure AD は、サインイン状態を維持させるよう永続的なクッキーをクライアントに発行します。この際、「サインイン状態を維持しますか？」画面は表示されませんが、サインイン状態を維持するクッキーが発行されます ([サインインの状態を維持しますか？] 画面で手動にて [はい] を押下したのと同じ状態となります)。</p>
<p>AD FS サーバー上の手順を以下におまとめいたしましたので、ご確認いただけますと幸いです。</p>
<ol>
<li>AD FS サーバーに管理者でログオンします。</li>
<li>AD FS の管理コンソールを開きます。</li>
<li>画面左側のツリーから [証明書利用者信頼] を選択します。</li>
<li>[Microsoft Office 365 Identity Platform] を右クリックし、[要求規則の編集] を選択します。</li>
<li>[発行変換規則] で [規則の追加] をクリックします。</li>
<li>変換要求規則の追加ウィザードでドロップダウンから [カスタム規則を使用して要求を送信] を選択し、[次へ] をクリックします。</li>
<li>[要求規則名] の下のボックスに Keep Users Signed In と入力し、次に進みます。</li>
<li><p>[カスタム規則:] ボックスに次のように入力します。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c:[Type == &quot;http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork&quot;, Value == &quot;true&quot;]</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>[完了]をクリックし、ウィザードを終了します。</p>
</li>
</ol>
<p>上記クレーム ルールを追加しますと、社内からの (WAP を経由しない) アクセスの場合は、<a href="http://schemas.microsoft.com/2014/03/psso" target="_blank" rel="noopener">http://schemas.microsoft.com/2014/03/psso</a> のクレームがトークンに追加されます。Azure AD はこのクレームを確認し、永続的なクッキーをクライアントに発行します。AD FS ファーム全体 (全ユーザー) が対象となるルールですが、新しく psso のクレームを追加するだけですので、既存のクレーム ルールに影響を及ぼすことはありません。また、上記ウィザードの完了後すぐに効果が及びます。</p>
<p>なお、クレームルールの追加により予期しない動作が生じた場合は、追加したルールを削除すれば元に戻すことが可能ですので、その際は、追加したルールを削除することで対応ください。</p>
<h3 id="2018-02-21-追記"><a href="#2018-02-21-追記" class="headerlink" title="2018/02/21 追記:"></a>2018/02/21 追記:</h3><p>上記設定は、発行変換規則に対するものです。アクセス制御に影響する発行承認規則には変更を加えません。このため、上記設定を行っても既存のクレーム ルールでのアクセス制御に影響を及ぼすことはありません。上記設定を実施後に、これまで動作していたアクセスがブロックされるなどの影響が起きることはないとお考えください。影響が及ぶのは Azure AD が永続的なクッキーをクライアントに発行し、サインイン状態が維持されるという点のみです。</p>
<h3 id="2018-02-26-追記"><a href="#2018-02-26-追記" class="headerlink" title="2018/02/26 追記:"></a>2018/02/26 追記:</h3><p>クレーム ルールを制御することで、<a href="http://schemas.microsoft.com/2014/03/psso" target="_blank" rel="noopener">http://schemas.microsoft.com/2014/03/psso</a> のクレームを有効にする対象ユーザーを制御することが可能です。例えば以下のようにしてクレーム ルールを指定すれば、社内からのアクセスで、さらに指定したグループにユーザーが含まれている場合のみ psso を有効にできます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c1:[Type == &quot;http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork&quot;, Value == &quot;true&quot;]</span><br><span class="line">&amp;&amp; c2:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid&quot;, Value == &quot;S-1-5-21-4118385845-2129555445-158388420-1121&quot;]</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
<p>上記のうち、S-1-5-21-4118385845-2129555445-158388420-1121 の箇所にご要望のグループの SID を指定ください。グループの SID は、[Active Directory ユーザーとコンピューター] や PowerShell の Get-ADGroup コマンドレットからご確認いただけます。</p>
<h3 id="2018-03-06-追記"><a href="#2018-03-06-追記" class="headerlink" title="2018/03/06 追記:"></a>2018/03/06 追記:</h3><p><strong>以上の内容は、Windows Server 2012 R2 以降の AD FS を対象とした手順です。</strong></p>
<p>Windows Server 2008 R2 および 2012 の AD FS をご利用の場合は以下のようにします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOT exists([Type == &quot;http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy&quot;])</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
<p>なお、Windows Server 2008 R2 で x-ms-proxy クレームを利用するには AD FS 2.0 ロールアップ 3 の適用が必要です (要 OS 再起動)。</p>
<p>Description of Update Rollup 3 for Active Directory Federation Services (AD FS) 2.0<br><a href="https://support.microsoft.com/ja-jp/help/2790338/description-of-update-rollup-3-for-active-directory-federation-service" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/2790338/description-of-update-rollup-3-for-active-directory-federation-service</a></p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/" data-id="cjtjvyw9h002mdgytq993w971" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/member-and-guest-user" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/12/azure-active-directory/member-and-guest-user/" class="article-date">
  <time datetime="2017-12-11T15:00:00.000Z" itemprop="datePublished">2017-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/12/azure-active-directory/member-and-guest-user/">Member ユーザーと Guest ユーザーについて</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>Azure AD に所属しているユーザーの種類として、下記のように 「Member」 と 「Guest」があります。今回は、こちらのユーザーの種類について説明します。</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/member-and-guest.png">
<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>下記のように、個人アカウントや別テナントの職場または学校アカウント (組織アカウント) を追加した (Azure AD B2B の機能を利用した) 場合に、ユーザーの種類が 「Guest」 として追加されます。</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/personal-work-account.png">
<p>これ以外の Azure のサブスクリプションのサインアップで利用した個人アカウントや組織内のドメイン (上記の例の場合：contso.com) をユーザー名 (例：<a href="mailto:test@contoso.com" target="_blank" rel="noopener">test@contoso.com</a>) に持つユーザーは「Member」として登録されます。また、クラシックポータル  (旧ポータル) より追加した外部ユーザーについては 「Member」として登録されております。</p>
<h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>既定ではゲスト ユーザーに対しては、 Azure AD のデータへのアクセスを制限しています。そのため、ゲスト ユーザーでサインインした場合、招待された Azure AD のユーザーの一覧を参照することもできませんし、各種設定の参照・変更も制限されています。もちろん、サブスクリプションに対する権限を付与していない場合は、サブスクリプションのリソースを操作することもできません。<br>(一般ユーザーとゲスト ユーザーがそれぞれできること (アクセス許可の比較) は、こちらをご参照ください。)</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/access-denied.png">
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/no-access-permission.png">
<p>ゲストに対するアクセス制限は、以下の赤枠の箇所 (ゲストのアクセス許可を制限する) で変更できます。この設定が “はい” の場合には「Guest」の操作は上記のように制限されています。</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/guest-users-permissions-are-limited.png">
<p>ユーザーの属性については、PowerShell を利用することで Member から Guest、またその逆についても変更が可能です。Guest から Member  に変更する際は「Guest」に対して行っていた制御の対象外のユーザーとなるため、セキュリティポリシーに沿った対応や特定のユーザーに絞った設定変更をお勧め致します。</p>
<h2 id="ユーザー-タイプ変更手順"><a href="#ユーザー-タイプ変更手順" class="headerlink" title="ユーザー タイプ変更手順"></a>ユーザー タイプ変更手順</h2><p>この作業を実施するためには、Azure AD 用の PowerShell (Azure AD v1 の PowerShell) を利用する必要がありますが、 PowerShell を利用する際には Microsoft アカウントではなく、組織アカウントでの全体管理者が必要です (Azure AD の PowerShell については <a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/04/aad-powershell/" target="_blank" rel="noopener">リンク</a> も参照ください)。そのために対処策は次の手順で実施する必要があります。</p>
<ol>
<li>Azure AD の全体管理者アカウントを作成する (※すでに組織アカウントの全体管理者が存在する場合は、スキップ)</li>
<li>PowerShell を実行し、該当ユーザーを 「Guest」 から 「Member」 に変更する</li>
</ol>
<h3 id="1-Azure-AD-の全体管理者アカウントを作成する-※すでに組織アカウントの全体管理者が存在する場合は、スキップ"><a href="#1-Azure-AD-の全体管理者アカウントを作成する-※すでに組織アカウントの全体管理者が存在する場合は、スキップ" class="headerlink" title="1. Azure AD の全体管理者アカウントを作成する (※すでに組織アカウントの全体管理者が存在する場合は、スキップ)"></a>1. Azure AD の全体管理者アカウントを作成する (※すでに組織アカウントの全体管理者が存在する場合は、スキップ)</h3><ol>
<li>Azure ポータルにサインインします。</li>
<li>Azure Active Directory を開き、[ドメイン名] を開きます。</li>
<li>一覧に表示されている名前で onmicrosoft.com を含む名前を控えておきます。</li>
<li>[ユーザーとグループ] - [すべてのユーザー] と辿り、右ペインの上部にある [+ 新しいユーザー] をクリックします。</li>
<li>名前欄に適当な例えば admin1 などを入力し、 ユーザー名として 1-3 で確認した onmicrosoft.com のドメイ<br>ン名と名前欄に設定したものを組み合わせて <a href="mailto:admin1@contoso.onmicrosoft.com" target="_blank" rel="noopener">admin1@contoso.onmicrosoft.com</a> というように入力します。</li>
<li>ディレクトリ ロール欄で “全体管理者” を選択し、 [OK] をクリックします。</li>
<li>“パスワードを表示” をクリックし、パスワードを控えて [作成] をクリックします。</li>
</ol>
<h3 id="2-PowerShell-を実行し、該当ユーザーを-Guest-から-Member-に変更する"><a href="#2-PowerShell-を実行し、該当ユーザーを-Guest-から-Member-に変更する" class="headerlink" title="2. PowerShell を実行し、該当ユーザーを Guest から Member に変更する"></a>2. PowerShell を実行し、該当ユーザーを Guest から Member に変更する</h3><ol>
<li>Azure AD 用の PowerShell (Azure AD v1 の MSOnline の PowerShell) を起動します。<br>※モジュールの入手方法については、弊社ブログをご参照ください。インストールされていない環境では 1. MSOnline (Azure AD v1) のインストールをお願いします。</li>
<li>以下のコマンドを実行します。<br>Connect-MsolService</li>
<li>資格情報の入力を求められるため、1 で作成したアカウントの情報を入力します。<br>このときパスワードの変更が求められるはずですので、パスワードを新しく設定します。</li>
<li><p>以下のコマンドを実行して、対象ユーザーの UserPrincipalName および UserType 属性値を確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -All | <span class="built_in">Format-Table</span> UserPrincipalName,UserType</span><br></pre></td></tr></table></figure>
<p> 出力例:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserPrincipalName                             UserType</span><br><span class="line">User1_live.com#EXT#@contoso.onmicrosoft.com   Guest  -&gt; 「Guest」 であることが確認できます。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li><p>以下のコマンドを実行して、対象ユーザーの UserType を 「Member」 に変更します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName &lt;対象ユーザーの UserPrincipalName&gt; -UserType Member</span><br></pre></td></tr></table></figure>
<p> 実行例:</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName User1_live.com<span class="comment">#EXT#@contoso.onmicrosoft.com -UserType Member</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p>再度以下のコマンドを実行して、対象ユーザーの UserType を確認します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -All | <span class="built_in">Format-Table</span> UserPrincipalName,UserType</span><br></pre></td></tr></table></figure>
<p>出力例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserPrincipalName                             UserType</span><br><span class="line">User1_live.com#EXT#@contoso.onmicrosoft.com   Member  -&gt; 変更されたことを確認します。</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>「Member」→「Guest」に変更する場合は、UserType に 「Guest」を指定します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName &lt;対象ユーザーの UserPrincipalName&gt; -UserType Guest</span><br></pre></td></tr></table></figure>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<h2 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h2><ul>
<li>2017/12/12: 公開しました。</li>
<li>2018/02/26: Microsoft Connect のリタイアに伴い MSOnline モジュールのダウンロードができなくなったため記載を変更しました。</li>
<li>2018/10/31: メンバーとゲストの既定のアクセス許可の比較情報のリンクを追加しました。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/12/azure-active-directory/member-and-guest-user/" data-id="cjtjvyw84000sdgyt5rq1zurl" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/what-is-b2b" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/12/azure-active-directory/what-is-b2b/" class="article-date">
  <time datetime="2017-12-11T15:00:00.000Z" itemprop="datePublished">2017-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/12/azure-active-directory/what-is-b2b/">Azure AD B2B とは</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は Azure AD B2B (Business-To-Business) コラボレーション機能 (以下、Azure AD B2B) について紹介します。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b</a></p>
<p>この機能については、上記のリンクでも紹介しています。Azure AD B2B と聞くと、もしかしたら小難しく聞こえるかもしれませんが、要は、他 Azure AD のユーザーを追加 (招待) する機能のことです。具体的には、Azure AD を利用する中で、次のような要望がでてくることがあります。</p>
<ul>
<li>会社間 (Azure AD 間) でリソースを共有したい</li>
<li>別の Azure AD に紐づいているリソースを使用したい</li>
<li>ひとりの管理者で、複数の Azure AD を管理したい</li>
<li>など</li>
</ul>
<p>このような連携が必要な時に、利用する機能が、今回ご紹介する Azure AD B2B になります。</p>
<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p> Azure サブスクリプションは必ず 1 つの Azure AD に関連付けられています。<br>そのため、その関連付けられた Azure AD に所属しているユーザーのみがそのサブスクリプションに紐づくリソースを利用可能です。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/subscription-user.png">
<p>では、複数の Azure AD がある場合はどのようになるでしょうか。<br>この場合、別の Azure AD へのアクセスや別の Azure AD に関連付けられているサブスクリプションにアクセスできません。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/subscription-user-inaccessible.png">
<p>こんな時、Azure AD B2B を利用することで、別 Azure AD にユーザーを追加(コピーのようなイメージ)することで、別の Azure AD に所属してリソースを利用することが可能です。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/invite-user-to-tenant.png">
<h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>別の Azure AD のユーザーを追加する方法で多く利用されるものを  2  つ紹介します。</p>
<h3 id="1-ゲスト-ユーザーの追加"><a href="#1-ゲスト-ユーザーの追加" class="headerlink" title="1. ゲスト ユーザーの追加"></a>1. ゲスト ユーザーの追加</h3><p>明示的に別の Azure AD (または outlook.com や gmail.com などのマイクロソフト アカウント) を追加する操作です。Azure ポータルのメニューより [Azure Active Directory] – [ユーザーとグループ] – [すべてのユーザー] の順に進みます。下記、[新しいゲスト ユーザー] から別の Azure AD のユーザーを追加できます。招待メールが送られ、そのメールよりウィザードを完了する必要があります。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/screenshot-new-guest-user.png">
<h3 id="2-RBAC-アクセス制御-IAM-によるユーザーの追加"><a href="#2-RBAC-アクセス制御-IAM-によるユーザーの追加" class="headerlink" title="2. RBAC (アクセス制御 IAM) によるユーザーの追加"></a>2. RBAC (アクセス制御 IAM) によるユーザーの追加</h3><p>RBAC では、Azure サブスクリプションに紐づけられている Azure AD のユーザーに対してアクセス権を割り当てる必要があります。では、RBAC でアクセス権を割り当てるときに別の Azure AD のユーザーに対してアクセス権を割り当てるときには、先に 1 の作業を実施しておく必要があるのでしょうか？</p>
<p>いいえ、もしユーザーが存在していない場合には、 1 のユーザー追加も合わせて行われます。<br>Azure ポータルの [サブスクリプション] – [サブスクリプション名] – [アクセス制御 (IAM)]の順に進みます。</p>
<p>下記、[追加] から別の Azure AD のユーザーを追加することができます。招待メールが送られ、そのメールよりウィザードを完了する流れは同様になりますが、同時にサブスクリプションに対するロールを割り当てられます。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/screenshot-iam.png">
<h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><span style="color:blue">Q</span>. B2B の機能以外で、Azure AD 間を連携することは可能ですか？</p>
<p><span style="color:red">A</span>. いいえ、できません。複数の Azure AD 間で同期や複製を行うことはできません。B2B の機能は Azure AD 同士を連携するというよりは、 Azure AD と別 Azure AD のユーザーを連携する機能です。</p>
<p><span style="color:blue">Q</span>. 別の Azure AD に登録されたアプリケーションを利用するのに、Azure AD B2B の機能を利用できますか？</p>
<p><span style="color:red">A</span>. はい、B2B の機能で要件を満たせます。Azure AD B2B の機能で別の Azure AD のユーザーを追加することで、そのユーザーは Azure AD 上のアプリケーションを利用することが可能です。</p>
<p><span style="color:blue">Q</span>. 旧ポータル(クラシックポータル)のように、個人アカウント(Microsoft アカウント)を明示的に指定して追加することはできますか？</p>
<p><span style="color:red">A</span>. いいえ、できません。ただし、 ユーザーのドメイン名が live.com、 hotmail.com、 gmail.com のようなコンシューマー向けのフリーアドレスを利用している場合にはマイクロソフト アカウントが招待されます。<br>それ以外では 個人アカウントを招待するのではなく、企業アカウントの招待が行われます。<br>そのため、招待対象のアカウントが個人アカウントであっても Azure ポータルから追加を試みた場合には組織アカウントが招待されます。</p>
<p>また、このときに組織アカウントとして該当のアカウントが存在していない場合には、組織アカウントのユーザー作成処理が試みられます。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は、Azure AD B2B に関する概要について紹介しましたが、Azure AD B2B に関するトラブルや Azure AD B2B 完了後のトラブル、または招待メールを利用しない方法などの記事も必要に応じて参照ください。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/12/azure-active-directory/what-is-b2b/" data-id="cjtjvyw8d0013dgytrdz9b2nq" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/RBAC/">RBAC</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/powershell-module" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/04/azure-active-directory/powershell-module/" class="article-date">
  <time datetime="2017-12-03T15:00:00.000Z" itemprop="datePublished">2017-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/04/azure-active-directory/powershell-module/">Azure Active Directory の PowerShell モジュール</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、 Azure ID チームの三浦です。今回は Azure Active Directory (Azure AD) の PowerShell モジュールの種類、インストール方法についてご案内します。</p>
<p>Azure AD への操作は主に Azure ポータル、 Office 365 ポータル、 Graph API それに今回紹介します PowerShell からおこなうことができます。PowerShell モジュールについても複数ありますので、その種類をまず紹介します。</p>
<h2 id="Azure-AD-PowerShell-の種類"><a href="#Azure-AD-PowerShell-の種類" class="headerlink" title="Azure AD PowerShell の種類"></a>Azure AD PowerShell の種類</h2><p>Azure AD の PowerShell には次のようなものがあります。</p>
<h3 id="1-MSOnline-Azure-AD-v1"><a href="#1-MSOnline-Azure-AD-v1" class="headerlink" title="1. MSOnline (Azure AD v1)"></a>1. MSOnline (Azure AD v1)</h3><p>Office 365 をご利用いただいている方にとっては Office 365 のライセンスを割り当てるときにも利用しますので馴染み深いかもしれません。当初からあるもので、あとから紹介する Azure AD v2 と明示的に区別する際に Azure AD v1 モジュールとも呼びます。Connect-Msolservice のようにコマンドレットに “Msol” という文字列が含まれています。現状でも Azure AD に対する PowerShell コマンドでよく使われています。</p>
<h3 id="2-Azure-AD-for-Graph-Azure-AD-v2"><a href="#2-Azure-AD-for-Graph-Azure-AD-v2" class="headerlink" title="2. Azure AD for Graph (Azure AD v2)"></a>2. Azure AD for Graph (Azure AD v2)</h3><p>当初は Azure AD は Office 365 の認証基盤という意味合いが大きかったのですが、 Azure AD に新しい機能が追加されることに伴い Azure AD  PowerShell の機能を拡張させていく必要がでてきました。その対応のために従来の MSOnline を拡張するのではなく、別途異なるモジュールを開発するというアプローチを取ることになり Azure AD for Graph (Azure AD v2 と言うほうが一般的なので以降は Azure AD v2 とします) というモジュールが作成されました。基本的には MSOnline で提供していた機能は Azure AD v2 でも提供されます。例えばユーザー作成をおこなうときに MSOnline モジュールでは <a href="https://docs.microsoft.com/en-us/powershell/module/msonline/new-msoluser?view=azureadps-1.0" target="_blank" rel="noopener">New-Msoluser</a> というコマンドを使いますが、Azure AD v2 では <a href="https://docs.microsoft.com/ja-jp/powershell/azure/active-directory/new-user-sample?view=azureadps-2.0" target="_blank" rel="noopener">New-AzureADUser</a> を利用します。基本的に MSOL コマンドレットの拡張は予定されていないため、新しい機能などは Azure AD v2 のみで提供されます。というわけで今後は基本的に Azure AD v2 コマンドをご利用くださいと案内したいところなのですが、、、完全に MSOL コマンドで提供していたものをカバーしているわけではないため、残念なのですが (大変申し訳ないのですが)、従来の MSOL コマンドも併用していく必要があります。</p>
<h3 id="3-Azure-AD-for-Graph-preview-Azure-AD-v2-preview"><a href="#3-Azure-AD-for-Graph-preview-Azure-AD-v2-preview" class="headerlink" title="3. Azure AD for Graph preview (Azure AD v2 preview)"></a>3. Azure AD for Graph preview (Azure AD v2 preview)</h3><p>Azure AD v2 モジュールはかなり早いスピードで新しいコマンドが追加されています。なるべく早く新しいモジュールを提供できるようプレビュー版も用意しています。プレビュー版については実際の運用環境での利用は推奨していませんが、Public Preview 中の機能を利用するためにはプレビュー版を利用する必要があることが多くあります。また、 Azure AD v2 の通常版 = General Availability 版がすでにインストールされている環境で通常版とプレビュー版を併用することはできません。 Preview 版を利用したい場合には、先に通常版を Uninstall-Module コマンドでアンインストールしたうえでプレビュー版をインストールをします。</p>
<h2 id="インストール方法について"><a href="#インストール方法について" class="headerlink" title="インストール方法について"></a>インストール方法について</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>MSOnline (Azure AD v1) と Azure AD v2 では前提となる .net Framework のバージョンが厳密には異なり、 MSOnline の場合には必ずしも必要にはならないのですが、古いものを利用していると問題が生じることがあるので、 Azure AD v1、 v2 を問わず、以下の前提条件を満たすようにしてください。なお、 Windows 10 / Windows Server 2016 は .NET Framework、 PowerShell の要件を既定で満たしていますので前提条件については考慮不要です。</p>
<ul>
<li>.NET Framework: バージョン 4.5.2 以降 (*1)</li>
<li>PowerShell: バージョン 5.0 以降 (*1)</li>
<li>OS: Windows 7 SP1 (*2)、 Windows Server 2008 R2 以降</li>
</ul>
<blockquote>
<ol>
<li>.NET Framework および PowerShell のバージョンについては、厳密に言うとこれを満たしていなくても動作するバージョンもありますが、古いバージョンだと問題が生じることがあるため上記を満たすようにします。</li>
<li>クライアント OS で利用する場合には 32 bit 環境ではなく 64 bit 環境の必要があります。</li>
</ol>
</blockquote>
<p>.NET Framework と PowerShell のインストール方法、現在インストールされているバージョンの確認方法は次の通りです。</p>
<h3 id="NET-Framework"><a href="#NET-Framework" class="headerlink" title=".NET Framework"></a>.NET Framework</h3><p>以下のサイトから .NET Framework 4.6 をインストールします。</p>
<p>Microsoft .NET Framework 4.6<br><a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=48137" target="_blank" rel="noopener">https://www.microsoft.com/ja-jp/download/details.aspx?id=48137</a></p>
<p>インストールを試みたときにすでにインストールされているという旨のメッセージが表示された場合にはすでにインストールされていますので不要です。実際にインストール ウィザードを実行していなくとも .NET Framework でどのバージョンがインストールされているかは、 PowerShell のウィンドウを開き、次のコマンドを実行することで確認できます。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ChildItem</span> <span class="string">'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP'</span> -recurse | <span class="built_in">Get-ItemProperty</span> -name Version,Release -EA <span class="number">0</span> | Where &#123; <span class="variable">$_</span>.PSChildName <span class="nomarkup">-match</span> <span class="string">'^(?!S)\p&#123;L&#125;'</span>&#125; | Select PSChildName, Version, Release</span><br></pre></td></tr></table></figure>
<p>以下の例では 4.7.02046 という新しいバージョンがインストールされていることが確認できます (4.7 のバージョンは OS によっては追加のモジュールのインストールが必要なのでここでは 4.6 の紹介にしていますが、もちろん 4.7 のインストールで構いません)。</p>

<h3 id="PowerShell-モジュール"><a href="#PowerShell-モジュール" class="headerlink" title="PowerShell モジュール"></a>PowerShell モジュール</h3><p>PowerShell のバージョンを 5.0 以上にするために Windows Management Framework (WMF) 5.1 を以下のサイトからダウンロードしてインストールします。</p>
<p>Windows Management Framework 5.1<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=54616" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=54616</a></p>
<p>システムの PowerShell のバージョンは $psversiontable で確認できます。以下の例だと 5.1.15063.726 というバージョンがインストールされていることが確認できます。</p>
<img src="/blog/2017/12/04/azure-active-directory/powershell-module/powershell-version.jpg">
<h3 id="Azure-AD-PowerShell-インストール方法"><a href="#Azure-AD-PowerShell-インストール方法" class="headerlink" title="Azure AD PowerShell インストール方法"></a>Azure AD PowerShell インストール方法</h3><p>上記の前提条件を満たしたうえで、次の手順でインストールを実施します。</p>
<ol>
<li>管理者で PowerShell を起動します。</li>
<li><p>下記のコマンドを実行し、モジュールをダウンロードし、インストールします。</p>
<p> MSOnline (Azure AD v1):</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name MSOnline</span><br></pre></td></tr></table></figure>
<p> Azure AD for Graph (Azure AD v2):</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name AzureAD</span><br></pre></td></tr></table></figure>
<p> Azure AD for Graph preview (Azure AD v2 preview):</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name AzureADPreview</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>Azure AD v2 と Azure AD v2 preview の両方を同じコンピューターにインストールできませんのでご注意ください。Azure AD Preview が必要にも関わらず Install-Module -Name AzureAD を実行してインストールした場合には、一度 Uninstall-Module -Name AzureAD を実行してアンインストールの上で Install-Module -Name AzureADPreview を実行します。</p>
</blockquote>
<blockquote>
<p>NuGet プロバイダーが必要というメッセージが表示された場合には Y をクリックして進めます。信頼されていないレポジトリのメッセージが表示された場合にも Y をクリックして進めます。それぞれの次のようなメッセージが表示されます。</p>
</blockquote>
<p>NuGet のメッセージ:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NuGet provider is required to <span class="keyword">continue</span></span><br><span class="line">PowerShellGet requires NuGet provider version <span class="string">'2.8.5.201'</span> or newer to interact with NuGet-based repositories. The NuGet</span><br><span class="line">provider must be available <span class="keyword">in</span> <span class="string">'C:\Program Files\PackageManagement\ProviderAssemblies'</span> or</span><br><span class="line"><span class="string">'C:\Users\taguiadmin\AppData\Local\PackageManagement\ProviderAssemblies'</span>. You can also install the NuGet provider by</span><br><span class="line">running <span class="string">'Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force'</span>. <span class="keyword">Do</span> you want PowerShellGet to install</span><br><span class="line">and import the NuGet provider now?</span><br><span class="line">[Y] Yes  [N] No  [S] Suspend  [?] Help (default is <span class="string">"Y"</span>):</span><br></pre></td></tr></table></figure>
<p>レポジトリのメッセージ:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Untrusted repository</span><br><span class="line">You are installing the modules from an untrusted repository. <span class="keyword">If</span> you trust this repository, change its</span><br><span class="line">InstallationPolicy value by running the Set-PSRepository cmdlet. Are you sure you want to install the modules from</span><br><span class="line"><span class="string">'PSGallery'</span>?</span><br><span class="line">[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is <span class="string">"N"</span>):</span><br></pre></td></tr></table></figure>
<blockquote>
<p>明示的にバージョン番号を指定する場合にはコマンドに -RequiredVersion 2.0.0.137 というように引数としてバージョン情報を追加します。</p>
</blockquote>
<blockquote>
<p>MSOnline については以前は Connect サイトからインストールパッケージをダウンロードできましたが、サイトのリタイアに伴いダウンロード パッケージは提供されなくなりました。Install-Module コマンドを実行することでインストールします。</p>
</blockquote>
<h2 id="補足事項"><a href="#補足事項" class="headerlink" title="補足事項"></a>補足事項</h2><p>&lt;別端末で保存したファイルを利用したい場合&gt;</p>
<p>何らかの理由で直接 Install-Module を実行してのインストールができないケースが稀にあります (ウイルス対策ソフトの影響等)。この場合には、他の端末で必要なモジュールを取得し、入手したファイルを元に Import-Module を実行する方法もあります (あまり多くの実績があるものではないため、基本は Install-Module での対応をお勧めします)。以下は Azure AD for Graph の例です。</p>
<ol>
<li>管理者として PowerShell を起動します。</li>
<li><p>下記のコマンドレットを実行し、リポジトリ ファイル群をダウンロードします。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Save-Module -Name AzureAD -Path C:\temp\</span><br></pre></td></tr></table></figure>
<blockquote>
<p>C:\temp\ は保存先フォルダの指定となりますので、任意の存在するパス/フォルダをご指定ください。</p>
</blockquote>
</li>
<li><p>指定したフォルダ配下の \AzureAD\&lt;バージョン番号&gt;\ フォルダ配下に、リポジトリ ファイル群が展開されたことを確認します。</p>
</li>
<li><p>実際に Azure AD の PowerShell コマンドを利用したい端末の C:\Program Files\WindowsPowerShell\Modules フォルダに 2 でダウンロードしたフォルダ (今回の例の場合 c:\temp 配下の AzureAD フォルダ) をコピーします。</p>
</li>
<li><p>C:\Program Files\WindowsPowerShell\Modules フォルダに保存されたモジュールは PowerShell で自動的にロードされるため、そのまま実行ができるはずですが、コマンドがエラーになる場合には、以下を実行したうえで Connect-AzureAD  などを実行します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> C:\Program Files\WindowsPowerShell\Modules\AzureAD\&lt;バージョン番号&gt;\AzureAD.psd1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>&lt;認証プロキシが存在する場合の注意事項&gt;</p>
<p>インターネットにアクセスする際に認証が必要なプロキシが存在するようなネットワーク環境では、 PowerShell 起動時に以下のコマンドを実行し、認証が必要なプロキシを経由してアクセスができるようにします。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ProxyCredential</span> = <span class="built_in">New-Object</span> System.Net.NetworkCredential(<span class="string">"ユーザー名"</span>,<span class="string">"パスワード"</span>)</span><br><span class="line">[System.Net.WebRequest]::DefaultWebProxy.Credentials = <span class="variable">$ProxyCredential</span></span><br></pre></td></tr></table></figure>
<p>&lt;モジュールがインストールされているかの確認&gt;</p>
<p>モジュールがインストールされているかは Get-InstalledModule コマンドで確認できます。</p>
<img src="/blog/2017/12/04/azure-active-directory/powershell-module/get-installedmodule.jpg">
<p>&lt;モジュールのアンインストール方法&gt;</p>
<p>Uninstall-Module コマンドでアンインストールができます。Azure AD v2 の通常版と Preview 版は併用できませんので、通常版を利用している環境で Preview 版を利用したい場合には管理者で PowerShell を起動し、 Preview 版をインストール前に次のコマンドで通常版のアンインストールが必要です。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uninstall-Module AzureAD</span><br></pre></td></tr></table></figure>
<p>以上です。最後に参考資料をご紹介します。</p>
<h2 id="参考資料"><a href="#参考資料" class="headerlink" title="参考資料"></a>参考資料</h2><p>Azure Active Directory PowerShell for Graph<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/active-directory/install-adv2?view=azureadps-2.0" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/powershell/azure/active-directory/install-adv2?view=azureadps-2.0</a></p>
<p>Azure​AD (Azure AD v2 コマンド一覧)<br><a href="https://docs.microsoft.com/en-us/powershell/azuread/v2/azureactivedirectory" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/powershell/azuread/v2/azureactivedirectory</a></p>
<p>AzureAD PowerShell’s Profile (Azure AD PowerShell 最新版リスト。 V1、 V2、 V2Preview)<br><a href="https://www.powershellgallery.com/profiles/AzureADPowerShell/" target="_blank" rel="noopener">https://www.powershellgallery.com/profiles/AzureADPowerShell/</a></p>
<h2 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h2><ul>
<li>2017/12/04: 公開しました。</li>
<li>2017/12/20: 前提条件について追記を行いました。</li>
<li>2018/01/31: Microsoft Connect のリタイアに伴い MSOnline モジュールのダウンロードができなくなったため追記しました。また、インストール時の手順として Save-Module は必要がありませんが、補足事項として別項を追加しました。</li>
<li>2018/02/08: Windows 10/2016 では前提条件を既定で満たしていることを追記しました。モジュールインストール時に表示される可能性があるメッセージを掲載しました。TLS 1.2 への対応などを考慮すると 4.6 のほうが望ましいため .NET Framework のダウンロードリンクを 4.6 のものに変更しました。</li>
<li>2018/05/10: モジュールがインストールされているかの確認方法とアンインストール コマンドを追記しました。</li>
<li>2018/07/13: Windows Management Framework 5.0 のリンクを 5.1 に変更しました。</li>
<li>2018/08/07: Save-Module で別端末でダウンロードしたモジュールを利用する際の手順を更新しました。</li>
<li>2018/10/17: Windows Management Framework (WMF) のサポート対象が 5.1 であることから .NET Framework の前提条件を WMF 5.1 インストールに必要となる 4.5.2 に変更しました。</li>
<li>2019/01/23: Azure AD v2 と Azure AD v2 preview が同時インストールできない注意書きをインストールの項目にも追記しました。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/04/azure-active-directory/powershell-module/" data-id="cjtjvyw9l002pdgytdunun3et" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/PowerShell/">PowerShell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/qanda-conditional-access" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/" class="article-date">
  <time datetime="2017-12-03T15:00:00.000Z" itemprop="datePublished">2017-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/">Azure AD の条件付きアクセスに関する Q&amp;A</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの高田です。</p>
<p>今回はお問い合わせをよくいただく、Azure AD の条件付きアクセスについてです。</p>
<p>お問い合わせの多いご質問について、Q&amp;A 形式でおまとめいたしました。既存のドキュメントではカバーされていない動作や質問について今後も適宜内容を拡充していきますので、ご参照いただければと思います。</p>
<hr>
<p><span style="color:blue">Q</span>. Office 365 を利用しているが、条件付きアクセスを利用できますか？</p>
<p><span style="color:red">A</span>. はい、利用可能です。Office 365 をご利用いただいているお客様は、認証基盤として Azure AD をご利用いただいている状態となります。そのため、追加で Azure AD Premium のライセンスを購入いただくことで、利用可能になります。</p>
<hr>
<p><span style="color:blue">Q</span>. Azure AD Application Proxy を利用して公開しているアプリケーションなども条件付きアクセスで制御可能でしょうか。</p>
<p><span style="color:red">A</span>. はい、条件付きアクセスで制御可能です。Azure AD 上に登録されているアプリケーションであれば、条件付きアクセスで制御できます。Azure AD Application Proxy を利用して公開しているアプリケーションやご自身で開発し Azure AD 上に登録したアプリケーションも制御対象とすることが可能です。</p>
<hr>
<p><span style="color:blue">Q</span>. Azure AD B2B コラボレーション機能により招待されたゲスト ユーザーに対して条件付きアクセスのルールを適用する場合には、Azure AD Premium のライセンスを購入する必要があるのでしょうか。</p>
<p><span style="color:red">A</span>. いいえ、テナントに割り当てられている Azure AD Premium ライセンス数の 5 倍までのアカウントであれば、ゲスト ユーザーに対して条件付きアクセスを含む Azure AD Premium の機能を利用させることが可能です。詳細は下記公開情報を参照ください。</p>
<p>Azure Active Directory B2B コラボレーションのライセンスに関するガイダンス<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-licensing" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-licensing</a></p>
<hr>
<p><span style="color:blue">Q</span>. Azure AD Premium のライセンスを対象人数分購入すれば、該当ユーザーに割り当てる必要はないでしょうか。</p>
<p><span style="color:red">A</span>. いいえ、要件として人数分購入いただくだけでなく、ユーザーに対して割り当てる必要がございます。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスを利用するためには、Azure AD Premium のライセンス数を何個購入すればよいでしょうか？</p>
<p><span style="color:red">A</span>. 条件付きアクセスの機能を利用してアプリケーションへのアクセス可否の評価が行われるユーザーに対して、Azure AD Premium (P1 以上) を割り当てる必要があります。現時点の実装では、Azure AD Premium ライセンスを割り当てていないユーザーであっても、ポリシーの対象であれば条件付きアクセス ポリシーの内容に従ってアクセス制限が行われますが、このような状態での利用はライセンス違反となります。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスのポリシーを複数作成し、適用の優先順位をつけることは可能でしょうか。</p>
<p><span style="color:red">A</span>. いいえ、優先順位を作成することはできません。条件付きアクセスではそれぞれのポリシーが独立しており、条件に合致したものが適用されます。各ポリシーで条件が重複しないように構成することを検討ください。</p>
<hr>
<p><span style="color:blue">Q</span>. Exchange Online に対して条件付きアクセスを設定したところ Office 365 ポータルに対しても条件付きアクセスが設定されてしまいました。これは想定される動作でしょうか？</p>
<p><span style="color:red">A</span>. はい、これは想定される動作です。 2017 年 8 月 24 日以降は Exchange Online または SharePoint Online を対象とした条件付きアクセスが Office 365 ポータルにも反映されます。詳細は英語での情報となりますが以下のリンクも参照ください。</p>
<p>An update to Azure AD Conditional Access for Office.com<br><a href="https://cloudblogs.microsoft.com/enterprisemobility/2017/08/04/an-update-to-azure-ad-conditional-access-for-office-com/" target="_blank" rel="noopener">https://cloudblogs.microsoft.com/enterprisemobility/2017/08/04/an-update-to-azure-ad-conditional-access-for-office-com/</a></p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスの [場所] の条件にクライアントの IP アドレス範囲を入れましたが制御されません。どうしてでしょうか？</p>
<p><span style="color:red">A</span>. 条件付きアクセスの [場所] の条件では、組織が外部と通信する際のグローバル IP アドレス (Azure AD から見た送信元グローバル IP アドレス) を利用します。例えば、社内のクライアントがプライベート IP アドレスを保持しており、外部ネットワークと通信する際にはグローバル IP アドレスを持つゲートウェイを経由して Azure AD と通信する環境があるとします。この場合、Azure AD から見ると、送信元 IP アドレスはグローバル IP アドレスを持つゲートウェイとなります。このような時は、件付きアクセスの [場所] の条件には、ゲートウェイのグローバル IP アドレスを指定ください。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスで、X-Forwarded-For HTTP ヘッダーを利用して、組織内のクライアントの送信元 IP アドレスを判断可能ですか？</p>
<p><span style="color:red">A</span>. いいえ、X-Forwarded-For HTTP ヘッダーを使用し、条件付きアクセスで組織内のクライアントの送信元 IP アドレスを判定することはできません。条件付きアクセスの [場所] の条件では、組織が外部と通信する際のゲートウェイが持つグローバル IP アドレス (Azure AD から見た送信元グローバル IP アドレス) が制御に利用されます。Azure AD には、このグローバル アドレスを場所として利用します。<br>X-Forwarded-For HTTP ヘッダーは HTTP ヘッダー フィールドの 1 つです。ロード バランサーなどでクライアントの送信元 IP アドレスが変換された場合でも、HTTP ヘッダーに接続元のクライアント IP アドレスの情報を付加することで、接続先サーバーが接続元クライアント IP アドレスを特定できるようにするために利用されます。しかしながら、この X-Forwarded-For HTTP ヘッダーで指定された情報は組織内の IP アドレスであり、場所を示すものではありません。このような理由から、現状 Azure AD では、組織が外部と通信する際のゲートウェイのグローバル IP アドレス (Azure AD から見た送信元グローバル IP アドレス) を制御に利用しています。</p>
<hr>
<p><span style="color:blue">Q</span>. クレームルールと条件付きアクセスは併用は可能ですか？</p>
<p><span style="color:red">A</span>. はい、技術的には可能です。AD FS を利用したフェデレーション環境であれば、クレーム ルールが判定された後、条件付きアクセスが動作します。クレーム ルールで認証が拒否された場合は、その後の条件付きアクセスの処理は動作しません。ただし、類似機能であるため運用の複雑さなどを考慮すると、どちらか一方の機能をメインでご利用いただくのがよいかと存じます。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスの設定において、全てユーザーがアクセスできない設定になってしまいました。設定を解除可能でしょうか。</p>
<p><span style="color:red">A</span>. このような状況の場合は、残念ながらお客様側での解除はできません。そのため、設定の解除をご希望の場合は、お手数ですが弊社サポート サービスをご利用いただけますと幸いです。Azure ポータルにもアクセスができない状況と存じますので、ほかにお持ちのテナントからお問い合わせを発行ください。<br>サポート サービスをご利用いただくには、Azure ポータル上から、Azure Active Directory を選択し、[新しいサポート要求] を選択ください。以下のような画面からお問い合わせいただければと思います。</p>
<img src="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/create-support-ticket-1.png">
<img src="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/create-support-ticket-2.png">
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/04/azure-active-directory/qanda-conditional-access/" data-id="cjtjvyw9v002sdgytsczysuko" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/azuread-access-denied" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/11/20/azure-active-directory/azuread-access-denied/" class="article-date">
  <time datetime="2017-11-19T15:00:00.000Z" itemprop="datePublished">2017-11-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/20/azure-active-directory/azuread-access-denied/">「アクセス権がありません」のエラーについて</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は Azure ポータル上で表示される Azure AD に関するエラーメッセージについて説明します。</p>
<p>Azure ポータル上で、[Azure Active Directory] を選択した際に、下記のエラーが表示される場合があります。</p>
<hr>
<p>アクセスが拒否されました</p>
<p>アクセス権がありません</p>
<p>このコンテンツへのアクセス権がないようです。アクセス権を得るには、所有者に連絡してください。</p>
<hr>
<p>画面は下記のような表示です。</p>
<img src="/blog/2017/11/20/azure-active-directory/azuread-access-denied/azuread-access-denied.png">
<p>こちらは、エラーメッセージの通りアクセスしようとしたユーザーの権限が不足している状況を示すエラーになります。</p>
<p>ここでいう、権限とはサブスクリプションの権限（RBAC で付与した所有者の権限など）とは異なる、Azure AD の権限となります。</p>
<p>サブスクリプションの管理者と Azure AD の管理者の説明については、下記のブログをご確認ください。</p>
<p>-参考情報</p>
<p><a href="./subscription-azure-ad-relationship.md">Azure サブスクリプションと Azure AD の管理者</a></p>
<p>詳細<br>下記、 [Azure AD 管理ポータルへのアクセスを制限する] が「はい」に設定されている場合は、Azure AD の管理者権限を持ったユーザーのみが [Azure Active Directory] を参照できるようになります。</p>
<p>こちらを「いいえ」に設定することで、一般のユーザーでも [Azure Active Directory] 配下の参照が可能になりますが、設計上「はい」にする必要がある場合は、個別のユーザー毎に下記の回避策をご実施ください。</p>
<img src="/blog/2017/11/20/azure-active-directory/azuread-access-denied/azuread-portal.png">
<p>回避策<br>Azure AD ディレクトリの全体管理者の権限をもつユーザーで、Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) へサインインします。<br>[Azure Active Directory] - [ユーザーとグループ] - [すべてのユーザー] - [（権限を付与する）ユーザー] の順に選択します。<br>[ディレクトリ ロール] をクリックします。<br>全体管理者 (または制限付き管理者) を選択して [保存] をクリックします。</p>
<p>管理者の種類と役割については、下記の弊社公開情報をご確認ください。</p>
<p>Azure Active Directory での管理者ロールの割り当て</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles</a></p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/11/20/azure-active-directory/azuread-access-denied/" data-id="cjtjvyw7l000adgytsrzqgktg" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/subscription-azure-ad-relationship" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/" class="article-date">
  <time datetime="2017-11-03T15:00:00.000Z" itemprop="datePublished">2017-11-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/">Azure サブスクリプションと Azure AD の管理者</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、 Azure ID サポートチームの三浦です。</p>
<p>今回は混乱することが多い Azure のサブスクリプションと Azure Active Directory (Azure AD) の関係、それぞれの管理者について紹介します。</p>
<h2 id="Azure-サブスクリプションと-Azure-AD-の関係"><a href="#Azure-サブスクリプションと-Azure-AD-の関係" class="headerlink" title="Azure サブスクリプションと Azure AD の関係"></a>Azure サブスクリプションと Azure AD の関係</h2><p>まず、 Azure サブスクリプションと Azure AD の関係ですが、 Azure のサブスクリプションに Azure AD が含まれているというイメージを持たれている方もいるかもしれませんが、以下の図のようなイメージは間違いです。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/wrong-understanding.png">
<p>正しくは Azure サブスクリプションと Azure AD には包含関係は無く、独立しています。Azure サブスクリプションは必ず 1 つの Azure AD に関連付けられています (*注1) ので、両者の関係性は次のような図になります。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/subscription-relationship.png">
<p>上の図では 2 つのサブスクリプションが Office 365 を利用中の同一の Azure AD に関連づけられている例です。この例では Office 365 で利用しているアカウント情報を Azure のサブスクリプションも参照し、サブスクリプションへのアクセス権限の付与などにもそのまま利用します。</p>
<blockquote>
<p>注 1: 関連付けのことを “信頼しています” という表現を使用する場合もあります。この関連付けを変更するためには、サブスクリプションのアカウント管理者を別の Azure AD のユーザーに譲渡する作業、もしくはディレクトリの切り替えの作業が必要です。Azure AD に関連づけられた Azure のサブスクリプションは 1 つの場合もありますし、3 つ以上の場合もあります。また、 Office 365 を利用中の Azure AD に関連付けることもできれば、そうではないケースもあります。</p>
</blockquote>
<p>1 つの Azure サブスクリプションが複数の Azure AD を指定することはできません。Azure サブスクリプションが参照する Azure AD は必ず 1 つです。</p>
<h2 id="Azure-サブスクリプションの管理者"><a href="#Azure-サブスクリプションの管理者" class="headerlink" title="Azure サブスクリプションの管理者"></a>Azure サブスクリプションの管理者</h2><p>Azure サブスクリプションの管理者については Microsoft Azure の各種アカウント権限について にそれぞれ説明があります。少し補足するとAzure クラシック ポータル時代にはアカウント管理者、サービス管理者、共同管理者という 3 つの役割しかありませんでした。</p>
<p>現在の Azure 新ポータルでも、それぞれの管理者は有効ですが、それに加えてサブスクリプション単位ではなく、リソース毎に閲覧、あるいは編集が可能なユーザーを柔軟に設定できる仕組み (RBAC = Role Based Access Control ロールベースのアクセス制御 *注2) が設定できます。サブスクリプションに対して所有者というロールを割り当てれば、従来のクラシック ポータルでの共同管理者相当になります。この RBAC の設定では Azure サブスクリプションが関連付けられた Azure AD のアカウント情報が利用されます。</p>
<blockquote>
<p>注 2: Azure ポータルで RBAC の設定を行う場合には Access Control (IAM) からおこないます。 IAM は Identity and Access Management の略です。</p>
</blockquote>
<h2 id="Azure-AD-の管理者"><a href="#Azure-AD-の管理者" class="headerlink" title="Azure AD の管理者"></a>Azure AD の管理者</h2><p>Azure AD でも Azure サブスクリプションの場合と同様に様々な役割があり、その詳細は Azure Active Directory での管理者ロールの割り当て で確認できます。代表的なものとして全体管理者 (Global Administrator) がありますが、この役割をもつアカウントは Azure AD のディレクトリに対してすべての権限を持ちます。</p>
<p>なお、各 Azure AD ディレクトリ (テナント) は独立していますので、ある Azure AD で全体管理者になっていても別の Azure AD の全体管理者になるわけではありません。例えば company1com.onmicrosoft.com という Azure AD ディレクトリの全体管理者は company2com.onmicrosoft.com の全体管理者ではありません。ただ、 B2B の機能で company2com.onmicrosoft.com から招待を受け、更にこのディレクトリの全体管理者の権限の付与を受けることは可能です。</p>
<h2 id="Azure-サブスクリプションの管理者と-Azure-AD-の管理者"><a href="#Azure-サブスクリプションの管理者と-Azure-AD-の管理者" class="headerlink" title="Azure サブスクリプションの管理者と Azure AD の管理者"></a>Azure サブスクリプションの管理者と Azure AD の管理者</h2><p>Azure サブスクリプションと Azure AD はそれぞれ独立したものです。</p>
<p>管理者についてもそれぞれ独立していますので Azure サブスクリプションの管理者であっても Azure AD の全体管理者でなければ、 Azure AD の管理 (ユーザー追加、削除など) はできません。同様に Azure AD の全体管理者であっても、必ずしも紐づく Azure サブスクリプションの管理者ではありません。</p>
<p>例えば次のような関係を考えてみましょう。</p>
<p>company1 という会社ではすでに Azure AD を保持しており、その Azure AD のディレクトリ名は company1com.onmicrosoft.com です。この Azure AD にはカスタムドメインとして company1.com というドメイン名が紐づけられています (*注3)。以下の図では <a href="mailto:user1@company1.com" target="_blank" rel="noopener">user1@company1.com</a> というアカウントが Azure のサブスクリプションを作成した状態での関係を示しています。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/subscription-relationship-a.png">
<p><a href="mailto:user1@company1.com" target="_blank" rel="noopener">user1@company1.com</a> というアカウントは Azure のサブスクリプションのアカウント管理者でありサービス管理者です。そのため、サブスクリプション内のすべての権限を持ちます。例えばこのサブスクリプション内で仮想マシンを作成したり、仮想ネットワークを設定したりすることができます。しかし、関連づけられている Azure AD に対しては user1 は管理者権限を持ちません。Azure AD に対して管理者権限を必要とする作業を実施する場合には <a href="mailto:admin1@company1com.onmicrosoft.com" target="_blank" rel="noopener">admin1@company1com.onmicrosoft.com</a> または <a href="mailto:admin2@company1.com" target="_blank" rel="noopener">admin2@company1.com</a> という全体管理者に、作業を依頼するか、あるいは自身に Azure AD の権限を与えてくれるように依頼する必要があります。</p>
<p>別のパターンを考えてみます。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/subscription-relationship-b.png">
<p>ここでは Microsoft アカウントの <a href="mailto:user2@outlook.com" target="_blank" rel="noopener">user2@outlook.com</a> を指定して Azure サブスクリプションを作成しています。この例の outlook.com のように企業に紐づかない Microsoft アカウントを利用して Azure サブスクリプションを作成した場合など、サブスクリプション作成時に利用したアカウントが所属する Azure AD が無い場合には、新規で Azure AD ディレクトリが自動的に作成されます。この場合、特に役割の追加作業をしていなくても Azure サブスクリプションのアカウント管理者 = Azure AD の全体管理者になります。</p>
<p>この場合でも以下のようにサブスクリプションに別のアカウント <a href="mailto:user3@outlook.com" target="_blank" rel="noopener">user3@outlook.com</a> を所有者として追加した場合には、このアカウントは Azure AD の管理者ではありませんので、もしそのアカウントにも権限を付与したいのであれば <a href="mailto:user2@outlook.com" target="_blank" rel="noopener">user2@outlook.com</a> が、 <a href="mailto:user3@outlook.com" target="_blank" rel="noopener">user3@outlook.com</a> を全体管理者にする作業が必要です。</p>
<blockquote>
<p>注 3: Azure AD では必ず設定される xxxxx.onmicrosoft.com というドメイン名に加えてカスタムドメイン名を追加することができます。カスタムドメイン名を追加するためには、そのドメインに対して権限を持っている (ドメインのゾーンをインターネットで名前解決でき、そのゾーンを管理している) 必要があります。詳しくはこちらのサイトを参照ください。</p>
</blockquote>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は混乱しやすい Azure サブスクリプションと Azure AD の関係についてご紹介しました。いろいろな管理者が存在していますが、その管理者が Azure サブスクリプションの管理者なのか Azure AD の管理者なのかということを意識するとわかりやすくなると思います。</p>
<p>文中でも一部触れていますが、参考となる公開情報を紹介しまして、今回は以上とします。</p>
<p>Microsoft Azure の各種アカウント権限について<br><a href="https://blogs.msdn.microsoft.com/dsazurejp/2013/10/02/303/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/dsazurejp/2013/10/02/303/</a></p>
<p>Azure サブスクリプションを Azure Active Directory に関連付ける方法<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-how-subscriptions-associated-directory" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-how-subscriptions-associated-directory</a></p>
<p>Azure Active Directory での管理者ロールの割り当て<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles-azure-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles-azure-portal</a></p>
<p>クイック スタート: カスタム ドメイン名を Azure Active Directory に追加する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/add-custom-domain" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/add-custom-domain</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/" data-id="cjtjvywa5002tdgytbjgxyj1c" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Subscription/">Subscription</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/page/2/">&laquo; 戻る</a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/blog/page/4/">4</a><a class="extend next" rel="next" href="/blog/page/4/">次へ &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグ</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AAD-Connect/">AAD Connect</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AD-Sync/">AD Sync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-Application-Proxy/">Azure AD Application Proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-Directory-Rolls/">Azure AD Directory Rolls</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-License/">Azure AD License</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/CBA/">CBA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ExpressRoute/">ExpressRoute</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hard-match/">Hard match</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Intune/">Intune</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MFA/">MFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/PowerShell/">PowerShell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/RBAC/">RBAC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Sgin-in-log/">Sgin-in log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Smart-lockout/">Smart lockout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Subscription/">Subscription</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Tenant-Restrictions/">Tenant Restrictions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/UPN/">UPN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Windows-Defender-ATP/">Windows Defender ATP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Workplace-Join/">Workplace Join</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/サポート/">サポート</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/トラブルシューティング/">トラブルシューティング</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/情報採取/">情報採取</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/証明書認証/">証明書認証</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグクラウド</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/AAD-Connect/" style="font-size: 16px;">AAD Connect</a> <a href="/blog/tags/AD-FS/" style="font-size: 18px;">AD FS</a> <a href="/blog/tags/AD-Sync/" style="font-size: 10px;">AD Sync</a> <a href="/blog/tags/Azure-AD/" style="font-size: 20px;">Azure AD</a> <a href="/blog/tags/Azure-AD-Application-Proxy/" style="font-size: 10px;">Azure AD Application Proxy</a> <a href="/blog/tags/Azure-AD-B2B/" style="font-size: 14px;">Azure AD B2B</a> <a href="/blog/tags/Azure-AD-Directory-Rolls/" style="font-size: 10px;">Azure AD Directory Rolls</a> <a href="/blog/tags/Azure-AD-License/" style="font-size: 10px;">Azure AD License</a> <a href="/blog/tags/CBA/" style="font-size: 10px;">CBA</a> <a href="/blog/tags/Conditional-Access/" style="font-size: 16px;">Conditional Access</a> <a href="/blog/tags/ExpressRoute/" style="font-size: 10px;">ExpressRoute</a> <a href="/blog/tags/Hard-match/" style="font-size: 10px;">Hard match</a> <a href="/blog/tags/Hybrid-Azure-AD-Join/" style="font-size: 10px;">Hybrid Azure AD Join</a> <a href="/blog/tags/Intune/" style="font-size: 12px;">Intune</a> <a href="/blog/tags/MFA/" style="font-size: 10px;">MFA</a> <a href="/blog/tags/PowerShell/" style="font-size: 10px;">PowerShell</a> <a href="/blog/tags/RBAC/" style="font-size: 12px;">RBAC</a> <a href="/blog/tags/Security/" style="font-size: 12px;">Security</a> <a href="/blog/tags/Sgin-in-log/" style="font-size: 10px;">Sgin-in log</a> <a href="/blog/tags/Smart-lockout/" style="font-size: 10px;">Smart lockout</a> <a href="/blog/tags/Subscription/" style="font-size: 10px;">Subscription</a> <a href="/blog/tags/Tenant-Restrictions/" style="font-size: 10px;">Tenant Restrictions</a> <a href="/blog/tags/UPN/" style="font-size: 10px;">UPN</a> <a href="/blog/tags/Windows-Defender-ATP/" style="font-size: 10px;">Windows Defender ATP</a> <a href="/blog/tags/Workplace-Join/" style="font-size: 10px;">Workplace Join</a> <a href="/blog/tags/サポート/" style="font-size: 12px;">サポート</a> <a href="/blog/tags/トラブルシューティング/" style="font-size: 12px;">トラブルシューティング</a> <a href="/blog/tags/情報採取/" style="font-size: 12px;">情報採取</a> <a href="/blog/tags/証明書認証/" style="font-size: 10px;">証明書認証</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/10/">十月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2019/02/04/azure-active-directory/how-to-get-sign-in-logs/">Azure AD サインイン ログ取得方法まとめ</a>
          </li>
        
          <li>
            <a href="/blog/2018/12/12/azure-active-directory/last-signin-reports/">PowerShell にて全ユーザーの最終サインイン日時を一括で取得する方法</a>
          </li>
        
          <li>
            <a href="/blog/2018/11/01/azure-active-directory/create-subscription-error/">サブスクリプション作成時のエラー「アカウントが Azure サブスクリプションに関連付けられないディレクトリに属しています。別のアカウントでサインインしてください」</a>
          </li>
        
          <li>
            <a href="/blog/2018/11/01/active-directory-federation-service/adfs-cba-ts/">証明書認証のトラブルシューティング</a>
          </li>
        
          <li>
            <a href="/blog/2018/10/15/azure-active-directory/mfa-reset/">多要素認証 (MFA) のリセット手順</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Azure Identity Support Japan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>