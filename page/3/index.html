<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <!-- this tag should remove when publish production  -->
  <meta name="”robots”" content="”noindex”">
  

  
  <title>Japan Azure Identity Support Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta name="keywords" content="Azure,Azure AD,Identity,AD FS">
<meta property="og:type" content="website">
<meta property="og:title" content="Japan Azure Identity Support Blog">
<meta property="og:url" content="https://jpazureid.github.io/page/3/index.html">
<meta property="og:site_name" content="Japan Azure Identity Support Blog">
<meta property="og:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
<meta property="og:locale" content="ja">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Japan Azure Identity Support Blog">
<meta name="twitter:description" content="日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。">
  
    <link rel="alternate" href="/blog/atom.xml" title="Japan Azure Identity Support Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Japan Azure Identity Support Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://jpazureid.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-active-directory-federation-service/kmsi-not-shown-wia" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/" class="article-date">
  <time datetime="2017-12-13T15:00:00.000Z" itemprop="datePublished">2017-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/">フェデレーション環境 (Windows 統合認証) で [サインインの状態を維持しますか？] の画面が表示されない</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure ID サポートチームの高田です。<br>本日は、Azure AD のサインイン画面の変更とそれに伴うフェデレーション環境への影響についておまとめしました。</p>
<h2 id="現在と以前のサインイン-エクスペリエンス"><a href="#現在と以前のサインイン-エクスペリエンス" class="headerlink" title="現在と以前のサインイン エクスペリエンス"></a>現在と以前のサインイン エクスペリエンス</h2><p>まず、Microsoft では、11 月より Azure AD のサインイン画面にいくつか変更を加えております。具体的には、新しいサインイン エクスペリエンスが導入されており、Azure AD へのサインイン時に以下のような画面が表示されることにお気づきの方もいらっしゃると思います。</p>
<p>▼古いサインイン エクスペリエンス</p>
<img src="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/old-signin-page.png">
<p>▼新しいサインイン エクスペリエンス</p>
<img src="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/new-signin-page.png">
<img src="/blog/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/new-signin-page-kmsi.png">
<p>※画面遷移の説明は、下記ブログを参照ください。</p>
<p>Fewer login prompts: The new “Keep me signed in” experience for Azure AD is in preview<br><a href="https://cloudblogs.microsoft.com/enterprisemobility/2017/09/19/fewer-login-prompts-the-new-keep-me-signed-in-experience-for-azure-ad-is-in-preview/" target="_blank" rel="noopener">https://cloudblogs.microsoft.com/enterprisemobility/2017/09/19/fewer-login-prompts-the-new-keep-me-signed-in-experience-for-azure-ad-is-in-preview/</a></p>
<p>この [サインインの状態を維持しますか？] の画面は、古いサインイン画面の [サインインしたままにする] チェックボックスと同じ設定を表しています。Azure AD の [会社のブランド] から構成できる [サインインしたままにするオプションを表示する] の設定が [はい] の場合に表示されます。</p>
<p>既定ではこのオプションは [はい] の状態で、明示的に [いいえ] にしていない限り、基本的に上記の [サインインの状態を維持しますか？] の画面が表示されることとなります (オプションを [いいえ] にした場合、[サインインの状態を維持しますか？] の画面は表示されず、サインイン状態は維持されない動作です)。</p>
<p>※ [会社のブランド] を構成する手順につきましては、下記の公開情報を参照ください。</p>
<p>クイック スタート: Azure AD のサインイン ページに会社のブランドを追加する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/customize-branding" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/customize-branding</a></p>
<p>※ 以下は、上記設定画面における既知の問題と対処方法を案内している公開情報です。</p>
<p>「サインインしたままにするオプションを表示する」 の設定が保存できない<br><a href="https://answers.microsoft.com/thread/e8a32fbe-8d80-43f3-b99c-af585b4c57b" target="_blank" rel="noopener">https://answers.microsoft.com/thread/e8a32fbe-8d80-43f3-b99c-af585b4c57b</a></p>
<p>この [サインインの状態を維持しますか？] の画面は、 [サインインしたままにするオプションを表示する] オプションを [はい] にしていても、以下の場合に表示されません。</p>
<ol>
<li>Azure AD がユーザーのサインインをリスクある状態と判断した場合</li>
<li>フェデレーション ユーザーにてサインインを試行し、AD FS にて Windows 統合認証が用いられた場合</li>
</ol>
<p>上記 1 については、同一のマシンを複数人で共有していたり、短時間に長距離を移動したユーザーが該当します。<br>リスクの高いサインインについては以下の資料も参考にしていただければと思います。</p>
<p>Azure Active Directory ポータルのリスクの高いサインイン レポート<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-security-risky-sign-ins" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-reporting-security-risky-sign-ins</a></p>
<p>上記 2 は、社内にいるユーザーが AD FS を利用してサインインする場合を示しています。<br>Windows 統合認証を用いてサインインする場合、ユーザーから見るとアプリケーションへのアクセスから Azure AD へのリダイレクト、さらに AD FS へのリダイレクト後の Windows 統合認証がすべて自動的に完了する流れとなります。[サインインの状態を維持しますか？] の画面は、一連の処理の流れを止めることとなるため、Windows 統合認証の場合に表示されないよう実装されました。AD FS にて Windows 統合認証が用いられたとき、[サインインの状態を維持しますか？] の選択は表示されませんが、選択としては [いいえ] の状態で認証が完了しています。このため、サインインの状態は維持されません (Azure AD から永続的なクッキーは発行されません)。</p>
<p>AD FS を利用する場合でも、社内からではなく外部から WAP (Web Application Proxy) を介してアクセスするような場合や、社内からのアクセスであっても、Firefox 等、AD FS の標準設定では Windows 統合認証が使用できないブラウザをお使いの場合は、フォーム認証が用いられます。このときは、1 に合致していない状況であれば [サインインの状態を維持しますか？] の画面が表示されます。</p>
<h2 id="Windows-統合認証が行われた場合もサインインの状態を維持させる方法"><a href="#Windows-統合認証が行われた場合もサインインの状態を維持させる方法" class="headerlink" title="Windows 統合認証が行われた場合もサインインの状態を維持させる方法"></a>Windows 統合認証が行われた場合もサインインの状態を維持させる方法</h2><p>フェデレーション環境をお持ちのお客様において、AD FS で Windows 統合認証が行われた場合もサインインの状態を維持したい (Azure AD から永続的なクッキーを発行したい) とお考えのお客様においては、後述の対応を実施いただければと思います。</p>
<p>以下では AD FS 側でクレーム ルールを変更し、組織内からの認証の場合は、psso (Persistent SSO) と呼ばれるクレームをトークンに含めるように構成します。これを受け取った Azure AD は、サインイン状態を維持させるよう永続的なクッキーをクライアントに発行します。この際、「サインイン状態を維持しますか？」画面は表示されませんが、サインイン状態を維持するクッキーが発行されます ([サインインの状態を維持しますか？] 画面で手動にて [はい] を押下したのと同じ状態となります)。</p>
<p>AD FS サーバー上の手順を以下におまとめいたしましたので、ご確認いただけますと幸いです。</p>
<ol>
<li>AD FS サーバーに管理者でログオンします。</li>
<li>AD FS の管理コンソールを開きます。</li>
<li>画面左側のツリーから [証明書利用者信頼] を選択します。</li>
<li>[Microsoft Office 365 Identity Platform] を右クリックし、[要求規則の編集] を選択します。</li>
<li>[発行変換規則] で [規則の追加] をクリックします。</li>
<li>変換要求規則の追加ウィザードでドロップダウンから [カスタム規則を使用して要求を送信] を選択し、[次へ] をクリックします。</li>
<li>[要求規則名] の下のボックスに Keep Users Signed In と入力し、次に進みます。</li>
<li><p>[カスタム規則:] ボックスに次のように入力します。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c:[Type == &quot;http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork&quot;, Value == &quot;true&quot;]</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>[完了]をクリックし、ウィザードを終了します。</p>
</li>
</ol>
<p>上記クレーム ルールを追加しますと、社内からの (WAP を経由しない) アクセスの場合は、<a href="http://schemas.microsoft.com/2014/03/psso" target="_blank" rel="noopener">http://schemas.microsoft.com/2014/03/psso</a> のクレームがトークンに追加されます。Azure AD はこのクレームを確認し、永続的なクッキーをクライアントに発行します。AD FS ファーム全体 (全ユーザー) が対象となるルールですが、新しく psso のクレームを追加するだけですので、既存のクレーム ルールに影響を及ぼすことはありません。また、上記ウィザードの完了後すぐに効果が及びます。</p>
<p>なお、クレームルールの追加により予期しない動作が生じた場合は、追加したルールを削除すれば元に戻すことが可能ですので、その際は、追加したルールを削除することで対応ください。</p>
<h3 id="2018-02-21-追記"><a href="#2018-02-21-追記" class="headerlink" title="2018/02/21 追記:"></a>2018/02/21 追記:</h3><p>上記設定は、発行変換規則に対するものです。アクセス制御に影響する発行承認規則には変更を加えません。このため、上記設定を行っても既存のクレーム ルールでのアクセス制御に影響を及ぼすことはありません。上記設定を実施後に、これまで動作していたアクセスがブロックされるなどの影響が起きることはないとお考えください。影響が及ぶのは Azure AD が永続的なクッキーをクライアントに発行し、サインイン状態が維持されるという点のみです。</p>
<h3 id="2018-02-26-追記"><a href="#2018-02-26-追記" class="headerlink" title="2018/02/26 追記:"></a>2018/02/26 追記:</h3><p>クレーム ルールを制御することで、<a href="http://schemas.microsoft.com/2014/03/psso" target="_blank" rel="noopener">http://schemas.microsoft.com/2014/03/psso</a> のクレームを有効にする対象ユーザーを制御することが可能です。例えば以下のようにしてクレーム ルールを指定すれば、社内からのアクセスで、さらに指定したグループにユーザーが含まれている場合のみ psso を有効にできます。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c1:[Type == &quot;http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork&quot;, Value == &quot;true&quot;]</span><br><span class="line">&amp;&amp; c2:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid&quot;, Value == &quot;S-1-5-21-4118385845-2129555445-158388420-1121&quot;]</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
<p>上記のうち、S-1-5-21-4118385845-2129555445-158388420-1121 の箇所にご要望のグループの SID を指定ください。グループの SID は、[Active Directory ユーザーとコンピューター] や PowerShell の Get-ADGroup コマンドレットからご確認いただけます。</p>
<h3 id="2018-03-06-追記"><a href="#2018-03-06-追記" class="headerlink" title="2018/03/06 追記:"></a>2018/03/06 追記:</h3><p><strong>以上の内容は、Windows Server 2012 R2 以降の AD FS を対象とした手順です。</strong></p>
<p>Windows Server 2008 R2 および 2012 の AD FS をご利用の場合は以下のようにします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOT exists([Type == &quot;http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy&quot;])</span><br><span class="line">=&gt; issue(Type = &quot;http://schemas.microsoft.com/2014/03/psso&quot;, Value = &quot;true&quot;);</span><br></pre></td></tr></table></figure>
<p>なお、Windows Server 2008 R2 で x-ms-proxy クレームを利用するには AD FS 2.0 ロールアップ 3 の適用が必要です (要 OS 再起動)。</p>
<p>Description of Update Rollup 3 for Active Directory Federation Services (AD FS) 2.0<br><a href="https://support.microsoft.com/ja-jp/help/2790338/description-of-update-rollup-3-for-active-directory-federation-service" target="_blank" rel="noopener">https://support.microsoft.com/ja-jp/help/2790338/description-of-update-rollup-3-for-active-directory-federation-service</a></p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/14/active-directory-federation-service/kmsi-not-shown-wia/" data-id="cjth664eb001zt8ytx600q0nh" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/member-and-guest-user" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/12/azure-active-directory/member-and-guest-user/" class="article-date">
  <time datetime="2017-12-11T15:00:00.000Z" itemprop="datePublished">2017-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/12/azure-active-directory/member-and-guest-user/">Member ユーザーと Guest ユーザーについて</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>Azure AD に所属しているユーザーの種類として、下記のように 「Member」 と 「Guest」があります。今回は、こちらのユーザーの種類について説明します。</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/member-and-guest.png">
<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>下記のように、個人アカウントや別テナントの職場または学校アカウント (組織アカウント) を追加した (Azure AD B2B の機能を利用した) 場合に、ユーザーの種類が 「Guest」 として追加されます。</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/personal-work-account.png">
<p>これ以外の Azure のサブスクリプションのサインアップで利用した個人アカウントや組織内のドメイン (上記の例の場合：contso.com) をユーザー名 (例：<a href="mailto:test@contoso.com" target="_blank" rel="noopener">test@contoso.com</a>) に持つユーザーは「Member」として登録されます。また、クラシックポータル  (旧ポータル) より追加した外部ユーザーについては 「Member」として登録されております。</p>
<h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>既定ではゲスト ユーザーに対しては、 Azure AD のデータへのアクセスを制限しています。そのため、ゲスト ユーザーでサインインした場合、招待された Azure AD のユーザーの一覧を参照することもできませんし、各種設定の参照・変更も制限されています。もちろん、サブスクリプションに対する権限を付与していない場合は、サブスクリプションのリソースを操作することもできません。<br>(一般ユーザーとゲスト ユーザーがそれぞれできること (アクセス許可の比較) は、こちらをご参照ください。)</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/access-denied.png">
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/no-access-permission.png">
<p>ゲストに対するアクセス制限は、以下の赤枠の箇所 (ゲストのアクセス許可を制限する) で変更できます。この設定が “はい” の場合には「Guest」の操作は上記のように制限されています。</p>
<img src="/blog/2017/12/12/azure-active-directory/member-and-guest-user/guest-users-permissions-are-limited.png">
<p>ユーザーの属性については、PowerShell を利用することで Member から Guest、またその逆についても変更が可能です。Guest から Member  に変更する際は「Guest」に対して行っていた制御の対象外のユーザーとなるため、セキュリティポリシーに沿った対応や特定のユーザーに絞った設定変更をお勧め致します。</p>
<h2 id="ユーザー-タイプ変更手順"><a href="#ユーザー-タイプ変更手順" class="headerlink" title="ユーザー タイプ変更手順"></a>ユーザー タイプ変更手順</h2><p>この作業を実施するためには、Azure AD 用の PowerShell (Azure AD v1 の PowerShell) を利用する必要がありますが、 PowerShell を利用する際には Microsoft アカウントではなく、組織アカウントでの全体管理者が必要です (Azure AD の PowerShell については <a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/04/aad-powershell/" target="_blank" rel="noopener">リンク</a> も参照ください)。そのために対処策は次の手順で実施する必要があります。</p>
<ol>
<li>Azure AD の全体管理者アカウントを作成する (※すでに組織アカウントの全体管理者が存在する場合は、スキップ)</li>
<li>PowerShell を実行し、該当ユーザーを 「Guest」 から 「Member」 に変更する</li>
</ol>
<h3 id="1-Azure-AD-の全体管理者アカウントを作成する-※すでに組織アカウントの全体管理者が存在する場合は、スキップ"><a href="#1-Azure-AD-の全体管理者アカウントを作成する-※すでに組織アカウントの全体管理者が存在する場合は、スキップ" class="headerlink" title="1. Azure AD の全体管理者アカウントを作成する (※すでに組織アカウントの全体管理者が存在する場合は、スキップ)"></a>1. Azure AD の全体管理者アカウントを作成する (※すでに組織アカウントの全体管理者が存在する場合は、スキップ)</h3><ol>
<li>Azure ポータルにサインインします。</li>
<li>Azure Active Directory を開き、[ドメイン名] を開きます。</li>
<li>一覧に表示されている名前で onmicrosoft.com を含む名前を控えておきます。</li>
<li>[ユーザーとグループ] - [すべてのユーザー] と辿り、右ペインの上部にある [+ 新しいユーザー] をクリックします。</li>
<li>名前欄に適当な例えば admin1 などを入力し、 ユーザー名として 1-3 で確認した onmicrosoft.com のドメイ<br>ン名と名前欄に設定したものを組み合わせて <a href="mailto:admin1@contoso.onmicrosoft.com" target="_blank" rel="noopener">admin1@contoso.onmicrosoft.com</a> というように入力します。</li>
<li>ディレクトリ ロール欄で “全体管理者” を選択し、 [OK] をクリックします。</li>
<li>“パスワードを表示” をクリックし、パスワードを控えて [作成] をクリックします。</li>
</ol>
<h3 id="2-PowerShell-を実行し、該当ユーザーを-Guest-から-Member-に変更する"><a href="#2-PowerShell-を実行し、該当ユーザーを-Guest-から-Member-に変更する" class="headerlink" title="2. PowerShell を実行し、該当ユーザーを Guest から Member に変更する"></a>2. PowerShell を実行し、該当ユーザーを Guest から Member に変更する</h3><ol>
<li>Azure AD 用の PowerShell (Azure AD v1 の MSOnline の PowerShell) を起動します。<br>※モジュールの入手方法については、弊社ブログをご参照ください。インストールされていない環境では 1. MSOnline (Azure AD v1) のインストールをお願いします。</li>
<li>以下のコマンドを実行します。<br>Connect-MsolService</li>
<li>資格情報の入力を求められるため、1 で作成したアカウントの情報を入力します。<br>このときパスワードの変更が求められるはずですので、パスワードを新しく設定します。</li>
<li><p>以下のコマンドを実行して、対象ユーザーの UserPrincipalName および UserType 属性値を確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -All | <span class="built_in">Format-Table</span> UserPrincipalName,UserType</span><br></pre></td></tr></table></figure>
<p> 出力例:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserPrincipalName                             UserType</span><br><span class="line">User1_live.com#EXT#@contoso.onmicrosoft.com   Guest  -&gt; 「Guest」 であることが確認できます。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li><p>以下のコマンドを実行して、対象ユーザーの UserType を 「Member」 に変更します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName &lt;対象ユーザーの UserPrincipalName&gt; -UserType Member</span><br></pre></td></tr></table></figure>
<p> 実行例:</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName User1_live.com<span class="comment">#EXT#@contoso.onmicrosoft.com -UserType Member</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p>再度以下のコマンドを実行して、対象ユーザーの UserType を確認します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -All | <span class="built_in">Format-Table</span> UserPrincipalName,UserType</span><br></pre></td></tr></table></figure>
<p>出力例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserPrincipalName                             UserType</span><br><span class="line">User1_live.com#EXT#@contoso.onmicrosoft.com   Member  -&gt; 変更されたことを確認します。</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>「Member」→「Guest」に変更する場合は、UserType に 「Guest」を指定します。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName &lt;対象ユーザーの UserPrincipalName&gt; -UserType Guest</span><br></pre></td></tr></table></figure>
<p>上記内容が少しでも皆様の参考となりますと幸いです。</p>
<h2 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h2><ul>
<li>2017/12/12: 公開しました。</li>
<li>2018/02/26: Microsoft Connect のリタイアに伴い MSOnline モジュールのダウンロードができなくなったため記載を変更しました。</li>
<li>2018/10/31: メンバーとゲストの既定のアクセス許可の比較情報のリンクを追加しました。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/12/azure-active-directory/member-and-guest-user/" data-id="cjth664ds000rt8yti3mypefy" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/what-is-b2b" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/12/azure-active-directory/what-is-b2b/" class="article-date">
  <time datetime="2017-12-11T15:00:00.000Z" itemprop="datePublished">2017-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/12/azure-active-directory/what-is-b2b/">Azure AD B2B とは</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は Azure AD B2B (Business-To-Business) コラボレーション機能 (以下、Azure AD B2B) について紹介します。</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b</a></p>
<p>この機能については、上記のリンクでも紹介しています。Azure AD B2B と聞くと、もしかしたら小難しく聞こえるかもしれませんが、要は、他 Azure AD のユーザーを追加 (招待) する機能のことです。具体的には、Azure AD を利用する中で、次のような要望がでてくることがあります。</p>
<ul>
<li>会社間 (Azure AD 間) でリソースを共有したい</li>
<li>別の Azure AD に紐づいているリソースを使用したい</li>
<li>ひとりの管理者で、複数の Azure AD を管理したい</li>
<li>など</li>
</ul>
<p>このような連携が必要な時に、利用する機能が、今回ご紹介する Azure AD B2B になります。</p>
<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p> Azure サブスクリプションは必ず 1 つの Azure AD に関連付けられています。<br>そのため、その関連付けられた Azure AD に所属しているユーザーのみがそのサブスクリプションに紐づくリソースを利用可能です。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/subscription-user.png">
<p>では、複数の Azure AD がある場合はどのようになるでしょうか。<br>この場合、別の Azure AD へのアクセスや別の Azure AD に関連付けられているサブスクリプションにアクセスできません。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/subscription-user-inaccessible.png">
<p>こんな時、Azure AD B2B を利用することで、別 Azure AD にユーザーを追加(コピーのようなイメージ)することで、別の Azure AD に所属してリソースを利用することが可能です。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/invite-user-to-tenant.png">
<h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>別の Azure AD のユーザーを追加する方法で多く利用されるものを  2  つ紹介します。</p>
<h3 id="1-ゲスト-ユーザーの追加"><a href="#1-ゲスト-ユーザーの追加" class="headerlink" title="1. ゲスト ユーザーの追加"></a>1. ゲスト ユーザーの追加</h3><p>明示的に別の Azure AD (または outlook.com や gmail.com などのマイクロソフト アカウント) を追加する操作です。Azure ポータルのメニューより [Azure Active Directory] – [ユーザーとグループ] – [すべてのユーザー] の順に進みます。下記、[新しいゲスト ユーザー] から別の Azure AD のユーザーを追加できます。招待メールが送られ、そのメールよりウィザードを完了する必要があります。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/screenshot-new-guest-user.png">
<h3 id="2-RBAC-アクセス制御-IAM-によるユーザーの追加"><a href="#2-RBAC-アクセス制御-IAM-によるユーザーの追加" class="headerlink" title="2. RBAC (アクセス制御 IAM) によるユーザーの追加"></a>2. RBAC (アクセス制御 IAM) によるユーザーの追加</h3><p>RBAC では、Azure サブスクリプションに紐づけられている Azure AD のユーザーに対してアクセス権を割り当てる必要があります。では、RBAC でアクセス権を割り当てるときに別の Azure AD のユーザーに対してアクセス権を割り当てるときには、先に 1 の作業を実施しておく必要があるのでしょうか？</p>
<p>いいえ、もしユーザーが存在していない場合には、 1 のユーザー追加も合わせて行われます。<br>Azure ポータルの [サブスクリプション] – [サブスクリプション名] – [アクセス制御 (IAM)]の順に進みます。</p>
<p>下記、[追加] から別の Azure AD のユーザーを追加することができます。招待メールが送られ、そのメールよりウィザードを完了する流れは同様になりますが、同時にサブスクリプションに対するロールを割り当てられます。</p>
<img src="/blog/2017/12/12/azure-active-directory/what-is-b2b/screenshot-iam.png">
<h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><span style="color:blue">Q</span>. B2B の機能以外で、Azure AD 間を連携することは可能ですか？</p>
<p><span style="color:red">A</span>. いいえ、できません。複数の Azure AD 間で同期や複製を行うことはできません。B2B の機能は Azure AD 同士を連携するというよりは、 Azure AD と別 Azure AD のユーザーを連携する機能です。</p>
<p><span style="color:blue">Q</span>. 別の Azure AD に登録されたアプリケーションを利用するのに、Azure AD B2B の機能を利用できますか？</p>
<p><span style="color:red">A</span>. はい、B2B の機能で要件を満たせます。Azure AD B2B の機能で別の Azure AD のユーザーを追加することで、そのユーザーは Azure AD 上のアプリケーションを利用することが可能です。</p>
<p><span style="color:blue">Q</span>. 旧ポータル(クラシックポータル)のように、個人アカウント(Microsoft アカウント)を明示的に指定して追加することはできますか？</p>
<p><span style="color:red">A</span>. いいえ、できません。ただし、 ユーザーのドメイン名が live.com、 hotmail.com、 gmail.com のようなコンシューマー向けのフリーアドレスを利用している場合にはマイクロソフト アカウントが招待されます。<br>それ以外では 個人アカウントを招待するのではなく、企業アカウントの招待が行われます。<br>そのため、招待対象のアカウントが個人アカウントであっても Azure ポータルから追加を試みた場合には組織アカウントが招待されます。</p>
<p>また、このときに組織アカウントとして該当のアカウントが存在していない場合には、組織アカウントのユーザー作成処理が試みられます。</p>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は、Azure AD B2B に関する概要について紹介しましたが、Azure AD B2B に関するトラブルや Azure AD B2B 完了後のトラブル、または招待メールを利用しない方法などの記事も必要に応じて参照ください。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/12/azure-active-directory/what-is-b2b/" data-id="cjth664dy0013t8ytht6rc039" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/RBAC/">RBAC</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/powershell-module" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/04/azure-active-directory/powershell-module/" class="article-date">
  <time datetime="2017-12-03T15:00:00.000Z" itemprop="datePublished">2017-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/04/azure-active-directory/powershell-module/">Azure Active Directory の PowerShell モジュール</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、 Azure ID チームの三浦です。今回は Azure Active Directory (Azure AD) の PowerShell モジュールの種類、インストール方法についてご案内します。</p>
<p>Azure AD への操作は主に Azure ポータル、 Office 365 ポータル、 Graph API それに今回紹介します PowerShell からおこなうことができます。PowerShell モジュールについても複数ありますので、その種類をまず紹介します。</p>
<h2 id="Azure-AD-PowerShell-の種類"><a href="#Azure-AD-PowerShell-の種類" class="headerlink" title="Azure AD PowerShell の種類"></a>Azure AD PowerShell の種類</h2><p>Azure AD の PowerShell には次のようなものがあります。</p>
<h3 id="1-MSOnline-Azure-AD-v1"><a href="#1-MSOnline-Azure-AD-v1" class="headerlink" title="1. MSOnline (Azure AD v1)"></a>1. MSOnline (Azure AD v1)</h3><p>Office 365 をご利用いただいている方にとっては Office 365 のライセンスを割り当てるときにも利用しますので馴染み深いかもしれません。当初からあるもので、あとから紹介する Azure AD v2 と明示的に区別する際に Azure AD v1 モジュールとも呼びます。Connect-Msolservice のようにコマンドレットに “Msol” という文字列が含まれています。現状でも Azure AD に対する PowerShell コマンドでよく使われています。</p>
<h3 id="2-Azure-AD-for-Graph-Azure-AD-v2"><a href="#2-Azure-AD-for-Graph-Azure-AD-v2" class="headerlink" title="2. Azure AD for Graph (Azure AD v2)"></a>2. Azure AD for Graph (Azure AD v2)</h3><p>当初は Azure AD は Office 365 の認証基盤という意味合いが大きかったのですが、 Azure AD に新しい機能が追加されることに伴い Azure AD  PowerShell の機能を拡張させていく必要がでてきました。その対応のために従来の MSOnline を拡張するのではなく、別途異なるモジュールを開発するというアプローチを取ることになり Azure AD for Graph (Azure AD v2 と言うほうが一般的なので以降は Azure AD v2 とします) というモジュールが作成されました。基本的には MSOnline で提供していた機能は Azure AD v2 でも提供されます。例えばユーザー作成をおこなうときに MSOnline モジュールでは <a href="https://docs.microsoft.com/en-us/powershell/module/msonline/new-msoluser?view=azureadps-1.0" target="_blank" rel="noopener">New-Msoluser</a> というコマンドを使いますが、Azure AD v2 では <a href="https://docs.microsoft.com/ja-jp/powershell/azure/active-directory/new-user-sample?view=azureadps-2.0" target="_blank" rel="noopener">New-AzureADUser</a> を利用します。基本的に MSOL コマンドレットの拡張は予定されていないため、新しい機能などは Azure AD v2 のみで提供されます。というわけで今後は基本的に Azure AD v2 コマンドをご利用くださいと案内したいところなのですが、、、完全に MSOL コマンドで提供していたものをカバーしているわけではないため、残念なのですが (大変申し訳ないのですが)、従来の MSOL コマンドも併用していく必要があります。</p>
<h3 id="3-Azure-AD-for-Graph-preview-Azure-AD-v2-preview"><a href="#3-Azure-AD-for-Graph-preview-Azure-AD-v2-preview" class="headerlink" title="3. Azure AD for Graph preview (Azure AD v2 preview)"></a>3. Azure AD for Graph preview (Azure AD v2 preview)</h3><p>Azure AD v2 モジュールはかなり早いスピードで新しいコマンドが追加されています。なるべく早く新しいモジュールを提供できるようプレビュー版も用意しています。プレビュー版については実際の運用環境での利用は推奨していませんが、Public Preview 中の機能を利用するためにはプレビュー版を利用する必要があることが多くあります。また、 Azure AD v2 の通常版 = General Availability 版がすでにインストールされている環境で通常版とプレビュー版を併用することはできません。 Preview 版を利用したい場合には、先に通常版を Uninstall-Module コマンドでアンインストールしたうえでプレビュー版をインストールをします。</p>
<h2 id="インストール方法について"><a href="#インストール方法について" class="headerlink" title="インストール方法について"></a>インストール方法について</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>MSOnline (Azure AD v1) と Azure AD v2 では前提となる .net Framework のバージョンが厳密には異なり、 MSOnline の場合には必ずしも必要にはならないのですが、古いものを利用していると問題が生じることがあるので、 Azure AD v1、 v2 を問わず、以下の前提条件を満たすようにしてください。なお、 Windows 10 / Windows Server 2016 は .NET Framework、 PowerShell の要件を既定で満たしていますので前提条件については考慮不要です。</p>
<ul>
<li>.NET Framework: バージョン 4.5.2 以降 (*1)</li>
<li>PowerShell: バージョン 5.0 以降 (*1)</li>
<li>OS: Windows 7 SP1 (*2)、 Windows Server 2008 R2 以降</li>
</ul>
<blockquote>
<ol>
<li>.NET Framework および PowerShell のバージョンについては、厳密に言うとこれを満たしていなくても動作するバージョンもありますが、古いバージョンだと問題が生じることがあるため上記を満たすようにします。</li>
<li>クライアント OS で利用する場合には 32 bit 環境ではなく 64 bit 環境の必要があります。</li>
</ol>
</blockquote>
<p>.NET Framework と PowerShell のインストール方法、現在インストールされているバージョンの確認方法は次の通りです。</p>
<h3 id="NET-Framework"><a href="#NET-Framework" class="headerlink" title=".NET Framework"></a>.NET Framework</h3><p>以下のサイトから .NET Framework 4.6 をインストールします。</p>
<p>Microsoft .NET Framework 4.6<br><a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=48137" target="_blank" rel="noopener">https://www.microsoft.com/ja-jp/download/details.aspx?id=48137</a></p>
<p>インストールを試みたときにすでにインストールされているという旨のメッセージが表示された場合にはすでにインストールされていますので不要です。実際にインストール ウィザードを実行していなくとも .NET Framework でどのバージョンがインストールされているかは、 PowerShell のウィンドウを開き、次のコマンドを実行することで確認できます。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ChildItem</span> <span class="string">'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP'</span> -recurse | <span class="built_in">Get-ItemProperty</span> -name Version,Release -EA <span class="number">0</span> | Where &#123; <span class="variable">$_</span>.PSChildName <span class="nomarkup">-match</span> <span class="string">'^(?!S)\p&#123;L&#125;'</span>&#125; | Select PSChildName, Version, Release</span><br></pre></td></tr></table></figure>
<p>以下の例では 4.7.02046 という新しいバージョンがインストールされていることが確認できます (4.7 のバージョンは OS によっては追加のモジュールのインストールが必要なのでここでは 4.6 の紹介にしていますが、もちろん 4.7 のインストールで構いません)。</p>

<h3 id="PowerShell-モジュール"><a href="#PowerShell-モジュール" class="headerlink" title="PowerShell モジュール"></a>PowerShell モジュール</h3><p>PowerShell のバージョンを 5.0 以上にするために Windows Management Framework (WMF) 5.1 を以下のサイトからダウンロードしてインストールします。</p>
<p>Windows Management Framework 5.1<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=54616" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=54616</a></p>
<p>システムの PowerShell のバージョンは $psversiontable で確認できます。以下の例だと 5.1.15063.726 というバージョンがインストールされていることが確認できます。</p>
<img src="/blog/2017/12/04/azure-active-directory/powershell-module/powershell-version.jpg">
<h3 id="Azure-AD-PowerShell-インストール方法"><a href="#Azure-AD-PowerShell-インストール方法" class="headerlink" title="Azure AD PowerShell インストール方法"></a>Azure AD PowerShell インストール方法</h3><p>上記の前提条件を満たしたうえで、次の手順でインストールを実施します。</p>
<ol>
<li>管理者で PowerShell を起動します。</li>
<li><p>下記のコマンドを実行し、モジュールをダウンロードし、インストールします。</p>
<p> MSOnline (Azure AD v1):</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name MSOnline</span><br></pre></td></tr></table></figure>
<p> Azure AD for Graph (Azure AD v2):</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name AzureAD</span><br></pre></td></tr></table></figure>
<p> Azure AD for Graph preview (Azure AD v2 preview):</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Module -Name AzureADPreview</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>Azure AD v2 と Azure AD v2 preview の両方を同じコンピューターにインストールできませんのでご注意ください。Azure AD Preview が必要にも関わらず Install-Module -Name AzureAD を実行してインストールした場合には、一度 Uninstall-Module -Name AzureAD を実行してアンインストールの上で Install-Module -Name AzureADPreview を実行します。</p>
</blockquote>
<blockquote>
<p>NuGet プロバイダーが必要というメッセージが表示された場合には Y をクリックして進めます。信頼されていないレポジトリのメッセージが表示された場合にも Y をクリックして進めます。それぞれの次のようなメッセージが表示されます。</p>
</blockquote>
<p>NuGet のメッセージ:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NuGet provider is required to <span class="keyword">continue</span></span><br><span class="line">PowerShellGet requires NuGet provider version <span class="string">'2.8.5.201'</span> or newer to interact with NuGet-based repositories. The NuGet</span><br><span class="line">provider must be available <span class="keyword">in</span> <span class="string">'C:\Program Files\PackageManagement\ProviderAssemblies'</span> or</span><br><span class="line"><span class="string">'C:\Users\taguiadmin\AppData\Local\PackageManagement\ProviderAssemblies'</span>. You can also install the NuGet provider by</span><br><span class="line">running <span class="string">'Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force'</span>. <span class="keyword">Do</span> you want PowerShellGet to install</span><br><span class="line">and import the NuGet provider now?</span><br><span class="line">[Y] Yes  [N] No  [S] Suspend  [?] Help (default is <span class="string">"Y"</span>):</span><br></pre></td></tr></table></figure>
<p>レポジトリのメッセージ:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Untrusted repository</span><br><span class="line">You are installing the modules from an untrusted repository. <span class="keyword">If</span> you trust this repository, change its</span><br><span class="line">InstallationPolicy value by running the Set-PSRepository cmdlet. Are you sure you want to install the modules from</span><br><span class="line"><span class="string">'PSGallery'</span>?</span><br><span class="line">[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is <span class="string">"N"</span>):</span><br></pre></td></tr></table></figure>
<blockquote>
<p>明示的にバージョン番号を指定する場合にはコマンドに -RequiredVersion 2.0.0.137 というように引数としてバージョン情報を追加します。</p>
</blockquote>
<blockquote>
<p>MSOnline については以前は Connect サイトからインストールパッケージをダウンロードできましたが、サイトのリタイアに伴いダウンロード パッケージは提供されなくなりました。Install-Module コマンドを実行することでインストールします。</p>
</blockquote>
<h2 id="補足事項"><a href="#補足事項" class="headerlink" title="補足事項"></a>補足事項</h2><p>&lt;別端末で保存したファイルを利用したい場合&gt;</p>
<p>何らかの理由で直接 Install-Module を実行してのインストールができないケースが稀にあります (ウイルス対策ソフトの影響等)。この場合には、他の端末で必要なモジュールを取得し、入手したファイルを元に Import-Module を実行する方法もあります (あまり多くの実績があるものではないため、基本は Install-Module での対応をお勧めします)。以下は Azure AD for Graph の例です。</p>
<ol>
<li>管理者として PowerShell を起動します。</li>
<li><p>下記のコマンドレットを実行し、リポジトリ ファイル群をダウンロードします。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Save-Module -Name AzureAD -Path C:\temp\</span><br></pre></td></tr></table></figure>
<blockquote>
<p>C:\temp\ は保存先フォルダの指定となりますので、任意の存在するパス/フォルダをご指定ください。</p>
</blockquote>
</li>
<li><p>指定したフォルダ配下の \AzureAD\&lt;バージョン番号&gt;\ フォルダ配下に、リポジトリ ファイル群が展開されたことを確認します。</p>
</li>
<li><p>実際に Azure AD の PowerShell コマンドを利用したい端末の C:\Program Files\WindowsPowerShell\Modules フォルダに 2 でダウンロードしたフォルダ (今回の例の場合 c:\temp 配下の AzureAD フォルダ) をコピーします。</p>
</li>
<li><p>C:\Program Files\WindowsPowerShell\Modules フォルダに保存されたモジュールは PowerShell で自動的にロードされるため、そのまま実行ができるはずですが、コマンドがエラーになる場合には、以下を実行したうえで Connect-AzureAD  などを実行します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> C:\Program Files\WindowsPowerShell\Modules\AzureAD\&lt;バージョン番号&gt;\AzureAD.psd1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>&lt;認証プロキシが存在する場合の注意事項&gt;</p>
<p>インターネットにアクセスする際に認証が必要なプロキシが存在するようなネットワーク環境では、 PowerShell 起動時に以下のコマンドを実行し、認証が必要なプロキシを経由してアクセスができるようにします。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ProxyCredential</span> = <span class="built_in">New-Object</span> System.Net.NetworkCredential(<span class="string">"ユーザー名"</span>,<span class="string">"パスワード"</span>)</span><br><span class="line">[System.Net.WebRequest]::DefaultWebProxy.Credentials = <span class="variable">$ProxyCredential</span></span><br></pre></td></tr></table></figure>
<p>&lt;モジュールがインストールされているかの確認&gt;</p>
<p>モジュールがインストールされているかは Get-InstalledModule コマンドで確認できます。</p>
<img src="/blog/2017/12/04/azure-active-directory/powershell-module/get-installedmodule.jpg">
<p>&lt;モジュールのアンインストール方法&gt;</p>
<p>Uninstall-Module コマンドでアンインストールができます。Azure AD v2 の通常版と Preview 版は併用できませんので、通常版を利用している環境で Preview 版を利用したい場合には管理者で PowerShell を起動し、 Preview 版をインストール前に次のコマンドで通常版のアンインストールが必要です。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uninstall-Module AzureAD</span><br></pre></td></tr></table></figure>
<p>以上です。最後に参考資料をご紹介します。</p>
<h2 id="参考資料"><a href="#参考資料" class="headerlink" title="参考資料"></a>参考資料</h2><p>Azure Active Directory PowerShell for Graph<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/active-directory/install-adv2?view=azureadps-2.0" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/powershell/azure/active-directory/install-adv2?view=azureadps-2.0</a></p>
<p>Azure​AD (Azure AD v2 コマンド一覧)<br><a href="https://docs.microsoft.com/en-us/powershell/azuread/v2/azureactivedirectory" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/powershell/azuread/v2/azureactivedirectory</a></p>
<p>AzureAD PowerShell’s Profile (Azure AD PowerShell 最新版リスト。 V1、 V2、 V2Preview)<br><a href="https://www.powershellgallery.com/profiles/AzureADPowerShell/" target="_blank" rel="noopener">https://www.powershellgallery.com/profiles/AzureADPowerShell/</a></p>
<h2 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h2><ul>
<li>2017/12/04: 公開しました。</li>
<li>2017/12/20: 前提条件について追記を行いました。</li>
<li>2018/01/31: Microsoft Connect のリタイアに伴い MSOnline モジュールのダウンロードができなくなったため追記しました。また、インストール時の手順として Save-Module は必要がありませんが、補足事項として別項を追加しました。</li>
<li>2018/02/08: Windows 10/2016 では前提条件を既定で満たしていることを追記しました。モジュールインストール時に表示される可能性があるメッセージを掲載しました。TLS 1.2 への対応などを考慮すると 4.6 のほうが望ましいため .NET Framework のダウンロードリンクを 4.6 のものに変更しました。</li>
<li>2018/05/10: モジュールがインストールされているかの確認方法とアンインストール コマンドを追記しました。</li>
<li>2018/07/13: Windows Management Framework 5.0 のリンクを 5.1 に変更しました。</li>
<li>2018/08/07: Save-Module で別端末でダウンロードしたモジュールを利用する際の手順を更新しました。</li>
<li>2018/10/17: Windows Management Framework (WMF) のサポート対象が 5.1 であることから .NET Framework の前提条件を WMF 5.1 インストールに必要となる 4.5.2 に変更しました。</li>
<li>2019/01/23: Azure AD v2 と Azure AD v2 preview が同時インストールできない注意書きをインストールの項目にも追記しました。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/04/azure-active-directory/powershell-module/" data-id="cjth664ei0025t8yt5qhdexka" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/PowerShell/">PowerShell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/qanda-conditional-access" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/" class="article-date">
  <time datetime="2017-12-03T15:00:00.000Z" itemprop="datePublished">2017-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/">Azure AD の条件付きアクセスに関する Q&amp;A</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの高田です。</p>
<p>今回はお問い合わせをよくいただく、Azure AD の条件付きアクセスについてです。</p>
<p>お問い合わせの多いご質問について、Q&amp;A 形式でおまとめいたしました。既存のドキュメントではカバーされていない動作や質問について今後も適宜内容を拡充していきますので、ご参照いただければと思います。</p>
<hr>
<p><span style="color:blue">Q</span>. Office 365 を利用しているが、条件付きアクセスを利用できますか？</p>
<p><span style="color:red">A</span>. はい、利用可能です。Office 365 をご利用いただいているお客様は、認証基盤として Azure AD をご利用いただいている状態となります。そのため、追加で Azure AD Premium のライセンスを購入いただくことで、利用可能になります。</p>
<hr>
<p><span style="color:blue">Q</span>. Azure AD Application Proxy を利用して公開しているアプリケーションなども条件付きアクセスで制御可能でしょうか。</p>
<p><span style="color:red">A</span>. はい、条件付きアクセスで制御可能です。Azure AD 上に登録されているアプリケーションであれば、条件付きアクセスで制御できます。Azure AD Application Proxy を利用して公開しているアプリケーションやご自身で開発し Azure AD 上に登録したアプリケーションも制御対象とすることが可能です。</p>
<hr>
<p><span style="color:blue">Q</span>. Azure AD B2B コラボレーション機能により招待されたゲスト ユーザーに対して条件付きアクセスのルールを適用する場合には、Azure AD Premium のライセンスを購入する必要があるのでしょうか。</p>
<p><span style="color:red">A</span>. いいえ、テナントに割り当てられている Azure AD Premium ライセンス数の 5 倍までのアカウントであれば、ゲスト ユーザーに対して条件付きアクセスを含む Azure AD Premium の機能を利用させることが可能です。詳細は下記公開情報を参照ください。</p>
<p>Azure Active Directory B2B コラボレーションのライセンスに関するガイダンス<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-licensing" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-licensing</a></p>
<hr>
<p><span style="color:blue">Q</span>. Azure AD Premium のライセンスを対象人数分購入すれば、該当ユーザーに割り当てる必要はないでしょうか。</p>
<p><span style="color:red">A</span>. いいえ、要件として人数分購入いただくだけでなく、ユーザーに対して割り当てる必要がございます。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスを利用するためには、Azure AD Premium のライセンス数を何個購入すればよいでしょうか？</p>
<p><span style="color:red">A</span>. 条件付きアクセスの機能を利用してアプリケーションへのアクセス可否の評価が行われるユーザーに対して、Azure AD Premium (P1 以上) を割り当てる必要があります。現時点の実装では、Azure AD Premium ライセンスを割り当てていないユーザーであっても、ポリシーの対象であれば条件付きアクセス ポリシーの内容に従ってアクセス制限が行われますが、このような状態での利用はライセンス違反となります。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスのポリシーを複数作成し、適用の優先順位をつけることは可能でしょうか。</p>
<p><span style="color:red">A</span>. いいえ、優先順位を作成することはできません。条件付きアクセスではそれぞれのポリシーが独立しており、条件に合致したものが適用されます。各ポリシーで条件が重複しないように構成することを検討ください。</p>
<hr>
<p><span style="color:blue">Q</span>. Exchange Online に対して条件付きアクセスを設定したところ Office 365 ポータルに対しても条件付きアクセスが設定されてしまいました。これは想定される動作でしょうか？</p>
<p><span style="color:red">A</span>. はい、これは想定される動作です。 2017 年 8 月 24 日以降は Exchange Online または SharePoint Online を対象とした条件付きアクセスが Office 365 ポータルにも反映されます。詳細は英語での情報となりますが以下のリンクも参照ください。</p>
<p>An update to Azure AD Conditional Access for Office.com<br><a href="https://cloudblogs.microsoft.com/enterprisemobility/2017/08/04/an-update-to-azure-ad-conditional-access-for-office-com/" target="_blank" rel="noopener">https://cloudblogs.microsoft.com/enterprisemobility/2017/08/04/an-update-to-azure-ad-conditional-access-for-office-com/</a></p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスの [場所] の条件にクライアントの IP アドレス範囲を入れましたが制御されません。どうしてでしょうか？</p>
<p><span style="color:red">A</span>. 条件付きアクセスの [場所] の条件では、組織が外部と通信する際のグローバル IP アドレス (Azure AD から見た送信元グローバル IP アドレス) を利用します。例えば、社内のクライアントがプライベート IP アドレスを保持しており、外部ネットワークと通信する際にはグローバル IP アドレスを持つゲートウェイを経由して Azure AD と通信する環境があるとします。この場合、Azure AD から見ると、送信元 IP アドレスはグローバル IP アドレスを持つゲートウェイとなります。このような時は、件付きアクセスの [場所] の条件には、ゲートウェイのグローバル IP アドレスを指定ください。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスで、X-Forwarded-For HTTP ヘッダーを利用して、組織内のクライアントの送信元 IP アドレスを判断可能ですか？</p>
<p><span style="color:red">A</span>. いいえ、X-Forwarded-For HTTP ヘッダーを使用し、条件付きアクセスで組織内のクライアントの送信元 IP アドレスを判定することはできません。条件付きアクセスの [場所] の条件では、組織が外部と通信する際のゲートウェイが持つグローバル IP アドレス (Azure AD から見た送信元グローバル IP アドレス) が制御に利用されます。Azure AD には、このグローバル アドレスを場所として利用します。<br>X-Forwarded-For HTTP ヘッダーは HTTP ヘッダー フィールドの 1 つです。ロード バランサーなどでクライアントの送信元 IP アドレスが変換された場合でも、HTTP ヘッダーに接続元のクライアント IP アドレスの情報を付加することで、接続先サーバーが接続元クライアント IP アドレスを特定できるようにするために利用されます。しかしながら、この X-Forwarded-For HTTP ヘッダーで指定された情報は組織内の IP アドレスであり、場所を示すものではありません。このような理由から、現状 Azure AD では、組織が外部と通信する際のゲートウェイのグローバル IP アドレス (Azure AD から見た送信元グローバル IP アドレス) を制御に利用しています。</p>
<hr>
<p><span style="color:blue">Q</span>. クレームルールと条件付きアクセスは併用は可能ですか？</p>
<p><span style="color:red">A</span>. はい、技術的には可能です。AD FS を利用したフェデレーション環境であれば、クレーム ルールが判定された後、条件付きアクセスが動作します。クレーム ルールで認証が拒否された場合は、その後の条件付きアクセスの処理は動作しません。ただし、類似機能であるため運用の複雑さなどを考慮すると、どちらか一方の機能をメインでご利用いただくのがよいかと存じます。</p>
<hr>
<p><span style="color:blue">Q</span>. 条件付きアクセスの設定において、全てユーザーがアクセスできない設定になってしまいました。設定を解除可能でしょうか。</p>
<p><span style="color:red">A</span>. このような状況の場合は、残念ながらお客様側での解除はできません。そのため、設定の解除をご希望の場合は、お手数ですが弊社サポート サービスをご利用いただけますと幸いです。Azure ポータルにもアクセスができない状況と存じますので、ほかにお持ちのテナントからお問い合わせを発行ください。<br>サポート サービスをご利用いただくには、Azure ポータル上から、Azure Active Directory を選択し、[新しいサポート要求] を選択ください。以下のような画面からお問い合わせいただければと思います。</p>
<img src="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/create-support-ticket-1.png">
<img src="/blog/2017/12/04/azure-active-directory/qanda-conditional-access/create-support-ticket-2.png">
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/12/04/azure-active-directory/qanda-conditional-access/" data-id="cjth664eo0026t8ytf7l6nhvz" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/azuread-access-denied" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/11/20/azure-active-directory/azuread-access-denied/" class="article-date">
  <time datetime="2017-11-19T15:00:00.000Z" itemprop="datePublished">2017-11-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/20/azure-active-directory/azuread-access-denied/">「アクセス権がありません」のエラーについて</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームの坂井です。</p>
<p>今回は Azure ポータル上で表示される Azure AD に関するエラーメッセージについて説明します。</p>
<p>Azure ポータル上で、[Azure Active Directory] を選択した際に、下記のエラーが表示される場合があります。</p>
<hr>
<p>アクセスが拒否されました</p>
<p>アクセス権がありません</p>
<p>このコンテンツへのアクセス権がないようです。アクセス権を得るには、所有者に連絡してください。</p>
<hr>
<p>画面は下記のような表示です。</p>
<img src="/blog/2017/11/20/azure-active-directory/azuread-access-denied/azuread-access-denied.png">
<p>こちらは、エラーメッセージの通りアクセスしようとしたユーザーの権限が不足している状況を示すエラーになります。</p>
<p>ここでいう、権限とはサブスクリプションの権限（RBAC で付与した所有者の権限など）とは異なる、Azure AD の権限となります。</p>
<p>サブスクリプションの管理者と Azure AD の管理者の説明については、下記のブログをご確認ください。</p>
<p>-参考情報</p>
<p><a href="./subscription-azure-ad-relationship.md">Azure サブスクリプションと Azure AD の管理者</a></p>
<p>詳細<br>下記、 [Azure AD 管理ポータルへのアクセスを制限する] が「はい」に設定されている場合は、Azure AD の管理者権限を持ったユーザーのみが [Azure Active Directory] を参照できるようになります。</p>
<p>こちらを「いいえ」に設定することで、一般のユーザーでも [Azure Active Directory] 配下の参照が可能になりますが、設計上「はい」にする必要がある場合は、個別のユーザー毎に下記の回避策をご実施ください。</p>
<img src="/blog/2017/11/20/azure-active-directory/azuread-access-denied/azuread-portal.png">
<p>回避策<br>Azure AD ディレクトリの全体管理者の権限をもつユーザーで、Azure ポータル (<a href="https://portal.azure.com" target="_blank" rel="noopener">https://portal.azure.com</a>) へサインインします。<br>[Azure Active Directory] - [ユーザーとグループ] - [すべてのユーザー] - [（権限を付与する）ユーザー] の順に選択します。<br>[ディレクトリ ロール] をクリックします。<br>全体管理者 (または制限付き管理者) を選択して [保存] をクリックします。</p>
<p>管理者の種類と役割については、下記の弊社公開情報をご確認ください。</p>
<p>Azure Active Directory での管理者ロールの割り当て</p>
<p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles</a></p>
<p>上記内容が少しでもお客様の参考となりますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/11/20/azure-active-directory/azuread-access-denied/" data-id="cjth664dl000ct8ytfq4eipdn" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory/subscription-azure-ad-relationship" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/" class="article-date">
  <time datetime="2017-11-03T15:00:00.000Z" itemprop="datePublished">2017-11-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/">Azure サブスクリプションと Azure AD の管理者</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、 Azure ID サポートチームの三浦です。</p>
<p>今回は混乱することが多い Azure のサブスクリプションと Azure Active Directory (Azure AD) の関係、それぞれの管理者について紹介します。</p>
<h2 id="Azure-サブスクリプションと-Azure-AD-の関係"><a href="#Azure-サブスクリプションと-Azure-AD-の関係" class="headerlink" title="Azure サブスクリプションと Azure AD の関係"></a>Azure サブスクリプションと Azure AD の関係</h2><p>まず、 Azure サブスクリプションと Azure AD の関係ですが、 Azure のサブスクリプションに Azure AD が含まれているというイメージを持たれている方もいるかもしれませんが、以下の図のようなイメージは間違いです。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/wrong-understanding.png">
<p>正しくは Azure サブスクリプションと Azure AD には包含関係は無く、独立しています。Azure サブスクリプションは必ず 1 つの Azure AD に関連付けられています (*注1) ので、両者の関係性は次のような図になります。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/subscription-relationship.png">
<p>上の図では 2 つのサブスクリプションが Office 365 を利用中の同一の Azure AD に関連づけられている例です。この例では Office 365 で利用しているアカウント情報を Azure のサブスクリプションも参照し、サブスクリプションへのアクセス権限の付与などにもそのまま利用します。</p>
<blockquote>
<p>注 1: 関連付けのことを “信頼しています” という表現を使用する場合もあります。この関連付けを変更するためには、サブスクリプションのアカウント管理者を別の Azure AD のユーザーに譲渡する作業、もしくはディレクトリの切り替えの作業が必要です。Azure AD に関連づけられた Azure のサブスクリプションは 1 つの場合もありますし、3 つ以上の場合もあります。また、 Office 365 を利用中の Azure AD に関連付けることもできれば、そうではないケースもあります。</p>
</blockquote>
<p>1 つの Azure サブスクリプションが複数の Azure AD を指定することはできません。Azure サブスクリプションが参照する Azure AD は必ず 1 つです。</p>
<h2 id="Azure-サブスクリプションの管理者"><a href="#Azure-サブスクリプションの管理者" class="headerlink" title="Azure サブスクリプションの管理者"></a>Azure サブスクリプションの管理者</h2><p>Azure サブスクリプションの管理者については Microsoft Azure の各種アカウント権限について にそれぞれ説明があります。少し補足するとAzure クラシック ポータル時代にはアカウント管理者、サービス管理者、共同管理者という 3 つの役割しかありませんでした。</p>
<p>現在の Azure 新ポータルでも、それぞれの管理者は有効ですが、それに加えてサブスクリプション単位ではなく、リソース毎に閲覧、あるいは編集が可能なユーザーを柔軟に設定できる仕組み (RBAC = Role Based Access Control ロールベースのアクセス制御 *注2) が設定できます。サブスクリプションに対して所有者というロールを割り当てれば、従来のクラシック ポータルでの共同管理者相当になります。この RBAC の設定では Azure サブスクリプションが関連付けられた Azure AD のアカウント情報が利用されます。</p>
<blockquote>
<p>注 2: Azure ポータルで RBAC の設定を行う場合には Access Control (IAM) からおこないます。 IAM は Identity and Access Management の略です。</p>
</blockquote>
<h2 id="Azure-AD-の管理者"><a href="#Azure-AD-の管理者" class="headerlink" title="Azure AD の管理者"></a>Azure AD の管理者</h2><p>Azure AD でも Azure サブスクリプションの場合と同様に様々な役割があり、その詳細は Azure Active Directory での管理者ロールの割り当て で確認できます。代表的なものとして全体管理者 (Global Administrator) がありますが、この役割をもつアカウントは Azure AD のディレクトリに対してすべての権限を持ちます。</p>
<p>なお、各 Azure AD ディレクトリ (テナント) は独立していますので、ある Azure AD で全体管理者になっていても別の Azure AD の全体管理者になるわけではありません。例えば company1com.onmicrosoft.com という Azure AD ディレクトリの全体管理者は company2com.onmicrosoft.com の全体管理者ではありません。ただ、 B2B の機能で company2com.onmicrosoft.com から招待を受け、更にこのディレクトリの全体管理者の権限の付与を受けることは可能です。</p>
<h2 id="Azure-サブスクリプションの管理者と-Azure-AD-の管理者"><a href="#Azure-サブスクリプションの管理者と-Azure-AD-の管理者" class="headerlink" title="Azure サブスクリプションの管理者と Azure AD の管理者"></a>Azure サブスクリプションの管理者と Azure AD の管理者</h2><p>Azure サブスクリプションと Azure AD はそれぞれ独立したものです。</p>
<p>管理者についてもそれぞれ独立していますので Azure サブスクリプションの管理者であっても Azure AD の全体管理者でなければ、 Azure AD の管理 (ユーザー追加、削除など) はできません。同様に Azure AD の全体管理者であっても、必ずしも紐づく Azure サブスクリプションの管理者ではありません。</p>
<p>例えば次のような関係を考えてみましょう。</p>
<p>company1 という会社ではすでに Azure AD を保持しており、その Azure AD のディレクトリ名は company1com.onmicrosoft.com です。この Azure AD にはカスタムドメインとして company1.com というドメイン名が紐づけられています (*注3)。以下の図では <a href="mailto:user1@company1.com" target="_blank" rel="noopener">user1@company1.com</a> というアカウントが Azure のサブスクリプションを作成した状態での関係を示しています。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/subscription-relationship-a.png">
<p><a href="mailto:user1@company1.com" target="_blank" rel="noopener">user1@company1.com</a> というアカウントは Azure のサブスクリプションのアカウント管理者でありサービス管理者です。そのため、サブスクリプション内のすべての権限を持ちます。例えばこのサブスクリプション内で仮想マシンを作成したり、仮想ネットワークを設定したりすることができます。しかし、関連づけられている Azure AD に対しては user1 は管理者権限を持ちません。Azure AD に対して管理者権限を必要とする作業を実施する場合には <a href="mailto:admin1@company1com.onmicrosoft.com" target="_blank" rel="noopener">admin1@company1com.onmicrosoft.com</a> または <a href="mailto:admin2@company1.com" target="_blank" rel="noopener">admin2@company1.com</a> という全体管理者に、作業を依頼するか、あるいは自身に Azure AD の権限を与えてくれるように依頼する必要があります。</p>
<p>別のパターンを考えてみます。</p>
<img src="/blog/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/subscription-relationship-b.png">
<p>ここでは Microsoft アカウントの <a href="mailto:user2@outlook.com" target="_blank" rel="noopener">user2@outlook.com</a> を指定して Azure サブスクリプションを作成しています。この例の outlook.com のように企業に紐づかない Microsoft アカウントを利用して Azure サブスクリプションを作成した場合など、サブスクリプション作成時に利用したアカウントが所属する Azure AD が無い場合には、新規で Azure AD ディレクトリが自動的に作成されます。この場合、特に役割の追加作業をしていなくても Azure サブスクリプションのアカウント管理者 = Azure AD の全体管理者になります。</p>
<p>この場合でも以下のようにサブスクリプションに別のアカウント <a href="mailto:user3@outlook.com" target="_blank" rel="noopener">user3@outlook.com</a> を所有者として追加した場合には、このアカウントは Azure AD の管理者ではありませんので、もしそのアカウントにも権限を付与したいのであれば <a href="mailto:user2@outlook.com" target="_blank" rel="noopener">user2@outlook.com</a> が、 <a href="mailto:user3@outlook.com" target="_blank" rel="noopener">user3@outlook.com</a> を全体管理者にする作業が必要です。</p>
<blockquote>
<p>注 3: Azure AD では必ず設定される xxxxx.onmicrosoft.com というドメイン名に加えてカスタムドメイン名を追加することができます。カスタムドメイン名を追加するためには、そのドメインに対して権限を持っている (ドメインのゾーンをインターネットで名前解決でき、そのゾーンを管理している) 必要があります。詳しくはこちらのサイトを参照ください。</p>
</blockquote>
<h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は混乱しやすい Azure サブスクリプションと Azure AD の関係についてご紹介しました。いろいろな管理者が存在していますが、その管理者が Azure サブスクリプションの管理者なのか Azure AD の管理者なのかということを意識するとわかりやすくなると思います。</p>
<p>文中でも一部触れていますが、参考となる公開情報を紹介しまして、今回は以上とします。</p>
<p>Microsoft Azure の各種アカウント権限について<br><a href="https://blogs.msdn.microsoft.com/dsazurejp/2013/10/02/303/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/dsazurejp/2013/10/02/303/</a></p>
<p>Azure サブスクリプションを Azure Active Directory に関連付ける方法<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-how-subscriptions-associated-directory" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-how-subscriptions-associated-directory</a></p>
<p>Azure Active Directory での管理者ロールの割り当て<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles-azure-portal" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-assign-admin-roles-azure-portal</a></p>
<p>クイック スタート: カスタム ドメイン名を Azure Active Directory に追加する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/add-custom-domain" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/active-directory/add-custom-domain</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/11/04/azure-active-directory/subscription-azure-ad-relationship/" data-id="cjth664eu0027t8ytpt0oroft" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Subscription/">Subscription</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-azure-active-directory-connect/upn-hard-match" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/10/05/azure-active-directory-connect/upn-hard-match/" class="article-date">
  <time datetime="2017-10-04T15:00:00.000Z" itemprop="datePublished">2017-10-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/10/05/azure-active-directory-connect/upn-hard-match/">Azure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>こんにちは、Azure &amp; Identity サポート チームです。</p>
<p>今回は Azure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法の一つで、ハードマッチと呼ばれる方法についてご紹介します。</p>
<p>既に Azure AD 上にユーザー アカウントが存在している状態で、そのユーザーを後からオンプレミスの Active Directory (AD) に追加し、同期をおこなうときにその既存のアカウントをそのまま利用したいということがあると思います。</p>
<p>このようなケースではオンプレミス AD で対象となるアカウントのメール アドレス、または UPN 名を一致させた上で同期をおこなうという手法が一般的には取られます (これをソフトマッチと呼びます)。このソフトマッチができない場合 (UPN 名が異なるアカウントを紐づける必要がある場合など) にはハード マッチと呼ばれる方法で直接的に同期時にオブジェクトの一意性を確保する ID 情報 Immutable ID を紐づけます。</p>
<p>Azure AD Connect の既定の構成では、オンプレミス AD の ObjectGUID (バージョン 1.1.486.0 以前) あるいは msDS-ConsistencyGuid (バージョン 1.1.524.0 以降) を Base64 でエンコードした値を Immutable ID (source Anchor) として紐づけています。</p>
<p>以下では Azure AD Connect で ObjectGUID を ImmutableId と紐づける構成とている場合においてハードマッチによる同期をおこなう設定をご紹介します。</p>
<p>ただし、基本的にはユーザーを紐付ける必要がある場合には、ソフトマッチを利用することを推奨します。</p>
<p>理由としましては、ハードマッチによるユーザーの紐づけの変更を複数回行った場合などに Azure 上での情報の伝搬がされ終えないうちに新しい情報が伝搬され、Azure を構成するサーバー上での情報に不整合が生じ、問題が発生することが想定されるためであり、過去の実績という観点からもハードマッチを実施したような事例も少ないため、基本的にはハードマッチでの紐づけはできる限りしないことをお勧めします。</p>
<h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><ol>
<li>オンプレミス AD にて Base64 でエンコードされた ObjectGUID を確認します</li>
<li>Azure AD 上で ImmutableId が設定されてないことを確認します</li>
<li>Azure AD 上のアカウントに ImmutableId を手動で設定します</li>
<li>手動で差分ディレクトリ同期を実施します</li>
</ol>
<ul>
<li>4 を除き、同期処理が止まっている状態で作業をご実施ください。同期処理が止まっていないと紐づけしたいオンプレミス AD のアカウントが同期されてしまい、Immutable ID を紐づけできません。</li>
</ul>
<h3 id="1-オンプレミス-AD-にて-Base64-でエンコードされた-ObjectGUID-を確認"><a href="#1-オンプレミス-AD-にて-Base64-でエンコードされた-ObjectGUID-を確認" class="headerlink" title="1. オンプレミス AD にて Base64 でエンコードされた ObjectGUID を確認"></a>1. オンプレミス AD にて Base64 でエンコードされた ObjectGUID を確認</h3><p>オンプレミス上の紐づけ対象のアカウントの GUID 情報を取得します。</p>
<ol>
<li>オンプレミス Active Directory の任意の DC 上で [管理ツール] - [Active Directory ユーザーとコンピューター] を開きます。</li>
<li>メニューから [表示] - [拡張機能] にチェックを入れます。</li>
<li>該当ユーザー アカウントのプロパティを開きます。</li>
<li>[属性エディター] タブを開き、”distinguishedName” 値を選択し、[表示] をクリックします。</li>
<li>distinguishedName 値 (以下、DN 値) の内容をコピーします。</li>
<li>コマンド プロンプト (PowerShell でも可) を起動し、以下のコマンドを実行します。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldifde -f c:\ ldifde_user.txt -d &quot;手順 5. でコピーした内容&quot; -p subtree</span><br></pre></td></tr></table></figure>
<p>コマンド例：</p>
<img src="/blog/2017/10/05/azure-active-directory-connect/upn-hard-match/hardmatch_11.png">
<p>1-7. 出力されたファイルを開き、ObjectGUID の値を確認します。<br>出力結果例：</p>
<img src="/blog/2017/10/05/azure-active-directory-connect/upn-hard-match/hardmatch_2.png">
<h2 id="2-Azure-AD-上で-ImmutableId-が設定されてないことを確認"><a href="#2-Azure-AD-上で-ImmutableId-が設定されてないことを確認" class="headerlink" title="2. Azure AD 上で ImmutableId が設定されてないことを確認"></a>2. Azure AD 上で ImmutableId が設定されてないことを確認</h2><p>Azure AD の紐づけ対象のアカウントに ImmutableId が設定されていないことを確認します。ImmutableId が設定されている場合には、すでに同期対象となっていることを示します。</p>
<ol>
<li>インターネットに接続している任意のコンピューター上で “Windows PowerShell 用 Windows Azure Active Directory モジュール” を管理者として実行します。</li>
<li>起動した PowerShell にて Connect-MsolService コマンドを実行します。<br>※ 認証ダイアログが表示されますので、管理者ユーザーの資格情報を入力して [OK] ボタンをクリックします。</li>
<li>下記のコマンドを実行します。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -UserPrincipalName &quot;対象ユーザーの UPN&quot; | fl</span><br></pre></td></tr></table></figure>
<p>コマンド例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -UserPrincipalName &quot;hm_test3@test01.onmicrosoft.com&quot; | fl</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>出力されたファイルを開き、ImmutableId の値を確認します。</li>
</ol>
<p>出力結果例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ImmutableId                            : （クラウド内ユーザーの場合、空白になります）</span><br><span class="line">UserPrincipalName                      : hm_test3@test01.onmicrosoft.com</span><br></pre></td></tr></table></figure>
<h3 id="3-ImmutableId-を手動で設定"><a href="#3-ImmutableId-を手動で設定" class="headerlink" title="3. ImmutableId を手動で設定"></a>3. ImmutableId を手動で設定</h3><p>ディレクトリ同期ツールにて、ユーザーの情報を関連付けるには下記の情報を使用します。<br>オンプレミス AD 側：objectGUID<br>Azure AD 側：ImmutableId</p>
<ol>
<li>インターネットに接続している任意のコンピューター上で “Windows PowerShell 用 Windows Azure Active Directory モジュール” を管理者として実行します。</li>
<li>起動した PowerShell にて Connect-MsolService コマンドを実行します。<br>※認証ダイアログが表示されますので、管理者ユーザーの資格情報を入力して [OK] ボタンをクリックします。</li>
<li>下記のコマンドを実行します。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName &lt;対象ユーザーの UPN&gt; -ImmutableId &lt;オンプレ AD ユーザーの  Base64 エンコードされた objectGUID 値&gt;</span><br></pre></td></tr></table></figure>
<p>コマンド実行例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-MsolUser -UserPrincipalName hm_test3@test01.onmicrosoft.com -ImmutableId 2/9JCtHr0EmH+hL07o11vA==</span><br></pre></td></tr></table></figure>
<p>3-4. 下記のコマンドを実行します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolUser -UserPrincipalName &quot;対象ユーザーの UPN&quot; | fl</span><br></pre></td></tr></table></figure>
<p>コマンド例：</p>
<img src="/blog/2017/10/05/azure-active-directory-connect/upn-hard-match/hardmatch_3.png">
<h3 id="4-手動で差分ディレクトリ同期を実施"><a href="#4-手動で差分ディレクトリ同期を実施" class="headerlink" title="4. 手動で差分ディレクトリ同期を実施"></a>4. 手動で差分ディレクトリ同期を実施</h3><p>※2016 年 2 月に公開された新しいバージョン（1.1.105.0 以上）の Azure AD Connectを使用した手順をご案内いたします。</p>
<ol>
<li>ディレクトリ同期サーバーに管理者権限でログインします。</li>
<li>管理者の PowerShell を起動して、以下のコマンドを実行します。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Start-ADSyncSyncCycle -PolicyType Delta</span><br></pre></td></tr></table></figure>
<p>*今回ご紹介しているケースのように Azure AD Connect が構成済みである場合は上記コマンドで差分同期をすることとなります。</p>
<ol start="3">
<li>Office 管理ポータルで作業対象ユーザーの [同期の種類] が [クラウド] から [Active Directory ] に変わったことを確認します。</li>
</ol>
<p>「コミュニティにおけるマイクロソフト社員による発言やコメントは、マイクロソフトの正式な見解またはコメントではありません。」</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/10/05/azure-active-directory-connect/upn-hard-match/" data-id="cjth664df0005t8yth5415eyl" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AAD-Connect/">AAD Connect</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Hard-match/">Hard match</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/UPN/">UPN</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-active-directory-federation-service/update-ssl-server-certificate" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/10/03/active-directory-federation-service/update-ssl-server-certificate/" class="article-date">
  <time datetime="2017-10-02T15:00:00.000Z" itemprop="datePublished">2017-10-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/10/03/active-directory-federation-service/update-ssl-server-certificate/">AD FS の証明書更新手順 (SSLサーバー証明書)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>皆様、こんにちは。Azure &amp; Identity サポート担当の竹村です。</p>
<p>今回は、比較的多くのお客様からお問合せをいただく、AD FS の証明書更新手順をご紹介します。本エントリでは SSL サーバー証明書 (サービス通信証明書) の手順をご紹介し、次回にトークン署名証明書、トークン暗号化証明書についてもご案内したいと思います。</p>
<p>対象リリース: Windows Server 2012 R2 (AD FS 3.0)</p>
<p>以下の流れで更新作業を行います。</p>
<h2 id="手順の概要"><a href="#手順の概要" class="headerlink" title="手順の概要"></a>手順の概要</h2><ol>
<li>証明書の取得</li>
<li>SSL サーバー証明書、ルート証明書、中間証明書のインストール</li>
<li>SSL サーバー証明書のアクセス権設定</li>
<li>AD FS のサービス通信証明書へ SSL サーバー証明書を設定</li>
<li>AD FS の SSL サーバー証明書を更新</li>
<li>WAP サーバーを再構成</li>
</ol>
<p>それぞれの詳細を後述致します。</p>
<h2 id="1-証明書の取得"><a href="#1-証明書の取得" class="headerlink" title="1. 証明書の取得"></a>1. 証明書の取得</h2><p>ご利用になる認証機関から SSL サーバー証明書とルート証明書、中間証明書を取得します。<br>認証機関によって CSR 作成・送信、証明書受領手順が異なるため、手順は省略します。</p>
<h2 id="2-SSL-サーバー証明書、ルート証明書、中間証明書のインストール"><a href="#2-SSL-サーバー証明書、ルート証明書、中間証明書のインストール" class="headerlink" title="2. SSL サーバー証明書、ルート証明書、中間証明書のインストール"></a>2. SSL サーバー証明書、ルート証明書、中間証明書のインストール</h2><p>ご利用になる認証機関から取得した SSL サーバー証明書、ルート証明書、中間証明書を以下手順でインストールします。</p>
<p>※ インポートする中間証明書の有無や数は、ご利用の認証機関によって異なります。</p>
<p>全 AD FS サーバー、全 WAP サーバーにて以下を実施します。</p>
<ol>
<li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p>
</li>
<li><p>画面左側から以下のストアを展開します。</p>
<p> [証明書 (ローカル コンピューター)] - [信頼されたルート証明機関] - [証明書]</p>
</li>
<li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書の発行元証明機関のルート証明書をインストールします。</p>
</li>
<li><p>続けて、画面左側から以下のストアを展開します。</p>
<p> [証明書 (ローカル コンピューター)] - [中間証明機関] - [証明書]</p>
</li>
<li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書の発行元証明機関の中間証明書をインストールします。</p>
</li>
<li><p>続けて、画面左側から以下のストアを展開します。<br>[証明書 (ローカル コンピューター)] - [個人] - [証明書]</p>
</li>
<li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書をインストールします。</p>
</li>
</ol>
<h2 id="3-SSL-サーバー証明書のアクセス権設定"><a href="#3-SSL-サーバー証明書のアクセス権設定" class="headerlink" title="3. SSL サーバー証明書のアクセス権設定"></a>3. SSL サーバー証明書のアクセス権設定</h2><p>証明書に、AD FS サービス アカウントに必要なアクセス許可を付与します。<br>全 AD FS サーバーにて以下を実施します。</p>
<ol>
<li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p>
</li>
<li><p>画面左側から以下のストアを展開します。</p>
<p> [証明書 (ローカル コンピューター)] - [個人] - [証明書]</p>
</li>
<li><p>中央から、手順 2. でインストールした SSL サーバー証明書を右クリックして、[すべてのタスク] - [秘密キーの管理] をクリックします。</p>
<p> ※ もし [秘密キーの管理] を実行できない場合は、次のコマンドを実行してください。    このコマンドを実行することにより、個人ストアのすべての証明書のキーの関連付けの修復、または証明書プロパティやキーのセキュリティ記述子の更新を行います。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -repairstore my *</span><br></pre></td></tr></table></figure>
</li>
<li><p>NT SERVICE\ADFSSRV と NT SERVICE\DRS (場所はローカル) を [追加] して、各アカウントには、少なくとも読み取りアクセス許可を付与します。</p>
<p> ※ NT SERVICE\DRS アカウントが存在しない場合には、NT SERVICE\ADFSSRV にのみアクセス許可を付与します。</p>
</li>
</ol>
<h2 id="4-AD-FS-のサービス通信証明書へ-SSL-サーバー証明書を設定"><a href="#4-AD-FS-のサービス通信証明書へ-SSL-サーバー証明書を設定" class="headerlink" title="4. AD FS のサービス通信証明書へ SSL サーバー証明書を設定"></a>4. AD FS のサービス通信証明書へ SSL サーバー証明書を設定</h2><p>AD FS のサービス通信証明書へ SSL サーバー証明書を設定します。プライマリ AD FS サーバーにて以下を実施します。</p>
<ol>
<li><p>スタート画面などから [AD FS の管理] コンソールを開きます。</p>
</li>
<li><p>画面左側から [AD FS] - [サービス] - [証明書] を右クリックし、 [サービス通信証明書の設定] をクリックします。</p>
</li>
<li><p>証明書の選択画面から手順 2. でインストールした SSL サーバー証明書を選択します。</p>
</li>
<li><p>[OK] をクリックします。</p>
<p> ※ 警告が表示されましたら、[OK] をクリックします。</p>
</li>
</ol>
<h2 id="5-AD-FS-の-SSL-サーバー証明書を更新"><a href="#5-AD-FS-の-SSL-サーバー証明書を更新" class="headerlink" title="5. AD FS の SSL サーバー証明書を更新"></a>5. AD FS の SSL サーバー証明書を更新</h2><p>AD FS の SSL サーバー証明書を更新します。全 AD FS サーバーにて以下を実施します。</p>
<ol>
<li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p>
</li>
<li><p>画面左側から以下のストアを展開します。</p>
<p> [証明書 (ローカル コンピューター)] - [個人] - [証明書]</p>
</li>
<li><p>中央から、手順 2. でインストールした SSL サーバー証明書をダブル クリックします。</p>
</li>
<li><p>[詳細] タブをクリックします。</p>
</li>
<li><p>[拇印] の値をメモします。</p>
</li>
<li><p>PowerShell を管理者として起動します。</p>
</li>
<li><p>起動した PowerShell で以下のコマンドを実行して SSL サーバー証明書を更新します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AdfsSslCertificate -Thumbprint</span><br></pre></td></tr></table></figure>
<p> 例えば、手順 5-5. でメモした拇印が “aa bb cc dd ee” の場合、スペースを除いて以下のようになります。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AdfsSslCertificate -Thumbprint aabbccddee</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="6-WAP-サーバーを再構成"><a href="#6-WAP-サーバーを再構成" class="headerlink" title="6. WAP サーバーを再構成"></a>6. WAP サーバーを再構成</h2><p>WAP サーバーを再構成します。全 WAP サーバーにて以下を実施します。</p>
<ol>
<li><p>レジストリ エディターを開きます。</p>
</li>
<li><p>[HKEY_LOCAL_MACHINE\Software\Microsoft\ADFS] を選択します。</p>
</li>
<li><p>[ProxyConfigurationStatus] をダブル クリックします。</p>
</li>
<li><p>[値のデータ] を 1 にして [OK] をクリックします。</p>
</li>
<li><p>スタート画面などから [リモート アクセス管理] コンソールを開きます。</p>
</li>
<li><p>画面左側から [構成] - [Web Application Proxy] をクリックします。</p>
</li>
<li><p>画面中央から [Web アプリケーション プロキシ構成ウィザードの実行] をクリックします。</p>
</li>
<li><p>初期構成時と同様に、WAP サーバーを構成します。</p>
<p> ※ [AD FS プロキシの証明書] 画面では、手順 2. でインストールした SSL サーバー証明書を選択します。</p>
</li>
</ol>
<blockquote>
<p>(注意) WAPサーバーの再構成を行う際には、hosts ファイルでフェデレーションサービス名がプライマリ AD FS サーバーに名前解決されるように設定ください。<br>AD FS サーバーとWAPサーバーとの間にロードバランサーが存在するような環境の場合、明示的にプライマリ AD FS サーバーに対して接続されるように設定しておきませんと、再構成に失敗することがございます。</p>
</blockquote>
<p>手順は以上の通りとなります。上記手順は過去にも同様のお問い合わせをお受けした際、多くのお客様にご案内しております実績のある手順となっておりますので、ご参考いただけますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/10/03/active-directory-federation-service/update-ssl-server-certificate/" data-id="cjth664d50001t8yt8918pkuj" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-active-directory-federation-service/update-token-certificate" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/10/03/active-directory-federation-service/update-token-certificate/" class="article-date">
  <time datetime="2017-10-02T15:00:00.000Z" itemprop="datePublished">2017-10-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/10/03/active-directory-federation-service/update-token-certificate/">AD FS の証明書更新手順（トークン署名証明書、トークン暗号化解除証明書）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>皆様、こんにちは。Azure &amp; Identity サポート担当の竹村です。</p>
<p>前回に引き続き、本エントリではトークン署名証明書、トークン暗号化解除証明書の更新手順をご紹介いたします。</p>
<p>トークン署名証明書、トークン暗号化解除証明書は AD FS が発行する自己証明書であり、既定では1年に1回自動的に新しい証明書の作成、更新処理が行われます。これを、<a href="https://blogs.technet.microsoft.com/jpntsblog/2016/10/13/ad-fs-%E3%81%AE%E8%87%AA%E5%8B%95%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E6%A9%9F%E8%83%BD%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6/" target="_blank" rel="noopener">自動ロールオーバー機能</a> と呼びます。</p>
<p>自動ロールオーバー機能は、具体的には以下のように動作します。</p>
<ol>
<li>有効期限が切れる 20 日前に、セカンダリのトークン署名/トークン暗号化解除証明書を作成します。</li>
<li>上記 1 でセカンダリの証明書が作成されてから 5 日後に、セカンダリの新しい証明書がプライマリとなり、実際に利用されるようになります。</li>
</ol>
<p>※ この 5 日間の間に、証明書利用者信頼に新しい証明書を登録する必要があります。</p>
<p>※ 2019/02/14 追記: 証明書利用者信頼にアップロードされるのはトークン署名証明書ですが、トークン暗号化解除証明書につきましても認証の際に利用されますので、有効期限が切れますと認証に失敗します。トークン署名証明書だけでなく、トークン暗号化解除証明書につきましても有効期限内での更新が必要です。</p>
<p>ここでは、これらの証明書を手動で更新する手順をご案内いたします。また、補足として証明書の有効期限を既定の 1年 から変更する方法についても併せてご紹介いたします。</p>
<p>対象リリース: Windows Server 2012 R2 (AD FS 3.0)</p>
<h2 id="更新手順"><a href="#更新手順" class="headerlink" title="更新手順"></a>更新手順</h2><p>以下の流れで更新作業を行います。</p>
<p>&lt;手順の概要&gt;</p>
<ol>
<li>セカンダリのトークン署名/トークン暗号化解除証明書を作成</li>
<li>証明書利用者信頼 (Office 365) の証明書情報を更新</li>
<li>セカンダリのトークン署名/トークン暗号化解除証明書をプライマリに昇格</li>
<li>Active Directory Federation Services サービスを再起動</li>
</ol>
<p>それぞれの詳細を後述致します。</p>
<h3 id="1-セカンダリのトークン署名-トークン暗号化解除証明書を作成"><a href="#1-セカンダリのトークン署名-トークン暗号化解除証明書を作成" class="headerlink" title="1. セカンダリのトークン署名/トークン暗号化解除証明書を作成"></a>1. セカンダリのトークン署名/トークン暗号化解除証明書を作成</h3><p>トークン署名/トークン暗号化解除証明書を更新するためには、現在使用されているプライマリのトークン署名/トークン暗号化解除証明書の有効期限が切れる前に、セカンダリのトークン署名/トークン暗号化解除証明書を作成致します。</p>
<p>このセカンダリのトークン署名/トークン暗号化解除証明書は、既定では、プライマリのトークン署名/トークン暗号化解除証明書の有効期限が切れる 20 日前に、AD FS によって自動で作成されます。</p>
<p>セカンダリのトークン署名/トークン暗号化解除証明書が作成されているか否かは、以下の手順で確認致します。</p>
<ol>
<li>プライマリ AD FS サーバーでスタート画面などから [AD FS の管理] コンソールを開きます。</li>
<li>画面左側から [AD FS] - [サービス] - [証明書] を選択します。</li>
<li><p>画面中央から、トークン署名/トークン暗号化解除証明書のセカンダリが存在するか確認します。</p>
<p> セカンダリのトークン署名/トークン暗号化解除証明書は、AD FS による自動作成を待たずに、手動で作成することも可能です。<br> もし、セカンダリのトークン署名/トークン暗号化解除証明書が作成されていない際には、自動で作成されるのを待つか、以下の手順で手動で作成します。</p>
</li>
<li><p>プライマリ AD FS サーバーで PowerShell を管理者として起動します。</p>
</li>
<li><p>起動した PowerShell で以下のコマンドを実行してセカンダリのトークン署名/トークン暗号化解除証明書を作成します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Update-ADFSCertificate</span><br></pre></td></tr></table></figure>
<p> ※ このコマンドを実行するためには、<a href="https://blogs.technet.microsoft.com/jpntsblog/2016/10/13/ad-fs-%E3%81%AE%E8%87%AA%E5%8B%95%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%83%AD%E3%83%BC%E3%83%AB%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E6%A9%9F%E8%83%BD%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6/" target="_blank" rel="noopener">自動ロールオーバー機能</a> が有効である必要がございます。無効の場合には、事前に以下のコマンドを実行し、有効にしてください。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上記 1-1. から 1-3. の手順で、セカンダリが作成されていることを確認します。</p>
</li>
</ol>
<p>以上でセカンダリのトークン署名/トークン暗号化解除証明書作成手順は終了です。<br>次のステップに進みます。</p>
<h3 id="2-証明書利用者信頼-Office-365-の証明書情報を更新"><a href="#2-証明書利用者信頼-Office-365-の証明書情報を更新" class="headerlink" title="2. 証明書利用者信頼 (Office 365) の証明書情報を更新"></a>2. 証明書利用者信頼 (Office 365) の証明書情報を更新</h3><p>新しいトークン署名証明書を作成いたしましたら、証明書利用者信頼にその新しい証明書を登録する必要があります。セカンダリのトークン署名/トークン暗号化解除証明書が作成されてから 5 日以内に、証明書利用者信頼に新しい証明書を登録する必要があります。これは、セカンダリのトークン署名/トークン暗号化解除証明書が作成されてから 5 日後にプライマリに昇格されて、実際に使用されるようになるためです。</p>
<p>ここでは、例として Office 365 の場合の手順をご案内します (Office 365以外の場合には、実際に利用されている証明書利用者信頼ごとに手順をご確認ください)。</p>
<ol>
<li>プライマリ AD FS サーバーでスタート画面などから [Windows PowerShell 用 Windows Azure Active Directory モジュール] を管理者として起動します。</li>
<li><p>起動した PowerShell で以下のコマンドを実行し、Office 365 に接続します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connect-MsolService</span><br></pre></td></tr></table></figure>
<p> 資格情報の入力を求められるので、管理者アカウントの情報を入力します。</p>
</li>
<li><p>続けて、以下のコマンドを実行して現在の証明書情報を調べて、更新が必要か確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-MsolFederationProperty -DomainName</span><br></pre></td></tr></table></figure>
<p> このコマンドで得られる結果から “Source : ADFS Server” と、”Source : Microsoft Office 365” のブロックを比較します。この 2 つのブロックの情報が異なる場合は、引き続き下記の手順に従って更新を行う必要があります。</p>
</li>
<li><p>続けて、以下のコマンドを実行して Office 365 の証明書情報を更新します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Update-MSOLFederatedDomain -DomainName</span><br></pre></td></tr></table></figure>
<p> ※ 複数のトップレベル ドメインをサポートしている場合は、代わりに以下コマンドを実行します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Update-MSOLFederatedDomain -DomainName -SupportMultipleDomain</span><br></pre></td></tr></table></figure>
</li>
<li><p>上記 3. の手順で再度確認を行います。</p>
</li>
</ol>
<p>以上で Office 365 の証明書情報更新手順は終了です。<br>次のステップに進みます。</p>
<h3 id="3-セカンダリのトークン署名-トークン暗号化解除証明書をプライマリに昇格"><a href="#3-セカンダリのトークン署名-トークン暗号化解除証明書をプライマリに昇格" class="headerlink" title="3. セカンダリのトークン署名/トークン暗号化解除証明書をプライマリに昇格"></a>3. セカンダリのトークン署名/トークン暗号化解除証明書をプライマリに昇格</h3><p>※ この手順以降、手順 4. が完了するまで、正しく認証ができない場合があります。手順 4. まで続けて実行してください。</p>
<p>手順 1. で自動、または手動でセカンダリのトークン署名/トークン暗号化解除証明書が作成されてから 5 日後に、AD FS によって自動でセカンダリがプライマリに昇格されます。それ以降、AD FS では、この新しいプライマリのトークン署名/トークン暗号化解除証明書が使用されるようになります。そのため、上述の手順 2. は、セカンダリの証明書が作成されてから 5 日以内に行う必要があります。</p>
<p>この AD FS によるプライマリへの自動昇格を待たずに、手動で昇格することも可能です。その手順は、以下になります。</p>
<ol>
<li>プライマリ AD FS サーバー で PowerShell を管理者として起動します。</li>
<li><p>起動した PowerShell で以下のコマンドを実行して自動ロールオーバー機能を無効化します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$false</span></span><br></pre></td></tr></table></figure>
<p> ※ すでに無効化されている場合は、このコマンドの実行は不要です。</p>
</li>
<li><p>スタート画面などから [AD FS の管理] コンソールを開き、画面左側から [AD FS] - [サービス] - [証明書] を選択します。</p>
</li>
<li>画面中央から、プライマリに昇格したいセカンダリのトークン署名/トークン暗号化解除証明書を右クリックし、[プライマリとして設定] を選択します。</li>
<li>警告が表示される場合は [はい] をクリックします。</li>
<li><p>続けて、PowerShell で以下のコマンドを実行して自動ロールオーバー機能を有効に戻します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$true</span></span><br></pre></td></tr></table></figure>
<p> ※ 無効化された状態で運用をされる場合は、このコマンドの実行は不要です。</p>
<p> 以下の手順でセカンダリのトークン署名/トークン暗号化解除証明書が自動、もしくは手動でプライマリに昇格されていることを確認致します。</p>
</li>
<li><p>プライマリ AD FS サーバーでスタート画面などから [AD FS の管理] コンソールを開きます。</p>
</li>
<li>画面左側から [AD FS] - [サービス] - [証明書] を選択します。</li>
<li>画面中央から、トークン署名/トークン暗号化解除証明書のプライマリとセカンダリが入れ替わっていることを確認します。</li>
</ol>
<p>以上でセカンダリのトークン署名/トークン暗号化解除証明書をプライマリに昇格する手順は終了です。次のステップに進みます。</p>
<h3 id="4-Active-Directory-Federation-Services-を再起動"><a href="#4-Active-Directory-Federation-Services-を再起動" class="headerlink" title="4. Active Directory Federation Services を再起動"></a>4. Active Directory Federation Services を再起動</h3><p>手順 3. の後、トークン署名/トークン暗号化解除証明書の入れ替えが各 AD FS サーバーに反映されるまで、10 分ほど待った後、各 AD FS サーバーの Active Directory Federation Services を再起動致します。各 AD FS サーバーで以下の手順を行い、Active Directory Federation Services を再起動致します。</p>
<ol>
<li>スタート画面などから [サービス] コンソールを開きます。</li>
<li>[Active Directory Federation Services] を右クリックし、[再起動] を選択します。</li>
</ol>
<p>以上で Active Directory Federation Services の再起動手順は終了です。</p>
<h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>以下について補足をさせて頂きます。トークン署名/トークン暗号化解除証明書の更新に際しまして、ご参考になれば幸いです。</p>
<ol>
<li>トークン署名/トークン暗号化解除証明書の有効期間を延ばす手順</li>
<li>自動ロールオーバー機能を無効化する手順</li>
<li>セカンダリのトークン署名/トークン暗号化解除証明書を削除する手順</li>
</ol>
<p>それぞれの詳細を後述致します。</p>
<h3 id="1-トークン署名-トークン暗号化解除証明書の有効期間を変更する手順"><a href="#1-トークン署名-トークン暗号化解除証明書の有効期間を変更する手順" class="headerlink" title="1. トークン署名/トークン暗号化解除証明書の有効期間を変更する手順"></a>1. トークン署名/トークン暗号化解除証明書の有効期間を変更する手順</h3><p>既定では、トークン署名/トークン暗号化解除証明書の有効期間は 1 年です。以下の手順に沿って、トークン署名/トークン暗号化解除証明書の有効期間を変更することで、次回以降作成される証明書に反映されます。</p>
<p>なお、この手順は現行の証明書の期間を変更するものではなく、この設定以降に作成される証明書の有効期間を変更するものとなります。そのため、トークン署名/トークン暗号化解除証明書の有効期間を変更する際には、最初にこの手順を実施していただいた後に証明書の更新作業を行ってください。</p>
<ol>
<li>プライマリ AD FS サーバー で PowerShell を管理者として起動します。</li>
<li><p>起動した PowerShell で以下のコマンドを実行して有効期間を設定します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AdfsProperties -CertificateDuration</span><br></pre></td></tr></table></figure>
<p> 例えば、およそ 10 年 (3650日) に設定する場合は以下のようになります。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AdfsProperties -CertificateDuration <span class="number">3650</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>弊社内部情報より、最長で 50 年の設定を行っても問題ないことを確認しております。</p>
<h3 id="2-自動ロールオーバー機能を無効化する手順"><a href="#2-自動ロールオーバー機能を無効化する手順" class="headerlink" title="2. 自動ロールオーバー機能を無効化する手順"></a>2. 自動ロールオーバー機能を無効化する手順</h3><p>先述のとおり、自動ロールオーバー機能は既定で以下のように動作します。</p>
<ul>
<li>現在使用されているプライマリのトークン署名/トークン暗号化解除証明書の有効期限が切れる 20 日前に、新証明書をセカンダリとして作成する</li>
<li>セカンダリのトークン署名/トークン暗号化解除証明書が作成されてから 5 日後に、プライマリ (旧証明書) とセカンダリ (新証明書) を入れ替える</li>
</ul>
<p>そのため、各証明書の有効期限に合わせて(既定では 1年ごとに) 新しい証明書を証明書利用者信頼に登録する作業を行っていただく必要がございます。</p>
<p>※ 証明書利用者信頼の中には、AD FS からフェデレーションメタデータを受信できるネットワーク環境であれば、自動的に更新作業が行われるものもございます。</p>
<p>上述 1 の証明書の有効期限を変更する手順と併せて、自動ロールオーバー機能を無効にしていただくことで、各作業を、各証明書の有効期限が切れるまでにお客様の任意のタイミングで進めていただくことができます。自動ロールオーバー機能を無効にする方法は以下になります。</p>
<ol>
<li>プライマリ AD FS サーバー で PowerShell を管理者として起動します。</li>
<li><p>起動した PowerShell で以下のコマンドを実行して自動ロールオーバー機能を無効化します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$false</span></span><br></pre></td></tr></table></figure>
<p> なお、自動ロールオーバー機能を有効に戻す場合は、以下のコマンドを実行します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$true</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="3-セカンダリのトークン署名-トークン暗号化解除証明書を削除する手順"><a href="#3-セカンダリのトークン署名-トークン暗号化解除証明書を削除する手順" class="headerlink" title="3. セカンダリのトークン署名/トークン暗号化解除証明書を削除する手順"></a>3. セカンダリのトークン署名/トークン暗号化解除証明書を削除する手順</h3><p>トークン署名/トークン暗号化解除証明書の更新作業を行っていただいた後、元々プライマリであった証明書がセカンダリとして残ります。以下の手順に沿って、このセカンダリの証明書を削除することが可能です。</p>
<p>なお、このセカンダリの証明書は残っていても AD FS の動作などに影響を及ぼすものではございません。</p>
<ol>
<li>プライマリ AD FS サーバー で PowerShell を管理者として起動します。</li>
<li><p>起動した PowerShell で以下のコマンドを実行して現在の証明書情報を確認します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AdfsCertificate</span><br></pre></td></tr></table></figure>
<p> CertificateType の値が Token-Signing になっていて IsPrimary の値が False になっているブロックがセカンダリのトークン署名証明書の情報ブロックです (例)。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Certificate : [Subject]</span><br><span class="line">CN=ADFS Signing - adfs.test.com</span><br><span class="line">[Issuer]</span><br><span class="line">CN=ADFS Signing - adfs.test.com</span><br><span class="line">[Serial Number]</span><br><span class="line">1E841605620028AC4FB542149E31A4A7</span><br><span class="line">[Not Before]</span><br><span class="line">2017/10/11 15:09:47</span><br><span class="line">[Not After]</span><br><span class="line">2057/10/01 15:09:47</span><br><span class="line">[Thumbprint]</span><br><span class="line">41D3FE9CB98FA89BE0899904B3B227DECB8A512A</span><br><span class="line">CertificateType : Token-Signing ★&lt;&lt;&lt;</span><br><span class="line">IsPrimary : False ★&lt;&lt;&lt;</span><br><span class="line">StoreLocation : CurrentUser</span><br><span class="line">StoreName : My</span><br><span class="line">Thumbprint : 41D3FE9CB98FA89BE0899904B3B227DECB8A512A ★&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>
<p> ※ 念のため、AD FS 管理ツールからセカンダリのトークン署名証明書をダブルクリックし、[詳細] タブの「拇印」が Thumbprint と一致していることを確認します。</p>
</li>
</ol>
<pre><code>CertificateType の値が Token-Decrypting になっていて IsPrimary の値が False になっているブロックがセカンダリのトークン暗号化解除証明書の情報ブロックです (例)。

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Certificate : [Subject]</span><br><span class="line">CN=ADFS Encryption - adfs.test.com</span><br><span class="line">[Issuer]</span><br><span class="line">CN=ADFS Encryption - adfs.test.com</span><br><span class="line">[Serial Number]</span><br><span class="line">3E79CAA431F92DB6454084FEA1AE9995</span><br><span class="line">[Not Before]</span><br><span class="line">2017/10/11 15:09:47</span><br><span class="line">[Not After]</span><br><span class="line">2057/10/01 15:09:47</span><br><span class="line">[Thumbprint]</span><br><span class="line">57CA6410E8C213DC14645AEBCCDEF0481FC8C641</span><br><span class="line">CertificateType : Token-Decrypting ★&lt;&lt;&lt;</span><br><span class="line">IsPrimary : False ★&lt;&lt;&lt;</span><br><span class="line">StoreLocation : CurrentUser</span><br><span class="line">StoreName : My</span><br><span class="line">Thumbprint : 57CA6410E8C213DC14645AEBCCDEF0481FC8C641 ★&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>

※ 念のため、AD FS 管理ツールからセカンダリのトークン暗号化解除証明書をダブルクリックし、[詳細] タブの「拇印」が Thumbprint と一致していることを確認します。
</code></pre><ol start="3">
<li><p>続けて、PowerShell で以下のコマンドを実行して自動ロールオーバー機能を無効化します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$false</span></span><br></pre></td></tr></table></figure>
<p> ※ すでに無効化されている場合はこのコマンドの実行は不要です。</p>
</li>
<li><p>上記 2. で確認した結果を元に、PowerShell で以下のコマンドを実行してセカンダリのトークン署名証明書を削除します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove-AdfsCertificate -Thumbprint 【削除する証明書の拇印】 -CertificateType Token-Signing</span><br></pre></td></tr></table></figure>
<p> 上記 2 の例ですと、以下のコマンドを実行します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove-AdfsCertificate -Thumbprint <span class="number">41</span>D3FE9CB98FA89BE0899904B3B227DECB8A512A -CertificateType Token-Signing</span><br></pre></td></tr></table></figure>
</li>
<li><p>上記 2. で確認した結果を元に、PowerShell で以下のコマンドを実行してセカンダリのトークン暗号化解除証明書を削除します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove-AdfsCertificate -Thumbprint 【削除する証明書の拇印】 -CertificateType Token-Decrypting</span><br></pre></td></tr></table></figure>
<p> 上記 2 の例ですと、以下のコマンドを実行します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove-AdfsCertificate -Thumbprint <span class="number">57</span>CA6410E8C213DC14645AEBCCDEF0481FC8C641 -CertificateType Token-Decrypting</span><br></pre></td></tr></table></figure>
</li>
<li><p>続けて、PowerShell で以下のコマンドを実行して自動ロールオーバー機能を有効に戻します。</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ADFSProperties -AutoCertificateRollover <span class="literal">$true</span></span><br></pre></td></tr></table></figure>
<p> ※ 無効化された状態で運用をされる場合はこのコマンドの実行は不要です。</p>
</li>
</ol>
<p>手順は以上の通りとなります。<br>上記手順は過去にも同様のお問い合わせをお受けした際、多くのお客様にご案内しております実績のある手順となっておりますので、ご参考いただけますと幸いです。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jpazureid.github.io/2017/10/03/active-directory-federation-service/update-token-certificate/" data-id="cjth664f6002rt8ytjhjz1syv" class="article-share-link">共有</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/page/2/">&laquo; 戻る</a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグ</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AAD-Connect/">AAD Connect</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AD-FS/">AD FS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AD-Sync/">AD Sync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD/">Azure AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-Application-Proxy/">Azure AD Application Proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-B2B/">Azure AD B2B</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-Directory-Rolls/">Azure AD Directory Rolls</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Azure-AD-License/">Azure AD License</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Conditional-Access/">Conditional Access</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ExpressRoute/">ExpressRoute</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hard-match/">Hard match</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hybrid-Azure-AD-Join/">Hybrid Azure AD Join</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Intune/">Intune</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MFA/">MFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/PowerShell/">PowerShell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/RBAC/">RBAC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Sgin-in-log/">Sgin-in log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Smart-lockout/">Smart lockout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Subscription/">Subscription</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Tenant-Restrictions/">Tenant Restrictions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/UPN/">UPN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Windows-Defender-ATP/">Windows Defender ATP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Workplace-Join/">Workplace Join</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグクラウド</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/AAD-Connect/" style="font-size: 14px;">AAD Connect</a> <a href="/blog/tags/AD-FS/" style="font-size: 18px;">AD FS</a> <a href="/blog/tags/AD-Sync/" style="font-size: 10px;">AD Sync</a> <a href="/blog/tags/Azure-AD/" style="font-size: 20px;">Azure AD</a> <a href="/blog/tags/Azure-AD-Application-Proxy/" style="font-size: 10px;">Azure AD Application Proxy</a> <a href="/blog/tags/Azure-AD-B2B/" style="font-size: 14px;">Azure AD B2B</a> <a href="/blog/tags/Azure-AD-Directory-Rolls/" style="font-size: 10px;">Azure AD Directory Rolls</a> <a href="/blog/tags/Azure-AD-License/" style="font-size: 10px;">Azure AD License</a> <a href="/blog/tags/Conditional-Access/" style="font-size: 16px;">Conditional Access</a> <a href="/blog/tags/ExpressRoute/" style="font-size: 10px;">ExpressRoute</a> <a href="/blog/tags/Hard-match/" style="font-size: 10px;">Hard match</a> <a href="/blog/tags/Hybrid-Azure-AD-Join/" style="font-size: 10px;">Hybrid Azure AD Join</a> <a href="/blog/tags/Intune/" style="font-size: 12px;">Intune</a> <a href="/blog/tags/MFA/" style="font-size: 10px;">MFA</a> <a href="/blog/tags/PowerShell/" style="font-size: 10px;">PowerShell</a> <a href="/blog/tags/RBAC/" style="font-size: 12px;">RBAC</a> <a href="/blog/tags/Security/" style="font-size: 12px;">Security</a> <a href="/blog/tags/Sgin-in-log/" style="font-size: 10px;">Sgin-in log</a> <a href="/blog/tags/Smart-lockout/" style="font-size: 10px;">Smart lockout</a> <a href="/blog/tags/Subscription/" style="font-size: 10px;">Subscription</a> <a href="/blog/tags/Tenant-Restrictions/" style="font-size: 10px;">Tenant Restrictions</a> <a href="/blog/tags/UPN/" style="font-size: 10px;">UPN</a> <a href="/blog/tags/Windows-Defender-ATP/" style="font-size: 10px;">Windows Defender ATP</a> <a href="/blog/tags/Workplace-Join/" style="font-size: 10px;">Workplace Join</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/10/">十月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2019/02/04/azure-active-directory/how-to-get-sign-in-logs/">Azure AD サインイン ログ取得方法まとめ</a>
          </li>
        
          <li>
            <a href="/blog/2018/12/12/azure-active-directory/last-signin-reports/">PowerShell にて全ユーザーの最終サインイン日時を一括で取得する方法</a>
          </li>
        
          <li>
            <a href="/blog/2018/11/01/azure-active-directory/create-subscription-error/">サブスクリプション作成時のエラー「アカウントが Azure サブスクリプションに関連付けられないディレクトリに属しています。別のアカウントでサインインしてください」</a>
          </li>
        
          <li>
            <a href="/blog/2018/10/15/azure-active-directory/mfa-reset/">多要素認証 (MFA) のリセット手順</a>
          </li>
        
          <li>
            <a href="/blog/2018/09/27/azure-active-directory/conditional-access-basuc/">条件付きアクセスの基本的な考え方</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Azure Identity Support Japan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>